---
title: 《玩转 Spring 全家桶》笔记
date: 2023-07-29 15:25:09
categories:
  - 笔记
  - Java
tags:
  - Java
  - 框架
  - Spring
  - SpringBoot
  - SpringCloud
permalink: /pages/eb5c76/
---

# 《玩转 Spring 全家桶》笔记

## 第一章：初识 Spring (4 讲)

## 第二章：JDBC 必知必会 (10 讲)

## 第三章：O/R Mapping 实践 (9 讲)

## 第四章：NoSQL 实践 (7 讲)

## 第五章：数据访问进阶 (8 讲)

## 第六章：Spring MVC 实践 (14 讲)

## 第七章：访问 Web 资源 (5 讲)

## 第八章： Web 开发进阶 (9 讲)

## 第九章：重新认识 Spring Boot (8 讲)

## 第十章：运行中的 Spring Boot (11 讲)

## 第十一章：Spring Cloud 及 Cloud Native 概述 (5 讲)

### 86 | 简单理解微服务

微服务就是一些协同工作的小而自治的服务。

微服务的优点

- 易于部署
- 与组织结构对齐
- 可组合性
- 可替代性

微服务的代价

- 架构复杂
- 运维复杂

### 87 | 如何理解云原生(Cloud Native)

云原生技术有利于各组织在公有云、私有云和混合云等新型动态环境中，构建和运行可弹性扩展的应用。

云原生应用要求

- DevOps
- 持续交付
- 微服务
- 容器

Cloud Native Computing Foundation，缩写 CNCF

### 88 | 12-Factor App（上）

### 89 | 12-Factor App（下）

12-Factor 为构建 SaaS 应用提供了方法论。

参考资料：https://12factor.net/zh_cn/

- 基准代码 - 一份基准代码，多份部署。解决方案：git

- 依赖 - 显式声明依赖关系。解决方案：maven、gradle

- 配置 - 在环境中存储配置。解决方案：apollo

- 后端服务 - 把后端服务当作附加资源

- 构建，发布，运行 - 严格分离构建和运行。解决方案：CI/CD（如：jenkins、sonar 等）

- 进程 - 以一个或多个无状态进程运行应用

- 端口绑定 - 通过端口绑定提供服务

- 并发 - 通过进程模型进行扩展

- 易处理 - 快速启动和优雅终止可最大化健壮性

- 开发环境与线上环境等价 - 尽可能的保持开发，预发布，线上环境相同

- 日志 - 把日志当作事件流

- 管理进程 - 后台管理任务当作一次性进程运行

### 90 | 认识 Spring Cloud 的组成部分

![](https://raw.githubusercontent.com/dunwu/images/dev/snap/20230729155944.svg)

Spring Cloud 的主要功能

- 服务发现
- 服务熔断
- 配置服务
- 服务安全
- 服务网关
- 分布式消息
- 分布式跟踪
- 各种云平台支持

## 第十二章：服务注册与发现 (9 讲)

### 91 | 使用 Eureka 作为服务注册中心

- **SpringCloud 启动包**
  - 服务端 - `spring-cloud-starter-netflix-eureka-server`
  - 客户端 - `spring-cloud-starter-netflix-eureka-client`
- **注解**
  - 服务端启动注解 - `@EnableEurekaServer`
  - 客户端启动注解
    - 通用注解 - `@EnableDiscoveryClient`
    - Eureka 特定注解 - `@EnableEurekaClient`
- **要点**
  - Eureka 默认端口 8761
- **配置**
  - `eureka.client.serviceUrl.defaultZone` - 注册地址，如 http://localhost:10001/eureka/
  - `eureka.client.register-with-eureka` - 是否将自己注册到 Eureka Server，默认为 true
  - `eureka.client.fetch-registry` - 是否从 Eureka Server 获取注册信息，默认为 true

### 92 | 使用 Spring Cloud Loadbalancer 访问服务

- 如何获得服务地址
  - `org.springframework.cloud.netflix.eureka.EurekaDiscoveryClient`
  - `org.springframework.cloud.client.discovery.DiscoveryClient` - 通用接口，推荐方式
- 负载均衡客户端
  - `@LoadBalanced`
  - 实际是通过 `ClientHttpRequestInterceptor` 实现的
  - `LoadBalancerInterceptor`
  - `LoadBalancerClient`
  - `RibbonLoadBalancerClient`

### 93 | 使用 Feign 访问服务

声明式 REST Web 服务客户端

- **SpringCloud 启动包**
  - spring-cloud-starter-openfeign
- **注解**
  - 启动注解 - `@EnableFeignClients`
  - 定义接口注解 - `@FeignClient`
- **配置** - `org.springframework.cloud.openfeign.FeignClientsConfiguration`

### 94 | 深入理解服务发现背后的 DiscoveryClient

- **服务端抽象接口** - `org.springframework.cloud.client.serviceregistry.ServiceRegistry`
  - `EurekaServiceRegistry`
  - `EurekaRegistration`
  - `EurekaAutoServiceRegistration`
  - `EurekaClientAutoConfiguration`
- **客户端抽象接口** - `org.springframework.cloud.client.discovery.DiscoveryClient`
  - `@EnableDiscoveryClient`
- **负载均衡抽象接口** - `org.springframework.cloud.client.loadbalancer.LoadBalancerClient`

### 95 | 使用 Zookeeper 作为服务注册中心

- **SpringCloud 启动包**
  - **spring-cloud-starter-zookeeper-discovery**
- **配置**
  - `ZookeeperAutoConfiguration`
  - `ZookeeperDiscoveryAutoConfiguration`

### 96 | 使用 Consul 作为服务注册中心

- **SpringCloud 启动包**
  - **spring-cloud-starter-consul-discovery**
- **配置**
  - `ConsulAutoConfiguration`

### 97 | 使用 Nacos 作为服务注册中心

- **SpringCloud 启动包**
  - **spring-cloud-starter-alibaba-nacos-discovery**
- **配置**
  - `NacosDiscoveryAutoConfiguration`

### 98 | 如何定制自己的 DiscoveryClient

**`DiscoveryClient`**

- `EurekaDiscoveryClient`
- `ZooKeeperDiscoveryClient`
- `ConsulDiscoveryClient`
- `NacosDiscoveryClient`

**`LoadBalancerClient`**

- `RibbonLoadBalancerClient`

**自定义 DiscoveryClient 步骤**

- 返回该 DiscoveryClient 能提供的服务名列表
- 返回指定服务对应的 ServiceInstance 列表
- 返回 DiscoveryClient 的顺序
- 返回 HealthIndicator 里显示的描述

自定义 RibbonClient 支持

- 实现 `ServerList<T extends Server>`
- Ribbon 提供了 AbstractServerList
- 提供一个配置类，声明 ServerList Bean 实例

### 99 | SpringBucks 实战项目进度小结

略

## 第十三章：服务熔断 (7 讲)

### 100 | 使用 Hystrix 实现服务熔断（上）

断路器模式

在断路器对象中封装受保护的方法调用

该对象监控调用和断路情况

调用失败触发阈值后，后序调用直接由断路器返回错误，不再执行实际调用

### 101 | 使用 Hystrix 实现服务熔断（下）

- **Hystrix 应用**

  - 注解
  - @HystrixCommand
    - fallbackMethod
    - commandProperties
      - @HystrixProperty

- **SpringCloud 启动包**
  - **spring-cloud-starter-netflix-hystrix**
- **注解**

  - `@EnableCircuitBreaker` - 断路器开启注解

- **Feign 支持**

  - `feign.hystrix.enabled=true`
  - `@FeignClient` 的 `fallback` / `fallbackFactory`

- **配置**
  - `NacosDiscoveryAutoConfiguration`

### 102 | 如何观察服务熔断

Spring Cloud 对于熔断的监控支持

- Hystrix Metrics Stream
  - spring-boot-starter-actuator
  - `/actuator/hystrix.stream`
- Hystrix Dashboard
  - spring-cloud-starter-netflix-hystrix-dashboard
  - `@EnableHystrixDashboard`
  - `/hystirx`

**聚合集群熔断信息**

- **SpringCloud 启动包** - spring-cloud-starter-netflix-turbines
- **注解** - `@EnableTurbine`
- `/turbine/stream?cluster=集群名`

### 103 | 使用 Resilience4j 实现服务熔断

Hystrix 官方已经停止维护，因此建议选择其他产品来替代。例如：[Resilience4J](https://github.com/resilience4j/resilience4j)

- Resilience4J 实现
  - 基于 `ConcurrentHashMap` 的内存断路器
  - `CircuitBreakerRegistry`
  - `CircuitBreakerConfig`
- Resilience4J 依赖

  - resilience4j-spring-boot2

- 注解
  - @CircuitBreaker
- 配置
  - CircuitBreakerProperties

### 104 | 使用 Resilience4j 实现服务限流（上）

Bulkhead

- 目的
  - 防止下游依赖被并发请求冲击
  - 防止发生雪崩
- 用法
  - BulkheadRegistry / BulkheadConfig
  - @Bulkhead(name = "xxx")

### 105 | 使用 Resilience4j 实现服务限流（下）

RateLimit

- 目的
  - 限制特定时间内的执行次数
- 用法
  - `RateLimiterRegistry` / `RateLimiterConfig`
  - `@RateLimiter`
- 配置
- RateLimiterPropertis

### 106 | SpringBucks 实战项目进度小结

略

## 第十四章：服务配置 (7 讲)

## 第十五章：Spring Cloud Stream (4 讲)

## 第十六章：服务链路追踪 (6 讲)

## 参考资料

- [玩转 Spring 全家桶](https://time.geekbang.org/course/intro/156)
