---
title: 《玩转 Spring 全家桶》笔记
date: 2023-07-29 15:25:09
categories:
  - 笔记
  - Java
tags:
  - Java
  - 框架
  - Spring
  - SpringBoot
  - SpringCloud
permalink: /pages/eb5c76/
---

# 《玩转 Spring 全家桶》笔记

## 第一章：初识 Spring (4 讲)

## 第二章：JDBC 必知必会 (10 讲)

## 第三章：O/R Mapping 实践 (9 讲)

## 第四章：NoSQL 实践 (7 讲)

## 第五章：数据访问进阶 (8 讲)

## 第六章：Spring MVC 实践 (14 讲)

## 第七章：访问 Web 资源 (5 讲)

## 第八章： Web 开发进阶 (9 讲)

## 第九章：重新认识 Spring Boot (8 讲)

### 67 | 认识 Spring Boot 的组成部分

### Spring Boot 的特性

- 方便地创建可独立运行的 Spring 应用程序
- 直接内嵌 Tomcat、Jetty 或 Undertow
- 简化了项目的构建配置
- 为 Spring 及第三方库提供自动配置
- 提供生产级特性
- 无需生成代码或进行 XML 配置

### Spring Boot 的四大核心

- 自动配置 - Auto Configuration
- 起步依赖 - Starter Dependency
- 命令行界面 - Spring Boot CLI
- Actuator

### 68 | 了解自动配置的实现原理

### 了解自动配置

**自动配置**

- 基于添加的 JAR 依赖自动对 Spring Boot 应⽤用程序进行配置
- spring-boot-autoconfiguration

**开启自动配置**

- `@EnableAutoConfiguration`
  - `exclude = Class<?>[]`
- `@SpringBootApplication`

### 自动配置的实现原理

**`@EnableAutoConfiguration`**

- `AutoConfigurationImportSelector`
- `META-INF/spring.factories`
  - `org.springframework.boot.autoconfigure.EnableAutoConfiguration`

**条件注解**

- `@Conditional`
- `@ConditionalOnClass`
- `@ConditionalOnBean`
- `@ConditionalOnMissingBean`
- `@ConditionalOnProperty`
- ……

### 了解自动配置的情况

**观察自动配置的判断结果**

- --debug

**`ConditionEvaluationReportLoggingListener`**

- Positive matches
- Negative matches
- Exclusions
- Unconditional classes

### 69 | 动手实现自己的自动配置

### 主要工作内容

- 编写 Java Config
  - `@Configuration`
- 添加条件
  - `@Conditional`
- 定位自动配置
  - `META-INF/spring.factories`

### 条件注解

**条件注解**

- `@Conditional`

**类条件**

- `@ConditionalOnClass`

- `@ConditionalOnMissingClass`

**属性条件**

- `@ConditionalOnProperty`

**Bean 条件**

- `@ConditionalOnBean`

- `@ConditionalOnMissingBean`

- `**@ConditionalOnSingleCandidate`\*\*

**资源条件**

- `@ConditionalOnResource`

**Web 应用条件**

- `@ConditionalOnWebApplication`
- `@ConditionalOnNotWebApplication`

**其他条件**

- `@ConditionalOnExpression`
- `@ConditionalOnJava`
- `@ConditionalOnJndi`

### 自动配置的执行顺序

**执行顺序**

- `@AutoConfigureBefore`
- `@AutoConfigureAfter`
- `@AutoConfigureOrder`

### 70 | 如何在低版本 Spring 中快速实现类似自动配置的功能

### 需求与问题

**核心的诉求**

- 现存系统，不打算重构
- Spring 版本 3.x，不打算升级版本和引入 Spring Boot
- 期望能够在少改代码的前提下实现一些功能增强

**面临的问题**

- 3.x 的 Spring 没有条件注解
- 无法自动定位需要加载的自动配置

### 核心解决思路

**条件判断**

- 通过 `BeanFactoryPostProcessor` 进行判断

**配置加载**

- 编写 Java Config 类
- 引入配置类
- 通过 component-scan
- 通过 xml 文件 import

### Spring 的扩展点

**BeanPostProcessor**

- 针对 Bean 实例

- 在 Bean 创建后提供定制逻辑回调

**BeanFactoryPostProcessor**

- 针对 Bean 定义

- 在容器创建 Bean 前获取配置元数据

- Java Config 中需要定义为 static 方法

### 关于 Bean 的一些定制

#### 生命周期回调

- InitializingBean / @PostConstruct / init-method
- DisposableBean / @PostDestory / destroy-method

#### XXXAware

- `ApplicationContextAware`
- `BeanFactoryAware`
- `BeanNameAware`

### 一些常用操作

**判断类是否存在**

- `ClassUtils.isPresent()`

**判断 Bean 是否已定义**

- `ListableBeanFactory.containsBeanDefinition()`
- `ListableBeanFactory.getBeanNamesForType()`

**注册 Bean 定义**

- `BeanDefinitionRegistry.registerBeanDefinition()`

  - `GenericBeanDefinition`

- `BeanFactory.registerSingleton()`

### 71 | 了解起步依赖及其实现原理

### Maven 依赖管理技巧

了解你的依赖

- mvn dependency:tree
- IDEA Maven Helper 插件

排除特定依赖

- exclusion

统一管理依赖

- dependencyManagement
- Bill of Materials - bom

### Spring Boot 的 starter 依赖

**Starter Dependencies**

- 直接面向功能
- 一站获得所有相关依赖，不再复制粘贴

**官方的 Starters**

- spring-boot-starter-\*

### 72 | 定制自己的起步依赖

**主要内容**

- autoconfigure 模块，包含自动配置代码
- starter 模块，包含指向自动配置模块的依赖及其他相关依赖

**命名方式**

- xxx-spring-boot-autoconfigure
- xxx-spring-boot-starter

**注意事项**

- 不要使用 spring-boot 作为依赖的前缀
- 不要使用 spring-boot 的配置命名空间
- starter 中仅添加必要的依赖
- 声明对 spring-boot-starter 的依赖

### 73 | 深挖 Spring Boot 的配置加载机制

### 外化配置加载顺序

- 开启 DevTools 时，`~/.spring-boot-devtools.properties`
- 测试类上的 `@TestPropertySource` 注解
- `@SpringBootTest#properties` 属性
- 命令行参数（ `--server.port=9000` ）
- SPRING_APPLICATION_JSON 中的属性
- `ServletConfig` 初始化参数
- `ServletContext` 初始化参数
- `java:comp/env` 中的 JNDI 属性
- `System.getProperties()`
- 操作系统环境变量
- `random.*` 涉及到的 `RandomValuePropertySource`
- jar 包外部的 application-{profile}.properties 或 .yml
- jar 包内部的 application-{profile}.properties 或 .yml
- jar 包外部的 application.properties 或 .yml
- jar 包内部的 application.properties 或 .yml
- @Configuration 类上的 @PropertySource
- SpringApplication.setDefaultProperties() 设置的默认属性

### application.properties

默认位置

- `./config`
- `./`
- CLASSPATH 中的 `/config`
- CLASSPATH 中的 `/`

修改名字或路路径

- `spring.config.name`
- `spring.config.location`
- `spring.config.additional-location`

### Relaxed Binding

| 命名风格             | 使用范围                                   | 示例                            |
| -------------------- | ------------------------------------------ | ------------------------------- |
| 短划线分隔           | Properties 文件<br/>YAML 文件<br/>系统属性 | geektime.spring-boot.first-demo |
| 驼峰式               | Properties 文件<br/>YAML 文件<br/>系统属性 | geektime.springBoot.firstDemo   |
| 下划线分割           | Properties 文件<br/>YAML 文件<br/>系统属性 | geektime.spring_boot.first_demo |
| 全⼤大写，下划线分隔 | 环境变量                                   | GEEKTIME_SPRINGBOOT_FIRSTDEMO   |

### 74 | 理解配置背后的 PropertySource 抽象

### 添加 PropertySource

- `<context:property-placeholder>`
- `PropertySourcesPlaceholderConfigurer`
- `PropertyPlaceholderConfigurer`
- `@PropertySource`
- `@PropertySources`

### Spring Boot 中的 @ConfigurationProperties

- 可以将属性绑定到结构化对象上
- 支持 Relaxed Binding
- 支持安全的类型转换
- `@EnableConfigurationProperties`

### 定制 PropertySource

**主要步骤**

- 实现 `PropertySource<T>`
- 从 `Environment` 取得 `PropertySources`
- 将自己的 `PropertySource` 添加到合适的位置

**切入位置**

- `EnvironmentPostProcessor`
- `BeanFactoryPostProcessor`

## 第十章：运行中的 Spring Boot (11 讲)

### 75 | 认识 Spring Boot 的各类 Actuator Endpoint

### Actuator

**目的**

- 监控并管理应用程序

**访问方式**

- HTTP
- JMX

**依赖**

- spring-boot-starter-actuator

### 一些常用 Endpoint

| ID             | 说明                                  | 默认开启 | 默认 HTTP | 默认 JMX |
| -------------- | ------------------------------------- | -------- | --------- | -------- |
| beans          | 显示容器中的 Bean 列表                | Y        | N         | Y        |
| caches         | 显示应用中的缓存                      | Y        | N         | Y        |
| conditions     | 显示配置条件的计算情况                | Y        | N         | Y        |
| configprops    | 显示 @ConfigurationProperties 的信息  | Y        | N         | Y        |
| env            | 显示 ConfigurableEnvironment 中的属性 | Y        | N         | Y        |
| health         | 显示健康检查信息                      | Y        | Y         | Y        |
| httptrace      | 显示 HTTP Trace 信息                  | Y        | N         | Y        |
| info           | 显示设置好的应用信息                  | Y        | Y         | Y        |
| loggers        | 显示并更新日志配置                    | Y        | N         | Y        |
| metrics        | 显示应用的度量信息                    | Y        | N         | Y        |
| mappings       | 显示所有的 @RequestMapping 信息       | Y        | N         | Y        |
| scheduledtasks | 显示应用的调度任务信息                | Y        | N         | Y        |
| shutdown       | 优雅地关闭应用程序                    | N        | N         | Y        |
| threaddump     | 执行 Thread Dump                      | Y        | N         | Y        |
| heapdump       | 返回 Heap Dump 文件，格式为 HPROF     | Y        | N         | N/A      |
| prometheus     | 返回可供 Prometheus 抓取的信息        | Y        | N         | N/A      |

### 如何访问 Actuator Endpoint

**HTTP 访问**

- `/actuator/<id>`

**端口与路径**

- `management.server.address=`
- `management.server.port=`
- `management.endpoints.web.base-path=/actuator`
- `management.endpoints.web.path-mapping.<id>=路径`

**开启 Endpoint**

- `management.endpoint.<id>.enabled=true`
- `management.endpoints.enabled-by-default=false`

**暴露 Endpoint**

- `management.endpoints.jmx.exposure.exclude=`
- `management.endpoints.jmx.exposure.include=*`
- `management.endpoints.web.exposure.exclude=`
- `management.endpoints.web.exposure.include=info, health`

### 76 | 动手定制自己的 Health Indicator

### Spring Boot 自带的 Health Indicator

目的

- 检查应用程序的运行状态

状态

- DOWN - 503
- OUT_OF_SERVICE - 503
- UP - 200
- UNKNOWN - 200

机制

- 通过 `HealthIndicatorRegistry` 收集信息
- `HealthIndicator` 实现具体检查逻辑

配置项

- `management.health.defaults.enabled=true|false`
- `management.health.<id>.enabled=true`
- `management.endpoint.health.show-details=never|whenauthorized|always`

**内置 HealthIndicator 清单**

- CassandraHealthIndicator

- ElasticsearchHealthIndicator

- MongoHealthIndicator

- SolrHealthIndicator

- CouchbaseHealthIndicator

- InfluxDbHealthIndicator

- Neo4jHealthIndicator

- DiskSpaceHealthIndicator

- JmsHealthIndicator

- RabbitHealthIndicator

- DataSourceHealthIndicator

- MailHealthIndicator

- RedisHealthIndicator

### 自定义 Health Indicator

**方法**

- 实现 HealthIndicator 接口
- 根据自定义检查逻辑返回对应 Health 状态
- Health 中包含状态和详细描述信息

### 77 | 通过 Micrometer 获取运行数据

### 认识 Micrometer

**特性**

- 多维度度量量
- 支持 Tag
- 预置大量探针
- 缓存、类加载器器、GC、CPU 利利⽤用率、线程池……
- 与 Spring 深度整合

**支持多种监控系统**

- Dimensional

  - AppOptics, Atlas, Azure Monitor, Cloudwatch, Datadog, Datadog StatsD, Dynatrace, Elastic, Humio, Influx, KairosDB, New Relic, Prometheus, SignalFx, Sysdig StatsD, Telegraf
    StatsD, Wavefront

- Hierarchical
  - Graphite, Ganglia, JMX, Etsy StatsD

### 一些核心度量指标

**核心接口**

- Meter

**内置实现**

- Gauge, TimeGauge
- Timer, LongTaskTimer, FunctionTimer
- Counter, FunctionCounter
- DistributionSummary

### Micrometer in Spring Boot 2.x

**一些 URL**

- `/actuator/metrics`
- `/actuator/prometheus`

**一些配置项**

- `management.metrics.export.*`
- `management.metrics.tags.*`
- `management.metrics.enable.*`
- `management.metrics.distribution.*`
- `management.metrics.web.server.auto-time-requests`

核心度量项

- JVM、CPU、文件句柄数、日志、启动时间

其他度量项

- Spring MVC、Spring WebFlux
- Tomcat、Jersey JAX-RS
- RestTemplate、WebClient
- 缓存、数据源、Hibernate
- Kafka、RabbitMQ

自定义度量指标

- 通过 MeterRegistry 注册 Meter
- 提供 MeterBinder Bean 让 Spring Boot ⾃自动绑定
- 通过 MeterFilter 进⾏行行定制

### 78 | 通过 Spring Boot Admin 了解程序的运行状态

### Spring Boot Admin

**目的**

- 为 Spring Boot 应用程序提供一套管理界面

**主要功能**

- 集中展示应用程序 Actuator 相关的内容
- 变更通知

### 快速上手

**服务端**

- `de.codecentric:spring-boot-admin-starter-server:2.1.3`
- `@EnableAdminServer`

**客户端**

- `de.codecentric:spring-boot-admin-starter-client:2.1.3`
- 配置服务端及 Endpoint
- `spring.boot.admin.client.url=http://localhost:8080`
- `management.endpoints.web.exposure.include=*`

### 安全控制

安全相关依赖

- spring-boot-starter-security

服务端配置

- spring.security.user.name
- spring.security.user.password

### 79 | 如何定制 Web 容器的运行参数

### 内嵌 Web 容器

可选容器列表

- `spring-boot-starter-tomcat`
- `spring-boot-starter-jetty`
- `spring-boot-starter-undertow`
- `spring-boot-starter-reactor-netty`

### 修改容器器配置

**端口**

- `server.port`
- `server.address`

**压缩**

- `server.compression.enabled`
- `server.compression.min-response-size`
- `server.compression.mime-types`

**Tomcat 特定配置**

- `server.tomcat.max-connections=10000`
- `server.tomcat.max-http-post-size=2MB`
- `server.tomcat.max-swallow-size=2MB`
- `server.tomcat.max-threads=200`
- `server.tomcat.min-spare-threads=10`

错误处理

- server.error.path=/error
- server.error.include-exception=false
- server.error.include-stacktrace=never
- server.error.whitelabel.enabled=true

其他

- server.use-forward-headers
- server.servlet.session.timeout

编程方式

- WebServerFactoryCustomizer<T>
- TomcatServletWebServerFactory
- JettyServletWebServerFactory
- UndertowServletWebServerFactory

### 80 | 如何配置容器支持 HTTP/2（上）

### 配置 HTTPS 支持

**通过参数进行配置**

- `server.port=8443`
- `server.ssl.*`
  - `server.ssl.key-store`
  - server.ssl.key-store-type，JKS 或者 PKCS12
  - `server.ssl.key-store-password=secret`

### 生成证书文件

**命令**

- keytool -genkey -alias 别名
  - -storetype 仓库类型 -keyalg 算法 -keysize 长度
  - -keystore 文件名 -validity 有效期

说明

- 仓库类型，JKS、JCEKS、PKCS12 等
- 算法，RSA、DSA 等
- 长度，例如 2048

### 客户端 HTTPS 支持

配置 HttpClient （ >= 4.4 ）

- SSLContextBuilder 构造 SSLContext
- setSSLHostnameVerifier(new NoopHostnameVerifier())

配置 RequestFactory

- HttpComponentsClientHttpRequestFactory
- setHttpClient()

### 81 | 如何配置容器支持 HTTP/2（下）

### 配置 HTTP/2 支持

前提条件

- Java >= JDK 9
- Tomcat >= 9.0.0
- Spring Boot 不支持 h2c，需要先配置 SSL

配置项

- server.http2.enabled

### 客户端 HTTP/2 支持

HTTP 库选择

- OkHttp（ com.squareup.okhttp3:okhttp:3.14.0 ）
- OkHttpClient

RestTemplate 配置

- OkHttp3ClientHttpRequestFactory

### 82 | 如何编写命令行运行的程序

### 关闭 Web 容器

控制依赖

- 不添加 Web 相关依赖

配置方式

- spring.main.web-application-type=none

编程方式

- SpringApplication
- setWebApplicationType()
- SpringApplicationBuilder
- web()
- 在调用 SpringApplication 的 run() 方法前设置 WebApplicationType

### 常用工具类

不同的 Runner

- ApplicationRunner
- 参数是 ApplicationArguments
- CommandLineRunner
- 参数是 String[]

返回码

- ExitCodeGenerator

### 83 | 了解可执行 Jar 背后的秘密

### 认识可执行 Jar

**其中包含**

- Jar 描述，`META-INF/MANIFEST.MF`
- Spring Boot Loader，org/springframework/boot/loader
- 项目内容，BOOT-INF/classes
- 项目依赖，BOOT-INF/lib

**其中不包含**

- JDK / JRE

### 如何找到程序的入口

**Jar 的启动类**

- `MANIFEST.MF`
- `Main-Class: org.springframework.boot.loader.JarLauncher`

**项目的主类**

- `@SpringApplication`
- `MANIFEST.MF`
- `Start-Class: xxx.yyy.zzz`

### 84 | 如何将 Spring Boot 应用打包成 Docker 镜像文件

### 什么是 Docker 镜像

- 镜像是静态的只读模板
- 镜像中包含构建 Docker 容器器的指令
- 镜像是分层的
- 通过 Dockerfile 来创建镜像

### Dockerfile

![](https://raw.githubusercontent.com/dunwu/images/dev/snap/20230806142644.png)

### 通过 Maven 构建 Docker 镜像

准备工作

- 提供一个 Dockerfile
- 配置 dockerfile-maven-plugin 插件

执行构建

- `mvn package`
- `mvn dockerfile:build`

检查结果

- `docker images`

### 85 | SpringBucks 实战项目进度小结

略

## 第十一章：Spring Cloud 及 Cloud Native 概述 (5 讲)

### 86 | 简单理解微服务

微服务就是一些协同工作的小而自治的服务。

微服务的优点

- 易于部署
- 与组织结构对齐
- 可组合性
- 可替代性

微服务的代价

- 架构复杂
- 运维复杂

### 87 | 如何理解云原生(Cloud Native)

云原生技术有利于各组织在公有云、私有云和混合云等新型动态环境中，构建和运行可弹性扩展的应用。

云原生应用要求

- DevOps
- 持续交付
- 微服务
- 容器

Cloud Native Computing Foundation，缩写 CNCF

### 88 | 12-Factor App（上）

### 89 | 12-Factor App（下）

12-Factor 为构建 SaaS 应用提供了方法论。

参考资料：https://12factor.net/zh_cn/

- 基准代码 - 一份基准代码，多份部署。解决方案：git

- 依赖 - 显式声明依赖关系。解决方案：maven、gradle

- 配置 - 在环境中存储配置。解决方案：apollo

- 后端服务 - 把后端服务当作附加资源

- 构建，发布，运行 - 严格分离构建和运行。解决方案：CI/CD（如：jenkins、sonar 等）

- 进程 - 以一个或多个无状态进程运行应用

- 端口绑定 - 通过端口绑定提供服务

- 并发 - 通过进程模型进行扩展

- 易处理 - 快速启动和优雅终止可最大化健壮性

- 开发环境与线上环境等价 - 尽可能的保持开发，预发布，线上环境相同

- 日志 - 把日志当作事件流

- 管理进程 - 后台管理任务当作一次性进程运行

### 90 | 认识 Spring Cloud 的组成部分

![](https://raw.githubusercontent.com/dunwu/images/dev/snap/20230729155944.svg)

Spring Cloud 的主要功能

- 服务发现
- 服务熔断
- 配置服务
- 服务安全
- 服务网关
- 分布式消息
- 分布式跟踪
- 各种云平台支持

## 第十二章：服务注册与发现 (9 讲)

### 91 | 使用 Eureka 作为服务注册中心

- **SpringCloud 启动包**
  - 服务端 - `spring-cloud-starter-netflix-eureka-server`
  - 客户端 - `spring-cloud-starter-netflix-eureka-client`
- **注解**
  - 服务端启动注解 - `@EnableEurekaServer`
  - 客户端启动注解
    - 通用注解 - `@EnableDiscoveryClient`
    - Eureka 特定注解 - `@EnableEurekaClient`
- **要点**
  - Eureka 默认端口 8761
- **配置**
  - `eureka.client.serviceUrl.defaultZone` - 注册地址，如 http://localhost:10001/eureka/
  - `eureka.client.register-with-eureka` - 是否将自己注册到 Eureka Server，默认为 true
  - `eureka.client.fetch-registry` - 是否从 Eureka Server 获取注册信息，默认为 true

### 92 | 使用 Spring Cloud Loadbalancer 访问服务

- 如何获得服务地址
  - `org.springframework.cloud.netflix.eureka.EurekaDiscoveryClient`
  - `org.springframework.cloud.client.discovery.DiscoveryClient` - 通用接口，推荐方式
- 负载均衡客户端
  - `@LoadBalanced`
  - 实际是通过 `ClientHttpRequestInterceptor` 实现的
  - `LoadBalancerInterceptor`
  - `LoadBalancerClient`
  - `RibbonLoadBalancerClient`

### 93 | 使用 Feign 访问服务

声明式 REST Web 服务客户端

- **SpringCloud 启动包**
  - spring-cloud-starter-openfeign
- **注解**
  - 启动注解 - `@EnableFeignClients`
  - 定义接口注解 - `@FeignClient`
- **配置** - `org.springframework.cloud.openfeign.FeignClientsConfiguration`

### 94 | 深入理解服务发现背后的 DiscoveryClient

- **服务端抽象接口** - `org.springframework.cloud.client.serviceregistry.ServiceRegistry`
  - `EurekaServiceRegistry`
  - `EurekaRegistration`
  - `EurekaAutoServiceRegistration`
  - `EurekaClientAutoConfiguration`
- **客户端抽象接口** - `org.springframework.cloud.client.discovery.DiscoveryClient`
  - `@EnableDiscoveryClient`
- **负载均衡抽象接口** - `org.springframework.cloud.client.loadbalancer.LoadBalancerClient`

### 95 | 使用 Zookeeper 作为服务注册中心

- **SpringCloud 启动包**
  - **spring-cloud-starter-zookeeper-discovery**
- **配置**
  - `ZookeeperAutoConfiguration`
  - `ZookeeperDiscoveryAutoConfiguration`

### 96 | 使用 Consul 作为服务注册中心

- **SpringCloud 启动包**
  - **spring-cloud-starter-consul-discovery**
- **配置**
  - `ConsulAutoConfiguration`

### 97 | 使用 Nacos 作为服务注册中心

- **SpringCloud 启动包**
  - **spring-cloud-starter-alibaba-nacos-discovery**
- **配置**
  - `NacosDiscoveryAutoConfiguration`

### 98 | 如何定制自己的 DiscoveryClient

**`DiscoveryClient`**

- `EurekaDiscoveryClient`
- `ZooKeeperDiscoveryClient`
- `ConsulDiscoveryClient`
- `NacosDiscoveryClient`

**`LoadBalancerClient`**

- `RibbonLoadBalancerClient`

**自定义 DiscoveryClient 步骤**

- 返回该 DiscoveryClient 能提供的服务名列表
- 返回指定服务对应的 ServiceInstance 列表
- 返回 DiscoveryClient 的顺序
- 返回 HealthIndicator 里显示的描述

自定义 RibbonClient 支持

- 实现 `ServerList<T extends Server>`
- Ribbon 提供了 AbstractServerList
- 提供一个配置类，声明 ServerList Bean 实例

### 99 | SpringBucks 实战项目进度小结

略

## 第十三章：服务熔断 (7 讲)

### 100 | 使用 Hystrix 实现服务熔断（上）

断路器模式

在断路器对象中封装受保护的方法调用

该对象监控调用和断路情况

调用失败触发阈值后，后序调用直接由断路器返回错误，不再执行实际调用

### 101 | 使用 Hystrix 实现服务熔断（下）

- **Hystrix 应用**

  - 注解
  - @HystrixCommand
    - fallbackMethod
    - commandProperties
      - @HystrixProperty

- **SpringCloud 启动包**
  - **spring-cloud-starter-netflix-hystrix**
- **注解**

  - `@EnableCircuitBreaker` - 断路器开启注解

- **Feign 支持**
  - `feign.hystrix.enabled=true`
  - `@FeignClient` 的 `fallback` / `fallbackFactory`
- **配置**
  - `HystrixCircuitBreakerAutoConfiguration`

### 102 | 如何观察服务熔断

Spring Cloud 对于熔断的监控支持

- Hystrix Metrics Stream
  - spring-boot-starter-actuator
  - `/actuator/hystrix.stream`
- Hystrix Dashboard
  - spring-cloud-starter-netflix-hystrix-dashboard
  - `@EnableHystrixDashboard`
  - `/hystirx`

**聚合集群熔断信息**

- **SpringCloud 启动包** - spring-cloud-starter-netflix-turbines
- **注解** - `@EnableTurbine`
- `/turbine/stream?cluster=集群名`

### 103 | 使用 Resilience4j 实现服务熔断

Hystrix 官方已经停止维护，因此建议选择其他产品来替代。例如：[Resilience4J](https://github.com/resilience4j/resilience4j)

- Resilience4J 实现
  - 基于 `ConcurrentHashMap` 的内存断路器
  - `CircuitBreakerRegistry`
  - `CircuitBreakerConfig`
- Resilience4J 依赖

  - resilience4j-spring-boot2

- 注解
  - @CircuitBreaker
- 配置
  - CircuitBreakerProperties

### 104 | 使用 Resilience4j 实现服务限流（上）

Bulkhead

- 目的
  - 防止下游依赖被并发请求冲击
  - 防止发生雪崩
- 用法
  - BulkheadRegistry / BulkheadConfig
  - @Bulkhead(name = "xxx")

### 105 | 使用 Resilience4j 实现服务限流（下）

RateLimit

- 目的
  - 限制特定时间内的执行次数
- 用法
  - `RateLimiterRegistry` / `RateLimiterConfig`
  - `@RateLimiter`
- 配置
- RateLimiterPropertis

### 106 | SpringBucks 实战项目进度小结

略

## 第十四章：服务配置 (7 讲)

### 107 | 基于 Git 的配置中心（上）

目的

提供针对外置配置的 HTTP API

- **SpringCloud 启动包** - spring-cloud-config-server
- **注解** - `@EnableConfigServer`

### 108 | 基于 Git 的配置中心（下）

### 109 | 基于 Zookeeper 的配置中心

### 110 | 深入理解 Spring Cloud 的配置抽象

实现

- 类似于 Spring 的 Environment 和 PropertySource
- 在上下文中增加 Spring Cloud Config 的 PropertySource

PropertySource 子类

- `ZooKeeperPropertySource`
- `ConsulPropertySource`
- `ConsulFilePropertySource`

PropertySourceLocator

EnvironmentRepositry

配置刷新

- /actuator/refresh
- Spring Cloud Bus - RegfreshRemoteApplicationEvent

ZooKeeperConfigBootstrapConfiguration

ZooKeeperConfigAutoConfiguration

### 111 | 基于 Consul 的配置中心

**SpringCloud 启动包** - spring-cloud-starter-consual-config

**配置文件** - bootstrap.propertis | yml

### 112 | 基于 Nacos 的配置中心

**SpringCloud 启动包** - spring-cloud-starter-alibaba-nacos-config

**配置文件** - bootstrap.propertis | yml

### 113 | SpringBucks 实战项目进度小结

略

## 第十五章：Spring Cloud Stream (4 讲)

### 114 | 认识 Spring Cloud Stream

Spring Cloud Stream 是一款用于构建消息驱动的微服务应用程序的轻量级框架。

特性

- 声明式编程模型
- 引入多种概念抽象：发布订阅、消费组、分区
- 支持多种消息中间件：RabbitMQ、Kafka

概念

- Binding
  - 生产者、消费者与 MQ 之间的桥梁
  - @EnableBinding
  - @Input /SubscribableChannel
  - @Output / MessageChannel
- 消费组
- 分区

生产消息

- 使用 MessageChannel 的 send()
- @SendTo

消费消息

- @StreamListener
- @Payload / @Headers / @Header

### 115 | 通过 Spring Cloud Stream 访问 RabbitMQ

**SpringCloud 启动包** - spring-cloud-starter-stream-rabbit

**SpringBoot 启动包** - spring-boot-starter-amqp

**配置**

org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration

### 116 | 通过 Spring Cloud Stream 访问 Kafka

**SpringCloud 启动包** - spring-cloud-starter-stream-kafka

**配置** - org.springframework.boot.autoconfigure.kafka.KafkaAutoConfiguration

Spring 定时任务

- TaskScheduler / Trigger / TriggerContext
- 配置定时任务
  - `@EnableScheduling`
  - `<task:scheduler />`
  - `@Scheduled`

Spring 事件机制

- ApplicationEvent
- 发送事件
  - ApplicationEventPublisher
  - ApplicationEventPublisherAware
- 监听事件
  - `ApplicationListener<T>`
  - `@EventListener`

### 117 | SpringBucks 实战项目进度小结

略

## 第十六章：服务链路追踪 (6 讲)

### 118 | 通过 Dapper 理解链路治理

略

### 119 | 使用 Spring Cloud Sleuth 实现链路追踪

**SpringCloud 启动包** - spring-cloud-starter-sleuth、spring-cloud-starter-zipkin

### 120 | 如何追踪消息链路

略

### 121 | 除了链路还要治理什么

略

### 122 | SpringBucks 实战项目进度小结

略

## 参考资料

- [玩转 Spring 全家桶](https://time.geekbang.org/course/intro/156)
