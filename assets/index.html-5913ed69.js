import{_ as u}from"./plugin-vue_export-helper-c27b6911.js";import{r as i,o as k,c as r,a as n,b as s,d as a,w as t,e as p}from"./app-0e67a029.js";const d={},m=p(`<h1 id="java-å¹¶å‘ä¹‹æ— é”" tabindex="-1"><a class="header-anchor" href="#java-å¹¶å‘ä¹‹æ— é”" aria-hidden="true">#</a> Java å¹¶å‘ä¹‹æ— é”</h1><p>å¹¶å‘å®‰å…¨éœ€è¦ä¿è¯å‡ ä¸ªåŸºæœ¬ç‰¹æ€§ï¼š</p><ul><li><strong>å¯è§æ€§</strong> - æ˜¯ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†æŸä¸ªå…±äº«å˜é‡ï¼Œå…¶çŠ¶æ€èƒ½å¤Ÿç«‹å³è¢«å…¶ä»–çº¿ç¨‹çŸ¥æ™“ï¼Œé€šå¸¸è¢«è§£é‡Šä¸ºå°†çº¿ç¨‹æœ¬åœ°çŠ¶æ€åæ˜ åˆ°ä¸»å†…å­˜ä¸Šï¼Œ<code>volatile</code> å°±æ˜¯è´Ÿè´£ä¿è¯å¯è§æ€§çš„ã€‚</li><li><strong>æœ‰åºæ€§</strong> - æ˜¯ä¿è¯çº¿ç¨‹å†…ä¸²è¡Œè¯­ä¹‰ï¼Œé¿å…æŒ‡ä»¤é‡æ’ç­‰ã€‚</li><li><strong>åŸå­æ€§</strong> - ç®€å•è¯´å°±æ˜¯ç›¸å…³æ“ä½œä¸ä¼šä¸­é€”è¢«å…¶ä»–çº¿ç¨‹å¹²æ‰°ï¼Œä¸€èˆ¬é€šè¿‡äº’æ–¥æœºåˆ¶ï¼ˆåŠ é”ï¼š<code>sychronized</code>ã€<code>Lock</code>ï¼‰å®ç°ã€‚</li></ul><p>äº’æ–¥åŒæ­¥æ˜¯æœ€å¸¸è§çš„åŸå­æ€§ä¿éšœæ‰‹æ®µã€‚<strong>äº’æ–¥åŒæ­¥æœ€ä¸»è¦çš„é—®é¢˜æ˜¯çº¿ç¨‹é˜»å¡å’Œå”¤é†’æ‰€å¸¦æ¥çš„æ€§èƒ½é—®é¢˜</strong>ã€‚å› æ­¤ï¼Œäº’æ–¥åŒæ­¥ä¹Ÿè¢«ç§°ä¸ºé˜»å¡åŒæ­¥ã€‚äº’æ–¥åŒæ­¥å±äºä¸€ç§æ‚²è§‚çš„å¹¶å‘ç­–ç•¥ï¼Œæ€»æ˜¯è®¤ä¸ºåªè¦ä¸å»åšæ­£ç¡®çš„åŒæ­¥æªæ–½ï¼Œé‚£å°±è‚¯å®šä¼šå‡ºç°é—®é¢˜ã€‚æ— è®ºå…±äº«æ•°æ®æ˜¯å¦çœŸçš„ä¼šå‡ºç°ç«äº‰ï¼Œå®ƒéƒ½è¦è¿›è¡ŒåŠ é”ï¼ˆè¿™é‡Œè®¨è®ºçš„æ˜¯æ¦‚å¿µæ¨¡å‹ï¼Œå®é™…ä¸Šè™šæ‹Ÿæœºä¼šä¼˜åŒ–æ‰å¾ˆå¤§ä¸€éƒ¨åˆ†ä¸å¿…è¦çš„åŠ é”ï¼‰ã€ç”¨æˆ·æ€æ ¸å¿ƒæ€è½¬æ¢ã€ç»´æŠ¤é”è®¡æ•°å™¨å’Œæ£€æŸ¥æ˜¯å¦æœ‰è¢«é˜»å¡çš„çº¿ç¨‹éœ€è¦å”¤é†’ç­‰æ“ä½œã€‚</p><p>è§£å†³å¹¶å‘å®‰å…¨é—®é¢˜ï¼Œè¿˜å¯ä»¥é‡‡ç”¨æ— é”æ–¹æ¡ˆã€‚æ— é”æ–¹æ¡ˆç›¸å¯¹äº’æ–¥é”æ–¹æ¡ˆï¼Œæœ€å¤§çš„å¥½å¤„å°±æ˜¯æ€§èƒ½ã€‚äº’æ–¥é”æ–¹æ¡ˆä¸ºäº†ä¿è¯äº’æ–¥æ€§ï¼Œéœ€è¦æ‰§è¡ŒåŠ é”ã€è§£é”æ“ä½œï¼Œè€ŒåŠ é”ã€è§£é”æ“ä½œæœ¬èº«å°±æ¶ˆè€—æ€§èƒ½ï¼›åŒæ—¶æ‹¿ä¸åˆ°é”çš„çº¿ç¨‹è¿˜ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œè¿›è€Œè§¦å‘çº¿ç¨‹åˆ‡æ¢ï¼Œçº¿ç¨‹åˆ‡æ¢å¯¹æ€§èƒ½çš„æ¶ˆè€—ä¹Ÿå¾ˆå¤§ã€‚ ç›¸æ¯”ä¹‹ä¸‹ï¼Œæ— é”æ–¹æ¡ˆåˆ™å®Œå…¨æ²¡æœ‰åŠ é”ã€è§£é”çš„æ€§èƒ½æ¶ˆè€—ï¼ŒåŒæ—¶è¿˜èƒ½ä¿è¯äº’æ–¥æ€§ã€‚</p><p>Java ä¸­çš„æ— é”æŠ€æœ¯æœ‰ï¼š</p><ul><li>CAS</li><li>åŸå­ç±»</li><li>ThreadLocal</li><li>Copy-on-Write</li><li>ä¸å˜æ¨¡å¼</li></ul><h2 id="cas" tabindex="-1"><a class="header-anchor" href="#cas" aria-hidden="true">#</a> CAS</h2><h3 id="cas-çš„è¦ç‚¹" tabindex="-1"><a class="header-anchor" href="#cas-çš„è¦ç‚¹" aria-hidden="true">#</a> CAS çš„è¦ç‚¹</h3><p><strong>CASï¼ˆCompare and Swapï¼‰ï¼Œå­—é¢æ„æ€ä¸ºæ¯”è¾ƒå¹¶äº¤æ¢ã€‚</strong></p><p>CAS æ¶‰åŠä¸‰ä¸ªæ“ä½œæ•°ï¼š</p><ul><li>Vï¼šéœ€è¦è¯»å†™çš„å†…å­˜ä½ç½®</li><li>Aï¼šè¿›è¡Œæ¯”è¾ƒçš„å€¼</li><li>Bï¼šæ‹Ÿå†™å…¥çš„æ–°å€¼</li></ul><p><strong>å½“ä¸”ä»…å½“ V çš„å€¼ç­‰äº A æ—¶ï¼Œæ‰ä¼šé€šè¿‡åŸå­æ–¹å¼ç”¨æ–°å€¼ B æ¥æ›´æ–° A çš„å€¼ï¼Œå¦åˆ™ä»€ä¹ˆéƒ½ä¸åš</strong>ã€‚</p><p>CAS å®é™…æ˜¯ä¹è§‚é”çš„ä¸€ç§å®ç°æ–¹å¼ï¼Œå› æ­¤ï¼Œ<strong>CAS åªé€‚ç”¨äºçº¿ç¨‹å†²çªè¾ƒå°‘çš„æƒ…å†µ</strong>ã€‚</p><h3 id="cas-çš„åº”ç”¨" tabindex="-1"><a class="header-anchor" href="#cas-çš„åº”ç”¨" aria-hidden="true">#</a> CAS çš„åº”ç”¨</h3><p>CAS çš„å…¸å‹åº”ç”¨åœºæ™¯æ˜¯ï¼š</p><ul><li>åŸå­ç±»</li><li>è‡ªæ—‹é”</li></ul><h4 id="åŸå­ç±»" tabindex="-1"><a class="header-anchor" href="#åŸå­ç±»" aria-hidden="true">#</a> åŸå­ç±»</h4><blockquote><p>åŸå­ç±»æ˜¯ CAS åœ¨ Java ä¸­æœ€å…¸å‹çš„åº”ç”¨ã€‚</p></blockquote><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªå¸¸è§çš„ä»£ç ç‰‡æ®µã€‚</p><div class="language-Java line-numbers-mode" data-ext="Java"><pre class="language-Java"><code>if(a==b) {
    a++;
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœ <code>a++</code> æ‰§è¡Œå‰ï¼Œ a çš„å€¼è¢«ä¿®æ”¹äº†æ€ä¹ˆåŠï¼Ÿè¿˜èƒ½å¾—åˆ°é¢„æœŸå€¼å—ï¼Ÿå‡ºç°è¯¥é—®é¢˜çš„åŸå› æ˜¯åœ¨å¹¶å‘ç¯å¢ƒä¸‹ï¼Œä»¥ä¸Šä»£ç ç‰‡æ®µä¸æ˜¯åŸå­æ“ä½œï¼Œéšæ—¶å¯èƒ½è¢«å…¶ä»–çº¿ç¨‹æ‰€ç¯¡æ”¹ã€‚</p><p>è§£å†³è¿™ç§é—®é¢˜çš„æœ€ç»å…¸æ–¹å¼æ˜¯åº”ç”¨åŸå­ç±»çš„ <code>incrementAndGet</code> æ–¹æ³•ã€‚</p><div class="language-Java line-numbers-mode" data-ext="Java"><pre class="language-Java"><code>public class AtomicIntegerDemo {

    public static void main(String[] args) throws InterruptedException {
        ExecutorService executorService = Executors.newFixedThreadPool(3);
        final AtomicInteger count = new AtomicInteger(0);
        for (int i = 0; i &lt; 10; i++) {
            executorService.execute(new Runnable() {
                @Override
                public void run() {
                    count.incrementAndGet();
                }
            });
        }

        executorService.shutdown();
        executorService.awaitTermination(3, TimeUnit.SECONDS);
        System.out.println(&quot;Final Count is : &quot; + count.get());
    }

}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>J.U.C åŒ…ä¸­æä¾›äº† <code>AtomicBoolean</code>ã€<code>AtomicInteger</code>ã€<code>AtomicLong</code> åˆ†åˆ«é’ˆå¯¹ <code>Boolean</code>ã€<code>Integer</code>ã€<code>Long</code> æ‰§è¡ŒåŸå­æ“ä½œï¼Œæ“ä½œå’Œä¸Šé¢çš„ç¤ºä¾‹å¤§ä½“ç›¸ä¼¼ï¼Œä¸åšèµ˜è¿°ã€‚</p><h4 id="è‡ªæ—‹é”" tabindex="-1"><a class="header-anchor" href="#è‡ªæ—‹é”" aria-hidden="true">#</a> è‡ªæ—‹é”</h4><p>åˆ©ç”¨åŸå­ç±»ï¼ˆæœ¬è´¨ä¸Šæ˜¯ CASï¼‰ï¼Œå¯ä»¥å®ç°è‡ªæ—‹é”ã€‚</p><p>æ‰€è°“è‡ªæ—‹é”ï¼Œæ˜¯æŒ‡çº¿ç¨‹åå¤æ£€æŸ¥é”å˜é‡æ˜¯å¦å¯ç”¨ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚ç”±äºçº¿ç¨‹åœ¨è¿™ä¸€è¿‡ç¨‹ä¸­ä¿æŒæ‰§è¡Œï¼Œå› æ­¤æ˜¯ä¸€ç§å¿™ç­‰å¾…ã€‚ä¸€æ—¦è·å–äº†è‡ªæ—‹é”ï¼Œçº¿ç¨‹ä¼šä¸€ç›´ä¿æŒè¯¥é”ï¼Œç›´è‡³æ˜¾å¼é‡Šæ”¾è‡ªæ—‹é”ã€‚</p><p>ç¤ºä¾‹ï¼šéçº¿ç¨‹å®‰å…¨ç¤ºä¾‹</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicReferenceDemo</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>ticket <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; å–å‡ºäº†ç¬¬ &quot;</span> <span class="token operator">+</span> ticket <span class="token operator">+</span> <span class="token string">&quot; å¼ ç¥¨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ticket<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¾“å‡ºç»“æœï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>pool-1-thread-2 å–å‡ºäº†ç¬¬ 10 å¼ ç¥¨
pool-1-thread-1 å–å‡ºäº†ç¬¬ 10 å¼ ç¥¨
pool-1-thread-3 å–å‡ºäº†ç¬¬ 10 å¼ ç¥¨
pool-1-thread-1 å–å‡ºäº†ç¬¬ 8 å¼ ç¥¨
pool-1-thread-2 å–å‡ºäº†ç¬¬ 9 å¼ ç¥¨
pool-1-thread-1 å–å‡ºäº†ç¬¬ 6 å¼ ç¥¨
pool-1-thread-3 å–å‡ºäº†ç¬¬ 7 å¼ ç¥¨
pool-1-thread-1 å–å‡ºäº†ç¬¬ 4 å¼ ç¥¨
pool-1-thread-2 å–å‡ºäº†ç¬¬ 5 å¼ ç¥¨
pool-1-thread-1 å–å‡ºäº†ç¬¬ 2 å¼ ç¥¨
pool-1-thread-3 å–å‡ºäº†ç¬¬ 3 å¼ ç¥¨
pool-1-thread-2 å–å‡ºäº†ç¬¬ 1 å¼ ç¥¨
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¾ˆæ˜æ˜¾ï¼Œå‡ºç°äº†é‡å¤å”®ç¥¨çš„æƒ…å†µã€‚</p><p>ã€ç¤ºä¾‹ã€‘ä½¿ç”¨è‡ªæ—‹é”æ¥ä¿è¯çº¿ç¨‹å®‰å…¨</p><p>å¯ä»¥é€šè¿‡è‡ªæ—‹é”è¿™ç§éé˜»å¡åŒæ­¥æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä¸‹é¢ä½¿ç”¨ <code>AtomicReference</code> æ¥å®ç°ä¸€ä¸ªè‡ªæ—‹é”ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicReferenceDemo2</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">threadSafeDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">threadSafeDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpinLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpinLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SpinLock</span> <span class="token punctuation">{</span>

        <span class="token keyword">private</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> atomicReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

        <span class="token keyword">private</span> <span class="token class-name">SpinLock</span> lock<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token class-name">SpinLock</span> lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>lock <span class="token operator">=</span> lock<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>ticket <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; å–å‡ºäº†ç¬¬ &quot;</span> <span class="token operator">+</span> ticket <span class="token operator">+</span> <span class="token string">&quot; å¼ ç¥¨&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    ticket<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¾“å‡ºç»“æœï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>pool-1-thread-2 å–å‡ºäº†ç¬¬ 10 å¼ ç¥¨
pool-1-thread-1 å–å‡ºäº†ç¬¬ 9 å¼ ç¥¨
pool-1-thread-3 å–å‡ºäº†ç¬¬ 8 å¼ ç¥¨
pool-1-thread-2 å–å‡ºäº†ç¬¬ 7 å¼ ç¥¨
pool-1-thread-3 å–å‡ºäº†ç¬¬ 6 å¼ ç¥¨
pool-1-thread-1 å–å‡ºäº†ç¬¬ 5 å¼ ç¥¨
pool-1-thread-2 å–å‡ºäº†ç¬¬ 4 å¼ ç¥¨
pool-1-thread-1 å–å‡ºäº†ç¬¬ 3 å¼ ç¥¨
pool-1-thread-3 å–å‡ºäº†ç¬¬ 2 å¼ ç¥¨
pool-1-thread-1 å–å‡ºäº†ç¬¬ 1 å¼ ç¥¨
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="cas-çš„åŸç†" tabindex="-1"><a class="header-anchor" href="#cas-çš„åŸç†" aria-hidden="true">#</a> CAS çš„åŸç†</h3><p><strong>åœ¨ Java ä¸­ï¼Œä¸»è¦åˆ©ç”¨ <code>Unsafe</code> è¿™ä¸ªç±»å®ç° CAS</strong>ã€‚</p><p><code>Unsafe</code> ç±»ä½äº <code>sun.misc</code> åŒ…ä¸‹ï¼Œæ˜¯ä¸€ä¸ªæä¾›ä½çº§åˆ«ã€ä¸å®‰å…¨æ“ä½œçš„ç±»ã€‚ç”±äºå…¶å¼ºå¤§çš„åŠŸèƒ½å’Œæ½œåœ¨çš„å±é™©æ€§ï¼Œå®ƒé€šå¸¸ç”¨äº JVM å†…éƒ¨æˆ–ä¸€äº›éœ€è¦æé«˜æ€§èƒ½å’Œåº•å±‚è®¿é—®çš„åº“ä¸­ï¼Œè€Œä¸æ¨èæ™®é€šå¼€å‘è€…åœ¨åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ã€‚</p><p><code>Unsafe</code> ç±»æä¾›äº† <code>compareAndSwapObject</code>ã€<code>compareAndSwapInt</code>ã€<code>compareAndSwapLong</code>æ–¹æ³•æ¥å®ç°çš„å¯¹ <code>Object</code>ã€<code>int</code>ã€<code>long </code> ç±»å‹çš„ CAS æ“ä½œï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * ä»¥åŸå­æ–¹å¼æ›´æ–°å¯¹è±¡å­—æ®µçš„å€¼ã€‚
 */</span>
<span class="token keyword">boolean</span> <span class="token function">compareAndSwapObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span> <span class="token class-name">Object</span> expected<span class="token punctuation">,</span> <span class="token class-name">Object</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * ä»¥åŸå­æ–¹å¼æ›´æ–° int ç±»å‹çš„å¯¹è±¡å­—æ®µçš„å€¼ã€‚
 */</span>
<span class="token keyword">boolean</span> <span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> expected<span class="token punctuation">,</span> <span class="token keyword">int</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * ä»¥åŸå­æ–¹å¼æ›´æ–° long ç±»å‹çš„å¯¹è±¡å­—æ®µçš„å€¼ã€‚
 */</span>
<span class="token keyword">boolean</span> <span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span> <span class="token keyword">long</span> expected<span class="token punctuation">,</span> <span class="token keyword">long</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Unsafe</code> ç±»ä¸­çš„ CAS æ–¹æ³•æ˜¯ <code>native</code> æ–¹æ³•ã€‚<code>native </code>å…³é”®å­—è¡¨æ˜è¿™äº›æ–¹æ³•æ˜¯ç”¨æœ¬åœ°ä»£ç ï¼ˆé€šå¸¸æ˜¯ C æˆ– C++ï¼‰å®ç°çš„ï¼Œè€Œä¸æ˜¯ç”¨ Java å®ç°çš„ã€‚è¿™äº›æ–¹æ³•ç›´æ¥è°ƒç”¨åº•å±‚çš„ã€å…·æœ‰åŸå­æ€§çš„ CPU æŒ‡ä»¤æ¥å®ç°ã€‚</p><p>ç”±äº CAS æ“ä½œå¯èƒ½ä¼šå› ä¸ºå¹¶å‘å†²çªè€Œå¤±è´¥ï¼Œå› æ­¤é€šå¸¸ä¼šä¼´éšç€è‡ªæ—‹ï¼Œè€Œæ‰€è°“è‡ªæ—‹ï¼Œå…¶å®å°±æ˜¯å¾ªç¯å°è¯•ã€‚</p><p><code>Unsafe#getAndAddInt</code> æºç ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// åŸå­åœ°è·å–å¹¶å¢åŠ æ•´æ•°å€¼</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndAddInt</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> delta<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> v<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">// ä»¥ volatile æ–¹å¼è·å–å¯¹è±¡ o åœ¨å†…å­˜åç§»é‡ offset å¤„çš„æ•´æ•°å€¼</span>
        v <span class="token operator">=</span> <span class="token function">getIntVolatile</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> v<span class="token punctuation">,</span> v <span class="token operator">+</span> delta<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è¿”å›æ—§å€¼</span>
    <span class="token keyword">return</span> v<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="cas-çš„é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#cas-çš„é—®é¢˜" aria-hidden="true">#</a> CAS çš„é—®é¢˜</h3><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ<strong>CAS æ¯”é”æ€§èƒ½æ›´é«˜</strong>ã€‚å› ä¸º CAS æ˜¯ä¸€ç§éé˜»å¡ç®—æ³•ï¼Œæ‰€ä»¥å…¶é¿å…äº†çº¿ç¨‹é˜»å¡å’Œå”¤é†’çš„ç­‰å¾…æ—¶é—´ã€‚ä½†æ˜¯ï¼Œäº‹ç‰©æ€»ä¼šæœ‰åˆ©æœ‰å¼Šï¼ŒCAS ä¹Ÿå­˜åœ¨ä¸‰å¤§é—®é¢˜ï¼š</p><ul><li><strong>ABA é—®é¢˜</strong></li><li><strong>å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§</strong></li><li><strong>åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ€§</strong></li></ul><h4 id="aba-é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#aba-é—®é¢˜" aria-hidden="true">#</a> ABA é—®é¢˜</h4><p>å¦‚æœä¸€ä¸ªå˜é‡åˆæ¬¡è¯»å–çš„æ—¶å€™æ˜¯ A å€¼ï¼Œå®ƒçš„å€¼è¢«æ”¹æˆäº† Bï¼Œåæ¥åˆè¢«æ”¹å›ä¸º Aï¼Œé‚£ CAS æ“ä½œå°±ä¼šè¯¯è®¤ä¸ºå®ƒä»æ¥æ²¡æœ‰è¢«æ”¹å˜è¿‡ï¼Œè¿™å°±æ˜¯ <strong>ABA é—®é¢˜</strong>ã€‚</p><p>ABA é—®é¢˜çš„è§£å†³æ€è·¯æ˜¯åœ¨å˜é‡å‰é¢è¿½åŠ ä¸Š<strong>ç‰ˆæœ¬å·æˆ–è€…æ—¶é—´æˆ³</strong>ã€‚J.U.C åŒ…æä¾›äº†ä¸€ä¸ªå¸¦æœ‰æ ‡è®°çš„<strong>åŸå­å¼•ç”¨ç±» <code>AtomicStampedReference</code> æ¥è§£å†³è¿™ä¸ªé—®é¢˜</strong>ï¼Œå®ƒå¯ä»¥é€šè¿‡æ§åˆ¶å˜é‡å€¼çš„ç‰ˆæœ¬æ¥ä¿è¯ CAS çš„æ­£ç¡®æ€§ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ ABA é—®é¢˜ä¸ä¼šå½±å“ç¨‹åºå¹¶å‘çš„æ­£ç¡®æ€§ï¼Œå¦‚æœéœ€è¦è§£å†³ ABA é—®é¢˜ï¼Œæ”¹ç”¨<strong>ä¼ ç»Ÿçš„äº’æ–¥åŒæ­¥å¯èƒ½ä¼šæ¯”åŸå­ç±»æ›´é«˜æ•ˆ</strong>ã€‚</p><h4 id="å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§" tabindex="-1"><a class="header-anchor" href="#å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§" aria-hidden="true">#</a> å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§</h4><p><strong>è‡ªæ—‹ CAS ï¼ˆä¸æ–­å°è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ï¼‰å¦‚æœé•¿æ—¶é—´ä¸æˆåŠŸï¼Œä¼šç»™ CPU å¸¦æ¥éå¸¸å¤§çš„æ‰§è¡Œå¼€é”€</strong>ã€‚</p><p>å¦‚æœ JVM èƒ½æ”¯æŒå¤„ç†å™¨æä¾›çš„ <code>pause</code> æŒ‡ä»¤é‚£ä¹ˆæ•ˆç‡ä¼šæœ‰ä¸€å®šçš„æå‡ï¼Œ<code>pause</code> æŒ‡ä»¤æœ‰ä¸¤ä¸ªä½œç”¨ï¼š</p><ul><li>å®ƒå¯ä»¥å»¶è¿Ÿæµæ°´çº¿æ‰§è¡ŒæŒ‡ä»¤ï¼ˆde-pipelineï¼‰, ä½¿ CPU ä¸ä¼šæ¶ˆè€—è¿‡å¤šçš„æ‰§è¡Œèµ„æºï¼Œå»¶è¿Ÿçš„æ—¶é—´å–å†³äºå…·ä½“å®ç°çš„ç‰ˆæœ¬ï¼Œåœ¨ä¸€äº›å¤„ç†å™¨ä¸Šå»¶è¿Ÿæ—¶é—´æ˜¯é›¶ã€‚</li><li>å®ƒå¯ä»¥é¿å…åœ¨é€€å‡ºå¾ªç¯çš„æ—¶å€™å› å†…å­˜é¡ºåºå†²çªï¼ˆmemory order violationï¼‰è€Œå¼•èµ· CPU æµæ°´çº¿è¢«æ¸…ç©ºï¼ˆCPU pipeline flushï¼‰ï¼Œä»è€Œæé«˜ CPU çš„æ‰§è¡Œæ•ˆç‡ã€‚</li></ul><p>æ¯”è¾ƒèŠ±è´¹ CPU èµ„æºï¼Œå³ä½¿æ²¡æœ‰ä»»ä½•ç”¨ä¹Ÿä¼šåšä¸€äº›æ— ç”¨åŠŸã€‚</p><h4 id="åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ€§" tabindex="-1"><a class="header-anchor" href="#åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ€§" aria-hidden="true">#</a> åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ€§</h4><p>å½“å¯¹ä¸€ä¸ªå…±äº«å˜é‡æ‰§è¡Œæ“ä½œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¾ªç¯ CAS çš„æ–¹å¼æ¥ä¿è¯åŸå­æ“ä½œï¼Œä½†æ˜¯å¯¹å¤šä¸ªå…±äº«å˜é‡æ“ä½œæ—¶ï¼Œå¾ªç¯ CAS å°±æ— æ³•ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç”¨é”ã€‚</p><p>æˆ–è€…æœ‰ä¸€ä¸ªå–å·§çš„åŠæ³•ï¼Œå°±æ˜¯æŠŠå¤šä¸ªå…±äº«å˜é‡åˆå¹¶æˆä¸€ä¸ªå…±äº«å˜é‡æ¥æ“ä½œã€‚æ¯”å¦‚æœ‰ä¸¤ä¸ªå…±äº«å˜é‡ <code>i ï¼ 2, j = a</code>ï¼Œåˆå¹¶ä¸€ä¸‹ <code>ij=2a</code>ï¼Œç„¶åç”¨ CAS æ¥æ“ä½œ <code>ij</code>ã€‚ä» Java 1.5 å¼€å§‹ JDK æä¾›äº† <code>AtomicReference</code> ç±»æ¥ä¿è¯å¼•ç”¨å¯¹è±¡ä¹‹é—´çš„åŸå­æ€§ï¼Œä½ å¯ä»¥æŠŠå¤šä¸ªå˜é‡æ”¾åœ¨ä¸€ä¸ªå¯¹è±¡é‡Œæ¥è¿›è¡Œ CAS æ“ä½œã€‚</p><h2 id="åŸå­ç±»-1" tabindex="-1"><a class="header-anchor" href="#åŸå­ç±»-1" aria-hidden="true">#</a> åŸå­ç±»</h2><h3 id="åŸå­ç±»ç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#åŸå­ç±»ç®€ä»‹" aria-hidden="true">#</a> åŸå­ç±»ç®€ä»‹</h3><p>åŸå­æ€§æ˜¯ç¡®ä¿å¹¶å‘å®‰å…¨ä¸‰å¤§ç‰¹æ€§ä¹‹ä¸€ã€‚ä¸ºäº†å…¼é¡¾åŸå­æ€§ä»¥åŠé”å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ï¼ŒJava å¼•å…¥äº† CAS ï¼ˆä¸»è¦ä½“ç°åœ¨ <code>Unsafe</code> ç±»ï¼‰æ¥å®ç°éé˜»å¡åŒæ­¥ï¼ˆä¹Ÿå«ä¹è§‚é”ï¼‰ï¼ŒCAS åº•å±‚åŸºäº CPU æŒ‡ä»¤ï¼ˆç¡¬ä»¶æ”¯æŒï¼‰æ”¯æŒï¼Œå…·æœ‰åŸå­æ€§ã€‚å¹¶åŸºäº CAS ï¼Œæä¾›äº†ä¸€å¥—åŸå­å·¥å…·ç±»ã€‚</p><p>åŸå­ç±»<strong>æ¯”é”çš„ç²’åº¦æ›´ç»†ï¼Œæ›´è½»é‡çº§</strong>ï¼Œå¹¶ä¸”å¯¹äºåœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šå®ç°é«˜æ€§èƒ½çš„å¹¶å‘ä»£ç æ¥è¯´æ˜¯éå¸¸å…³é”®çš„ã€‚åŸå­å˜é‡å°†å‘ç”Ÿç«äº‰çš„èŒƒå›´ç¼©å°åˆ°å•ä¸ªå˜é‡ä¸Šã€‚</p><p>åŸå­ç±»ç›¸å½“äºä¸€ç§æ³›åŒ–çš„ <code>volatile</code> å˜é‡ï¼Œèƒ½å¤Ÿ<strong>æ”¯æŒåŸå­çš„ã€æœ‰æ¡ä»¶çš„è¯»/æ”¹/å†™æ“</strong>ä½œã€‚</p><p>åŸå­ç±»å¯ä»¥åˆ†ä¸º 5 ä¸ªç±»åˆ«ï¼Œè¿™ 5 ä¸ªç±»åˆ«æä¾›çš„æ–¹æ³•åŸºæœ¬ä¸Šæ˜¯ç›¸ä¼¼çš„ï¼š</p><ul><li><strong>åŸºæœ¬æ•°æ®ç±»å‹</strong><ul><li><code>AtomicBoolean</code> - å¸ƒå°”ç±»å‹åŸå­ç±»</li><li><code>AtomicInteger</code> - æ•´å‹åŸå­ç±»</li><li><code>AtomicLong</code> - é•¿æ•´å‹åŸå­ç±»</li></ul></li><li><strong>å¼•ç”¨æ•°æ®ç±»å‹</strong><ul><li><code>AtomicReference</code> - å¼•ç”¨ç±»å‹åŸå­ç±»</li><li><code>AtomicMarkableReference</code> - å¸¦æœ‰æ ‡è®°ä½çš„å¼•ç”¨ç±»å‹åŸå­ç±»</li><li><code>AtomicStampedReference</code> - å¸¦æœ‰ç‰ˆæœ¬å·çš„å¼•ç”¨ç±»å‹åŸå­ç±»</li></ul></li><li><strong>æ•°ç»„æ•°æ®ç±»å‹</strong><ul><li><code>AtomicIntegerArray</code> - æ•´å½¢æ•°ç»„åŸå­ç±»</li><li><code>AtomicLongArray</code> - é•¿æ•´å‹æ•°ç»„åŸå­ç±»</li><li><code>AtomicReferenceArray</code> - å¼•ç”¨ç±»å‹æ•°ç»„åŸå­ç±»</li></ul></li><li><strong>å±æ€§æ›´æ–°å™¨ç±»å‹</strong><ul><li><code>AtomicIntegerFieldUpdater</code> - æ•´å‹å­—æ®µçš„åŸå­æ›´æ–°å™¨</li><li><code>AtomicLongFieldUpdater</code> - é•¿æ•´å‹å­—æ®µçš„åŸå­æ›´æ–°å™¨</li><li><code>AtomicReferenceFieldUpdater</code> - åŸå­æ›´æ–°å¼•ç”¨ç±»å‹é‡Œçš„å­—æ®µ</li></ul></li><li>ç´¯åŠ å™¨ <ul><li><code>DoubleAdder</code> - æµ®ç‚¹å‹åŸå­ç´¯åŠ å™¨</li><li><code>LongAdder</code> - é•¿æ•´å‹åŸå­ç´¯åŠ å™¨</li><li><code>DoubleAccumulator</code> - æ›´å¤æ‚çš„æµ®ç‚¹å‹åŸå­ç´¯åŠ å™¨</li><li><code>LongAccumulator</code> - æ›´å¤æ‚çš„é•¿æ•´å‹åŸå­ç´¯åŠ å™¨</li></ul></li></ul><h3 id="åŸå­ç±»ä¹‹åŸºæœ¬æ•°æ®ç±»å‹" tabindex="-1"><a class="header-anchor" href="#åŸå­ç±»ä¹‹åŸºæœ¬æ•°æ®ç±»å‹" aria-hidden="true">#</a> åŸå­ç±»ä¹‹åŸºæœ¬æ•°æ®ç±»å‹</h3><p><strong>åŸºæœ¬æ•°æ®ç±»å‹åŸå­ç±»é’ˆå¯¹ Java åŸºæœ¬ç±»å‹æä¾›åŸå­æ“ä½œ</strong>ã€‚</p><ul><li><code>AtomicBoolean</code> - å¸ƒå°”ç±»å‹åŸå­ç±»</li><li><code>AtomicInteger</code> - æ•´å‹åŸå­ç±»</li><li><code>AtomicLong</code> - é•¿æ•´å‹åŸå­ç±»</li></ul>`,71),v={href:"https://en.wikipedia.org/wiki/Compare-and-swap",target:"_blank",rel:"noopener noreferrer"},b=n("code",null,"AtomicInteger",-1),h=n("code",null,"AtomicLong",-1),g=p(`<blockquote><p>ğŸ’¡ æç¤ºï¼š</p><p>è™½ç„¶ Java åªæä¾›äº† <code>AtomicBoolean</code> ã€<code>AtomicInteger</code>ã€<code>AtomicLong</code>ï¼Œä½†æ˜¯å¯ä»¥æ¨¡æ‹Ÿå…¶ä»–åŸºæœ¬ç±»å‹çš„åŸå­å˜é‡ã€‚è¦æƒ³æ¨¡æ‹Ÿå…¶ä»–åŸºæœ¬ç±»å‹çš„åŸå­å˜é‡ï¼Œå¯ä»¥å°† <code>short</code> æˆ– <code>byte</code> ç­‰ç±»å‹ä¸ <code>int</code> ç±»å‹è¿›è¡Œè½¬æ¢ï¼Œä»¥åŠä½¿ç”¨ <code>Float.floatToIntBits</code> ã€<code>Double.doubleToLongBits</code> æ¥è½¬æ¢æµ®ç‚¹æ•°ã€‚</p><p>ç”±äº <code>AtomicBoolean</code>ã€<code>AtomicInteger</code>ã€<code>AtomicLong</code> å®ç°æ–¹å¼ã€ä½¿ç”¨æ–¹å¼éƒ½ç›¸è¿‘ï¼Œæ‰€ä»¥æœ¬æ–‡ä»…é’ˆå¯¹ <code>AtomicInteger</code> è¿›è¡Œä»‹ç»ã€‚</p></blockquote><h4 id="atomicinteger-ç”¨æ³•" tabindex="-1"><a class="header-anchor" href="#atomicinteger-ç”¨æ³•" aria-hidden="true">#</a> <strong><code>AtomicInteger</code> ç”¨æ³•</strong></h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// è·å–å½“å‰å€¼</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndSet</span><span class="token punctuation">(</span><span class="token keyword">int</span> newValue<span class="token punctuation">)</span> <span class="token comment">// è·å–å½“å‰å€¼ï¼Œå¹¶è®¾ç½®æ–°å€¼</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">// è·å–å½“å‰å€¼ï¼Œå¹¶è‡ªå¢</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndDecrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// è·å–å½“å‰å€¼ï¼Œå¹¶è‡ªå‡</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndAdd</span><span class="token punctuation">(</span><span class="token keyword">int</span> delta<span class="token punctuation">)</span> <span class="token comment">// è·å–å½“å‰å€¼ï¼Œå¹¶åŠ ä¸Šé¢„æœŸå€¼</span>
<span class="token keyword">boolean</span> <span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">int</span> expect<span class="token punctuation">,</span> <span class="token keyword">int</span> update<span class="token punctuation">)</span> <span class="token comment">// å¦‚æœè¾“å…¥å€¼ï¼ˆupdateï¼‰ç­‰äºé¢„æœŸå€¼ï¼Œå°†è¯¥å€¼è®¾ç½®ä¸ºè¾“å…¥å€¼</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">lazySet</span><span class="token punctuation">(</span><span class="token keyword">int</span> newValue<span class="token punctuation">)</span> <span class="token comment">// æœ€ç»ˆè®¾ç½®ä¸º newValueï¼Œä½¿ç”¨ lazySet è®¾ç½®ä¹‹åå¯èƒ½å¯¼è‡´å…¶ä»–çº¿ç¨‹åœ¨ä¹‹åçš„ä¸€å°æ®µæ—¶é—´å†…è¿˜æ˜¯å¯ä»¥è¯»åˆ°æ—§çš„å€¼ã€‚</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>AtomicInteger</code> ä½¿ç”¨ç¤ºä¾‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicIntegerDemo</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; count=&quot;</span> <span class="token operator">+</span> count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                count<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executorService<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Final Count is : &quot;</span> <span class="token operator">+</span> count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="atomicinteger-å®ç°" tabindex="-1"><a class="header-anchor" href="#atomicinteger-å®ç°" aria-hidden="true">#</a> <strong><code>AtomicInteger</code> å®ç°</strong></h4><p>é˜…è¯» <code>AtomicInteger</code> æºç ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹å®šä¹‰ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Unsafe</span> unsafe <span class="token operator">=</span> <span class="token class-name">Unsafe</span><span class="token punctuation">.</span><span class="token function">getUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> valueOffset<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token punctuation">{</span>
	<span class="token keyword">try</span> <span class="token punctuation">{</span>
		valueOffset <span class="token operator">=</span> unsafe<span class="token punctuation">.</span>objectFieldOffset
			<span class="token punctuation">(</span><span class="token class-name">AtomicInteger</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">&quot;value&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>è¯´æ˜ï¼š</p><ul><li><code>value</code> - value å±æ€§ä½¿ç”¨ <code>volatile</code> ä¿®é¥°ï¼Œä½¿å¾—å¯¹ value çš„ä¿®æ”¹åœ¨å¹¶å‘ç¯å¢ƒä¸‹å¯¹æ‰€æœ‰çº¿ç¨‹å¯è§ã€‚</li><li><code>valueOffset</code> - value å±æ€§çš„åç§»é‡ï¼Œé€šè¿‡è¿™ä¸ªåç§»é‡å¯ä»¥å¿«é€Ÿå®šä½åˆ° value å­—æ®µï¼Œè¿™ä¸ªæ˜¯å®ç° AtomicInteger çš„å…³é”®ã€‚</li><li><code>unsafe</code> - Unsafe ç±»å‹çš„å±æ€§ï¼Œå®ƒä¸º <code>AtomicInteger</code> æä¾›äº† CAS æ“ä½œã€‚</li></ul></blockquote><h3 id="åŸå­ç±»ä¹‹å¼•ç”¨æ•°æ®ç±»å‹" tabindex="-1"><a class="header-anchor" href="#åŸå­ç±»ä¹‹å¼•ç”¨æ•°æ®ç±»å‹" aria-hidden="true">#</a> åŸå­ç±»ä¹‹å¼•ç”¨æ•°æ®ç±»å‹</h3>`,10),w=n("strong",null,"åŸºæœ¬æ•°æ®ç±»å‹",-1),y=n("strong",null,"å¼•ç”¨æ•°æ®ç±»å‹",-1),f={href:"https://dunwu.github.io/waterdrop/pages/cba76603/",target:"_blank",rel:"noopener noreferrer"},A=p("<p>ä¸Šä¸€èŠ‚ä¸­æåˆ°äº†é’ˆå¯¹åŸºæœ¬æ•°æ®ç±»å‹çš„åŸå­ç±»ï¼Œé‚£ä¹ˆå¦‚æœæƒ³é’ˆå¯¹å¼•ç”¨ç±»å‹åšåŸå­æ“ä½œæ€ä¹ˆåŠï¼ŸJava ä¹Ÿæä¾›äº†ç›¸å…³çš„åŸå­ç±»ï¼š</p><ul><li><code>AtomicReference</code> - å¼•ç”¨ç±»å‹åŸå­ç±»</li><li><code>AtomicMarkableReference</code> - å¸¦æœ‰æ ‡è®°ä½çš„å¼•ç”¨ç±»å‹åŸå­ç±»</li><li><code>AtomicStampedReference</code> - å¸¦æœ‰ç‰ˆæœ¬å·çš„å¼•ç”¨ç±»å‹åŸå­ç±»</li></ul><blockquote><p><code>AtomicStampedReference</code> ç±»åœ¨å¼•ç”¨ç±»å‹åŸå­ç±»ä¸­ï¼Œå½»åº•åœ°è§£å†³äº† ABA é—®é¢˜ï¼Œå…¶å®ƒçš„ CAS èƒ½åŠ›ä¸å¦å¤–ä¸¤ä¸ªç±»ç›¸è¿‘ï¼Œæ‰€ä»¥æœ€å…·ä»£è¡¨æ€§ã€‚å› æ­¤ï¼Œæœ¬èŠ‚åªé’ˆå¯¹ <code>AtomicStampedReference</code> è¿›è¡Œè¯´æ˜ã€‚</p></blockquote>",3),S=n("code",null,"AtomicReference",-1),T=n("code",null,"AtomicMarkableReference",-1),x=n("code",null,"AtomicStampedReference",-1),L=n("p",null,[s("ã€ç¤ºä¾‹ã€‘åŸºäº "),n("code",null,"AtomicReference"),s(" å®ç°ä¸€ä¸ªç®€å•çš„è‡ªæ—‹é”")],-1),_=n("div",{class:"language-java line-numbers-mode","data-ext":"java"},[n("pre",{class:"language-java"},[n("code",null,[n("span",{class:"token keyword"},"public"),s(),n("span",{class:"token keyword"},"class"),s(),n("span",{class:"token class-name"},"AtomicReferenceDemo2"),s(),n("span",{class:"token punctuation"},"{"),s(`

    `),n("span",{class:"token keyword"},"private"),s(),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"int"),s(" ticket "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"10"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"public"),s(),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"String"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),s(" args"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token function"},"threadSafeDemo"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token keyword"},"private"),s(),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"threadSafeDemo"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token class-name"},"SpinLock"),s(" lock "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"new"),s(),n("span",{class:"token class-name"},"SpinLock"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token class-name"},"ExecutorService"),s(" executorService "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token class-name"},"Executors"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"newFixedThreadPool"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"5"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            executorService`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"execute"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"new"),s(),n("span",{class:"token class-name"},"MyThread"),n("span",{class:"token punctuation"},"("),s("lock"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
        executorService`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"shutdown"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token doc-comment comment"},[s(`/**
     * åŸºäº `),n("span",{class:"token punctuation"},"{"),n("span",{class:"token keyword"},"@link"),s(),n("span",{class:"token reference"},[n("span",{class:"token class-name"},"AtomicReference")]),n("span",{class:"token punctuation"},"}"),s(` å®ç°çš„ç®€å•è‡ªæ—‹é”
     */`)]),s(`
    `),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"class"),s(),n("span",{class:"token class-name"},"SpinLock"),s(),n("span",{class:"token punctuation"},"{"),s(`

        `),n("span",{class:"token keyword"},"private"),s(),n("span",{class:"token class-name"},"AtomicReference"),n("span",{class:"token generics"},[n("span",{class:"token punctuation"},"<"),n("span",{class:"token class-name"},"Thread"),n("span",{class:"token punctuation"},">")]),s(" atomicReference "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"new"),s(),n("span",{class:"token class-name"},"AtomicReference"),n("span",{class:"token generics"},[n("span",{class:"token punctuation"},"<"),n("span",{class:"token punctuation"},">")]),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

        `),n("span",{class:"token keyword"},"public"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"lock"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token class-name"},"Thread"),s(" current "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token class-name"},"Thread"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"currentThread"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token operator"},"!"),s("atomicReference"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"compareAndSet"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"null"),n("span",{class:"token punctuation"},","),s(" current"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),n("span",{class:"token punctuation"},"}"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`

        `),n("span",{class:"token keyword"},"public"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"unlock"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token class-name"},"Thread"),s(" current "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token class-name"},"Thread"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"currentThread"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            atomicReference`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"compareAndSet"),n("span",{class:"token punctuation"},"("),s("current"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token keyword"},"null"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token doc-comment comment"},[s(`/**
     * åˆ©ç”¨è‡ªæ—‹é” `),n("span",{class:"token punctuation"},"{"),n("span",{class:"token keyword"},"@link"),s(),n("span",{class:"token reference"},[n("span",{class:"token class-name"},"SpinLock")]),n("span",{class:"token punctuation"},"}"),s(` å¹¶å‘å¤„ç†æ•°æ®
     */`)]),s(`
    `),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"class"),s(),n("span",{class:"token class-name"},"MyThread"),s(),n("span",{class:"token keyword"},"implements"),s(),n("span",{class:"token class-name"},"Runnable"),s(),n("span",{class:"token punctuation"},"{"),s(`

        `),n("span",{class:"token keyword"},"private"),s(),n("span",{class:"token class-name"},"SpinLock"),s(" lock"),n("span",{class:"token punctuation"},";"),s(`

        `),n("span",{class:"token keyword"},"public"),s(),n("span",{class:"token class-name"},"MyThread"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"SpinLock"),s(" lock"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token keyword"},"this"),n("span",{class:"token punctuation"},"."),s("lock "),n("span",{class:"token operator"},"="),s(" lock"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`

        `),n("span",{class:"token annotation punctuation"},"@Override"),s(`
        `),n("span",{class:"token keyword"},"public"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"run"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token keyword"},"while"),s(),n("span",{class:"token punctuation"},"("),s("ticket "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                lock`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"lock"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("ticket "),n("span",{class:"token operator"},">"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                    `),n("span",{class:"token class-name"},"System"),n("span",{class:"token punctuation"},"."),s("out"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"println"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"Thread"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"currentThread"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"getName"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token string"},'" å–å‡ºäº†ç¬¬ "'),s(),n("span",{class:"token operator"},"+"),s(" ticket "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token string"},'" å¼ ç¥¨"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                    ticket`),n("span",{class:"token operator"},"--"),n("span",{class:"token punctuation"},";"),s(`
                `),n("span",{class:"token punctuation"},"}"),s(`
                lock`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"unlock"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),j=n("p",null,[s("ã€ç¤ºä¾‹ã€‘"),n("code",null,"AtomicMarkableReference"),s(" ä½¿ç”¨ç¤ºä¾‹ï¼ˆè§£å†³ ABA é—®é¢˜ï¼‰")],-1),I={href:"https://dunwu.github.io/waterdrop/pages/e98ae9d2",target:"_blank",rel:"noopener noreferrer"},C=n("code",null,"AtomicMarkableReference",-1),R=n("code",null,"AtomicStampedReference",-1),q=n("p",null,[n("code",null,"AtomicMarkableReference"),s(" ä½¿ç”¨ä¸€ä¸ªå¸ƒå°”å€¼ä½œä¸ºæ ‡è®°ï¼Œä¿®æ”¹æ—¶åœ¨ true / false ä¹‹é—´åˆ‡æ¢ã€‚è¿™ç§ç­–ç•¥ä¸èƒ½æ ¹æœ¬ä¸Šè§£å†³ ABA é—®é¢˜ï¼Œä½†æ˜¯å¯ä»¥é™ä½ ABA å‘ç”Ÿçš„å‡ ç‡ã€‚å¸¸ç”¨äºç¼“å­˜æˆ–è€…çŠ¶æ€æè¿°è¿™æ ·çš„åœºæ™¯ã€‚")],-1),M=n("div",{class:"language-java line-numbers-mode","data-ext":"java"},[n("pre",{class:"language-java"},[n("code",null,[n("span",{class:"token keyword"},"public"),s(),n("span",{class:"token keyword"},"class"),s(),n("span",{class:"token class-name"},"AtomicMarkableReferenceDemo"),s(),n("span",{class:"token punctuation"},"{"),s(`

    `),n("span",{class:"token keyword"},"private"),s(),n("span",{class:"token keyword"},"final"),s(),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token class-name"},"String"),s(),n("span",{class:"token constant"},"INIT_TEXT"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token string"},'"abc"'),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"public"),s(),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"String"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),s(" args"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"throws"),s(),n("span",{class:"token class-name"},"InterruptedException"),s(),n("span",{class:"token punctuation"},"{"),s(`

        `),n("span",{class:"token keyword"},"final"),s(),n("span",{class:"token class-name"},"AtomicMarkableReference"),n("span",{class:"token generics"},[n("span",{class:"token punctuation"},"<"),n("span",{class:"token class-name"},"String"),n("span",{class:"token punctuation"},">")]),s(" amr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"new"),s(),n("span",{class:"token class-name"},"AtomicMarkableReference"),n("span",{class:"token generics"},[n("span",{class:"token punctuation"},"<"),n("span",{class:"token punctuation"},">")]),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"INIT_TEXT"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token boolean"},"false"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

        `),n("span",{class:"token class-name"},"ExecutorService"),s(" executorService "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token class-name"},"Executors"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"newFixedThreadPool"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"10"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            executorService`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"submit"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"new"),s(),n("span",{class:"token class-name"},"Runnable"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                `),n("span",{class:"token annotation punctuation"},"@Override"),s(`
                `),n("span",{class:"token keyword"},"public"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"run"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                    `),n("span",{class:"token keyword"},"try"),s(),n("span",{class:"token punctuation"},"{"),s(`
                        `),n("span",{class:"token class-name"},"Thread"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"Math"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"abs"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"Math"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"random"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token number"},"100"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"catch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"InterruptedException"),s(" e"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                        e`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"printStackTrace"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                    `),n("span",{class:"token punctuation"},"}"),s(`

                    `),n("span",{class:"token class-name"},"String"),s(" name "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token class-name"},"Thread"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"currentThread"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"getName"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                    `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("amr"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"compareAndSet"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"INIT_TEXT"),n("span",{class:"token punctuation"},","),s(" name"),n("span",{class:"token punctuation"},","),s(" amr"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"isMarked"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token operator"},"!"),s("amr"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"isMarked"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                        `),n("span",{class:"token class-name"},"System"),n("span",{class:"token punctuation"},"."),s("out"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"println"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"Thread"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"currentThread"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"getName"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token string"},'" ä¿®æ”¹äº†å¯¹è±¡ï¼"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                        `),n("span",{class:"token class-name"},"System"),n("span",{class:"token punctuation"},"."),s("out"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"println"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"æ–°çš„å¯¹è±¡ä¸ºï¼š"'),s(),n("span",{class:"token operator"},"+"),s(" amr"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"getReference"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                    `),n("span",{class:"token punctuation"},"}"),s(`
                `),n("span",{class:"token punctuation"},"}"),s(`
            `),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`

        executorService`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"shutdown"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        executorService`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"awaitTermination"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token class-name"},"TimeUnit"),n("span",{class:"token punctuation"},"."),n("span",{class:"token constant"},"SECONDS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),U=n("p",null,[s("ã€ç¤ºä¾‹ã€‘"),n("code",null,"AtomicStampedReference"),s(" ä½¿ç”¨ç¤ºä¾‹")],-1),E=n("p",null,[n("strong",null,[n("code",null,"AtomicStampedReference"),s(" ä½¿ç”¨ä¸€ä¸ªæ•´å‹å€¼åšä¸ºç‰ˆæœ¬å·ï¼Œæ¯æ¬¡æ›´æ–°å‰å…ˆæ¯”è¾ƒç‰ˆæœ¬å·ï¼Œå¦‚æœä¸€è‡´ï¼Œæ‰è¿›è¡Œä¿®æ”¹")]),s("ã€‚é€šè¿‡è¿™ç§ç­–ç•¥ï¼Œå¯ä»¥æ ¹æœ¬ä¸Šè§£å†³ ABA é—®é¢˜ã€‚")],-1),F=n("div",{class:"language-java line-numbers-mode","data-ext":"java"},[n("pre",{class:"language-java"},[n("code",null,[n("span",{class:"token keyword"},"public"),s(),n("span",{class:"token keyword"},"class"),s(),n("span",{class:"token class-name"},"AtomicStampedReferenceDemo"),s(),n("span",{class:"token punctuation"},"{"),s(`

    `),n("span",{class:"token keyword"},"private"),s(),n("span",{class:"token keyword"},"final"),s(),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token class-name"},"String"),s(),n("span",{class:"token constant"},"INIT_REF"),s(),n("span",{class:"token operator"},"="),s(),n("span",{class:"token string"},'"pool-1-thread-3"'),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"private"),s(),n("span",{class:"token keyword"},"final"),s(),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token class-name"},"AtomicStampedReference"),n("span",{class:"token generics"},[n("span",{class:"token punctuation"},"<"),n("span",{class:"token class-name"},"String"),n("span",{class:"token punctuation"},">")]),s(" asr "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"new"),s(),n("span",{class:"token class-name"},"AtomicStampedReference"),n("span",{class:"token generics"},[n("span",{class:"token punctuation"},"<"),n("span",{class:"token punctuation"},">")]),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"INIT_REF"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"public"),s(),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"String"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),s(" args"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token keyword"},"throws"),s(),n("span",{class:"token class-name"},"InterruptedException"),s(),n("span",{class:"token punctuation"},"{"),s(`

        `),n("span",{class:"token class-name"},"System"),n("span",{class:"token punctuation"},"."),s("out"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"println"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"åˆå§‹å¯¹è±¡ä¸ºï¼š"'),s(),n("span",{class:"token operator"},"+"),s(" asr"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"getReference"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

        `),n("span",{class:"token class-name"},"ExecutorService"),s(" executorService "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token class-name"},"Executors"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"newFixedThreadPool"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            executorService`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"execute"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"new"),s(),n("span",{class:"token class-name"},"MyThread"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`

        executorService`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"shutdown"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        executorService`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"awaitTermination"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"3"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token class-name"},"TimeUnit"),n("span",{class:"token punctuation"},"."),n("span",{class:"token constant"},"SECONDS"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"class"),s(),n("span",{class:"token class-name"},"MyThread"),s(),n("span",{class:"token keyword"},"implements"),s(),n("span",{class:"token class-name"},"Runnable"),s(),n("span",{class:"token punctuation"},"{"),s(`

        `),n("span",{class:"token annotation punctuation"},"@Override"),s(`
        `),n("span",{class:"token keyword"},"public"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"run"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token keyword"},"try"),s(),n("span",{class:"token punctuation"},"{"),s(`
                `),n("span",{class:"token class-name"},"Thread"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"Math"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"abs"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"Math"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"random"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"*"),s(),n("span",{class:"token number"},"100"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"catch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"InterruptedException"),s(" e"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                e`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"printStackTrace"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(`

            `),n("span",{class:"token keyword"},"final"),s(),n("span",{class:"token keyword"},"int"),s(" stamp "),n("span",{class:"token operator"},"="),s(" asr"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"getStamp"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("asr"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"compareAndSet"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"INIT_REF"),n("span",{class:"token punctuation"},","),s(),n("span",{class:"token class-name"},"Thread"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"currentThread"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"getName"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},","),s(" stamp"),n("span",{class:"token punctuation"},","),s(" stamp "),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token number"},"1"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                `),n("span",{class:"token class-name"},"System"),n("span",{class:"token punctuation"},"."),s("out"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"println"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"Thread"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"currentThread"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"getName"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token string"},'" ä¿®æ”¹äº†å¯¹è±¡ï¼"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                `),n("span",{class:"token class-name"},"System"),n("span",{class:"token punctuation"},"."),s("out"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"println"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"æ–°çš„å¯¹è±¡ä¸ºï¼š"'),s(),n("span",{class:"token operator"},"+"),s(" asr"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"getReference"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),J=p(`<h3 id="åŸå­ç±»ä¹‹æ•°ç»„æ•°æ®ç±»å‹" tabindex="-1"><a class="header-anchor" href="#åŸå­ç±»ä¹‹æ•°ç»„æ•°æ®ç±»å‹" aria-hidden="true">#</a> åŸå­ç±»ä¹‹æ•°ç»„æ•°æ®ç±»å‹</h3><p>Java æä¾›äº†ä»¥ä¸‹é’ˆå¯¹æ•°ç»„çš„åŸå­ç±»ï¼š</p><ul><li><code>AtomicIntegerArray</code> - æ•´å½¢æ•°ç»„åŸå­ç±»</li><li><code>AtomicLongArray</code> - é•¿æ•´å‹æ•°ç»„åŸå­ç±»</li><li><code>AtomicReferenceArray</code> - å¼•ç”¨ç±»å‹æ•°ç»„åŸå­ç±»</li></ul><p>å·²ç»æœ‰äº†é’ˆå¯¹åŸºæœ¬ç±»å‹å’Œå¼•ç”¨ç±»å‹çš„åŸå­ç±»ï¼Œä¸ºä»€ä¹ˆè¿˜è¦æä¾›é’ˆå¯¹æ•°ç»„çš„åŸå­ç±»å‘¢ï¼Ÿ</p><p><strong>æ•°ç»„ç±»å‹çš„åŸå­ç±»ä¸ºæ•°ç»„å…ƒç´ æä¾›äº† <code>volatile</code> ç±»å‹çš„è®¿é—®è¯­ä¹‰</strong>ï¼Œè¿™æ˜¯æ™®é€šæ•°ç»„æ‰€ä¸å…·å¤‡çš„ç‰¹æ€§â€”â€”<strong><code>volatile</code> ç±»å‹çš„æ•°ç»„ä»…åœ¨æ•°ç»„å¼•ç”¨ä¸Šå…·æœ‰ <code>volatile</code> è¯­ä¹‰</strong>ã€‚</p><p>ã€ç¤ºä¾‹ã€‘<code>AtomicIntegerArray</code> ä½¿ç”¨ç¤ºä¾‹ï¼ˆ<code>AtomicLongArray</code> ã€<code>AtomicReferenceArray</code> ä½¿ç”¨æ–¹å¼ä¹Ÿç±»ä¼¼ï¼‰</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicIntegerArrayDemo</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">AtomicIntegerArray</span> atomicIntegerArray <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicIntegerArray</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arguments<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Init Values: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> atomicIntegerArray<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            atomicIntegerArray<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>atomicIntegerArray<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Compare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        t1<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Final Values: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> atomicIntegerArray<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>atomicIntegerArray<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; &quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Increment</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> atomicIntegerArray<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> value <span class="token operator">=</span> atomicIntegerArray<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;, index = &quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;, value = &quot;</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Compare</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> atomicIntegerArray<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">boolean</span> swapped <span class="token operator">=</span> atomicIntegerArray<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>swapped<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; swapped, index = &quot;</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">&quot;, value = 3&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="åŸå­ç±»ä¹‹å±æ€§æ›´æ–°å™¨" tabindex="-1"><a class="header-anchor" href="#åŸå­ç±»ä¹‹å±æ€§æ›´æ–°å™¨" aria-hidden="true">#</a> åŸå­ç±»ä¹‹å±æ€§æ›´æ–°å™¨</h3><p><strong>å±æ€§æ›´æ–°å™¨æ”¯æŒåŸºäºåå°„æœºåˆ¶çš„æ›´æ–°å­—æ®µå€¼çš„åŸå­æ“ä½œ</strong>ã€‚</p><ul><li><code>AtomicIntegerFieldUpdater</code> - æ•´å‹å­—æ®µçš„åŸå­æ›´æ–°å™¨ã€‚</li><li><code>AtomicLongFieldUpdater</code> - é•¿æ•´å‹å­—æ®µçš„åŸå­æ›´æ–°å™¨ã€‚</li><li><code>AtomicReferenceFieldUpdater</code> - åŸå­æ›´æ–°å¼•ç”¨ç±»å‹é‡Œçš„å­—æ®µã€‚</li></ul><p>è¿™äº›ç±»çš„ä½¿ç”¨æœ‰ä¸€å®šé™åˆ¶ï¼š</p><ul><li>å› ä¸ºå¯¹è±¡çš„å±æ€§ä¿®æ”¹ç±»å‹åŸå­ç±»éƒ½æ˜¯æŠ½è±¡ç±»ï¼Œæ‰€ä»¥æ¯æ¬¡ä½¿ç”¨éƒ½å¿…é¡»ä½¿ç”¨é™æ€æ–¹æ³• <code>newUpdater()</code> åˆ›å»ºä¸€ä¸ªæ›´æ–°å™¨ï¼Œå¹¶ä¸”éœ€è¦è®¾ç½®æƒ³è¦æ›´æ–°çš„ç±»å’Œå±æ€§ã€‚</li><li>å­—æ®µå¿…é¡»æ˜¯ <code>volatile</code> ç±»å‹çš„ï¼›</li><li>ä¸èƒ½ä½œç”¨äºé™æ€å˜é‡ï¼ˆ<code>static</code>ï¼‰ï¼›</li><li>ä¸èƒ½ä½œç”¨äºå¸¸é‡ï¼ˆ<code>final</code>ï¼‰ï¼›</li></ul><p>ã€ç¤ºä¾‹ã€‘<code>AtomicReferenceFieldUpdater</code> ä½¿ç”¨ç¤ºä¾‹</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicReferenceFieldUpdaterDemo</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;begin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token class-name">AtomicReferenceFieldUpdater</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> updater <span class="token operator">=</span>
        <span class="token class-name">AtomicReferenceFieldUpdater</span><span class="token punctuation">.</span><span class="token function">newUpdater</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">MyThread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>updater<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> <span class="token string">&quot;begin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; å·²ä¿®æ”¹ name = &quot;</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; å·²è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>

        <span class="token keyword">volatile</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="åŸå­ç±»ä¹‹ç´¯åŠ å™¨" tabindex="-1"><a class="header-anchor" href="#åŸå­ç±»ä¹‹ç´¯åŠ å™¨" aria-hidden="true">#</a> åŸå­ç±»ä¹‹ç´¯åŠ å™¨</h3><p><code>DoubleAccumulator</code>ã€<code>DoubleAdder</code>ã€<code>LongAccumulator</code> å’Œ <code>LongAdder</code>ï¼Œè¿™å››ä¸ªç±»ä»…ä»…ç”¨æ¥æ‰§è¡Œç´¯åŠ æ“ä½œï¼Œç›¸æ¯”åŸå­åŒ–çš„åŸºæœ¬æ•°æ®ç±»å‹ï¼Œé€Ÿåº¦æ›´å¿«ï¼Œä½†æ˜¯ä¸æ”¯æŒ <code>compareAndSet()</code> æ–¹æ³•ã€‚å¦‚æœä½ ä»…ä»…éœ€è¦ç´¯åŠ æ“ä½œï¼Œä½¿ç”¨åŸå­åŒ–çš„ç´¯åŠ å™¨æ€§èƒ½ä¼šæ›´å¥½ï¼Œä»£ä»·å°±æ˜¯ä¼šæ¶ˆè€—æ›´å¤šçš„å†…å­˜ç©ºé—´ã€‚</p><p><code>LongAdder</code> å†…éƒ¨ç”±ä¸€ä¸ª <code>base</code> å˜é‡å’Œä¸€ä¸ª <code>cell[]</code> æ•°ç»„ç»„æˆã€‚</p><ul><li>å½“åªæœ‰ä¸€ä¸ªå†™çº¿ç¨‹ï¼Œæ²¡æœ‰ç«äº‰çš„æƒ…å†µä¸‹ï¼Œ<code>LongAdder</code> ä¼šç›´æ¥ä½¿ç”¨ <code>base</code> å˜é‡ä½œä¸ºåŸå­æ“ä½œå˜é‡ï¼Œé€šè¿‡ CAS æ“ä½œä¿®æ”¹å˜é‡ï¼›</li><li>å½“æœ‰å¤šä¸ªå†™çº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹ï¼Œé™¤äº†å ç”¨ <code>base</code> å˜é‡çš„ä¸€ä¸ªå†™çº¿ç¨‹ä¹‹å¤–ï¼Œå…¶å®ƒå„ä¸ªçº¿ç¨‹ä¼šå°†ä¿®æ”¹çš„å˜é‡å†™å…¥åˆ°è‡ªå·±çš„æ§½ <code>cell[]</code> æ•°ç»„ä¸­ã€‚</li></ul><p>æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œ<code>LongAdder</code> åœ¨æ“ä½œåçš„è¿”å›å€¼åªæ˜¯ä¸€ä¸ªè¿‘ä¼¼å‡†ç¡®çš„æ•°å€¼ï¼Œä½†æ˜¯ <code>LongAdder</code> æœ€ç»ˆè¿”å›çš„æ˜¯ä¸€ä¸ªå‡†ç¡®çš„æ•°å€¼ï¼Œ æ‰€ä»¥åœ¨ä¸€äº›å¯¹å®æ—¶æ€§è¦æ±‚æ¯”è¾ƒé«˜çš„åœºæ™¯ä¸‹ï¼Œ<code>LongAdder</code> å¹¶ä¸èƒ½å–ä»£ <code>AtomicInteger</code> æˆ– <code>AtomicLong</code>ã€‚</p><h2 id="threadlocal" tabindex="-1"><a class="header-anchor" href="#threadlocal" aria-hidden="true">#</a> ThreadLocal</h2><p>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå…±äº«å˜é‡å­˜åœ¨å¹¶å‘å®‰å…¨é—®é¢˜ã€‚æ¢ä¸ªæ€è·¯ï¼Œå¦‚æœå˜é‡éå…±äº«ï¼Œè€Œæ˜¯å„ä¸ªçº¿ç¨‹ç‹¬äº«ï¼Œå°±ä¸ä¼šæœ‰å¹¶å‘å®‰å…¨é—®é¢˜ã€‚è¿™ç§æ€æƒ³æœ‰ä¸ªæœ¯è¯­å«<strong>çº¿ç¨‹å°é—­</strong>ï¼Œå…¶æœ¬è´¨ä¸Šå°±æ˜¯é¿å…å…±äº«ã€‚æ²¡æœ‰å…±äº«ï¼Œè‡ªç„¶ä¹Ÿå°±æ²¡æœ‰å¹¶å‘å®‰å…¨é—®é¢˜ã€‚åœ¨ Java ä¸­ï¼Œ<code>ThreadLocal</code> æ­£æ˜¯æ ¹æ®è¿™ä¸ªæ€è·¯è€Œè®¾è®¡çš„ã€‚</p><p><strong><code>ThreadLocal</code> ä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½åˆ›å»ºäº†ä¸€ä¸ªæœ¬åœ°å‰¯æœ¬</strong>ï¼Œè¿™ä¸ªå‰¯æœ¬åªèƒ½è¢«å½“å‰çº¿ç¨‹è®¿é—®ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è®¿é—®ï¼Œé‚£ä¹ˆè‡ªç„¶æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><h3 id="threadlocal-çš„åº”ç”¨" tabindex="-1"><a class="header-anchor" href="#threadlocal-çš„åº”ç”¨" aria-hidden="true">#</a> ThreadLocal çš„åº”ç”¨</h3><p><code>ThreadLocal</code> çš„æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> <span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">S</span><span class="token punctuation">&gt;</span></span> supplier<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>è¯´æ˜ï¼š</p><ul><li><code>get</code> - ç”¨äºè·å– <code>ThreadLocal</code> åœ¨å½“å‰çº¿ç¨‹ä¸­ä¿å­˜çš„å˜é‡å‰¯æœ¬ã€‚</li><li><code>set</code> - ç”¨äºè®¾ç½®å½“å‰çº¿ç¨‹ä¸­å˜é‡çš„å‰¯æœ¬ã€‚</li><li><code>remove</code> - ç”¨äºåˆ é™¤å½“å‰çº¿ç¨‹ä¸­å˜é‡çš„å‰¯æœ¬ã€‚å¦‚æœæ­¤çº¿ç¨‹å±€éƒ¨å˜é‡éšåè¢«å½“å‰çº¿ç¨‹è¯»å–ï¼Œåˆ™å…¶å€¼å°†é€šè¿‡è°ƒç”¨å…¶ <code>initialValue</code> æ–¹æ³•é‡æ–°åˆå§‹åŒ–ï¼Œé™¤éå…¶å€¼ç”±ä¸­é—´çº¿ç¨‹ä¸­çš„å½“å‰çº¿ç¨‹è®¾ç½®ã€‚ è¿™å¯èƒ½ä¼šå¯¼è‡´å½“å‰çº¿ç¨‹ä¸­å¤šæ¬¡è°ƒç”¨ <code>initialValue</code> æ–¹æ³•ã€‚</li><li><code>initialValue</code> - ä¸º ThreadLocal è®¾ç½®é»˜è®¤çš„ <code>get</code> åˆå§‹å€¼ï¼Œéœ€è¦é‡å†™ <code>initialValue</code> æ–¹æ³• ã€‚</li></ul></blockquote><p><code>ThreadLocal</code> å¸¸ç”¨äºé˜²æ­¢å¯¹å¯å˜çš„å•ä¾‹ï¼ˆSingletonï¼‰å˜é‡æˆ–å…¨å±€å˜é‡è¿›è¡Œå…±äº«ã€‚å…¸å‹åº”ç”¨åœºæ™¯æœ‰ï¼šç®¡ç†æ•°æ®åº“è¿æ¥ã€Session ç®¡ç†ç­‰ã€‚</p>`,27),D=n("code",null,"SimpleDateFormat",-1),B=n("code",null,"ThreadLocal",-1),N=n("p",null,"ã€ç¤ºä¾‹ã€‘æ•°æ®åº“è¿æ¥",-1),O=n("div",{class:"language-java line-numbers-mode","data-ext":"java"},[n("pre",{class:"language-java"},[n("code",null,[n("span",{class:"token keyword"},"private"),s(),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token class-name"},"ThreadLocal"),n("span",{class:"token generics"},[n("span",{class:"token punctuation"},"<"),n("span",{class:"token class-name"},"Connection"),n("span",{class:"token punctuation"},">")]),s(" connectionHolder "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"new"),s(),n("span",{class:"token class-name"},"ThreadLocal"),n("span",{class:"token generics"},[n("span",{class:"token punctuation"},"<"),n("span",{class:"token class-name"},"Connection"),n("span",{class:"token punctuation"},">")]),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token annotation punctuation"},"@Override"),s(`
    `),n("span",{class:"token keyword"},"public"),s(),n("span",{class:"token class-name"},"Connection"),s(),n("span",{class:"token function"},"initialValue"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token class-name"},"DriverManager"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"getConnection"),n("span",{class:"token punctuation"},"("),n("span",{class:"token constant"},"DB_URL"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
`),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"public"),s(),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token class-name"},"Connection"),s(),n("span",{class:"token function"},"getConnection"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" connectionHolder"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"get"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),V=n("p",null,"ã€ç¤ºä¾‹ã€‘Session ç®¡ç†",-1),W=n("div",{class:"language-java line-numbers-mode","data-ext":"java"},[n("pre",{class:"language-java"},[n("code",null,[n("span",{class:"token keyword"},"private"),s(),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"final"),s(),n("span",{class:"token class-name"},"ThreadLocal"),n("span",{class:"token generics"},[n("span",{class:"token punctuation"},"<"),n("span",{class:"token class-name"},"Session"),n("span",{class:"token punctuation"},">")]),s(" sessionHolder "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"new"),s(),n("span",{class:"token class-name"},"ThreadLocal"),n("span",{class:"token generics"},[n("span",{class:"token punctuation"},"<"),n("span",{class:"token punctuation"},">")]),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

`),n("span",{class:"token keyword"},"public"),s(),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token class-name"},"Session"),s(),n("span",{class:"token function"},"getSession"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
    `),n("span",{class:"token class-name"},"Session"),s(" session "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"Session"),n("span",{class:"token punctuation"},")"),s(" sessionHolder"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"get"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token keyword"},"try"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"if"),s(),n("span",{class:"token punctuation"},"("),s("session "),n("span",{class:"token operator"},"=="),s(),n("span",{class:"token keyword"},"null"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            session `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token function"},"createSession"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            sessionHolder`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"set"),n("span",{class:"token punctuation"},"("),s("session"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"catch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"Exception"),s(" e"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        e`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"printStackTrace"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token keyword"},"return"),s(" session"),n("span",{class:"token punctuation"},";"),s(`
`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),P=n("p",null,[s("ã€ç¤ºä¾‹ã€‘çº¿ç¨‹å®‰å…¨çš„ "),n("code",null,"SimpleDateFormat")],-1),H=n("p",null,"SimpleDateFormat ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¦‚æœè¦ä¿è¯å¹¶å‘å®‰å…¨ï¼Œå¯ä»¥ä½¿ç”¨ ThreadLocal æ¥è§£å†³ã€‚",-1),G=n("div",{class:"language-java line-numbers-mode","data-ext":"java"},[n("pre",{class:"language-java"},[n("code",null,[n("span",{class:"token keyword"},"public"),s(),n("span",{class:"token keyword"},"class"),s(),n("span",{class:"token class-name"},"SafeDateFormat"),s(),n("span",{class:"token punctuation"},"{"),s(`

    `),n("span",{class:"token comment"},"//å®šä¹‰ ThreadLocal å˜é‡"),s(`
    `),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"final"),s(),n("span",{class:"token class-name"},"ThreadLocal"),n("span",{class:"token generics"},[n("span",{class:"token punctuation"},"<"),n("span",{class:"token class-name"},"DateFormat"),n("span",{class:"token punctuation"},">")]),s(`
        tl `),n("span",{class:"token operator"},"="),s(),n("span",{class:"token class-name"},"ThreadLocal"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"withInitial"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"->"),s(),n("span",{class:"token keyword"},"new"),s(),n("span",{class:"token class-name"},"SimpleDateFormat"),n("span",{class:"token punctuation"},"("),n("span",{class:"token string"},'"yyyy-MM-dd HH:mm:ss"'),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token class-name"},"DateFormat"),s(),n("span",{class:"token function"},"get"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token keyword"},"return"),s(" tl"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"get"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token keyword"},"public"),s(),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"String"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),s(" args"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token comment"},"//ä¸åŒçº¿ç¨‹æ‰§è¡Œä¸‹é¢ä»£ç "),s(`
        `),n("span",{class:"token comment"},"//è¿”å›çš„ df æ˜¯ä¸åŒçš„"),s(`
        `),n("span",{class:"token class-name"},"DateFormat"),s(" df "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token class-name"},"SafeDateFormat"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"get"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),z=n("p",null,[s("ã€ç¤ºä¾‹ã€‘å®Œæ•´ä½¿ç”¨ "),n("code",null,"ThreadLocal"),s(" ç¤ºä¾‹")],-1),X=n("div",{class:"language-java line-numbers-mode","data-ext":"java"},[n("pre",{class:"language-java"},[n("code",null,[n("span",{class:"token keyword"},"public"),s(),n("span",{class:"token keyword"},"class"),s(),n("span",{class:"token class-name"},"ThreadLocalDemo"),s(),n("span",{class:"token punctuation"},"{"),s(`

    `),n("span",{class:"token keyword"},"private"),s(),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token class-name"},"ThreadLocal"),n("span",{class:"token generics"},[n("span",{class:"token punctuation"},"<"),n("span",{class:"token class-name"},"Integer"),n("span",{class:"token punctuation"},">")]),s(" threadLocal "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token keyword"},"new"),s(),n("span",{class:"token class-name"},"ThreadLocal"),n("span",{class:"token generics"},[n("span",{class:"token punctuation"},"<"),n("span",{class:"token class-name"},"Integer"),n("span",{class:"token punctuation"},">")]),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token annotation punctuation"},"@Override"),s(`
        `),n("span",{class:"token keyword"},"protected"),s(),n("span",{class:"token class-name"},"Integer"),s(),n("span",{class:"token function"},"initialValue"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token keyword"},"return"),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
    `),n("span",{class:"token punctuation"},"}"),n("span",{class:"token punctuation"},";"),s(`

    `),n("span",{class:"token keyword"},"public"),s(),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"main"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"String"),n("span",{class:"token punctuation"},"["),n("span",{class:"token punctuation"},"]"),s(" args"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
        `),n("span",{class:"token class-name"},"ExecutorService"),s(" executorService "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token class-name"},"Executors"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"newFixedThreadPool"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"10"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"10"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            executorService`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"execute"),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"new"),s(),n("span",{class:"token class-name"},"MyThread"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`
        executorService`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"shutdown"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
    `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token keyword"},"static"),s(),n("span",{class:"token keyword"},"class"),s(),n("span",{class:"token class-name"},"MyThread"),s(),n("span",{class:"token keyword"},"implements"),s(),n("span",{class:"token class-name"},"Runnable"),s(),n("span",{class:"token punctuation"},"{"),s(`

        `),n("span",{class:"token annotation punctuation"},"@Override"),s(`
        `),n("span",{class:"token keyword"},"public"),s(),n("span",{class:"token keyword"},"void"),s(),n("span",{class:"token function"},"run"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
            `),n("span",{class:"token keyword"},"int"),s(" count "),n("span",{class:"token operator"},"="),s(" threadLocal"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"get"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token keyword"},"for"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token keyword"},"int"),s(" i "),n("span",{class:"token operator"},"="),s(),n("span",{class:"token number"},"0"),n("span",{class:"token punctuation"},";"),s(" i "),n("span",{class:"token operator"},"<"),s(),n("span",{class:"token number"},"10"),n("span",{class:"token punctuation"},";"),s(" i"),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                `),n("span",{class:"token keyword"},"try"),s(),n("span",{class:"token punctuation"},"{"),s(`
                    count`),n("span",{class:"token operator"},"++"),n("span",{class:"token punctuation"},";"),s(`
                    `),n("span",{class:"token class-name"},"Thread"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"sleep"),n("span",{class:"token punctuation"},"("),n("span",{class:"token number"},"100"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                `),n("span",{class:"token punctuation"},"}"),s(),n("span",{class:"token keyword"},"catch"),s(),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"InterruptedException"),s(" e"),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token punctuation"},"{"),s(`
                    e`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"printStackTrace"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
                `),n("span",{class:"token punctuation"},"}"),s(`
            `),n("span",{class:"token punctuation"},"}"),s(`
            threadLocal`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"set"),n("span",{class:"token punctuation"},"("),s("count"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            threadLocal`),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"remove"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
            `),n("span",{class:"token class-name"},"System"),n("span",{class:"token punctuation"},"."),s("out"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"println"),n("span",{class:"token punctuation"},"("),n("span",{class:"token class-name"},"Thread"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"currentThread"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},"."),n("span",{class:"token function"},"getName"),n("span",{class:"token punctuation"},"("),n("span",{class:"token punctuation"},")"),s(),n("span",{class:"token operator"},"+"),s(),n("span",{class:"token string"},'" : "'),s(),n("span",{class:"token operator"},"+"),s(" count"),n("span",{class:"token punctuation"},")"),n("span",{class:"token punctuation"},";"),s(`
        `),n("span",{class:"token punctuation"},"}"),s(`

    `),n("span",{class:"token punctuation"},"}"),s(`

`),n("span",{class:"token punctuation"},"}"),s(`
`)])]),n("div",{class:"line-numbers","aria-hidden":"true"},[n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"}),n("div",{class:"line-number"})])],-1),K=p(`<h3 id="threadlocal-çš„åŸç†" tabindex="-1"><a class="header-anchor" href="#threadlocal-çš„åŸç†" aria-hidden="true">#</a> ThreadLocal çš„åŸç†</h3><h4 id="å­˜å‚¨ç»“æ„" tabindex="-1"><a class="header-anchor" href="#å­˜å‚¨ç»“æ„" aria-hidden="true">#</a> å­˜å‚¨ç»“æ„</h4><p><strong><code>Thread</code> ç±»ä¸­ç»´æŠ¤ç€ 2 ä¸ª <code>ThreadLocal.ThreadLocalMap</code> ç±»å‹çš„æˆå‘˜</strong> <code>threadLocals</code> å’Œ inheritableThreadLocals ã€‚è¿™ 2 ä¸ªæˆå‘˜å°±æ˜¯ç”¨æ¥å­˜å‚¨å½“å‰çº¿ç¨‹ç‹¬å çš„å˜é‡å‰¯æœ¬ã€‚</p><p><code>ThreadLocalMap</code> æ˜¯ <code>ThreadLocal</code> çš„å†…éƒ¨ç±»ï¼Œå®ƒç»´æŠ¤ç€ä¸€ä¸ª <code>Entry</code> æ•°ç»„ï¼Œ<strong><code>Entry</code> ç»§æ‰¿äº† <code>WeakReference</code></strong> ï¼Œæ‰€ä»¥æ˜¯å¼±å¼•ç”¨ã€‚ <code>Entry</code> ç”¨äºä¿å­˜é”®å€¼å¯¹ï¼Œå…¶ä¸­ï¼š</p><ul><li><code>key</code> æ˜¯ <code>ThreadLocal</code> å¯¹è±¡</li><li><code>value</code> æ˜¯ä¼ é€’è¿›æ¥çš„å¯¹è±¡ï¼ˆå˜é‡å‰¯æœ¬ï¼‰</li></ul><figure><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/202409110720703.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p><code>ThreadLocal</code> å…³é”®æºç å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Thread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap</span> threadLocals <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    <span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap</span> inheritableThreadLocals <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalMap</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span> <span class="token keyword">extends</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ThreadLocal</span><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/** The value associated with this ThreadLocal. */</span>
        <span class="token class-name">Object</span> value<span class="token punctuation">;</span>

        <span class="token class-name">Entry</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> k<span class="token punctuation">,</span> <span class="token class-name">Object</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
            value <span class="token operator">=</span> v<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="å¦‚ä½•è§£å†³-hash-å†²çª" tabindex="-1"><a class="header-anchor" href="#å¦‚ä½•è§£å†³-hash-å†²çª" aria-hidden="true">#</a> å¦‚ä½•è§£å†³ Hash å†²çª</h4><p><code>ThreadLocalMap</code> è™½ç„¶æ˜¯ç±»ä¼¼ <code>Map</code> ç»“æ„çš„æ•°æ®ç»“æ„ï¼Œä½†å®ƒå¹¶æ²¡æœ‰å®ç° <code>Map</code> æ¥å£ã€‚å®ƒä¸æ”¯æŒ <code>Map</code> æ¥å£ä¸­çš„ <code>next</code> æ–¹æ³•ï¼Œè¿™æ„å‘³ç€ <code>ThreadLocalMap</code> ä¸­è§£å†³ Hash å†²çªçš„æ–¹å¼å¹¶é <strong>æ‹‰é“¾è¡¨</strong> æ–¹å¼ã€‚</p><p>å®é™…ä¸Šï¼Œ<strong><code>ThreadLocalMap</code> é‡‡ç”¨çº¿æ€§æ¢æµ‹çš„æ–¹å¼æ¥è§£å†³ Hash å†²çª</strong>ã€‚æ‰€è°“çº¿æ€§æ¢æµ‹ï¼Œå°±æ˜¯æ ¹æ®åˆå§‹ key çš„ hashcode å€¼ç¡®å®šå…ƒç´ åœ¨ table æ•°ç»„ä¸­çš„ä½ç½®ï¼Œå¦‚æœå‘ç°è¿™ä¸ªä½ç½®ä¸Šå·²ç»è¢«å…¶ä»–çš„ key å€¼å ç”¨ï¼Œåˆ™åˆ©ç”¨å›ºå®šçš„ç®—æ³•å¯»æ‰¾ä¸€å®šæ­¥é•¿çš„ä¸‹ä¸ªä½ç½®ï¼Œä¾æ¬¡åˆ¤æ–­ï¼Œç›´è‡³æ‰¾åˆ°èƒ½å¤Ÿå­˜æ”¾çš„ä½ç½®ã€‚</p><h4 id="å†…å­˜æ³„æ¼é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#å†…å­˜æ³„æ¼é—®é¢˜" aria-hidden="true">#</a> å†…å­˜æ³„æ¼é—®é¢˜</h4><p><code>ThreadLocal</code> ä»…ä»…æ˜¯ä¸€ä¸ªä»£ç†å·¥å…·ç±»ï¼Œå†…éƒ¨å¹¶ä¸æŒæœ‰ä»»ä½•ä¸çº¿ç¨‹ç›¸å…³çš„æ•°æ®ï¼Œæ‰€æœ‰å’Œçº¿ç¨‹ç›¸å…³çš„æ•°æ®éƒ½å­˜å‚¨åœ¨ <code>Thread</code> é‡Œé¢ï¼Œè¿™æ ·çš„è®¾è®¡å®¹æ˜“ç†è§£ã€‚</p><p>å½“ç„¶è¿˜æœ‰ä¸€ä¸ªæ›´åŠ æ·±å±‚æ¬¡çš„åŸå› ï¼Œé‚£å°±æ˜¯<strong>ä¸å®¹æ˜“äº§ç”Ÿå†…å­˜æ³„éœ²</strong>ã€‚å¦‚æœ <code>ThreadLocal</code> å’Œå®é™…å®ç°åå…¶é“è€Œè¡Œä¹‹ï¼šå°† <code>Thread</code> çš„å¼•ç”¨ç»´æŠ¤åœ¨ä¸€ä¸ª <code>Map</code> ä¸­ï¼Œå°±ä¼šå‡ºç°è¿™ç§æƒ…å†µâ€”â€”åªè¦ <code>ThreadLocal</code> å¯¹è±¡å­˜åœ¨ï¼Œé‚£ä¹ˆ Map ä¸­çš„ Thread å¯¹è±¡å°±æ°¸è¿œä¸ä¼šè¢«å›æ”¶ã€‚è€Œ <code>ThreadLocal</code> çš„ç”Ÿå‘½å‘¨æœŸå¾€å¾€éƒ½æ¯”çº¿ç¨‹è¦é•¿ï¼Œæ‰€ä»¥è¿™ç§è®¾è®¡æ–¹æ¡ˆå¾ˆå®¹æ˜“å¯¼è‡´å†…å­˜æ³„éœ²ã€‚è€Œ Java çš„å®ç°ä¸­ <code>Thread</code> æŒæœ‰ <code>ThreadLocalMap</code>ï¼Œè€Œä¸” <code>ThreadLocalMap</code> é‡Œå¯¹ <code>ThreadLocal</code> çš„å¼•ç”¨è¿˜æ˜¯å¼±å¼•ç”¨ï¼ˆ<code>WeakReference</code>ï¼‰ï¼Œæ‰€ä»¥åªè¦ <code>Thread</code> å¯¹è±¡å¯ä»¥è¢«å›æ”¶ï¼Œé‚£ä¹ˆ <code>ThreadLocalMap</code> å°±èƒ½è¢«å›æ”¶ã€‚Java çš„è¿™ç§å®ç°æ–¹æ¡ˆè™½ç„¶çœ‹ä¸Šå»å¤æ‚ä¸€äº›ï¼Œä½†æ˜¯æ›´åŠ å®‰å…¨ã€‚</p><p><code>ThreadLocalMap</code> çš„ <code>Entry</code> ç»§æ‰¿äº† <code>WeakReference</code>ï¼Œæ‰€ä»¥å®ƒçš„ <strong>key ï¼ˆ<code>ThreadLocal</code> å¯¹è±¡ï¼‰æ˜¯å¼±å¼•ç”¨ï¼Œè€Œ value ï¼ˆå˜é‡å‰¯æœ¬ï¼‰æ˜¯å¼ºå¼•ç”¨</strong>ã€‚å¦‚æœ <code>ThreadLocal</code> å¯¹è±¡æ²¡æœ‰å¤–éƒ¨å¼ºå¼•ç”¨æ¥å¼•ç”¨å®ƒï¼Œé‚£ä¹ˆ <code>ThreadLocal</code> å¯¹è±¡ä¼šåœ¨ä¸‹æ¬¡ GC æ—¶è¢«å›æ”¶ã€‚æ­¤æ—¶ï¼Œ<code>Entry</code> ä¸­çš„ key å·²ç»è¢«å›æ”¶ï¼Œä½†æ˜¯ value ç”±äºæ˜¯å¼ºå¼•ç”¨ä¸ä¼šè¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶ã€‚å¦‚æœåˆ›å»º <code>ThreadLocal</code> çš„çº¿ç¨‹ä¸€ç›´æŒç»­è¿è¡Œï¼Œé‚£ä¹ˆ value å°±ä¼šä¸€ç›´å¾—ä¸åˆ°å›æ”¶ï¼Œä»è€Œå¯¼è‡´<strong>å†…å­˜æ³„éœ²</strong>ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•é¿å…å†…å­˜æ³„æ¼å‘¢ï¼Ÿæ–¹æ³•å°±æ˜¯ï¼š<strong>ä½¿ç”¨ <code>ThreadLocal</code> çš„ <code>set</code> æ–¹æ³•åï¼Œåœ¨ <code>try {} finally {} </code> ä¸­æ˜¾ç¤ºçš„è°ƒç”¨ <code>remove</code> æ–¹æ³•</strong> ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name">ExecutorService</span> es<span class="token punctuation">;</span>
<span class="token class-name">ThreadLocal</span> tl<span class="token punctuation">;</span>
es<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//ThreadLocal å¢åŠ å˜é‡</span>
    tl<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// çœç•¥ä¸šåŠ¡é€»è¾‘ä»£ç </span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">//æ‰‹åŠ¨æ¸…ç† ThreadLocal</span>
        tl<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="threadlocal-çš„è¯¯åŒº" tabindex="-1"><a class="header-anchor" href="#threadlocal-çš„è¯¯åŒº" aria-hidden="true">#</a> ThreadLocal çš„è¯¯åŒº</h3>`,18),Q={href:"https://time.geekbang.org/column/intro/100047701",target:"_blank",rel:"noopener noreferrer"},Y=p(`<p>ThreadLocal é€‚ç”¨äºå˜é‡åœ¨çº¿ç¨‹é—´éš”ç¦»ï¼Œè€Œåœ¨æ–¹æ³•æˆ–ç±»é—´å…±äº«çš„åœºæ™¯ã€‚</p><p>å‰æ–‡æåˆ°ï¼ŒThreadLocal æ˜¯çº¿ç¨‹éš”ç¦»çš„ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯ä½¿ç”¨ ThreadLocal å°±ä¸€å®šé«˜æ•æ— å¿§å‘¢ï¼Ÿ</p><h4 id="threadlocal-é”™è¯¯æ¡ˆä¾‹" tabindex="-1"><a class="header-anchor" href="#threadlocal-é”™è¯¯æ¡ˆä¾‹" aria-hidden="true">#</a> ThreadLocal é”™è¯¯æ¡ˆä¾‹</h4><p>ä½¿ç”¨ Spring Boot åˆ›å»ºä¸€ä¸ª Web åº”ç”¨ç¨‹åºï¼Œä½¿ç”¨ ThreadLocal å­˜æ”¾ä¸€ä¸ª Integer çš„å€¼ï¼Œæ¥æš‚ä¸”ä»£è¡¨éœ€è¦åœ¨çº¿ç¨‹ä¸­ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯ï¼Œè¿™ä¸ªå€¼åˆå§‹æ˜¯ nullã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> currentUser <span class="token operator">=</span> <span class="token class-name">ThreadLocal</span><span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;wrong&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">wrong</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//è®¾ç½®ç”¨æˆ·ä¿¡æ¯ä¹‹å‰å…ˆæŸ¥è¯¢ä¸€æ¬¡ ThreadLocal ä¸­çš„ç”¨æˆ·ä¿¡æ¯</span>
        <span class="token class-name">String</span> before <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> currentUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è®¾ç½®ç”¨æˆ·ä¿¡æ¯åˆ° ThreadLocal</span>
        currentUser<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//è®¾ç½®ç”¨æˆ·ä¿¡æ¯ä¹‹åå†æŸ¥è¯¢ä¸€æ¬¡ ThreadLocal ä¸­çš„ç”¨æˆ·ä¿¡æ¯</span>
        <span class="token class-name">String</span> after <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> currentUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//æ±‡æ€»è¾“å‡ºä¸¤æ¬¡æŸ¥è¯¢ç»“æœ</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;before&quot;</span><span class="token punctuation">,</span> before<span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;after&quot;</span><span class="token punctuation">,</span> after<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ã€é¢„æœŸã€‘ä»ä»£ç é€»è¾‘æ¥çœ‹ï¼Œæˆ‘ä»¬é¢„æœŸç¬¬ä¸€æ¬¡è·å–çš„å€¼å§‹ç»ˆåº”è¯¥æ˜¯ nullã€‚</p><p>ã€å®é™…ã€‘</p><p>ä¸ºäº†æ–¹ä¾¿å¤ç°ï¼Œå°† Tomcat å·¥ä½œçº¿ç¨‹è®¾ä¸º 1ï¼š</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>server.tomcat.max-threads=1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>å½“è®¿é—® id = 1 æ—¶ï¼Œç¬¦åˆé¢„æœŸ</p><figure><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200731111854.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>å½“è®¿é—® id = 2 æ—¶ï¼Œbefore çš„åº”ç­”ä¸æ˜¯ nullï¼Œè€Œæ˜¯ 1ï¼Œä¸ç¬¦åˆé¢„æœŸã€‚</p><p>ã€åˆ†æã€‘å®é™…æƒ…å†µå’Œé¢„æœŸå­˜åœ¨åå·®ã€‚Spring Boot ç¨‹åºè¿è¡Œåœ¨ Tomcat ä¸­ï¼Œæ‰§è¡Œç¨‹åºçš„çº¿ç¨‹æ˜¯ Tomcat çš„å·¥ä½œçº¿ç¨‹ï¼Œè€Œ Tomcat çš„å·¥ä½œçº¿ç¨‹æ˜¯åŸºäºçº¿ç¨‹æ± çš„ã€‚<strong>çº¿ç¨‹æ± ä¼šé‡ç”¨å›ºå®šçš„å‡ ä¸ªçº¿ç¨‹ï¼Œä¸€æ—¦çº¿ç¨‹é‡ç”¨ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½é¦–æ¬¡ä»</strong><br><strong>ThreadLocal è·å–çš„å€¼æ˜¯ä¹‹å‰å…¶ä»–ç”¨æˆ·çš„è¯·æ±‚é—ç•™çš„å€¼ã€‚è¿™æ—¶ï¼ŒThreadLocal ä¸­çš„ç”¨æˆ·ä¿¡æ¯å°±æ˜¯å…¶ä»–ç”¨æˆ·çš„ä¿¡æ¯</strong>ã€‚</p><p><strong>å¹¶ä¸èƒ½è®¤ä¸ºæ²¡æœ‰æ˜¾å¼å¼€å¯å¤šçº¿ç¨‹å°±ä¸ä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜</strong>ã€‚ä½¿ç”¨ç±»ä¼¼ ThreadLocal å·¥å…·æ¥å­˜æ”¾ä¸€äº›æ•°æ®æ—¶ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„åœ¨ä»£ç è¿è¡Œå®Œåï¼Œæ˜¾å¼åœ°å»æ¸…ç©ºè®¾ç½®çš„æ•°æ®ã€‚</p><h4 id="threadlocal-é”™è¯¯æ¡ˆä¾‹ä¿®æ­£" tabindex="-1"><a class="header-anchor" href="#threadlocal-é”™è¯¯æ¡ˆä¾‹ä¿®æ­£" aria-hidden="true">#</a> ThreadLocal é”™è¯¯æ¡ˆä¾‹ä¿®æ­£</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;right&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">right</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> before <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> currentUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        currentUser<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> after <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> currentUser<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;before&quot;</span><span class="token punctuation">,</span> before<span class="token punctuation">)</span><span class="token punctuation">;</span>
            result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;after&quot;</span><span class="token punctuation">,</span> after<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">//åœ¨ finally ä»£ç å—ä¸­åˆ é™¤ ThreadLocal ä¸­çš„æ•°æ®ï¼Œç¡®ä¿æ•°æ®ä¸ä¸²</span>
            currentUser<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="inheritablethreadlocal" tabindex="-1"><a class="header-anchor" href="#inheritablethreadlocal" aria-hidden="true">#</a> InheritableThreadLocal</h3><p>é€šè¿‡ <code>ThreadLocal</code> åˆ›å»ºçš„çº¿ç¨‹å˜é‡ï¼Œå…¶å­çº¿ç¨‹æ˜¯æ— æ³•ç»§æ‰¿çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ä½ åœ¨çº¿ç¨‹ä¸­é€šè¿‡ <code>ThreadLocal</code> åˆ›å»ºäº†çº¿ç¨‹å˜é‡ Vï¼Œè€Œåè¯¥çº¿ç¨‹åˆ›å»ºäº†å­çº¿ç¨‹ï¼Œä½ åœ¨å­çº¿ç¨‹ä¸­æ˜¯æ— æ³•é€šè¿‡ <code>ThreadLocal</code> æ¥è®¿é—®çˆ¶çº¿ç¨‹çš„çº¿ç¨‹å˜é‡ V çš„ã€‚</p><p>å¦‚æœä½ éœ€è¦å­çº¿ç¨‹ç»§æ‰¿çˆ¶çº¿ç¨‹çš„çº¿ç¨‹å˜é‡ï¼Œé‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼ŒJava æä¾›äº† <code>InheritableThreadLocal</code> æ¥æ”¯æŒè¿™ç§ç‰¹æ€§ï¼Œ<code>InheritableThreadLocal</code> æ˜¯ <code>ThreadLocal</code> å­ç±»ï¼Œæ‰€ä»¥ç”¨æ³•å’Œ <code>ThreadLocal</code> ç›¸åŒã€‚ä¸ <code>ThreadLocal</code> ä¸åŒçš„æ˜¯ï¼Œ<code>InheritableThreadLocal</code> å…è®¸ä¸€ä¸ªçº¿ç¨‹ä»¥åŠè¯¥çº¿ç¨‹åˆ›å»ºçš„æ‰€æœ‰å­çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®å®ƒä¿å­˜çš„æ•°æ®ã€‚</p><p>ä¸è¿‡ï¼Œå®Œå…¨ä¸å»ºè®®ä½ åœ¨çº¿ç¨‹æ± ä¸­ä½¿ç”¨ <code>InheritableThreadLocal</code>ï¼Œä¸ä»…ä»…æ˜¯å› ä¸ºå®ƒå…·æœ‰ <code>ThreadLocal</code> ç›¸åŒçš„ç¼ºç‚¹â€”â€”å¯èƒ½å¯¼è‡´å†…å­˜æ³„éœ²ï¼Œæ›´é‡è¦çš„åŸå› æ˜¯ï¼šçº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„åˆ›å»ºæ˜¯åŠ¨æ€çš„ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´ç»§æ‰¿å…³ç³»é”™ä¹±ï¼Œå¦‚æœä½ çš„ä¸šåŠ¡é€»è¾‘ä¾èµ– <code>InheritableThreadLocal</code>ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½å¯¼è‡´ä¸šåŠ¡é€»è¾‘è®¡ç®—é”™è¯¯ï¼Œè€Œè¿™ä¸ªé”™è¯¯å¾€å¾€æ¯”å†…å­˜æ³„éœ²æ›´è¦å‘½ã€‚</p>`,20),Z={href:"https://blog.csdn.net/ni357103403/article/details/51970748",target:"_blank",rel:"noopener noreferrer"},$=p(`<h2 id="immutability-æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#immutability-æ¨¡å¼" aria-hidden="true">#</a> Immutability æ¨¡å¼</h2><p>è§£å†³å¹¶å‘é—®é¢˜ï¼Œå…¶å®æœ€ç®€å•çš„åŠæ³•å°±æ˜¯è®©å…±äº«å˜é‡åªæœ‰è¯»æ“ä½œï¼Œè€Œæ²¡æœ‰å†™æ“ä½œã€‚è¿™ä¸ªåŠæ³•å¦‚æ­¤é‡è¦ï¼Œä»¥è‡³äºè¢«ä¸Šå‡åˆ°äº†ä¸€ç§è§£å†³å¹¶å‘é—®é¢˜çš„è®¾è®¡æ¨¡å¼ï¼š<strong>ä¸å˜æ€§ï¼ˆImmutabilityï¼‰æ¨¡å¼</strong>ã€‚æ‰€è°“<strong>ä¸å˜æ€§ï¼Œæ˜¯æŒ‡ï¼šä¸€æ—¦åˆ›å»ºï¼ŒçŠ¶æ€ä¸å†å˜åŒ–</strong>ã€‚æ¢å¥è¯è¯´ï¼Œå°±æ˜¯å˜é‡ä¸€æ—¦è¢«èµ‹å€¼ï¼Œå°±ä¸å…è®¸ä¿®æ”¹äº†ï¼ˆæ²¡æœ‰å†™æ“ä½œï¼‰ï¼›æ²¡æœ‰ä¿®æ”¹æ“ä½œï¼Œä¹Ÿå°±æ˜¯ä¿æŒäº†ä¸å˜æ€§ã€‚</p><h3 id="å¿«é€Ÿå®ç°å…·å¤‡ä¸å¯å˜æ€§çš„ç±»" tabindex="-1"><a class="header-anchor" href="#å¿«é€Ÿå®ç°å…·å¤‡ä¸å¯å˜æ€§çš„ç±»" aria-hidden="true">#</a> å¿«é€Ÿå®ç°å…·å¤‡ä¸å¯å˜æ€§çš„ç±»</h3><p><strong>å°†ä¸€ä¸ªç±»æ‰€æœ‰çš„å±æ€§éƒ½è®¾ç½®æˆ final çš„ï¼Œå¹¶ä¸”åªå…è®¸å­˜åœ¨åªè¯»æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»åŸºæœ¬ä¸Šå°±å…·å¤‡ä¸å¯å˜æ€§äº†</strong>ã€‚æ›´ä¸¥æ ¼çš„åšæ³•æ˜¯<strong>è¿™ä¸ªç±»æœ¬èº«ä¹Ÿæ˜¯ final çš„</strong>ï¼Œä¹Ÿå°±æ˜¯ä¸å…è®¸ç»§æ‰¿ã€‚å› ä¸ºå­ç±»å¯ä»¥è¦†ç›–çˆ¶ç±»çš„æ–¹æ³•ï¼Œæœ‰å¯èƒ½æ”¹å˜ä¸å¯å˜æ€§ï¼Œæ‰€ä»¥æ¨èä½ åœ¨å®é™…å·¥ä½œä¸­ï¼Œä½¿ç”¨è¿™ç§æ›´ä¸¥æ ¼çš„åšæ³•ã€‚</p><p>åœ¨ Java ä¸­ï¼Œç»å¸¸ç”¨åˆ°çš„ <code>String</code> å’Œ <code>Long</code>ã€<code>Integer</code>ã€<code>Double</code> ç­‰åŸºç¡€ç±»å‹çš„åŒ…è£…ç±»éƒ½å…·å¤‡ä¸å¯å˜æ€§ï¼Œè¿™äº›å¯¹è±¡çš„çº¿ç¨‹å®‰å…¨æ€§éƒ½æ˜¯é ä¸å¯å˜æ€§æ¥ä¿è¯çš„ã€‚å¦‚æœä½ ä»”ç»†ç¿»çœ‹è¿™äº›ç±»çš„å£°æ˜ã€å±æ€§å’Œæ–¹æ³•ï¼Œä½ ä¼šå‘ç°å®ƒä»¬éƒ½ä¸¥æ ¼éµå®ˆä¸å¯å˜ç±»çš„ä¸‰ç‚¹è¦æ±‚ï¼š<strong>ç±»å’Œå±æ€§éƒ½æ˜¯ final çš„ï¼Œæ‰€æœ‰æ–¹æ³•å‡æ˜¯åªè¯»çš„</strong>ã€‚</p><p><code>String</code> è¿™ä¸ªç±»è™½ç„¶æœ‰æ›¿æ¢æ“ä½œï¼Œä½†å®é™…ä»æ˜¯åªè¯»çš„ã€‚é˜…è¯» <code>String</code> æºç å¯ä»¥å‘ç°ï¼š<code>String</code> è¿™ä¸ªç±»ä»¥åŠå®ƒçš„å±æ€§ <code>value[]</code> éƒ½æ˜¯ <code>final</code> çš„ï¼›è€Œ <code>replace()</code> æ–¹æ³•çš„å®ç°ï¼Œå°±çš„ç¡®æ²¡æœ‰ä¿®æ”¹ <code>value[]</code>ï¼Œè€Œæ˜¯å°†æ›¿æ¢åçš„å­—ç¬¦ä¸²ä½œä¸ºè¿”å›å€¼è¿”å›äº†ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">String</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">char</span> value<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// å­—ç¬¦æ›¿æ¢</span>
  <span class="token class-name">String</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token keyword">char</span> oldChar<span class="token punctuation">,</span>
      <span class="token keyword">char</span> newChar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//æ— éœ€æ›¿æ¢ï¼Œç›´æ¥è¿”å› this</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldChar <span class="token operator">==</span> newChar<span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> len <span class="token operator">=</span> value<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">/* avoid getfield opcode */</span>
    <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> val <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token comment">//å®šä½åˆ°éœ€è¦æ›¿æ¢çš„å­—ç¬¦ä½ç½®</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">++</span>i <span class="token operator">&lt;</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>val<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> oldChar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//æœªæ‰¾åˆ° oldCharï¼Œæ— éœ€æ›¿æ¢</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//åˆ›å»ºä¸€ä¸ª buf[]ï¼Œè¿™æ˜¯å…³é”®</span>
    <span class="token comment">//ç”¨æ¥ä¿å­˜æ›¿æ¢åçš„å­—ç¬¦ä¸²</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> i<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      buf<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> val<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">char</span> c <span class="token operator">=</span> val<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> oldChar<span class="token punctuation">)</span> <span class="token operator">?</span>
        newChar <span class="token operator">:</span> c<span class="token punctuation">;</span>
      i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//åˆ›å»ºä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²è¿”å›</span>
    <span class="token comment">//åŸå­—ç¬¦ä¸²ä¸ä¼šå‘ç”Ÿä»»ä½•å˜åŒ–</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡åˆ†æ <code>String</code> çš„å®ç°ï¼Œä½ å¯èƒ½å·²ç»å‘ç°äº†ï¼Œå¦‚æœå…·å¤‡ä¸å¯å˜æ€§çš„ç±»ï¼Œéœ€è¦æä¾›ç±»ä¼¼ä¿®æ”¹çš„åŠŸèƒ½ï¼Œå…·ä½“è¯¥æ€ä¹ˆæ“ä½œå‘¢ï¼Ÿåšæ³•å¾ˆç®€å•ï¼Œé‚£å°±æ˜¯<strong>åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸å¯å˜å¯¹è±¡</strong>ï¼Œè¿™æ˜¯ä¸å¯å˜å¯¹è±¡çš„ä¸€ä¸ªé‡è¦åŒºåˆ«ï¼Œå¯å˜å¯¹è±¡å¾€å¾€æ˜¯ä¿®æ”¹è‡ªå·±çš„å±æ€§ã€‚</p><h3 id="ä½¿ç”¨-immutability-æ¨¡å¼çš„æ³¨æ„äº‹é¡¹" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨-immutability-æ¨¡å¼çš„æ³¨æ„äº‹é¡¹" aria-hidden="true">#</a> ä½¿ç”¨ Immutability æ¨¡å¼çš„æ³¨æ„äº‹é¡¹</h3><p>åœ¨ä½¿ç”¨ Immutability æ¨¡å¼çš„æ—¶å€™ï¼Œéœ€è¦æ³¨æ„ä»¥ä¸‹ä¸¤ç‚¹ï¼š</p><ol><li>å¯¹è±¡çš„æ‰€æœ‰å±æ€§éƒ½æ˜¯ final çš„ï¼Œå¹¶ä¸èƒ½ä¿è¯ä¸å¯å˜æ€§ï¼›</li><li>ä¸å¯å˜å¯¹è±¡ä¹Ÿéœ€è¦æ­£ç¡®å‘å¸ƒã€‚</li></ol><p>åœ¨ Java è¯­è¨€ä¸­ï¼Œfinal ä¿®é¥°çš„å±æ€§ä¸€æ—¦è¢«èµ‹å€¼ï¼Œå°±ä¸å¯ä»¥å†ä¿®æ”¹ï¼Œä½†æ˜¯å¦‚æœå±æ€§çš„ç±»å‹æ˜¯æ™®é€šå¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªæ™®é€šå¯¹è±¡çš„å±æ€§æ˜¯å¯ä»¥è¢«ä¿®æ”¹çš„ã€‚ä¾‹å¦‚ä¸‹é¢çš„ä»£ç ä¸­ï¼ŒBar çš„å±æ€§ foo è™½ç„¶æ˜¯ final çš„ï¼Œä¾ç„¶å¯ä»¥é€šè¿‡ setAge() æ–¹æ³•æ¥è®¾ç½® foo çš„å±æ€§ ageã€‚æ‰€ä»¥ï¼Œ<strong>åœ¨ä½¿ç”¨ Immutability æ¨¡å¼çš„æ—¶å€™ä¸€å®šè¦ç¡®è®¤ä¿æŒä¸å˜æ€§çš„è¾¹ç•Œåœ¨å“ªé‡Œï¼Œæ˜¯å¦è¦æ±‚å±æ€§å¯¹è±¡ä¹Ÿå…·å¤‡ä¸å¯å˜æ€§</strong>ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Foo</span><span class="token punctuation">{</span>
  <span class="token keyword">int</span> age<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> name<span class="token operator">=</span><span class="token string">&quot;abc&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Bar</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> <span class="token class-name">Foo</span> foo<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span><span class="token punctuation">{</span>
    foo<span class="token punctuation">.</span>age<span class="token operator">=</span>a<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸å¯å˜å¯¹è±¡è™½ç„¶æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯å¹¶ä¸æ„å‘³ç€å¼•ç”¨è¿™äº›ä¸å¯å˜å¯¹è±¡çš„å¯¹è±¡å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ä¾‹å¦‚åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼ŒFoo å…·å¤‡ä¸å¯å˜æ€§ï¼Œçº¿ç¨‹å®‰å…¨ï¼Œä½†æ˜¯ç±» Bar å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œç±» Bar ä¸­æŒæœ‰å¯¹ Foo çš„å¼•ç”¨ fooï¼Œå¯¹ foo è¿™ä¸ªå¼•ç”¨çš„ä¿®æ”¹åœ¨å¤šçº¿ç¨‹ä¸­å¹¶ä¸èƒ½ä¿è¯å¯è§æ€§å’ŒåŸå­æ€§ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">//Foo çº¿ç¨‹å®‰å…¨</span>
<span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Foo</span><span class="token punctuation">{</span>
  <span class="token keyword">final</span> <span class="token keyword">int</span> age<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token keyword">int</span> name<span class="token operator">=</span><span class="token string">&quot;abc&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//Bar çº¿ç¨‹ä¸å®‰å…¨</span>
<span class="token keyword">class</span> <span class="token class-name">Bar</span> <span class="token punctuation">{</span>
  <span class="token class-name">Foo</span> foo<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">setFoo</span><span class="token punctuation">(</span><span class="token class-name">Foo</span> f<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>foo<span class="token operator">=</span>f<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœä½ çš„ç¨‹åºä»…ä»…éœ€è¦ foo ä¿æŒå¯è§æ€§ï¼Œæ— éœ€ä¿è¯åŸå­æ€§ï¼Œé‚£ä¹ˆå¯ä»¥å°† foo å£°æ˜ä¸º volatile å˜é‡ï¼Œè¿™æ ·å°±èƒ½ä¿è¯å¯è§æ€§ã€‚å¦‚æœä½ çš„ç¨‹åºéœ€è¦ä¿è¯åŸå­æ€§ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡åŸå­ç±»æ¥å®ç°ã€‚ä¸‹é¢çš„ç¤ºä¾‹ä»£ç æ˜¯åˆç†åº“å­˜çš„åŸå­åŒ–å®ç°ï¼Œä½ åº”è¯¥å¾ˆç†Ÿæ‚‰äº†ï¼Œå…¶ä¸­å°±æ˜¯ç”¨åŸå­ç±»è§£å†³äº†ä¸å¯å˜å¯¹è±¡å¼•ç”¨çš„åŸå­æ€§é—®é¢˜ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SafeWM</span> <span class="token punctuation">{</span>

    <span class="token keyword">class</span> <span class="token class-name">WMRange</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> upper<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> lower<span class="token punctuation">;</span>
        <span class="token class-name">WMRange</span><span class="token punctuation">(</span><span class="token keyword">int</span> upper<span class="token punctuation">,</span> <span class="token keyword">int</span> lower<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//çœç•¥æ„é€ å‡½æ•°å®ç°</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WMRange</span><span class="token punctuation">&gt;</span></span> rf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WMRange</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è®¾ç½®åº“å­˜ä¸Šé™</span>
    <span class="token keyword">void</span> <span class="token function">setUpper</span><span class="token punctuation">(</span><span class="token keyword">int</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">WMRange</span> or <span class="token operator">=</span> rf<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ£€æŸ¥å‚æ•°åˆæ³•æ€§</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">&lt;</span> or<span class="token punctuation">.</span>lower<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">WMRange</span> nr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WMRange</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> or<span class="token punctuation">.</span>lower<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rf<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>or<span class="token punctuation">,</span> nr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="copy-on-write-æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#copy-on-write-æ¨¡å¼" aria-hidden="true">#</a> Copy-on-Write æ¨¡å¼</h2><p>æ‰€è°“ Copy-on-Writeï¼Œç»å¸¸è¢«ç¼©å†™ä¸º CoWï¼Œé¡¾åæ€ä¹‰å°±æ˜¯<strong>å†™æ—¶å¤åˆ¶</strong>ã€‚</p><p>Java æ”¯æŒ <code>CopyOnWriteArrayList</code> å’Œ <code>CopyOnWriteArraySet</code> ä¸¤ç§å¹¶å‘å®¹å™¨ï¼Œå…¶è®¾è®¡æ€æƒ³å°±æ˜¯ CoWï¼›é€šè¿‡ Copy-on-Write è¿™ä¸¤ä¸ªå®¹å™¨å®ç°çš„è¯»æ“ä½œæ˜¯æ— é”çš„ï¼Œç”±äºæ— é”ï¼Œæ‰€ä»¥å°†è¯»æ“ä½œçš„æ€§èƒ½å‘æŒ¥åˆ°äº†æè‡´ã€‚</p><p>CoW æ˜¯ä¸€é¡¹éå¸¸é€šç”¨çš„æŠ€æœ¯æ–¹æ¡ˆï¼Œåœ¨å¾ˆå¤šé¢†åŸŸéƒ½æœ‰ç€å¹¿æ³›çš„åº”ç”¨ã€‚ä¸è¿‡ï¼Œå®ƒä¹Ÿæœ‰ç¼ºç‚¹çš„ï¼Œé‚£å°±æ˜¯æ¶ˆè€—å†…å­˜ï¼Œæ¯æ¬¡ä¿®æ”¹éƒ½éœ€è¦å¤åˆ¶ä¸€ä¸ªæ–°çš„å‰¯æœ¬å‡ºæ¥ã€‚</p><h2 id="å‚è€ƒèµ„æ–™" tabindex="-1"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™" aria-hidden="true">#</a> å‚è€ƒèµ„æ–™</h2>`,22),nn={href:"https://book.douban.com/subject/10484692/",target:"_blank",rel:"noopener noreferrer"},sn={href:"https://book.douban.com/subject/26591326/",target:"_blank",rel:"noopener noreferrer"},an={href:"https://book.douban.com/subject/34907497/",target:"_blank",rel:"noopener noreferrer"},en={href:"https://time.geekbang.org/column/intro/100047701",target:"_blank",rel:"noopener noreferrer"},tn={href:"http://tutorials.jenkov.com/java-concurrency/non-blocking-algorithms.html",target:"_blank",rel:"noopener noreferrer"},on={href:"https://www.jianshu.com/p/473e14d5ab2d",target:"_blank",rel:"noopener noreferrer"},cn={href:"https://blog.csdn.net/ls5718/article/details/52563959",target:"_blank",rel:"noopener noreferrer"},pn={href:"http://www.itsoku.com/article/182",target:"_blank",rel:"noopener noreferrer"},ln={href:"https://juejin.im/post/5a64a581f265da3e3b7aa02d",target:"_blank",rel:"noopener noreferrer"};function un(kn,rn){const e=i("ExternalLinkIcon"),l=i("Tabs");return k(),r("div",null,[m,n("p",null,[s("ä»¥ä¸Šç±»éƒ½æ”¯æŒ CASï¼ˆ"),n("a",v,[s("compare-and-swap"),a(e)]),s("ï¼‰æŠ€æœ¯ï¼Œæ­¤å¤–ï¼Œ"),b,s("ã€"),h,s(" è¿˜æ”¯æŒç®—æœ¯è¿ç®—ã€‚")]),g,n("p",null,[s("Java æ•°æ®ç±»å‹åˆ†ä¸º "),w,s(" å’Œ "),y,s(" ä¸¤å¤§ç±»ï¼ˆä¸äº†è§£ Java æ•°æ®ç±»å‹åˆ’åˆ†å¯ä»¥å‚è€ƒï¼š "),n("a",f,[s("Java åŸºæœ¬æ•°æ®ç±»å‹"),a(e)]),s(" ï¼‰ã€‚")]),A,a(l,{id:"493",data:[{id:"<code v-pre>AtomicReference</code> ä½¿ç”¨ç¤ºä¾‹"},{id:"<code v-pre>AtomicMarkableReference</code> ä½¿ç”¨ç¤ºä¾‹"},{id:"<code v-pre>AtomicStampedReference</code> ä½¿ç”¨ç¤ºä¾‹"}],"tab-id":"åŸå­ç±»ä¹‹å¼•ç”¨ç±»å‹ç¤ºä¾‹"},{title0:t(({value:o,isActive:c})=>[S,s(" ä½¿ç”¨ç¤ºä¾‹")]),title1:t(({value:o,isActive:c})=>[T,s(" ä½¿ç”¨ç¤ºä¾‹")]),title2:t(({value:o,isActive:c})=>[x,s(" ä½¿ç”¨ç¤ºä¾‹")]),tab0:t(({value:o,isActive:c})=>[L,_]),tab1:t(({value:o,isActive:c})=>[j,n("p",null,[s("åŸå­ç±»çš„å®ç°åŸºäº CAS æœºåˆ¶ï¼Œè€Œ CAS å­˜åœ¨ ABA é—®é¢˜ï¼ˆä¸äº†è§£ ABA é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒï¼š"),n("a",I,[s("Java å¹¶å‘ä¹‹å†…å­˜æ¨¡å‹"),a(e)]),s("ï¼‰ã€‚æ­£æ˜¯ä¸ºäº†è§£å†³ ABA é—®é¢˜ï¼Œæ‰æœ‰äº† "),C,s(" å’Œ "),R,s("ã€‚")]),q,M]),tab2:t(({value:o,isActive:c})=>[U,E,F]),_:1}),J,a(l,{id:"677",data:[{id:"æ•°æ®åº“è¿æ¥"},{id:"Session ç®¡ç†"},{id:"çº¿ç¨‹å®‰å…¨çš„ <code v-pre>SimpleDateFormat</code>"},{id:"å®Œæ•´ä½¿ç”¨ <code v-pre>ThreadLocal</code> ç¤ºä¾‹"}],"tab-id":"ThreadLocal åº”ç”¨ç¤ºä¾‹"},{title0:t(({value:o,isActive:c})=>[s("æ•°æ®åº“è¿æ¥")]),title1:t(({value:o,isActive:c})=>[s("Session ç®¡ç†")]),title2:t(({value:o,isActive:c})=>[s("çº¿ç¨‹å®‰å…¨çš„ "),D]),title3:t(({value:o,isActive:c})=>[s("å®Œæ•´ä½¿ç”¨ "),B,s(" ç¤ºä¾‹")]),tab0:t(({value:o,isActive:c})=>[N,O]),tab1:t(({value:o,isActive:c})=>[V,W]),tab2:t(({value:o,isActive:c})=>[P,H,G]),tab3:t(({value:o,isActive:c})=>[z,X]),_:1}),K,n("blockquote",null,[n("p",null,[s("ç¤ºä¾‹æ‘˜è‡ªï¼š"),n("a",Q,[s("æå®¢æ—¶é—´æ•™ç¨‹ - Java ä¸šåŠ¡å¼€å‘å¸¸è§é”™è¯¯ 100 ä¾‹"),a(e)])])]),Y,n("blockquote",null,[n("p",null,[s("åŸç†å‚è€ƒï¼š"),n("a",Z,[s("Java å¤šçº¿ç¨‹ï¼šInheritableThreadLocal å®ç°åŸç†"),a(e)])])]),$,n("ul",null,[n("li",null,[n("a",nn,[s("ã€ŠJava å¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹"),a(e)])]),n("li",null,[n("a",sn,[s("ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹"),a(e)])]),n("li",null,[n("a",an,[s("ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºã€‹"),a(e)])]),n("li",null,[n("a",en,[s("æå®¢æ—¶é—´æ•™ç¨‹ - Java ä¸šåŠ¡å¼€å‘å¸¸è§é”™è¯¯ 100 ä¾‹"),a(e)])]),n("li",null,[n("a",tn,[s("Non-blocking Algorithms"),a(e)])]),n("li",null,[n("a",on,[s("Java CAS å®Œå…¨è§£è¯»"),a(e)])]),n("li",null,[n("a",cn,[s("Java ä¸­ CAS è¯¦è§£"),a(e)])]),n("li",null,[n("a",pn,[s("JUC ä¸­çš„åŸå­ç±»"),a(e)])]),n("li",null,[n("a",ln,[s("ThreadLocal ç»ˆæç¯‡"),a(e)])])])])}const vn=u(d,[["render",un],["__file","index.html.vue"]]);export{vn as default};
