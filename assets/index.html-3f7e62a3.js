import{_ as o}from"./plugin-vue_export-helper-c27b6911.js";import{r as p,o as l,c as i,a,b as n,d as e,e as t}from"./app-38fe414d.js";const c={},r=t(`<h1 id="版本管理中间件-flyway" tabindex="-1"><a class="header-anchor" href="#版本管理中间件-flyway" aria-hidden="true">#</a> 版本管理中间件 Flyway</h1><blockquote><p>Flyway 是一个数据迁移工具。</p></blockquote><h2 id="简介" tabindex="-1"><a class="header-anchor" href="#简介" aria-hidden="true">#</a> 简介</h2><h3 id="什么是-flyway" tabindex="-1"><a class="header-anchor" href="#什么是-flyway" aria-hidden="true">#</a> 什么是 Flyway</h3><p><strong>Flyway 是一个开源的数据库迁移工具。</strong></p><h3 id="为什么要使用数据迁移" tabindex="-1"><a class="header-anchor" href="#为什么要使用数据迁移" aria-hidden="true">#</a> 为什么要使用数据迁移</h3><p>为了说明数据迁移的作用，我们来举一个示例：</p><p>（1）假设，有一个叫做 Shiny 的项目，它的架构是一个叫做 Shiny Soft 的 App 连接叫做 Shiny DB 的数据库。</p><p>（2）对于大多数项目而言，最简单的持续集成场景如下所示：</p><figure><img src="https://flywaydb.org/assets/balsamiq/Environments.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>这意味着，我们不仅仅要处理一份环境中的修改，由此会引入一些版本冲突问题：</p><p>在代码侧（即应用软件）的版本问题比较容易解决：</p><ul><li>有方便的版本控制工具</li><li>有可复用的构建和持续集成</li><li>规范的发布和部署过程</li></ul><p>那么，数据库层面的版本问题如何解决呢？</p><p>目前仍然没有方便的数据库版本工具。许多项目仍使用 sql 脚本来解决版本冲突，甚至是遇到冲突问题时才想起用 sql 语句去解决。</p><p>由此，引发一些问题：</p><ul><li>机器上的数据库是什么状态？</li><li>脚本到底生效没有？</li><li>生产环境修复的问题是否也在测试环境修复了？</li><li>如何建立一个新的数据库实例？</li></ul><p>数据迁移就是用来搞定这些混乱的问题：</p><ul><li>通过草稿重建一个数据库。</li><li>在任何时候都可以清楚的了解数据库的状态。</li><li>以一种明确的方式将数据库从当前版本迁移到一个新版本。</li></ul><h3 id="flyway-如何工作" tabindex="-1"><a class="header-anchor" href="#flyway-如何工作" aria-hidden="true">#</a> Flyway 如何工作？</h3><p>最简单的场景是指定 Flyway 迁移到一个空的数据库。</p><figure><img src="http://upload-images.jianshu.io/upload_images/3101171-bb6e9f39e56ebbda.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>Flyway 会尝试查找它的 schema 历史表，如果数据库是空的，Flyway 就不再查找，而是直接创建数据库。</p><p>现再你就有了一个仅包含一张空表的数据库，默认情况下，这张表叫 <strong>flyway_schema_history</strong>。</p><figure><img src="http://upload-images.jianshu.io/upload_images/3101171-410eb31c6313b389.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>这张表将被用于追踪数据库的状态。</p><p>然后，Flyway 将开始扫描文件系统或应用 classpath 中的 <strong>migrations</strong>。这些 <strong>migrations</strong> 可以是 sql 或 java。</p><p>这些 <strong>migrations</strong> 将根据他们的版本号进行排序。</p><figure><img src="http://upload-images.jianshu.io/upload_images/3101171-d36ee07ada4efbcd.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>任意 migration 应用后，schema 历史表将更新。当元数据和初始状态替换后，可以称之为：迁移到新版本。</p><p>Flyway 一旦扫描了文件系统或应用 classpath 下的 migrations，这些 migrations 会检查 schema 历史表。如果它们的版本号低于或等于当前的版本，将被忽略。保留下来的 migrations 是等待的 migrations，有效但没有应用。</p><figure><img src="http://upload-images.jianshu.io/upload_images/3101171-99a88fea7a31a070.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>migrations 将根据版本号排序并按序执行。</p><figure><img src="http://upload-images.jianshu.io/upload_images/3101171-b444fef6e5c13b71.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h2 id="快速上手" tabindex="-1"><a class="header-anchor" href="#快速上手" aria-hidden="true">#</a> 快速上手</h2><p>Flyway 有 4 种使用方式：</p><ul><li>命令行</li><li>JAVA API</li><li>Maven</li><li>Gradle</li></ul><h3 id="命令行" tabindex="-1"><a class="header-anchor" href="#命令行" aria-hidden="true">#</a> 命令行</h3><p>适用于非 Java 用户，无需构建。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token operator">&gt;</span> flyway migrate <span class="token parameter variable">-url</span><span class="token operator">=</span><span class="token punctuation">..</span>. <span class="token parameter variable">-user</span><span class="token operator">=</span><span class="token punctuation">..</span>. <span class="token parameter variable">-password</span><span class="token operator">=</span><span class="token punctuation">..</span>.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>（1）<strong>下载解压</strong></p>`,41),d={href:"https://flywaydb.org/download/",target:"_blank",rel:"noopener noreferrer"},u=t(`<p>（2）<strong>配置 flyway</strong></p><p>编辑 <code>/conf/flyway.conf</code>：</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token key attr-name">flyway.url</span><span class="token punctuation">=</span><span class="token value attr-value">jdbc:h2:file:./foobardb</span>
<span class="token key attr-name">flyway.user</span><span class="token punctuation">=</span><span class="token value attr-value">SA</span>
<span class="token key attr-name">flyway.password</span><span class="token punctuation">=</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）<strong>创建第一个 migration</strong></p><p>在 <code>/sql</code> 目录下创建 <code>V1__Create_person_table.sql</code> 文件，内容如下：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> PERSON <span class="token punctuation">(</span>
    ID <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    NAME <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（4）<strong>迁移数据库</strong></p><p>运行 Flyway 来迁移数据库：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>flyway-5.1.<span class="token operator"><span class="token file-descriptor important">4</span>&gt;</span> flyway migrate
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>运行正常的情况下，应该可以看到如下结果：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Database: jdbc:h2:file:./foobardb (H2 1.4)
Successfully validated 1 migration (execution time 00:00.008s)
Creating Schema History table: &quot;PUBLIC&quot;.&quot;flyway_schema_history&quot;
Current version of schema &quot;PUBLIC&quot;: &lt;&lt; Empty Schema &gt;&gt;
Migrating schema &quot;PUBLIC&quot; to version 1 - Create person table
Successfully applied 1 migration to schema &quot;PUBLIC&quot; (execution time 00:00.033s)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（5）<strong>添加第二个 migration</strong></p><p>在 <code>/sql</code> 目录下创建 <code>V2__Add_people.sql</code> 文件，内容如下：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> PERSON <span class="token punctuation">(</span>ID<span class="token punctuation">,</span> NAME<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&#39;Axel&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> PERSON <span class="token punctuation">(</span>ID<span class="token punctuation">,</span> NAME<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&#39;Mr. Foo&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> PERSON <span class="token punctuation">(</span>ID<span class="token punctuation">,</span> NAME<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&#39;Ms. Bar&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行 Flyway</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>flyway-5.1.<span class="token operator"><span class="token file-descriptor important">4</span>&gt;</span> flyway migrate
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>运行正常的情况下，应该可以看到如下结果：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Database: jdbc:h2:file:./foobardb (H2 1.4)
Successfully validated 2 migrations (execution time 00:00.018s)
Current version of schema &quot;PUBLIC&quot;: 1
Migrating schema &quot;PUBLIC&quot; to version 2 - Add people
Successfully applied 1 migration to schema &quot;PUBLIC&quot; (execution time 00:00.016s)
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="java-api" tabindex="-1"><a class="header-anchor" href="#java-api" aria-hidden="true">#</a> JAVA API</h3><p>（1）<strong>准备</strong></p><ul><li>Java8+</li><li>Maven 3.x</li></ul><p>（2）<strong>添加依赖</strong></p><p>在 <code>pom.xml</code> 中添加依赖：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">...</span><span class="token punctuation">&gt;</span></span>
    ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.flywaydb<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flyway-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.h2database<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>h2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.3.170<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）<strong>集成 Flyway</strong></p><p>添加 <code>App.java</code> 文件，内容如下：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>flywaydb<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Flyway</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Create the Flyway instance</span>
        <span class="token class-name">Flyway</span> flyway <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Flyway</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Point it to the database</span>
        flyway<span class="token punctuation">.</span><span class="token function">setDataSource</span><span class="token punctuation">(</span><span class="token string">&quot;jdbc:h2:file:./target/foobar&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sa&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Start the migration</span>
        flyway<span class="token punctuation">.</span><span class="token function">migrate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（4）<strong>创建第一个 migration</strong></p><p>添加 <code>src/main/resources/db/migration/V1__Create_person_table.sql</code> 文件，内容如下：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> PERSON <span class="token punctuation">(</span>
    ID <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    NAME <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（5）<strong>执行程序</strong></p><p>执行 <code>App#main</code>：</p><p>运行正常的情况下，应该可以看到如下结果：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>INFO: Creating schema history table: &quot;PUBLIC&quot;.&quot;flyway_schema_history&quot;
INFO: Current version of schema &quot;PUBLIC&quot;: &lt;&lt; Empty Schema &gt;&gt;
INFO: Migrating schema &quot;PUBLIC&quot; to version 1 - Create person table
INFO: Successfully applied 1 migration to schema &quot;PUBLIC&quot; (execution time 00:00.062s).
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（6）<strong>添加第二个 migration</strong></p><p>添加 src/main/resources/db/migration/V2__Add_people.sql 文件，内容如下：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> PERSON <span class="token punctuation">(</span>ID<span class="token punctuation">,</span> NAME<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&#39;Axel&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> PERSON <span class="token punctuation">(</span>ID<span class="token punctuation">,</span> NAME<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&#39;Mr. Foo&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> PERSON <span class="token punctuation">(</span>ID<span class="token punctuation">,</span> NAME<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&#39;Ms. Bar&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行正常的情况下，应该可以看到如下结果：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>INFO: Current version of schema &quot;PUBLIC&quot;: 1
INFO: Migrating schema &quot;PUBLIC&quot; to version 2 - Add people
INFO: Successfully applied 1 migration to schema &quot;PUBLIC&quot; (execution time 00:00.090s).
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="maven" tabindex="-1"><a class="header-anchor" href="#maven" aria-hidden="true">#</a> Maven</h3><p>与 Java API 方式大体相同，区别在 <strong>集成 Flyway</strong> 步骤：</p><p>Maven 方式使用插件来集成 Flyway：</p><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>...<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.flywaydb<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flyway-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>jdbc:h2:file:./target/foobar<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">&gt;</span></span>sa<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.h2database<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>h2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.4.191<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>因为用的是插件，所以执行方式不再是运行 Java 类，而是执行 maven 插件：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token operator">&gt;</span> mvn flyway:migrate
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,45),g={href:"https://github.com/dunwu/Database/tree/master/codes/middleware/flyway",target:"_blank",rel:"noopener noreferrer"},k=t(`<h3 id="gradle" tabindex="-1"><a class="header-anchor" href="#gradle" aria-hidden="true">#</a> Gradle</h3><p>本人不用 Gradle，略。</p><h2 id="入门篇" tabindex="-1"><a class="header-anchor" href="#入门篇" aria-hidden="true">#</a> 入门篇</h2><h3 id="概念" tabindex="-1"><a class="header-anchor" href="#概念" aria-hidden="true">#</a> 概念</h3><h4 id="migrations" tabindex="-1"><a class="header-anchor" href="#migrations" aria-hidden="true">#</a> Migrations</h4><p>在 Flyway 中，对于数据库的任何改变都称之为 <strong>Migrations</strong>。</p><p>Migrations 可以分为 Versioned migrations 和 Repeatable migrations。</p><p>Versioned migrations 有 2 种形式：regular 和 undo。</p><p>Versioned migrations 和 Repeatable migrations 都可以使用 SQL 或 JAVA 来编写。</p><h5 id="versioned-migrations" tabindex="-1"><a class="header-anchor" href="#versioned-migrations" aria-hidden="true">#</a> Versioned migrations</h5><p>由一个版本号（version）、一段描述（description）、一个校验（checksum）组成。版本号必须是惟一的。Versioned migrations 只能按顺序执行一次。</p><p>一般用于：</p><ul><li>增删改 tables/indexes/foreign keys/enums/UDTs。</li><li>引用数据更新</li><li>用户数据校正</li></ul><p>Regular 示例：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> car <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    license_plate <span class="token keyword">VARCHAR</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    color <span class="token keyword">VARCHAR</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> owner <span class="token keyword">ADD</span> driver_license_id <span class="token keyword">VARCHAR</span><span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> brand <span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&#39;DeLorean&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="undo-migrations" tabindex="-1"><a class="header-anchor" href="#undo-migrations" aria-hidden="true">#</a> Undo migrations</h5><blockquote><p>注：仅专业版支持</p></blockquote><p>Undo Versioned Migrations 负责撤销 Regular Versioned migrations 的影响。</p><p>Undo 示例：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> brand <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">&#39;DeLorean&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> owner <span class="token keyword">DROP</span> driver_license_id<span class="token punctuation">;</span>

<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> car<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="repeatable-migrations" tabindex="-1"><a class="header-anchor" href="#repeatable-migrations" aria-hidden="true">#</a> Repeatable migrations</h5><p>由一段描述（description）、一个校验（checksum）组成。Versioned migrations 每次执行后，校验（checksum）会更新。</p><p>Repeatable migrations 用于管理可以通过一个文件来维护版本控制的数据库对象。</p><p>一般用于：</p><ul><li>创建（重建）views/procedures/functions/packages 等。</li><li>大量引用数据重新插入</li></ul><p>示例：</p><div class="language-sql line-numbers-mode" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token operator">OR</span> <span class="token keyword">REPLACE</span> <span class="token keyword">VIEW</span> blue_cars <span class="token keyword">AS</span>
    <span class="token keyword">SELECT</span> id<span class="token punctuation">,</span> license_plate <span class="token keyword">FROM</span> cars <span class="token keyword">WHERE</span> color<span class="token operator">=</span><span class="token string">&#39;blue&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="基于-sql-的-migrations" tabindex="-1"><a class="header-anchor" href="#基于-sql-的-migrations" aria-hidden="true">#</a> 基于 SQL 的 migrations</h5><p>migrations 最常用的编写形式就是 SQL。</p><p>基于 SQL 的 migrations 一般用于：</p><ul><li>DDL 变更（针对 TABLES,VIEWS,TRIGGERS,SEQUENCES 等的 CREATE/ALTER/DROP 操作）</li><li>简单的引用数据变更（引用数据表中的 CRUD）</li><li>简单的大量数据变更（常规数据表中的 CRUD）</li></ul><p><strong>命名规则</strong></p><p>为了被 Flyway 自动识别，SQL migrations 的文件命名必须遵循规定的模式：</p><figure><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/database/flyway/sql-migrations.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><ul><li><strong>Prefix</strong> - <code>V</code> 代表 versioned migrations (可配置), <code>U</code> 代表 undo migrations (可配置)、 <code>R</code> 代表 repeatable migrations (可配置)</li><li><strong>Version</strong> - 版本号通过<code>.</code>(点)或<code>_</code>(下划线)分隔 (repeatable migrations 不需要)</li><li><strong>Separator</strong> - <code>__</code> (两个下划线) (可配置)</li><li><strong>Description</strong> - 下划线或空格分隔的单词</li><li><strong>Suffix</strong> - <code>.sql</code> (可配置)</li></ul><h5 id="基于-java-的-migrations" tabindex="-1"><a class="header-anchor" href="#基于-java-的-migrations" aria-hidden="true">#</a> 基于 JAVA 的 migrations</h5><p>基于 JAVA 的 migrations 适用于使用 SQL 不容易表达的场景：</p><ul><li>BLOB 和 CLOB 变更</li><li>大量数据的高级变更（重新计算、高级格式变更）</li></ul><p><strong>命名规则</strong></p><p>为了被 Flyway 自动识别，JAVA migrations 的文件命名必须遵循规定的模式：</p><figure><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/database/flyway/java-migrations.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><ul><li><strong>Prefix</strong> - <code>V</code> 代表 versioned migrations (可配置), <code>U</code> 代表 undo migrations (可配置)、 <code>R</code> 代表 repeatable migrations (可配置)</li><li><strong>Version</strong> - 版本号通过<code>.</code>(点)或<code>_</code>(下划线)分隔 (repeatable migrations 不需要)</li><li><strong>Separator</strong> - <code>__</code> (两个下划线) (可配置)</li><li><strong>Description</strong> - 下划线或空格分隔的单词</li></ul>`,42),m={href:"https://flywaydb.org/documentation/migrations",target:"_blank",rel:"noopener noreferrer"},b=t('<h4 id="callbacks" tabindex="-1"><a class="header-anchor" href="#callbacks" aria-hidden="true">#</a> Callbacks</h4><blockquote><p>注：部分 events 仅专业版支持。</p></blockquote><p>尽管 Migrations 可能已经满足绝大部分场景的需要，但是某些情况下需要你一遍又一遍的执行相同的行为。这可能会重新编译存储过程，更新视图以及许多其他类型的开销。</p><p>因为以上原因，Flyway 提供了 Callbacks，用于在 Migrations 生命周期中添加钩子。</p><p>Callbacks 可以用 SQL 或 JAVA 来实现。</p><h5 id="sql-callbacks" tabindex="-1"><a class="header-anchor" href="#sql-callbacks" aria-hidden="true">#</a> SQL Callbacks</h5><p>SQL Callbacks 的命名规则为：event 名 + SQL migration。</p><p>如： <code>beforeMigrate.sql</code>, <code>beforeEachMigrate.sql</code>, <code>afterEachMigrate.sql</code> 等。</p><p>SQL Callbacks 也可以包含描述（description）。这种情况下，SQL Callbacks 文件名 = event 名 + 分隔符 + 描述 + 后缀。例：<code>beforeRepair__vacuum.sql</code></p><p>当同一个 event 有多个 SQL callbacks，将按照它们描述（description）的顺序执行。</p><blockquote><p><strong>注：</strong> Flyway 也支持你配置的 <code>sqlMigrationSuffixes</code>。</p></blockquote><h5 id="java-callbacks" tabindex="-1"><a class="header-anchor" href="#java-callbacks" aria-hidden="true">#</a> JAVA Callbacks</h5><blockquote><p>当 SQL Callbacks 不够方便时，才应考虑 JAVA Callbacks。</p></blockquote><p>JAVA Callbacks 有 3 种形式：</p><ol><li><strong>基于 Java 的 Migrations</strong> - 实现 JdbcMigration、SpringJdbcMigration、MigrationInfoProvider、MigrationChecksumProvider、ConfigurationAware、FlywayConfiguration</li><li><strong>基于 Java 的 Callbacks</strong> - 实现 org.flywaydb.core.api.callback 接口。</li><li><strong>自定义 Migration resolvers 和 executors</strong> - 实现 MigrationResolver、MigrationExecutor、ConfigurationAware、FlywayConfiguration 接口。</li></ol>',15),v={href:"https://flywaydb.org/documentation/callbacks",target:"_blank",rel:"noopener noreferrer"},h=t('<h4 id="error-handlers" tabindex="-1"><a class="header-anchor" href="#error-handlers" aria-hidden="true">#</a> Error Handlers</h4><blockquote><p>注：仅专业版支持。</p></blockquote><p>（略）</p><h4 id="dry-runs" tabindex="-1"><a class="header-anchor" href="#dry-runs" aria-hidden="true">#</a> Dry Runs</h4><blockquote><p>注：仅专业版支持。</p></blockquote><p>（略）</p><h3 id="命令" tabindex="-1"><a class="header-anchor" href="#命令" aria-hidden="true">#</a> 命令</h3>',7),y={href:"https://flywaydb.org/documentation/command/migrate",target:"_blank",rel:"noopener noreferrer"},f={href:"https://flywaydb.org/documentation/command/clean",target:"_blank",rel:"noopener noreferrer"},w={href:"https://flywaydb.org/documentation/command/info",target:"_blank",rel:"noopener noreferrer"},_={href:"https://flywaydb.org/documentation/command/validate",target:"_blank",rel:"noopener noreferrer"},q={href:"https://flywaydb.org/documentation/command/undo",target:"_blank",rel:"noopener noreferrer"},x={href:"https://flywaydb.org/documentation/command/baseline",target:"_blank",rel:"noopener noreferrer"},A={href:"https://flywaydb.org/documentation/command/repair",target:"_blank",rel:"noopener noreferrer"},S=a("p",null,"注：各命令的使用方法细节请查阅官方文档。",-1),E=a("h3",{id:"支持的数据库",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#支持的数据库","aria-hidden":"true"},"#"),n(" 支持的数据库")],-1),I={href:"https://flywaydb.org/documentation/database/oracle",target:"_blank",rel:"noopener noreferrer"},L={href:"https://flywaydb.org/documentation/database/sqlserver",target:"_blank",rel:"noopener noreferrer"},C={href:"https://flywaydb.org/documentation/database/db2",target:"_blank",rel:"noopener noreferrer"},R={href:"https://flywaydb.org/documentation/database/mysql",target:"_blank",rel:"noopener noreferrer"},M={href:"https://flywaydb.org/documentation/database/mariadb",target:"_blank",rel:"noopener noreferrer"},F={href:"https://flywaydb.org/documentation/database/postgresql",target:"_blank",rel:"noopener noreferrer"},N={href:"https://flywaydb.org/documentation/database/redshift",target:"_blank",rel:"noopener noreferrer"},P={href:"https://flywaydb.org/documentation/database/cockroachdb",target:"_blank",rel:"noopener noreferrer"},V={href:"https://flywaydb.org/documentation/database/saphana",target:"_blank",rel:"noopener noreferrer"},D={href:"https://flywaydb.org/documentation/database/sybasease",target:"_blank",rel:"noopener noreferrer"},B={href:"https://flywaydb.org/documentation/database/informix",target:"_blank",rel:"noopener noreferrer"},O={href:"https://flywaydb.org/documentation/database/h2",target:"_blank",rel:"noopener noreferrer"},U={href:"https://flywaydb.org/documentation/database/hsqldb",target:"_blank",rel:"noopener noreferrer"},j={href:"https://flywaydb.org/documentation/database/derby",target:"_blank",rel:"noopener noreferrer"},T={href:"https://flywaydb.org/documentation/database/sqlite",target:"_blank",rel:"noopener noreferrer"},Q=a("h2",{id:"资料",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#资料","aria-hidden":"true"},"#"),n(" 资料")],-1),J={href:"https://github.com/flyway/flyway",target:"_blank",rel:"noopener noreferrer"},H={href:"https://flywaydb.org/",target:"_blank",rel:"noopener noreferrer"},z=a("h2",{id:"🚪-传送",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#🚪-传送","aria-hidden":"true"},"#"),n(" 🚪 传送")],-1),G={href:"https://dunwu.github.io/waterdrop/",target:"_blank",rel:"noopener noreferrer"};function W(Y,K){const s=p("ExternalLinkIcon");return l(),i("div",null,[r,a("p",null,[n("进入"),a("a",d,[n("官方下载页面"),e(s)]),n("，选择合适版本，下载并解压到本地。")]),u,a("blockquote",null,[a("p",null,[n("👉 参考："),a("a",g,[n("示例源码"),e(s)])])]),k,a("blockquote",null,[a("p",null,[n("👉 更多细节请参考："),a("a",m,[n("https://flywaydb.org/documentation/migrations"),e(s)])])]),b,a("blockquote",null,[a("p",null,[n("👉 更多细节请参考："),a("a",v,[n("https://flywaydb.org/documentation/callbacks"),e(s)])])]),h,a("p",null,[n("Flyway 的功能主要围绕着 7 个基本命令："),a("a",y,[n("Migrate"),e(s)]),n("、"),a("a",f,[n("Clean"),e(s)]),n("、"),a("a",w,[n("Info"),e(s)]),n("、"),a("a",_,[n("Validate"),e(s)]),n("、"),a("a",q,[n("Undo"),e(s)]),n("、"),a("a",x,[n("Baseline"),e(s)]),n(" 和 "),a("a",A,[n("Repair"),e(s)]),n("。")]),S,E,a("ul",null,[a("li",null,[a("a",I,[n("Oracle"),e(s)])]),a("li",null,[a("a",L,[n("SQL Server"),e(s)])]),a("li",null,[a("a",C,[n("DB2"),e(s)])]),a("li",null,[a("a",R,[n("MySQL"),e(s)])]),a("li",null,[a("a",M,[n("MariaDB"),e(s)])]),a("li",null,[a("a",F,[n("PostgreSQL"),e(s)])]),a("li",null,[a("a",N,[n("Redshift"),e(s)])]),a("li",null,[a("a",P,[n("CockroachDB"),e(s)])]),a("li",null,[a("a",V,[n("SAP HANA"),e(s)])]),a("li",null,[a("a",D,[n("Sybase ASE"),e(s)])]),a("li",null,[a("a",B,[n("Informix"),e(s)])]),a("li",null,[a("a",O,[n("H2"),e(s)])]),a("li",null,[a("a",U,[n("HSQLDB"),e(s)])]),a("li",null,[a("a",j,[n("Derby"),e(s)])]),a("li",null,[a("a",T,[n("SQLite"),e(s)])])]),Q,a("p",null,[n("| "),a("a",J,[n("Github"),e(s)]),n(" | "),a("a",H,[n("官方文档"),e(s)]),n(" |")]),z,a("p",null,[n("◾ 💧 "),a("a",G,[n("钝悟的 IT 知识图谱"),e(s)]),n(" ◾")])])}const $=o(c,[["render",W],["__file","index.html.vue"]]);export{$ as default};
