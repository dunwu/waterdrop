import{_ as e}from"./plugin-vue_export-helper-c27b6911.js";import{r as o,o as c,c as l,a as n,b as s,d as t,e as p}from"./app-0e67a029.js";const i={},u=p('<h1 id="java-å¹¶å‘ä¹‹å®¹å™¨" tabindex="-1"><a class="header-anchor" href="#java-å¹¶å‘ä¹‹å®¹å™¨" aria-hidden="true">#</a> Java å¹¶å‘ä¹‹å®¹å™¨</h1><h2 id="åŒæ­¥å®¹å™¨" tabindex="-1"><a class="header-anchor" href="#åŒæ­¥å®¹å™¨" aria-hidden="true">#</a> åŒæ­¥å®¹å™¨</h2><h3 id="åŒæ­¥å®¹å™¨ç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#åŒæ­¥å®¹å™¨ç®€ä»‹" aria-hidden="true">#</a> åŒæ­¥å®¹å™¨ç®€ä»‹</h3><p>åœ¨ Java ä¸­ï¼ŒåŒæ­¥å®¹å™¨ä¸»è¦åŒ…æ‹¬ 2 ç±»ï¼š</p><ul><li><code>Vector</code>ã€<code>Stack</code>ã€<code>Hashtable</code><ul><li><code>Vector</code> - <code>Vector</code> å®ç°äº† <code>List</code> æ¥å£ã€‚<code>Vector</code> å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå’Œ <code>ArrayList</code> ç±»ä¼¼ã€‚ä½†æ˜¯ <code>Vector</code> ä¸­çš„æ–¹æ³•éƒ½æ˜¯ <code>synchronized</code> æ–¹æ³•ï¼Œå³è¿›è¡Œäº†åŒæ­¥æªæ–½ã€‚</li><li><code>Stack</code> - <code>Stack</code> ä¹Ÿæ˜¯ä¸€ä¸ªåŒæ­¥å®¹å™¨ï¼Œå®ƒçš„æ–¹æ³•ä¹Ÿç”¨ <code>synchronized</code> è¿›è¡Œäº†åŒæ­¥ï¼Œå®ƒå®é™…ä¸Šæ˜¯ç»§æ‰¿äº <code>Vector</code> ç±»ã€‚</li><li><code>Hashtable</code>- <code>Hashtable</code> å®ç°äº† <code>Map</code> æ¥å£ï¼Œå®ƒå’Œ <code>HashMap</code> å¾ˆç›¸ä¼¼ï¼Œä½†æ˜¯ <code>Hashtable</code> è¿›è¡Œäº†åŒæ­¥å¤„ç†ï¼Œè€Œ <code>HashMap</code> æ²¡æœ‰ã€‚</li></ul></li><li><code>Collections</code> ç±»ä¸­æä¾›çš„é™æ€å·¥å‚æ–¹æ³•åˆ›å»ºçš„ç±»ï¼ˆç”± <code>Collections.synchronizedXXX</code> ç­‰æ–¹æ³•ï¼‰</li></ul><h3 id="åŒæ­¥å®¹å™¨çš„é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#åŒæ­¥å®¹å™¨çš„é—®é¢˜" aria-hidden="true">#</a> åŒæ­¥å®¹å™¨çš„é—®é¢˜</h3><p>åŒæ­¥å®¹å™¨çš„åŒæ­¥åŸç†å°±æ˜¯åœ¨å…¶ <code>get</code>ã€<code>set</code>ã€<code>size</code> ç­‰ä¸»è¦æ–¹æ³•ä¸Šç”¨ <code>synchronized</code> ä¿®é¥°ã€‚ <strong><code>synchronized</code> å¯ä»¥ä¿è¯åœ¨åŒä¸€ä¸ªæ—¶åˆ»ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡ŒæŸä¸ªæ–¹æ³•æˆ–è€…æŸä¸ªä»£ç å—</strong>ã€‚</p>',7),k=n("code",null,"synchronized",-1),r={href:"https://dunwu.github.io/waterdrop/pages/f824f527/",target:"_blank",rel:"noopener noreferrer"},d=p(`<h4 id="æ€§èƒ½é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#æ€§èƒ½é—®é¢˜" aria-hidden="true">#</a> æ€§èƒ½é—®é¢˜</h4><p><code>synchronized</code> çš„äº’æ–¥åŒæ­¥ä¼šäº§ç”Ÿé˜»å¡å’Œå”¤é†’çº¿ç¨‹çš„å¼€é”€ã€‚æ˜¾ç„¶ï¼Œè¿™ç§æ–¹å¼æ¯”æ²¡æœ‰ä½¿ç”¨ <code>synchronized</code> çš„å®¹å™¨æ€§èƒ½è¦å·®å¾ˆå¤šã€‚</p><blockquote><p>æ³¨ï¼šå°¤å…¶æ˜¯åœ¨ Java 1.6 æ²¡æœ‰å¯¹ <code>synchronized</code> è¿›è¡Œä¼˜åŒ–å‰ï¼Œé˜»å¡å¼€é”€å¾ˆé«˜ã€‚</p></blockquote><h4 id="å®‰å…¨é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#å®‰å…¨é—®é¢˜" aria-hidden="true">#</a> å®‰å…¨é—®é¢˜</h4><p>åŒæ­¥å®¹å™¨çœŸçš„ç»å¯¹å®‰å…¨å—ï¼Ÿ</p><p>å…¶å®ä¹Ÿæœªå¿…ã€‚åœ¨åšå¤åˆæ“ä½œï¼ˆéåŸå­æ“ä½œï¼‰æ—¶ï¼Œä»ç„¶éœ€è¦åŠ é”æ¥ä¿æŠ¤ã€‚å¸¸è§å¤åˆæ“ä½œå¦‚ä¸‹ï¼š</p><ul><li><strong>è¿­ä»£</strong>ï¼šåå¤è®¿é—®å…ƒç´ ï¼Œç›´åˆ°éå†å®Œå…¨éƒ¨å…ƒç´ ï¼›</li><li><strong>è·³è½¬</strong>ï¼šæ ¹æ®æŒ‡å®šé¡ºåºå¯»æ‰¾å½“å‰å…ƒç´ çš„ä¸‹ä¸€ä¸ªï¼ˆä¸‹ n ä¸ªï¼‰å…ƒç´ ï¼›</li><li><strong>æ¡ä»¶è¿ç®—</strong>ï¼šä¾‹å¦‚è‹¥æ²¡æœ‰åˆ™æ·»åŠ ç­‰ï¼›</li></ul><p>âŒ ä¸å®‰å…¨çš„ç¤ºä¾‹</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VectorDemo</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token class-name">Vector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> vector <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            vector<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                vector<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">Thread</span> thread1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> vector<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        vector<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token class-name">Thread</span> thread2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> vector<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        vector<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            thread1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">activeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;åŒæ—¶å­˜åœ¨ 10 ä¸ªä»¥ä¸Šçº¿ç¨‹ï¼Œé€€å‡º&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»¥ä¸Šç¨‹åºæ‰§è¡Œæ—¶å¯èƒ½ä¼šå‡ºç°æ•°ç»„è¶Šç•Œé”™è¯¯ã€‚</p><p><code>Vector</code> æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œé‚£ä¸ºä»€ä¹ˆè¿˜ä¼šæŠ¥è¿™ä¸ªé”™ï¼Ÿ</p><p>è¿™æ˜¯å› ä¸ºï¼Œå¯¹äº Vectorï¼Œè™½ç„¶èƒ½ä¿è¯æ¯ä¸€ä¸ªæ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®å®ƒï¼Œä½†æ˜¯ä¸æ’é™¤è¿™ç§å¯èƒ½ï¼š</p><p>å½“æŸä¸ªçº¿ç¨‹åœ¨æŸä¸ªæ—¶åˆ»æ‰§è¡Œè¿™å¥æ—¶ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>vector<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    vector<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>å‡è‹¥æ­¤æ—¶ vector çš„ size æ–¹æ³•è¿”å›çš„æ˜¯ 10ï¼Œi çš„å€¼ä¸º 9</p><p>ç„¶åå¦å¤–ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œäº†è¿™å¥ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>vector<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    vector<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>å°†ä¸‹æ ‡ä¸º 9 çš„å…ƒç´ åˆ é™¤äº†ã€‚</p><p>é‚£ä¹ˆé€šè¿‡ get æ–¹æ³•è®¿é—®ä¸‹æ ‡ä¸º 9 çš„å…ƒç´ è‚¯å®šå°±ä¼šå‡ºé—®é¢˜äº†ã€‚</p><p>âœ”ï¸ï¸ï¸ å®‰å…¨ç¤ºä¾‹</p><p>å› æ­¤ä¸ºäº†ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå¿…é¡»åœ¨æ–¹æ³•è°ƒç”¨ç«¯åšé¢å¤–çš„åŒæ­¥æªæ–½ï¼Œå¦‚ä¸‹é¢æ‰€ç¤ºï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VectorDemo2</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token class-name">Vector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> vector <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                vector<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">Thread</span> thread1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">VectorDemo2</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">//è¿›è¡Œé¢å¤–çš„åŒæ­¥</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> vector<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            vector<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token class-name">Thread</span> thread2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">VectorDemo2</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> vector<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            vector<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            thread1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            thread2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">activeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;åŒæ—¶å­˜åœ¨ 10 ä¸ªä»¥ä¸Šçº¿ç¨‹ï¼Œé€€å‡º&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>ConcurrentModificationException</code> å¼‚å¸¸</p><p>åœ¨å¯¹ <code>Vector</code> ç­‰å®¹å™¨å¹¶å‘åœ°è¿›è¡Œè¿­ä»£ä¿®æ”¹æ—¶ï¼Œä¼šæŠ¥ <code>ConcurrentModificationException</code> å¼‚å¸¸ï¼Œå…³äºè¿™ä¸ªå¼‚å¸¸å°†ä¼šåœ¨åç»­æ–‡ç« ä¸­è®²è¿°ã€‚</p><p>ä½†æ˜¯åœ¨å¹¶å‘å®¹å™¨ä¸­ä¸ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ã€‚</p><h2 id="å¹¶å‘å®¹å™¨ç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#å¹¶å‘å®¹å™¨ç®€ä»‹" aria-hidden="true">#</a> å¹¶å‘å®¹å™¨ç®€ä»‹</h2><p>åŒæ­¥å®¹å™¨å°†æ‰€æœ‰å¯¹å®¹å™¨çŠ¶æ€çš„è®¿é—®éƒ½ä¸²è¡ŒåŒ–ï¼Œä»¥ä¿è¯çº¿ç¨‹å®‰å…¨æ€§ï¼Œè¿™ç§ç­–ç•¥ä¼šä¸¥é‡é™ä½å¹¶å‘æ€§ã€‚</p><p>Java 1.5 åæä¾›äº†å¤šç§å¹¶å‘å®¹å™¨ï¼Œ<strong>ä½¿ç”¨å¹¶å‘å®¹å™¨æ¥æ›¿ä»£åŒæ­¥å®¹å™¨ï¼Œå¯ä»¥æå¤§åœ°æé«˜ä¼¸ç¼©æ€§å¹¶é™ä½é£é™©</strong>ã€‚</p><p>J.U.C åŒ…ä¸­æä¾›äº†å‡ ä¸ªéå¸¸æœ‰ç”¨çš„å¹¶å‘å®¹å™¨ä½œä¸ºçº¿ç¨‹å®‰å…¨çš„å®¹å™¨ï¼š</p><table><thead><tr><th>å¹¶å‘å®¹å™¨</th><th>å¯¹åº”çš„æ™®é€šå®¹å™¨</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>ConcurrentHashMap</code></td><td><code>HashMap</code></td><td>Java 1.8 ä¹‹å‰é‡‡ç”¨åˆ†æ®µé”æœºåˆ¶ç»†åŒ–é”ç²’åº¦ï¼Œé™ä½é˜»å¡ï¼Œä»è€Œæé«˜å¹¶å‘æ€§ï¼›Java 1.8 ä¹‹ååŸºäº CAS å®ç°ã€‚</td></tr><tr><td><code>ConcurrentSkipListMap</code></td><td><code>SortedMap</code></td><td>åŸºäºè·³è¡¨å®ç°çš„</td></tr><tr><td><code>CopyOnWriteArrayList</code></td><td><code>ArrayList</code></td><td></td></tr><tr><td><code>CopyOnWriteArraySet</code></td><td><code>Set</code></td><td>åŸºäº <code>CopyOnWriteArrayList</code> å®ç°ã€‚</td></tr><tr><td><code>ConcurrentSkipListSet</code></td><td><code>SortedSet</code></td><td>åŸºäº <code>ConcurrentSkipListMap</code> å®ç°ã€‚</td></tr><tr><td><code>ConcurrentLinkedQueue</code></td><td><code>Queue</code></td><td>çº¿ç¨‹å®‰å…¨çš„æ— ç•Œé˜Ÿåˆ—ã€‚åº•å±‚é‡‡ç”¨å•é“¾è¡¨ã€‚æ”¯æŒ FIFOã€‚</td></tr><tr><td><code>ConcurrentLinkedDeque</code></td><td><code>Deque</code></td><td>çº¿ç¨‹å®‰å…¨çš„æ— ç•ŒåŒç«¯é˜Ÿåˆ—ã€‚åº•å±‚é‡‡ç”¨åŒå‘é“¾è¡¨ã€‚æ”¯æŒ FIFO å’Œ FILOã€‚</td></tr><tr><td><code>ArrayBlockingQueue</code></td><td><code>Queue</code></td><td>æ•°ç»„å®ç°çš„é˜»å¡é˜Ÿåˆ—ã€‚</td></tr><tr><td><code>LinkedBlockingQueue</code></td><td><code>Queue</code></td><td>é“¾è¡¨å®ç°çš„é˜»å¡é˜Ÿåˆ—ã€‚</td></tr><tr><td><code>LinkedBlockingDeque</code></td><td><code>Deque</code></td><td>åŒå‘é“¾è¡¨å®ç°çš„åŒç«¯é˜»å¡é˜Ÿåˆ—ã€‚</td></tr></tbody></table><p>J.U.C åŒ…ä¸­æä¾›çš„å¹¶å‘å®¹å™¨å‘½åä¸€èˆ¬åˆ†ä¸ºä¸‰ç±»ï¼š</p><ul><li><code>Concurrent</code><ul><li>è¿™ç±»å‹çš„é”ç«äº‰ç›¸å¯¹äº <code>CopyOnWrite</code> è¦é«˜ä¸€äº›ï¼Œä½†å†™æ“ä½œä»£ä»·è¦å°ä¸€äº›ã€‚</li><li>æ­¤å¤–ï¼Œ<code>Concurrent</code> å¾€å¾€æä¾›äº†è¾ƒä½çš„éå†ä¸€è‡´æ€§ï¼Œå³ï¼šå½“åˆ©ç”¨è¿­ä»£å™¨éå†æ—¶ï¼Œå¦‚æœå®¹å™¨å‘ç”Ÿä¿®æ”¹ï¼Œè¿­ä»£å™¨ä»ç„¶å¯ä»¥ç»§ç»­è¿›è¡Œéå†ã€‚ä»£ä»·å°±æ˜¯ï¼Œåœ¨è·å–å®¹å™¨å¤§å° <code>size()</code> ï¼Œå®¹å™¨æ˜¯å¦ä¸ºç©ºç­‰æ–¹æ³•ï¼Œä¸ä¸€å®šå®Œå…¨ç²¾ç¡®ï¼Œä½†è¿™æ˜¯ä¸ºäº†è·å–å¹¶å‘ååé‡çš„è®¾è®¡å–èˆï¼Œå¯ä»¥ç†è§£ã€‚ä¸ä¹‹ç›¸æ¯”ï¼Œå¦‚æœæ˜¯ä½¿ç”¨åŒæ­¥å®¹å™¨ï¼Œå°±ä¼šå‡ºç° <code>fail-fast</code> é—®é¢˜ï¼Œå³ï¼šæ£€æµ‹åˆ°å®¹å™¨åœ¨éå†è¿‡ç¨‹ä¸­å‘ç”Ÿäº†ä¿®æ”¹ï¼Œåˆ™æŠ›å‡º <code>ConcurrentModificationException</code>ï¼Œä¸å†ç»§ç»­éå†ã€‚</li></ul></li><li><code>CopyOnWrite</code> - ä¸€ä¸ªçº¿ç¨‹å†™ï¼Œå¤šä¸ªçº¿ç¨‹è¯»ã€‚è¯»æ“ä½œæ—¶ä¸åŠ é”ï¼Œå†™æ“ä½œæ—¶é€šè¿‡åœ¨å‰¯æœ¬ä¸ŠåŠ é”ä¿è¯å¹¶å‘å®‰å…¨ï¼Œç©ºé—´å¼€é”€è¾ƒå¤§ã€‚</li><li><code>Blocking</code> - å†…éƒ¨å®ç°ä¸€èˆ¬æ˜¯åŸºäºé”ï¼Œæä¾›é˜»å¡é˜Ÿåˆ—çš„èƒ½åŠ›ã€‚</li></ul><p>âŒ é”™è¯¯ç¤ºä¾‹ï¼Œäº§ç”Ÿ <code>ConcurrentModificationException</code> å¼‚å¸¸ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeKeys</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    map<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeIf</span><span class="token punctuation">(</span>key <span class="token operator">-&gt;</span> <span class="token class-name">ArrayUtil</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>âŒ é”™è¯¯ç¤ºä¾‹ï¼Œäº§ç”Ÿ <code>ConcurrentModificationException</code> å¼‚å¸¸ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token function">removeKeys</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">K</span> key <span class="token operator">:</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		map<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> map<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å¹¶å‘åœºæ™¯ä¸‹çš„-map" tabindex="-1"><a class="header-anchor" href="#å¹¶å‘åœºæ™¯ä¸‹çš„-map" aria-hidden="true">#</a> å¹¶å‘åœºæ™¯ä¸‹çš„ Map</h3><p>å¦‚æœå¯¹æ•°æ®æœ‰å¼ºä¸€è‡´è¦æ±‚ï¼Œåˆ™éœ€ä½¿ç”¨ <code>Hashtable</code>ï¼›åœ¨å¤§éƒ¨åˆ†åœºæ™¯é€šå¸¸éƒ½æ˜¯å¼±ä¸€è‡´æ€§çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ <code>ConcurrentHashMap</code> å³å¯ï¼›å¦‚æœæ•°æ®é‡åœ¨åƒä¸‡çº§åˆ«ï¼Œä¸”å­˜åœ¨å¤§é‡å¢åˆ æ”¹æ“ä½œï¼Œåˆ™å¯ä»¥è€ƒè™‘ä½¿ç”¨ <code>ConcurrentSkipListMap</code>ã€‚</p><h3 id="å¹¶å‘åœºæ™¯ä¸‹çš„-list" tabindex="-1"><a class="header-anchor" href="#å¹¶å‘åœºæ™¯ä¸‹çš„-list" aria-hidden="true">#</a> å¹¶å‘åœºæ™¯ä¸‹çš„ List</h3><p>è¯»å¤šå†™å°‘ç”¨ <code>CopyOnWriteArrayList</code>ã€‚</p><p>å†™å¤šè¯»å°‘ç”¨ <code>ConcurrentLinkedQueue</code> ï¼Œä½†ç”±äºæ˜¯æ— ç•Œçš„ï¼Œè¦æœ‰å®¹é‡é™åˆ¶ï¼Œé¿å…æ— é™è†¨èƒ€ï¼Œå¯¼è‡´å†…å­˜æº¢å‡ºã€‚</p><h2 id="map" tabindex="-1"><a class="header-anchor" href="#map" aria-hidden="true">#</a> Map</h2><p>Map æ¥å£çš„ä¸¤ä¸ªå®ç°æ˜¯ ConcurrentHashMap å’Œ ConcurrentSkipListMapï¼Œå®ƒä»¬ä»åº”ç”¨çš„è§’åº¦æ¥çœ‹ï¼Œä¸»è¦åŒºåˆ«åœ¨äº<strong>ConcurrentHashMap çš„ key æ˜¯æ— åºçš„ï¼Œè€Œ ConcurrentSkipListMap çš„ key æ˜¯æœ‰åºçš„</strong>ã€‚æ‰€ä»¥å¦‚æœä½ éœ€è¦ä¿è¯ key çš„é¡ºåºï¼Œå°±åªèƒ½ä½¿ç”¨ ConcurrentSkipListMapã€‚</p><p>ä½¿ç”¨ ConcurrentHashMap å’Œ ConcurrentSkipListMap éœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯ï¼Œå®ƒä»¬çš„ key å’Œ value éƒ½ä¸èƒ½ä¸ºç©ºï¼Œå¦åˆ™ä¼šæŠ›å‡º<code>NullPointerException</code>è¿™ä¸ªè¿è¡Œæ—¶å¼‚å¸¸ã€‚</p><h3 id="concurrenthashmap" tabindex="-1"><a class="header-anchor" href="#concurrenthashmap" aria-hidden="true">#</a> ConcurrentHashMap</h3><p><code>ConcurrentHashMap</code> æ˜¯çº¿ç¨‹å®‰å…¨çš„ <code>HashMap</code> ï¼Œç”¨äºæ›¿ä»£ <code>Hashtable</code>ã€‚</p><h4 id="concurrenthashmap-çš„ç‰¹æ€§" tabindex="-1"><a class="header-anchor" href="#concurrenthashmap-çš„ç‰¹æ€§" aria-hidden="true">#</a> <code>ConcurrentHashMap</code> çš„ç‰¹æ€§</h4><p><code>ConcurrentHashMap</code> <code>å®ç°äº†</code> <code>ConcurrentMap</code> æ¥å£ï¼Œè€Œ <code>ConcurrentMap</code> æ¥å£æ‰©å±•äº† <code>Map</code> æ¥å£ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">implements</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>ConcurrentHashMap</code> çš„å®ç°åŒ…å«äº† <code>HashMap</code> æ‰€æœ‰çš„åŸºæœ¬ç‰¹æ€§ï¼Œå¦‚ï¼šæ•°æ®ç»“æ„ã€è¯»å†™ç­–ç•¥ç­‰ã€‚</p><p><code>ConcurrentHashMap</code> æ²¡æœ‰å®ç°å¯¹ <code>Map</code> åŠ é”ä»¥æä¾›ç‹¬å è®¿é—®ã€‚å› æ­¤æ— æ³•é€šè¿‡åœ¨å®¢æˆ·ç«¯åŠ é”çš„æ–¹å¼æ¥åˆ›å»ºæ–°çš„åŸå­æ“ä½œã€‚ä½†æ˜¯ï¼Œä¸€äº›å¸¸è§çš„å¤åˆæ“ä½œï¼Œå¦‚ï¼šâ€œè‹¥æ²¡æœ‰åˆ™æ·»åŠ â€ã€â€œè‹¥ç›¸ç­‰åˆ™ç§»é™¤â€ã€â€œè‹¥ç›¸ç­‰åˆ™æ›¿æ¢â€ï¼Œéƒ½å·²ç»å®ç°ä¸ºåŸå­æ“ä½œï¼Œå¹¶ä¸”æ˜¯å›´ç»• <code>ConcurrentMap</code> çš„æ‰©å±•æ¥å£è€Œå®ç°ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">// ä»…å½“ K æ²¡æœ‰ç›¸åº”çš„æ˜ å°„å€¼æ‰æ’å…¥</span>
    <span class="token class-name">V</span> <span class="token function">putIfAbsent</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ä»…å½“ K è¢«æ˜ å°„åˆ° V æ—¶æ‰ç§»é™¤</span>
    <span class="token keyword">boolean</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ä»…å½“ K è¢«æ˜ å°„åˆ° oldValue æ—¶æ‰æ›¿æ¢ä¸º newValue</span>
    <span class="token keyword">boolean</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> oldValue<span class="token punctuation">,</span> <span class="token class-name">V</span> newValue<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ä»…å½“ K è¢«æ˜ å°„åˆ°æŸä¸ªå€¼æ—¶æ‰æ›¿æ¢ä¸º newValue</span>
    <span class="token class-name">V</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸åŒäº <code>Hashtable</code>ï¼Œ<code>ConcurrentHashMap</code> æä¾›çš„è¿­ä»£å™¨ä¸ä¼šæŠ›å‡º <code>ConcurrentModificationException</code>ï¼Œå› æ­¤ä¸éœ€è¦åœ¨è¿­ä»£è¿‡ç¨‹ä¸­å¯¹å®¹å™¨åŠ é”ã€‚</p><blockquote><p>ğŸ”” æ³¨æ„ï¼šä¸€äº›éœ€è¦å¯¹æ•´ä¸ª <code>Map</code> è¿›è¡Œè®¡ç®—çš„æ–¹æ³•ï¼Œå¦‚ <code>size</code> å’Œ <code>isEmpty</code> ï¼Œç”±äºè¿”å›çš„ç»“æœåœ¨è®¡ç®—æ—¶å¯èƒ½å·²ç»è¿‡æœŸï¼Œæ‰€ä»¥<strong>å¹¶éå®æ—¶çš„ç²¾ç¡®å€¼</strong>ã€‚è¿™æ˜¯ä¸€ç§ç­–ç•¥ä¸Šçš„æƒè¡¡ï¼Œåœ¨å¹¶å‘ç¯å¢ƒä¸‹ï¼Œè¿™ç±»æ–¹æ³•ç”±äºæ€»åœ¨ä¸æ–­å˜åŒ–ï¼Œæ‰€ä»¥è·å–å…¶å®æ—¶ç²¾ç¡®å€¼çš„æ„ä¹‰ä¸å¤§ã€‚<code>ConcurrentHashMap</code> å¼±åŒ–è¿™ç±»æ–¹æ³•ï¼Œä»¥æ¢å–æ›´é‡è¦æ“ä½œï¼ˆå¦‚ï¼š<code>get</code>ã€<code>put</code>ã€<code>containesKey</code>ã€<code>remove</code> ç­‰ï¼‰çš„æ€§èƒ½ã€‚</p></blockquote><h4 id="concurrenthashmap-çš„ç”¨æ³•" tabindex="-1"><a class="header-anchor" href="#concurrenthashmap-çš„ç”¨æ³•" aria-hidden="true">#</a> ConcurrentHashMap çš„ç”¨æ³•</h4><p>ç¤ºä¾‹ï¼šä¸ä¼šå‡ºç° <code>ConcurrentModificationException</code></p><p><code>ConcurrentHashMap</code> çš„åŸºæœ¬æ“ä½œä¸ <code>HashMap</code> çš„ç”¨æ³•åŸºæœ¬ä¸€æ ·ã€‚ä¸åŒäº <code>HashMap</code>ã€<code>Hashtable</code>ï¼Œ<code>ConcurrentHashMap</code> æä¾›çš„è¿­ä»£å™¨ä¸ä¼šæŠ›å‡º <code>ConcurrentModificationException</code>ï¼Œå› æ­¤ä¸éœ€è¦åœ¨è¿­ä»£è¿‡ç¨‹ä¸­å¯¹å®¹å™¨åŠ é”ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentHashMapDemo</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>

        <span class="token comment">// HashMap åœ¨å¹¶å‘è¿­ä»£è®¿é—®æ—¶ä¼šæŠ›å‡º ConcurrentModificationException å¼‚å¸¸</span>
        <span class="token comment">// Map&lt;Integer, Character&gt; map = new HashMap&lt;&gt;();</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Character</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Thread</span> wthread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;å†™æ“ä½œçº¿ç¨‹å¼€å§‹æ‰§è¡Œ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">26</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token char">&#39;a&#39;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> rthread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;è¯»æ“ä½œçº¿ç¨‹å¼€å§‹æ‰§è¡Œ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span> key <span class="token operator">:</span> map<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>key <span class="token operator">+</span> <span class="token string">&quot; - &quot;</span> <span class="token operator">+</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wthread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rthread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="concurrenthashmap-çš„åŸç†" tabindex="-1"><a class="header-anchor" href="#concurrenthashmap-çš„åŸç†" aria-hidden="true">#</a> ConcurrentHashMap çš„åŸç†</h4><blockquote><p><code>ConcurrentHashMap</code> ä¸€ç›´åœ¨æ¼”è¿›ï¼Œå°¤å…¶åœ¨ Java 1.7 å’Œ Java 1.8ï¼Œå…¶æ•°æ®ç»“æ„å’Œå¹¶å‘æœºåˆ¶æœ‰å¾ˆå¤§çš„å·®å¼‚ã€‚</p></blockquote><ul><li>Java 1.7 <ul><li>æ•°æ®ç»“æ„ï¼š<strong>æ•°ç»„ï¼‹å•é“¾è¡¨</strong></li><li>å¹¶å‘æœºåˆ¶ï¼šé‡‡ç”¨åˆ†æ®µé”æœºåˆ¶ç»†åŒ–é”ç²’åº¦ï¼Œé™ä½é˜»å¡ï¼Œä»è€Œæé«˜å¹¶å‘æ€§ã€‚</li></ul></li><li>Java 1.8 <ul><li>æ•°æ®ç»“æ„ï¼š<strong>æ•°ç»„ï¼‹å•é“¾è¡¨ï¼‹çº¢é»‘æ ‘</strong></li><li>å¹¶å‘æœºåˆ¶ï¼šå–æ¶ˆåˆ†æ®µé”ï¼Œä¹‹ååŸºäº CAS + synchronized å®ç°ã€‚</li></ul></li></ul><h5 id="java-1-7-çš„å®ç°" tabindex="-1"><a class="header-anchor" href="#java-1-7-çš„å®ç°" aria-hidden="true">#</a> Java 1.7 çš„å®ç°</h5><p>åˆ†æ®µé”ï¼Œæ˜¯å°†å†…éƒ¨è¿›è¡Œåˆ†æ®µï¼ˆSegmentï¼‰ï¼Œé‡Œé¢æ˜¯ <code>HashEntry</code> æ•°ç»„ï¼Œå’Œ <code>HashMap</code> ç±»ä¼¼ï¼Œå“ˆå¸Œç›¸åŒçš„æ¡ç›®ä¹Ÿæ˜¯ä»¥é“¾è¡¨å½¢å¼å­˜æ”¾ã€‚<br><code>HashEntry</code> å†…éƒ¨ä½¿ç”¨ <code>volatile</code> çš„ <code>value</code> å­—æ®µæ¥ä¿è¯å¯è§æ€§ï¼Œä¹Ÿåˆ©ç”¨äº†ä¸å¯å˜å¯¹è±¡çš„æœºåˆ¶ï¼Œä»¥æ”¹è¿›åˆ©ç”¨ <code>Unsafe</code> æä¾›çš„åº•å±‚èƒ½åŠ›ï¼Œæ¯”å¦‚ volatile accessï¼Œå»ç›´æ¥å®Œæˆéƒ¨åˆ†æ“ä½œï¼Œä»¥æœ€ä¼˜åŒ–æ€§èƒ½ï¼Œæ¯•ç«Ÿ <code>Unsafe</code> ä¸­çš„å¾ˆå¤šæ“ä½œéƒ½æ˜¯ JVM intrinsic ä¼˜åŒ–è¿‡çš„ã€‚</p><figure><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200605214405.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>åœ¨è¿›è¡Œå¹¶å‘å†™æ“ä½œæ—¶ï¼Œ<code>ConcurrentHashMap</code> ä¼šè·å–å¯é‡å…¥é”ï¼ˆ<code>ReentrantLock</code>ï¼‰ï¼Œä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚æ‰€ä»¥ï¼Œåœ¨å¹¶å‘ä¿®æ”¹æœŸé—´ï¼Œç›¸åº” <code>Segment</code> æ˜¯è¢«é”å®šçš„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>

    <span class="token comment">// å°†æ•´ä¸ªhashmapåˆ†æˆå‡ ä¸ªå°çš„mapï¼Œæ¯ä¸ªsegmentéƒ½æ˜¯ä¸€ä¸ªé”ï¼›ä¸hashtableç›¸æ¯”ï¼Œè¿™ä¹ˆè®¾è®¡çš„ç›®çš„æ˜¯å¯¹äºput, removeç­‰æ“ä½œï¼Œå¯ä»¥å‡å°‘å¹¶å‘å†²çªï¼Œå¯¹</span>
    <span class="token comment">// ä¸å±äºåŒä¸€ä¸ªç‰‡æ®µçš„èŠ‚ç‚¹å¯ä»¥å¹¶å‘æ“ä½œï¼Œå¤§å¤§æé«˜äº†æ€§èƒ½</span>
    <span class="token keyword">final</span> <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> segments<span class="token punctuation">;</span>

    <span class="token comment">// æœ¬è´¨ä¸ŠSegmentç±»å°±æ˜¯ä¸€ä¸ªå°çš„hashmapï¼Œé‡Œé¢tableæ•°ç»„å­˜å‚¨äº†å„ä¸ªèŠ‚ç‚¹çš„æ•°æ®ï¼Œç»§æ‰¿äº†ReentrantLock, å¯ä»¥ä½œä¸ºäº’æ‹†é”ä½¿ç”¨</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Segment</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">ReentrantLock</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
        <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span>
        <span class="token keyword">transient</span> <span class="token keyword">int</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// åŸºæœ¬èŠ‚ç‚¹ï¼Œå­˜å‚¨Keyï¼Œ Valueå€¼</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> hash<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token class-name">K</span> key<span class="token punctuation">;</span>
        <span class="token keyword">volatile</span> <span class="token class-name">V</span> value<span class="token punctuation">;</span>
        <span class="token keyword">volatile</span> <span class="token class-name">HashEntry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="java-1-8-çš„å®ç°" tabindex="-1"><a class="header-anchor" href="#java-1-8-çš„å®ç°" aria-hidden="true">#</a> Java 1.8 çš„å®ç°</h5><ul><li>æ•°æ®ç»“æ„æ”¹è¿›ï¼šä¸ HashMap ä¸€æ ·ï¼Œå°†åŸå…ˆ <strong>æ•°ç»„ï¼‹å•é“¾è¡¨</strong> çš„æ•°æ®ç»“æ„ï¼Œå˜æ›´ä¸º <strong>æ•°ç»„ï¼‹å•é“¾è¡¨ï¼‹çº¢é»‘æ ‘</strong> çš„ç»“æ„ã€‚å½“å‡ºç°å“ˆå¸Œå†²çªæ—¶ï¼Œæ•°æ®ä¼šå­˜å…¥æ•°ç»„æŒ‡å®šæ¡¶çš„å•é“¾è¡¨ï¼Œå½“é“¾è¡¨é•¿åº¦è¾¾åˆ° 8ï¼Œåˆ™å°†å…¶è½¬æ¢ä¸ºçº¢é»‘æ ‘ç»“æ„ï¼Œè¿™æ ·å…¶æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦å¯ä»¥é™ä½åˆ° $$O(logN)$$ï¼Œä»¥æ”¹è¿›æ€§èƒ½ã€‚</li><li>å¹¶å‘æœºåˆ¶æ”¹è¿›ï¼š <ul><li>å–æ¶ˆ segments å­—æ®µï¼Œ<strong>ç›´æ¥é‡‡ç”¨ <code>transient volatile HashEntry&lt;K,V&gt;[] table</code> ä¿å­˜æ•°æ®ï¼Œé‡‡ç”¨ table æ•°ç»„å…ƒç´ ä½œä¸ºé”ï¼Œä»è€Œå®ç°äº†å¯¹æ¯ä¸€è¡Œæ•°æ®è¿›è¡ŒåŠ é”ï¼Œè¿›ä¸€æ­¥å‡å°‘å¹¶å‘å†²çªçš„æ¦‚ç‡</strong>ã€‚</li><li>ä½¿ç”¨ CAS + <code>sychronized</code> æ“ä½œï¼Œåœ¨ç‰¹å®šåœºæ™¯è¿›è¡Œæ— é”å¹¶å‘æ“ä½œã€‚ä½¿ç”¨ Unsafeã€LongAdder ä¹‹ç±»åº•å±‚æ‰‹æ®µï¼Œè¿›è¡Œæç«¯æƒ…å†µçš„ä¼˜åŒ–ã€‚ç°ä»£ JDK ä¸­ï¼Œsynchronized å·²ç»è¢«ä¸æ–­ä¼˜åŒ–ï¼Œå¯ä»¥ä¸å†è¿‡åˆ†æ‹…å¿ƒæ€§èƒ½å·®å¼‚ï¼Œå¦å¤–ï¼Œç›¸æ¯”äº ReentrantLockï¼Œå®ƒå¯ä»¥å‡å°‘å†…å­˜æ¶ˆè€—ï¼Œè¿™æ˜¯ä¸ªéå¸¸å¤§çš„ä¼˜åŠ¿ã€‚</li></ul></li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">V</span> <span class="token function">putVal</span><span class="token punctuation">(</span><span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyIfAbsent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token function">spread</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> binCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> f<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> i<span class="token punctuation">,</span> fh<span class="token punctuation">;</span>
        <span class="token comment">// å¦‚æœtableä¸ºç©ºï¼Œåˆå§‹åŒ–ï¼›å¦åˆ™ï¼Œæ ¹æ®hashå€¼è®¡ç®—å¾—åˆ°æ•°ç»„ç´¢å¼•iï¼Œå¦‚æœtab[i]ä¸ºç©ºï¼Œç›´æ¥æ–°å»ºèŠ‚ç‚¹Nodeå³å¯ã€‚æ³¨ï¼štab[i]å®è´¨ä¸ºé“¾è¡¨æˆ–è€…çº¢é»‘æ ‘çš„é¦–èŠ‚ç‚¹ã€‚</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tab <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            tab <span class="token operator">=</span> <span class="token function">initTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">casTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
                         <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>                   <span class="token comment">// no lock when adding to empty bin</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å¦‚æœtab[i]ä¸ä¸ºç©ºå¹¶ä¸”hashå€¼ä¸ºMOVEDï¼Œè¯´æ˜è¯¥é“¾è¡¨æ­£åœ¨è¿›è¡Œtransferæ“ä½œï¼Œè¿”å›æ‰©å®¹å®Œæˆåçš„tableã€‚</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fh <span class="token operator">=</span> f<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">MOVED</span><span class="token punctuation">)</span>
            tab <span class="token operator">=</span> <span class="token function">helpTransfer</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">V</span> oldVal <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token comment">// é’ˆå¯¹é¦–ä¸ªèŠ‚ç‚¹è¿›è¡ŒåŠ é”æ“ä½œï¼Œè€Œä¸æ˜¯segmentï¼Œè¿›ä¸€æ­¥å‡å°‘çº¿ç¨‹å†²çª</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>fh <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        binCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> e <span class="token operator">=</span> f<span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token operator">++</span>binCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">K</span> ek<span class="token punctuation">;</span>
                            <span class="token comment">// å¦‚æœåœ¨é“¾è¡¨ä¸­æ‰¾åˆ°å€¼ä¸ºkeyçš„èŠ‚ç‚¹eï¼Œç›´æ¥è®¾ç½®e.val = valueå³å¯ã€‚</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span>
                                <span class="token punctuation">(</span><span class="token punctuation">(</span>ek <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span>
                                 <span class="token punctuation">(</span>ek <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ek<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                oldVal <span class="token operator">=</span> e<span class="token punctuation">.</span>val<span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent<span class="token punctuation">)</span>
                                    e<span class="token punctuation">.</span>val <span class="token operator">=</span> value<span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment">// å¦‚æœæ²¡æœ‰æ‰¾åˆ°å€¼ä¸ºkeyçš„èŠ‚ç‚¹ï¼Œç›´æ¥æ–°å»ºNodeå¹¶åŠ å…¥é“¾è¡¨å³å¯ã€‚</span>
                            <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> pred <span class="token operator">=</span> e<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                pred<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span>
                                                          value<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// å¦‚æœé¦–èŠ‚ç‚¹ä¸ºTreeBinç±»å‹ï¼Œè¯´æ˜ä¸ºçº¢é»‘æ ‘ç»“æ„ï¼Œæ‰§è¡ŒputTreeValæ“ä½œã€‚</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token keyword">instanceof</span> <span class="token class-name">TreeBin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span> p<span class="token punctuation">;</span>
                        binCount <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">TreeBin</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span><span class="token class-name">V</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span>f<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putTreeVal</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span>
                                                       value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            oldVal <span class="token operator">=</span> p<span class="token punctuation">.</span>val<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent<span class="token punctuation">)</span>
                                p<span class="token punctuation">.</span>val <span class="token operator">=</span> value<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// å¦‚æœèŠ‚ç‚¹æ•°&gt;ï¼8ï¼Œé‚£ä¹ˆè½¬æ¢é“¾è¡¨ç»“æ„ä¸ºçº¢é»‘æ ‘ç»“æ„ã€‚</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">&gt;=</span> <span class="token constant">TREEIFY_THRESHOLD</span><span class="token punctuation">)</span>
                    <span class="token function">treeifyBin</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVal <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> oldVal<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// è®¡æ•°å¢åŠ 1ï¼Œæœ‰å¯èƒ½è§¦å‘transferæ“ä½œ(æ‰©å®¹)ã€‚</span>
    <span class="token function">addCount</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span> binCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="concurrenthashmap-çš„å®æˆ˜" tabindex="-1"><a class="header-anchor" href="#concurrenthashmap-çš„å®æˆ˜" aria-hidden="true">#</a> ConcurrentHashMap çš„å®æˆ˜</h4>`,70),v={href:"https://time.geekbang.org/column/intro/100047701",target:"_blank",rel:"noopener noreferrer"},m=p(`<h5 id="concurrenthashmap-é”™è¯¯ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#concurrenthashmap-é”™è¯¯ç¤ºä¾‹" aria-hidden="true">#</a> ConcurrentHashMap é”™è¯¯ç¤ºä¾‹</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token comment">//çº¿ç¨‹ä¸ªæ•°</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token constant">THREAD_COUNT</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token comment">//æ€»å…ƒç´ æ•°é‡</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token constant">ITEM_COUNT</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> concurrentHashMap <span class="token operator">=</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token constant">ITEM_COUNT</span> <span class="token operator">-</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åˆå§‹900ä¸ªå…ƒç´ </span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;init size:&quot;</span> <span class="token operator">+</span> concurrentHashMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ForkJoinPool</span> forkJoinPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span><span class="token constant">THREAD_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ä½¿ç”¨çº¿ç¨‹æ± å¹¶å‘å¤„ç†é€»è¾‘</span>
        forkJoinPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">//æŸ¥è¯¢è¿˜éœ€è¦è¡¥å……å¤šå°‘ä¸ªå…ƒç´ </span>
            <span class="token keyword">int</span> gap <span class="token operator">=</span> <span class="token constant">ITEM_COUNT</span> <span class="token operator">-</span> concurrentHashMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;gap size:&quot;</span> <span class="token operator">+</span> gap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//è¡¥å……å…ƒç´ </span>
            concurrentHashMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span><span class="token function">getData</span><span class="token punctuation">(</span>gap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ</span>
        forkJoinPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        forkJoinPool<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//æœ€åå…ƒç´ ä¸ªæ•°ä¼šæ˜¯1000å—ï¼Ÿ</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;finish size:&quot;</span> <span class="token operator">+</span> concurrentHashMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">LongStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>
                <span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toConcurrentMap</span><span class="token punctuation">(</span>
                    i <span class="token operator">-&gt;</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    i <span class="token operator">-&gt;</span> i<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>o1<span class="token punctuation">,</span> o2<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> o1<span class="token punctuation">,</span>
                    <span class="token class-name">ConcurrentHashMap</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆå§‹å¤§å° 900 ç¬¦åˆé¢„æœŸï¼Œè¿˜éœ€è¦å¡«å…… 100 ä¸ªå…ƒç´ ã€‚</p><p>é¢„æœŸç»“æœä¸º 1000 ä¸ªå…ƒç´ ï¼Œå®é™…å¤§äº 1000 ä¸ªå…ƒç´ ã€‚</p><p>ã€åˆ†æã€‘</p><p>ConcurrentHashMap å¯¹å¤–æä¾›çš„æ–¹æ³•æˆ–èƒ½åŠ›çš„é™åˆ¶ï¼š</p><ul><li>ä½¿ç”¨äº† ConcurrentHashMapï¼Œä¸ä»£è¡¨å¯¹å®ƒçš„å¤šä¸ªæ“ä½œä¹‹é—´çš„çŠ¶æ€æ˜¯ä¸€è‡´çš„ï¼Œæ˜¯æ²¡æœ‰å…¶ä»–çº¿ç¨‹åœ¨æ“ä½œå®ƒçš„ï¼Œå¦‚æœéœ€è¦ç¡®ä¿éœ€è¦æ‰‹åŠ¨åŠ é”ã€‚</li><li>è¯¸å¦‚ sizeã€isEmpty å’Œ containsValue ç­‰èšåˆæ–¹æ³•ï¼Œåœ¨å¹¶å‘æƒ…å†µä¸‹å¯èƒ½ä¼šåæ˜  ConcurrentHashMap çš„ä¸­é—´çŠ¶æ€ã€‚å› æ­¤åœ¨å¹¶å‘æƒ…å†µä¸‹ï¼Œè¿™äº›æ–¹æ³•çš„è¿”å›å€¼åªèƒ½ç”¨ä½œå‚è€ƒï¼Œè€Œä¸èƒ½ç”¨äºæµç¨‹æ§åˆ¶ã€‚æ˜¾ç„¶ï¼Œåˆ©ç”¨ size æ–¹æ³•è®¡ç®—å·®å¼‚å€¼ï¼Œæ˜¯ä¸€ä¸ªæµç¨‹æ§åˆ¶ã€‚</li><li>è¯¸å¦‚ putAll è¿™æ ·çš„èšåˆæ–¹æ³•ä¹Ÿä¸èƒ½ç¡®ä¿åŸå­æ€§ï¼Œåœ¨ putAll çš„è¿‡ç¨‹ä¸­å»è·å–æ•°æ®å¯èƒ½ä¼šè·å–åˆ°éƒ¨åˆ†æ•°æ®ã€‚</li></ul><h5 id="concurrenthashmap-é”™è¯¯ç¤ºä¾‹ä¿®æ­£-1-0-ç‰ˆ" tabindex="-1"><a class="header-anchor" href="#concurrenthashmap-é”™è¯¯ç¤ºä¾‹ä¿®æ­£-1-0-ç‰ˆ" aria-hidden="true">#</a> ConcurrentHashMap é”™è¯¯ç¤ºä¾‹ä¿®æ­£ 1.0 ç‰ˆ</h5><p>é€šè¿‡ synchronized åŠ é”ï¼Œå½“ç„¶å¯ä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œä½†æ˜¯ç‰ºç‰²äº† ConcurrentHashMap çš„æ€§èƒ½ï¼Œæ²¡å“ŸçœŸæ­£å‘æŒ¥å‡º ConcurrentHashMap çš„ç‰¹æ€§ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
    <span class="token comment">//çº¿ç¨‹ä¸ªæ•°</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token constant">THREAD_COUNT</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token comment">//æ€»å…ƒç´ æ•°é‡</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token constant">ITEM_COUNT</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> concurrentHashMap <span class="token operator">=</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token constant">ITEM_COUNT</span> <span class="token operator">-</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åˆå§‹900ä¸ªå…ƒç´ </span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;init size:&quot;</span> <span class="token operator">+</span> concurrentHashMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ForkJoinPool</span> forkJoinPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span><span class="token constant">THREAD_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ä½¿ç”¨çº¿ç¨‹æ± å¹¶å‘å¤„ç†é€»è¾‘</span>
        forkJoinPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">//æŸ¥è¯¢è¿˜éœ€è¦è¡¥å……å¤šå°‘ä¸ªå…ƒç´ </span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>concurrentHashMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> gap <span class="token operator">=</span> <span class="token constant">ITEM_COUNT</span> <span class="token operator">-</span> concurrentHashMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;gap size:&quot;</span> <span class="token operator">+</span> gap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//è¡¥å……å…ƒç´ </span>
                concurrentHashMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span><span class="token function">getData</span><span class="token punctuation">(</span>gap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ</span>
        forkJoinPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        forkJoinPool<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//æœ€åå…ƒç´ ä¸ªæ•°ä¼šæ˜¯1000å—ï¼Ÿ</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;finish size:&quot;</span> <span class="token operator">+</span> concurrentHashMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">LongStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> count<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>
                <span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toConcurrentMap</span><span class="token punctuation">(</span>
                    i <span class="token operator">-&gt;</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    i <span class="token operator">-&gt;</span> i<span class="token punctuation">,</span>
                    <span class="token punctuation">(</span>o1<span class="token punctuation">,</span> o2<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> o1<span class="token punctuation">,</span>
                    <span class="token class-name">ConcurrentHashMap</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="concurrenthashmap-é”™è¯¯ç¤ºä¾‹ä¿®æ­£-2-0-ç‰ˆ" tabindex="-1"><a class="header-anchor" href="#concurrenthashmap-é”™è¯¯ç¤ºä¾‹ä¿®æ­£-2-0-ç‰ˆ" aria-hidden="true">#</a> ConcurrentHashMap é”™è¯¯ç¤ºä¾‹ä¿®æ­£ 2.0 ç‰ˆ</h5><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>
    <span class="token comment">//å¾ªç¯æ¬¡æ•°</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token constant">LOOP_COUNT</span> <span class="token operator">=</span> <span class="token number">10000000</span><span class="token punctuation">;</span>
    <span class="token comment">//çº¿ç¨‹ä¸ªæ•°</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token constant">THREAD_COUNT</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token comment">//æ€»å…ƒç´ æ•°é‡</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token constant">ITEM_COUNT</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;normaluse&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> normaluse <span class="token operator">=</span> <span class="token function">normaluse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>normaluse<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">ITEM_COUNT</span><span class="token punctuation">,</span> <span class="token string">&quot;normaluse size error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>normaluse<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">mapToLong</span><span class="token punctuation">(</span>aLong <span class="token operator">-&gt;</span> aLong<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token operator">::</span><span class="token function">sum</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">LOOP_COUNT</span>
            <span class="token punctuation">,</span> <span class="token string">&quot;normaluse count error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;gooduse&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> gooduse <span class="token operator">=</span> <span class="token function">gooduse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>gooduse<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">ITEM_COUNT</span><span class="token punctuation">,</span> <span class="token string">&quot;gooduse size error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>gooduse<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">mapToLong</span><span class="token punctuation">(</span>l <span class="token operator">-&gt;</span> l<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token operator">::</span><span class="token function">sum</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">LOOP_COUNT</span>
            <span class="token punctuation">,</span> <span class="token string">&quot;gooduse count error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>stopWatch<span class="token punctuation">.</span><span class="token function">prettyPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">normaluse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> freqs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">ITEM_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ForkJoinPool</span> forkJoinPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span><span class="token constant">THREAD_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        forkJoinPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">LOOP_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;item&quot;</span> <span class="token operator">+</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token constant">ITEM_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>freqs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>freqs<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        freqs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> freqs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        freqs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        forkJoinPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        forkJoinPool<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> freqs<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">gooduse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">LongAdder</span><span class="token punctuation">&gt;</span></span> freqs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">ITEM_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ForkJoinPool</span> forkJoinPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span><span class="token constant">THREAD_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        forkJoinPool<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">LOOP_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;item&quot;</span> <span class="token operator">+</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token constant">ITEM_COUNT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                freqs<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> k <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">LongAdder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        forkJoinPool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        forkJoinPool<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">HOURS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> freqs<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>
                e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                e <span class="token operator">-&gt;</span> e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="list" tabindex="-1"><a class="header-anchor" href="#list" aria-hidden="true">#</a> List</h2><h3 id="copyonwritearraylist" tabindex="-1"><a class="header-anchor" href="#copyonwritearraylist" aria-hidden="true">#</a> CopyOnWriteArrayList</h3><p><code>CopyOnWriteArrayList</code> æ˜¯çº¿ç¨‹å®‰å…¨çš„ <code>ArrayList</code>ã€‚<code>CopyOnWrite</code> å­—é¢æ„æ€ä¸º<strong>å†™çš„æ—¶å€™ä¼šå°†å…±äº«å˜é‡æ–°å¤åˆ¶ä¸€ä»½</strong>å‡ºæ¥ã€‚å¤åˆ¶çš„å¥½å¤„åœ¨äº<strong>è¯»æ“ä½œæ˜¯æ— é”çš„</strong>ï¼ˆä¹Ÿå°±æ˜¯æ— é˜»å¡ï¼‰ã€‚</p><p>CopyOnWriteArrayList <strong>ä»…é€‚ç”¨äºå†™æ“ä½œéå¸¸å°‘çš„åœºæ™¯</strong>ï¼Œè€Œä¸”èƒ½å¤Ÿå®¹å¿è¯»å†™çš„çŸ­æš‚ä¸ä¸€è‡´ã€‚å¦‚æœè¯»å†™æ¯”ä¾‹å‡è¡¡æˆ–è€…æœ‰å¤§é‡å†™æ“ä½œçš„è¯ï¼Œä½¿ç”¨ CopyOnWriteArrayList çš„æ€§èƒ½ä¼šéå¸¸ç³Ÿç³•ã€‚</p><h4 id="copyonwritearraylist-åŸç†" tabindex="-1"><a class="header-anchor" href="#copyonwritearraylist-åŸç†" aria-hidden="true">#</a> CopyOnWriteArrayList åŸç†</h4><p>CopyOnWriteArrayList å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªæ•°ç»„ï¼Œæˆå‘˜å˜é‡ array å°±æŒ‡å‘è¿™ä¸ªå†…éƒ¨æ•°ç»„ï¼Œæ‰€æœ‰çš„è¯»æ“ä½œéƒ½æ˜¯åŸºäº array è¿›è¡Œçš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¿­ä»£å™¨ Iterator éå†çš„å°±æ˜¯ array æ•°ç»„ã€‚</p><figure><img src="https://raw.githubusercontent.com/dunwu/images/master/snap/20200702204541.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><ul><li>lock - æ‰§è¡Œå†™æ—¶å¤åˆ¶æ“ä½œï¼Œéœ€è¦ä½¿ç”¨å¯é‡å…¥é”åŠ é”</li><li>array - å¯¹è±¡æ•°ç»„ï¼Œç”¨äºå­˜æ”¾å…ƒç´ </li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token doc-comment comment">/** The lock protecting all mutators */</span>
    <span class="token keyword">final</span> <span class="token keyword">transient</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token doc-comment comment">/** The array, accessed only via getArray/setArray. */</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="https://raw.githubusercontent.com/dunwu/images/master/cs/java/javacore/container/CopyOnWriteArrayList.png" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>ï¼ˆ1ï¼‰è¯»æ“ä½œ</p><p>åœ¨ <code>CopyOnWriteAarrayList</code> ä¸­ï¼Œè¯»æ“ä½œä¸åŒæ­¥ï¼Œå› ä¸ºå®ƒä»¬åœ¨å†…éƒ¨æ•°ç»„çš„å¿«ç…§ä¸Šå·¥ä½œï¼Œæ‰€ä»¥å¤šä¸ªè¿­ä»£å™¨å¯ä»¥åŒæ—¶éå†è€Œä¸ä¼šç›¸äº’é˜»å¡ï¼ˆå›¾ 1,2,4ï¼‰ã€‚</p><p>CopyOnWriteArrayList çš„è¯»æ“ä½œæ˜¯ä¸ç”¨åŠ é”çš„ï¼Œæ€§èƒ½å¾ˆé«˜ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token function">getArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token class-name">E</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">E</span><span class="token punctuation">)</span> a<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ï¼ˆ2ï¼‰å†™æ“ä½œ</p><p>æ‰€æœ‰çš„å†™æ“ä½œéƒ½æ˜¯åŒæ­¥çš„ã€‚ä»–ä»¬åœ¨å¤‡ä»½æ•°ç»„ï¼ˆå›¾ 3ï¼‰çš„å‰¯æœ¬ä¸Šå·¥ä½œã€‚å†™æ“ä½œå®Œæˆåï¼Œåå¤‡é˜µåˆ—å°†è¢«æ›¿æ¢ä¸ºå¤åˆ¶çš„é˜µåˆ—ï¼Œå¹¶é‡Šæ”¾é”å®šã€‚æ”¯æŒæ•°ç»„å˜å¾—æ˜“å˜ï¼Œæ‰€ä»¥æ›¿æ¢æ•°ç»„çš„è°ƒç”¨æ˜¯åŸå­ï¼ˆå›¾ 5ï¼‰ã€‚</p><p>å†™æ“ä½œååˆ›å»ºçš„è¿­ä»£å™¨å°†èƒ½å¤Ÿçœ‹åˆ°ä¿®æ”¹çš„ç»“æ„ï¼ˆå›¾ 6,7ï¼‰ã€‚</p><p>å†™æ—¶å¤åˆ¶é›†åˆè¿”å›çš„è¿­ä»£å™¨ä¸ä¼šæŠ›å‡º <code>ConcurrentModificationException</code>ï¼Œå› ä¸ºå®ƒä»¬åœ¨æ•°ç»„çš„å¿«ç…§ä¸Šå·¥ä½œï¼Œå¹¶ä¸”æ— è®ºåç»­çš„ä¿®æ”¹ï¼ˆ2,4ï¼‰å¦‚ä½•ï¼Œéƒ½ä¼šåƒè¿­ä»£å™¨åˆ›å»ºæ—¶é‚£æ ·å®Œå…¨è¿”å›å…ƒç´ ã€‚</p><p><strong>æ·»åŠ æ“ä½œ</strong> - æ·»åŠ çš„é€»è¾‘å¾ˆç®€å•ï¼Œå…ˆå°†åŸå®¹å™¨ copy ä¸€ä»½ï¼Œç„¶ååœ¨æ–°å‰¯æœ¬ä¸Šæ‰§è¡Œå†™æ“ä½œï¼Œä¹‹åå†åˆ‡æ¢å¼•ç”¨ã€‚å½“ç„¶æ­¤è¿‡ç¨‹æ˜¯è¦åŠ é”çš„ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//ReentrantLockåŠ é”ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> elements <span class="token operator">=</span> <span class="token function">getArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token comment">//æ‹·è´åŸå®¹å™¨ï¼Œé•¿åº¦ä¸ºåŸå®¹å™¨é•¿åº¦åŠ ä¸€</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newElements <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>elements<span class="token punctuation">,</span> len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//åœ¨æ–°å‰¯æœ¬ä¸Šæ‰§è¡Œæ·»åŠ æ“ä½œ</span>
        newElements<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
        <span class="token comment">//å°†åŸå®¹å™¨å¼•ç”¨æŒ‡å‘æ–°å‰¯æœ¬</span>
        <span class="token function">setArray</span><span class="token punctuation">(</span>newElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">//è§£é”</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>åˆ é™¤æ“ä½œ</strong> - åˆ é™¤æ“ä½œåŒç†ï¼Œå°†é™¤è¦åˆ é™¤å…ƒç´ ä¹‹å¤–çš„å…¶ä»–å…ƒç´ æ‹·è´åˆ°æ–°å‰¯æœ¬ä¸­ï¼Œç„¶ååˆ‡æ¢å¼•ç”¨ï¼Œå°†åŸå®¹å™¨å¼•ç”¨æŒ‡å‘æ–°å‰¯æœ¬ã€‚åŒå±å†™æ“ä½œï¼Œéœ€è¦åŠ é”ã€‚</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">E</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//åŠ é”</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> elements <span class="token operator">=</span> <span class="token function">getArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token class-name">E</span> oldValue <span class="token operator">=</span> <span class="token function">get</span><span class="token punctuation">(</span>elements<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> numMoved <span class="token operator">=</span> len <span class="token operator">-</span> index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>numMoved <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token comment">//å¦‚æœè¦åˆ é™¤çš„æ˜¯åˆ—è¡¨æœ«ç«¯æ•°æ®ï¼Œæ‹·è´å‰len-1ä¸ªæ•°æ®åˆ°æ–°å‰¯æœ¬ä¸Šï¼Œå†åˆ‡æ¢å¼•ç”¨</span>
            <span class="token function">setArray</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>elements<span class="token punctuation">,</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">//å¦åˆ™ï¼Œå°†é™¤è¦åˆ é™¤å…ƒç´ ä¹‹å¤–çš„å…¶ä»–å…ƒç´ æ‹·è´åˆ°æ–°å‰¯æœ¬ä¸­ï¼Œå¹¶åˆ‡æ¢å¼•ç”¨</span>
            <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newElements <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>elements<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> newElements<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">arraycopy</span><span class="token punctuation">(</span>elements<span class="token punctuation">,</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> newElements<span class="token punctuation">,</span> index<span class="token punctuation">,</span>
                              numMoved<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setArray</span><span class="token punctuation">(</span>newElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">//è§£é”</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="copyonwritearraylist-ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#copyonwritearraylist-ç¤ºä¾‹" aria-hidden="true">#</a> CopyOnWriteArrayList ç¤ºä¾‹</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CopyOnWriteArrayListDemo</span> <span class="token punctuation">{</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ReadTask</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">;</span>

        <span class="token class-name">ReadTask</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>list <span class="token operator">=</span> list<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> str <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WriteTask</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">;</span>
        <span class="token keyword">int</span> index<span class="token punctuation">;</span>

        <span class="token class-name">WriteTask</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>list <span class="token operator">=</span> list<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">=</span> index<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            list<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token string">&quot;write_&quot;</span> <span class="token operator">+</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">NUM</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token comment">// ArrayList åœ¨å¹¶å‘è¿­ä»£è®¿é—®æ—¶ä¼šæŠ›å‡º ConcurrentModificationException å¼‚å¸¸</span>
        <span class="token comment">// List&lt;String&gt; list = new ArrayList&lt;&gt;();</span>
        <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">NUM</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;main_&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token constant">NUM</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">NUM</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ReadTask</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WriteTask</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayListDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="copyonwritearraylist-å®æˆ˜" tabindex="-1"><a class="header-anchor" href="#copyonwritearraylist-å®æˆ˜" aria-hidden="true">#</a> CopyOnWriteArrayList å®æˆ˜</h4><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WrongCopyOnWriteList</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">testRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">testWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span> <span class="token function">testWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> copyOnWriteArrayList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> synchronizedList <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> loopCount <span class="token operator">=</span> <span class="token number">100000</span><span class="token punctuation">;</span>
        stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;Write:copyOnWriteArrayList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>__ <span class="token operator">-&gt;</span> copyOnWriteArrayList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>loopCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;Write:synchronizedList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>__ <span class="token operator">-&gt;</span> synchronizedList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>loopCount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>stopWatch<span class="token punctuation">.</span><span class="token function">prettyPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;copyOnWriteArrayList&quot;</span><span class="token punctuation">,</span> copyOnWriteArrayList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;synchronizedList&quot;</span><span class="token punctuation">,</span> synchronizedList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        list<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span> <span class="token function">testRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> copyOnWriteArrayList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> synchronizedList <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addAll</span><span class="token punctuation">(</span>copyOnWriteArrayList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addAll</span><span class="token punctuation">(</span>synchronizedList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StopWatch</span> stopWatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StopWatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> loopCount <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> copyOnWriteArrayList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;Read:copyOnWriteArrayList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>__ <span class="token operator">-&gt;</span> copyOnWriteArrayList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stopWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;Read:synchronizedList&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> loopCount<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>__ <span class="token operator">-&gt;</span> synchronizedList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stopWatch<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>stopWatch<span class="token punctuation">.</span><span class="token function">prettyPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;copyOnWriteArrayList&quot;</span><span class="token punctuation">,</span> copyOnWriteArrayList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;synchronizedList&quot;</span><span class="token punctuation">,</span> synchronizedList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯»æ€§èƒ½å·®ä¸å¤šæ˜¯å†™æ€§èƒ½çš„ä¸€ç™¾å€ã€‚</p><h2 id="set" tabindex="-1"><a class="header-anchor" href="#set" aria-hidden="true">#</a> Set</h2><p>Set æ¥å£çš„ä¸¤ä¸ªå®ç°æ˜¯ CopyOnWriteArraySet å’Œ ConcurrentSkipListSetï¼Œä½¿ç”¨åœºæ™¯å¯ä»¥å‚è€ƒå‰é¢è®²è¿°çš„ CopyOnWriteArrayList å’Œ ConcurrentSkipListMapï¼Œå®ƒä»¬çš„åŸç†éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p><h2 id="queue" tabindex="-1"><a class="header-anchor" href="#queue" aria-hidden="true">#</a> Queue</h2><p>Java å¹¶å‘åŒ…é‡Œé¢ Queue è¿™ç±»å¹¶å‘å®¹å™¨æ˜¯æœ€å¤æ‚çš„ï¼Œä½ å¯ä»¥ä»ä»¥ä¸‹ä¸¤ä¸ªç»´åº¦æ¥åˆ†ç±»ã€‚ä¸€ä¸ªç»´åº¦æ˜¯<strong>é˜»å¡ä¸éé˜»å¡</strong>ï¼Œæ‰€è°“é˜»å¡æŒ‡çš„æ˜¯ï¼š<strong>å½“é˜Ÿåˆ—å·²æ»¡æ—¶ï¼Œå…¥é˜Ÿæ“ä½œé˜»å¡ï¼›å½“é˜Ÿåˆ—å·²ç©ºæ—¶ï¼Œå‡ºé˜Ÿæ“ä½œé˜»å¡</strong>ã€‚å¦ä¸€ä¸ªç»´åº¦æ˜¯<strong>å•ç«¯ä¸åŒç«¯</strong>ï¼Œå•ç«¯æŒ‡çš„æ˜¯åªèƒ½é˜Ÿå°¾å…¥é˜Ÿï¼Œé˜Ÿé¦–å‡ºé˜Ÿï¼›è€ŒåŒç«¯æŒ‡çš„æ˜¯é˜Ÿé¦–é˜Ÿå°¾çš†å¯å…¥é˜Ÿå‡ºé˜Ÿã€‚Java å¹¶å‘åŒ…é‡Œ<strong>é˜»å¡é˜Ÿåˆ—éƒ½ç”¨ Blocking å…³é”®å­—æ ‡è¯†ï¼Œå•ç«¯é˜Ÿåˆ—ä½¿ç”¨ Queue æ ‡è¯†ï¼ŒåŒç«¯é˜Ÿåˆ—ä½¿ç”¨ Deque æ ‡è¯†</strong>ã€‚</p><h3 id="blockingqueue" tabindex="-1"><a class="header-anchor" href="#blockingqueue" aria-hidden="true">#</a> BlockingQueue</h3><p><code>BlockingQueue</code> é¡¾åæ€ä¹‰ï¼Œæ˜¯ä¸€ä¸ª<strong>é˜»å¡é˜Ÿåˆ—</strong>ã€‚<strong><code>BlockingQueue</code> åŸºæœ¬éƒ½æ˜¯åŸºäºé”å®ç°</strong>ã€‚åœ¨ <code>BlockingQueue</code> ä¸­ï¼Œ<strong>å½“é˜Ÿåˆ—å·²æ»¡æ—¶ï¼Œå…¥é˜Ÿæ“ä½œé˜»å¡ï¼›å½“é˜Ÿåˆ—å·²ç©ºæ—¶ï¼Œå‡ºé˜Ÿæ“ä½œé˜»å¡</strong>ã€‚</p><p><code>BlockingQueue</code> æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>æ ¸å¿ƒ APIï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// è·å–å¹¶ç§»é™¤é˜Ÿåˆ—å¤´ç»“ç‚¹ï¼Œå¦‚æœå¿…è¦ï¼Œå…¶ä¼šç­‰å¾…ç›´åˆ°é˜Ÿåˆ—å‡ºç°å…ƒç´ </span>
<span class="token class-name">E</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
<span class="token comment">// æ’å…¥å…ƒç´ ï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™ç­‰å¾…ç›´åˆ°é˜Ÿåˆ—å‡ºç°ç©ºé—²ç©ºé—´</span>
<span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>BlockingQueue</code> å¯¹æ’å…¥æ“ä½œã€ç§»é™¤æ“ä½œã€è·å–å…ƒç´ æ“ä½œæä¾›äº†å››ç§ä¸åŒçš„æ–¹æ³•ç”¨äºä¸åŒçš„åœºæ™¯ä¸­ä½¿ç”¨ï¼š</p><ul><li>æŠ›å‡ºå¼‚å¸¸ï¼›</li><li>è¿”å›ç‰¹æ®Šå€¼ï¼ˆ<code>null</code> æˆ– <code>true</code>/<code>false</code>ï¼Œå–å†³äºå…·ä½“çš„æ“ä½œï¼‰ï¼›</li><li>é˜»å¡ç­‰å¾…æ­¤æ“ä½œï¼Œç›´åˆ°è¿™ä¸ªæ“ä½œæˆåŠŸï¼›</li><li>é˜»å¡ç­‰å¾…æ­¤æ“ä½œï¼Œç›´åˆ°æˆåŠŸæˆ–è€…è¶…æ—¶æŒ‡å®šæ—¶é—´ã€‚</li></ul><p>æ€»ç»“å¦‚ä¸‹ï¼š</p><table><thead><tr><th></th><th><strong>Throws exception</strong></th><th><strong>Special value</strong></th><th><strong>Blocks</strong></th><th><strong>Times out</strong></th></tr></thead><tbody><tr><td>Insert</td><td>add(e)</td><td>offer(e)</td><td>put(e)</td><td>offer(e, time, unit)</td></tr><tr><td>Remove</td><td>remove()</td><td>poll()</td><td>take()</td><td>poll(time, unit)</td></tr><tr><td>Examine</td><td>element()</td><td>peek()</td><td><strong>not applicable</strong></td><td><strong>not applicable</strong></td></tr></tbody></table><p><code>BlockingQueue</code> çš„å„ä¸ªå®ç°ç±»éƒ½éµå¾ªäº†è¿™äº›è§„åˆ™ã€‚</p><p><code>BlockingQueue</code> ä¸æ¥å— <code>null</code> å€¼å…ƒç´ ã€‚</p><p>JDK æä¾›äº†ä»¥ä¸‹é˜»å¡é˜Ÿåˆ—ï¼š</p><ul><li><code>ArrayBlockingQueue</code> - ä¸€ä¸ªç”±<strong>æ•°ç»„ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—</strong>ã€‚</li><li><code>LinkedBlockingQueue</code> - ä¸€ä¸ªç”±<strong>é“¾è¡¨ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—</strong>ã€‚</li><li><code>PriorityBlockingQueue</code> - ä¸€ä¸ª<strong>æ”¯æŒä¼˜å…ˆçº§æ’åºçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—</strong>ã€‚</li><li><code>SynchronousQueue</code> - ä¸€ä¸ª<strong>ä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—</strong>ã€‚</li><li><code>DelayQueue</code> - ä¸€ä¸ªä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚</li><li><code>LinkedTransferQueue</code> - ä¸€ä¸ª<strong>ç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—</strong>ã€‚</li></ul><p><code>BlockingQueue</code> åŸºæœ¬éƒ½æ˜¯åŸºäºé”å®ç°ã€‚</p><h3 id="priorityblockingqueue-ç±»" tabindex="-1"><a class="header-anchor" href="#priorityblockingqueue-ç±»" aria-hidden="true">#</a> PriorityBlockingQueue ç±»</h3><p><code>PriorityBlockingQueue</code> ç±»å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PriorityBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
    <span class="token keyword">implements</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="priorityblockingqueue-è¦ç‚¹" tabindex="-1"><a class="header-anchor" href="#priorityblockingqueue-è¦ç‚¹" aria-hidden="true">#</a> PriorityBlockingQueue è¦ç‚¹</h4><ul><li><code>PriorityBlockingQueue</code> å¯ä»¥è§†ä¸º <code>PriorityQueue</code> çš„çº¿ç¨‹å®‰å…¨ç‰ˆæœ¬ã€‚</li><li><code>PriorityBlockingQueue</code> å®ç°äº† <code>BlockingQueue</code>ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ã€‚</li><li><code>PriorityBlockingQueue</code> å®ç°äº† <code>Serializable</code>ï¼Œæ”¯æŒåºåˆ—åŒ–ã€‚</li><li><code>PriorityBlockingQueue</code> ä¸æ¥å— <code>null</code> å€¼å…ƒç´ ã€‚</li><li><code>PriorityBlockingQueue</code> çš„æ’å…¥æ“ä½œ <code>put</code> æ–¹æ³•ä¸ä¼š blockï¼Œå› ä¸ºå®ƒæ˜¯æ— ç•Œé˜Ÿåˆ—ï¼ˆtake æ–¹æ³•åœ¨é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ä¼šé˜»å¡ï¼‰ã€‚</li></ul><h4 id="priorityblockingqueue-åŸç†" tabindex="-1"><a class="header-anchor" href="#priorityblockingqueue-åŸç†" aria-hidden="true">#</a> PriorityBlockingQueue åŸç†</h4><p><code>PriorityBlockingQueue</code> æœ‰ä¸¤ä¸ªé‡è¦æˆå‘˜ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> queue<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>queue</code> æ˜¯ä¸€ä¸ª <code>Object</code> æ•°ç»„ï¼Œç”¨äºä¿å­˜ <code>PriorityBlockingQueue</code> çš„å…ƒç´ ã€‚</li><li>è€Œå¯é‡å…¥é” <code>lock</code> åˆ™ç”¨äºåœ¨æ‰§è¡Œæ’å…¥ã€åˆ é™¤æ“ä½œæ—¶ï¼Œä¿è¯è¿™ä¸ªæ–¹æ³•åœ¨å½“å‰çº¿ç¨‹é‡Šæ”¾é”ä¹‹å‰ï¼Œå…¶ä»–çº¿ç¨‹ä¸èƒ½è®¿é—®ã€‚</li></ul><p><code>PriorityBlockingQueue</code> çš„å®¹é‡è™½ç„¶æœ‰åˆå§‹åŒ–å¤§å°ï¼Œä½†æ˜¯ä¸é™åˆ¶å¤§å°ï¼Œå¦‚æœå½“å‰å®¹é‡å·²æ»¡ï¼Œæ’å…¥æ–°å…ƒç´ æ—¶ä¼šè‡ªåŠ¨æ‰©å®¹ã€‚</p><h3 id="arrayblockingqueue-ç±»" tabindex="-1"><a class="header-anchor" href="#arrayblockingqueue-ç±»" aria-hidden="true">#</a> ArrayBlockingQueue ç±»</h3><p><code>ArrayBlockingQueue</code> æ˜¯ç”±æ•°ç»„ç»“æ„ç»„æˆçš„<strong>æœ‰ç•Œé˜»å¡é˜Ÿåˆ—</strong>ã€‚</p><h4 id="arrayblockingqueue-è¦ç‚¹" tabindex="-1"><a class="header-anchor" href="#arrayblockingqueue-è¦ç‚¹" aria-hidden="true">#</a> ArrayBlockingQueue è¦ç‚¹</h4><p><code>ArrayBlockingQueue</code> ç±»å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span>
    <span class="token comment">// æ•°ç»„çš„å¤§å°å°±å†³å®šäº†é˜Ÿåˆ—çš„è¾¹ç•Œï¼Œæ‰€ä»¥åˆå§‹åŒ–æ—¶å¿…é¡»æŒ‡å®šå®¹é‡</span>
    <span class="token keyword">public</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//... }</span>
    <span class="token keyword">public</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">,</span> <span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//... }</span>
    <span class="token keyword">public</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">,</span> <span class="token keyword">boolean</span> fair<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//... }</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š</p><ul><li><code>ArrayBlockingQueue</code> å®ç°äº† <code>BlockingQueue</code>ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ã€‚</li><li><code>ArrayBlockingQueue</code> å®ç°äº† <code>Serializable</code>ï¼Œæ”¯æŒåºåˆ—åŒ–ã€‚</li><li><code>ArrayBlockingQueue</code> æ˜¯åŸºäºæ•°ç»„å®ç°çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚æ‰€ä»¥åˆå§‹åŒ–æ—¶å¿…é¡»æŒ‡å®šå®¹é‡ã€‚</li></ul><h4 id="arrayblockingqueue-åŸç†" tabindex="-1"><a class="header-anchor" href="#arrayblockingqueue-åŸç†" aria-hidden="true">#</a> ArrayBlockingQueue åŸç†</h4><p><code>ArrayBlockingQueue</code> çš„é‡è¦æˆå‘˜å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// ç”¨äºå­˜æ”¾å…ƒç´ çš„æ•°ç»„</span>
<span class="token keyword">final</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> items<span class="token punctuation">;</span>
<span class="token comment">// ä¸‹ä¸€æ¬¡è¯»å–æ“ä½œçš„ä½ç½®</span>
<span class="token keyword">int</span> takeIndex<span class="token punctuation">;</span>
<span class="token comment">// ä¸‹ä¸€æ¬¡å†™å…¥æ“ä½œçš„ä½ç½®</span>
<span class="token keyword">int</span> putIndex<span class="token punctuation">;</span>
<span class="token comment">// é˜Ÿåˆ—ä¸­çš„å…ƒç´ æ•°é‡</span>
<span class="token keyword">int</span> count<span class="token punctuation">;</span>

<span class="token comment">// ä»¥ä¸‹å‡ ä¸ªå°±æ˜¯æ§åˆ¶å¹¶å‘ç”¨çš„åŒæ­¥å™¨</span>
<span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notEmpty<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notFull<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>ArrayBlockingQueue</code> å†…éƒ¨ä»¥ <code>final</code> çš„æ•°ç»„ä¿å­˜æ•°æ®ï¼Œæ•°ç»„çš„å¤§å°å°±å†³å®šäº†é˜Ÿåˆ—çš„è¾¹ç•Œã€‚</p><p><code>ArrayBlockingQueue</code> å®ç°å¹¶å‘åŒæ­¥çš„åŸç†å°±æ˜¯ï¼Œè¯»æ“ä½œå’Œå†™æ“ä½œéƒ½éœ€è¦è·å–åˆ° AQS ç‹¬å é”æ‰èƒ½è¿›è¡Œæ“ä½œã€‚</p><ul><li>å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œè¿™ä¸ªæ—¶å€™è¯»æ“ä½œçš„çº¿ç¨‹è¿›å…¥åˆ°è¯»çº¿ç¨‹é˜Ÿåˆ—æ’é˜Ÿï¼Œç­‰å¾…å†™çº¿ç¨‹å†™å…¥æ–°çš„å…ƒç´ ï¼Œç„¶åå”¤é†’è¯»çº¿ç¨‹é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ã€‚</li><li>å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œè¿™ä¸ªæ—¶å€™å†™æ“ä½œçš„çº¿ç¨‹è¿›å…¥åˆ°å†™çº¿ç¨‹é˜Ÿåˆ—æ’é˜Ÿï¼Œç­‰å¾…è¯»çº¿ç¨‹å°†é˜Ÿåˆ—å…ƒç´ ç§»é™¤ï¼Œç„¶åå”¤é†’å†™çº¿ç¨‹é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ã€‚</li></ul><p>å¯¹äº <code>ArrayBlockingQueue</code>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ„é€ çš„æ—¶å€™æŒ‡å®šä»¥ä¸‹ä¸‰ä¸ªå‚æ•°ï¼š</p><ul><li>é˜Ÿåˆ—å®¹é‡ï¼Œå…¶é™åˆ¶äº†é˜Ÿåˆ—ä¸­æœ€å¤šå…è®¸çš„å…ƒç´ ä¸ªæ•°ï¼›</li><li>æŒ‡å®šç‹¬å é”æ˜¯å…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é”ã€‚éå…¬å¹³é”çš„ååé‡æ¯”è¾ƒé«˜ï¼Œå…¬å¹³é”å¯ä»¥ä¿è¯æ¯æ¬¡éƒ½æ˜¯ç­‰å¾…æœ€ä¹…çš„çº¿ç¨‹è·å–åˆ°é”ï¼›</li><li>å¯ä»¥æŒ‡å®šç”¨ä¸€ä¸ªé›†åˆæ¥åˆå§‹åŒ–ï¼Œå°†æ­¤é›†åˆä¸­çš„å…ƒç´ åœ¨æ„é€ æ–¹æ³•æœŸé—´å°±å…ˆæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ã€‚</li></ul><h3 id="linkedblockingqueue-ç±»" tabindex="-1"><a class="header-anchor" href="#linkedblockingqueue-ç±»" aria-hidden="true">#</a> LinkedBlockingQueue ç±»</h3><p><code>LinkedBlockingQueue</code> æ˜¯ç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚å®¹æ˜“è¢«è¯¯è§£ä¸ºæ— è¾¹ç•Œï¼Œä½†å…¶å®å…¶è¡Œä¸ºå’Œå†…éƒ¨ä»£ç éƒ½æ˜¯åŸºäºæœ‰ç•Œçš„é€»è¾‘å®ç°çš„ï¼Œåªä¸è¿‡å¦‚æœæˆ‘ä»¬æ²¡æœ‰åœ¨åˆ›å»ºé˜Ÿåˆ—æ—¶å°±æŒ‡å®šå®¹é‡ï¼Œé‚£ä¹ˆå…¶å®¹é‡é™åˆ¶å°±è‡ªåŠ¨è¢«è®¾ç½®ä¸º <code>Integer.MAX_VALUE</code>ï¼Œæˆä¸ºäº†æ— ç•Œé˜Ÿåˆ—ã€‚</p><h4 id="linkedblockingqueue-è¦ç‚¹" tabindex="-1"><a class="header-anchor" href="#linkedblockingqueue-è¦ç‚¹" aria-hidden="true">#</a> LinkedBlockingQueue è¦ç‚¹</h4><p><code>LinkedBlockingQueue</code> ç±»å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span>
        <span class="token keyword">implements</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>LinkedBlockingQueue</code> å®ç°äº† <code>BlockingQueue</code>ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ã€‚</li><li><code>LinkedBlockingQueue</code> å®ç°äº† <code>Serializable</code>ï¼Œæ”¯æŒåºåˆ—åŒ–ã€‚</li><li><code>LinkedBlockingQueue</code> æ˜¯åŸºäºå•é“¾è¡¨å®ç°çš„é˜»å¡é˜Ÿåˆ—ï¼Œå¯ä»¥å½“åšæ— ç•Œé˜Ÿåˆ—ä¹Ÿå¯ä»¥å½“åšæœ‰ç•Œé˜Ÿåˆ—æ¥ä½¿ç”¨ã€‚</li><li><code>LinkedBlockingQueue</code> ä¸­å…ƒç´ æŒ‰ç…§æ’å…¥é¡ºåºä¿å­˜ï¼ˆFIFOï¼‰ã€‚</li></ul><h4 id="linkedblockingqueue-åŸç†" tabindex="-1"><a class="header-anchor" href="#linkedblockingqueue-åŸç†" aria-hidden="true">#</a> LinkedBlockingQueue åŸç†</h4><p><code>LinkedBlockingQueue</code> ä¸­çš„é‡è¦æ•°æ®ç»“æ„ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token comment">// é˜Ÿåˆ—å®¹é‡</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> capacity<span class="token punctuation">;</span>
<span class="token comment">// é˜Ÿåˆ—ä¸­çš„å…ƒç´ æ•°é‡</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// é˜Ÿå¤´</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> head<span class="token punctuation">;</span>
<span class="token comment">// é˜Ÿå°¾</span>
<span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">Node</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> last<span class="token punctuation">;</span>

<span class="token comment">// take, poll, peek ç­‰è¯»æ“ä½œçš„æ–¹æ³•éœ€è¦è·å–åˆ°è¿™ä¸ªé”</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> takeLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// å¦‚æœè¯»æ“ä½œçš„æ—¶å€™é˜Ÿåˆ—æ˜¯ç©ºçš„ï¼Œé‚£ä¹ˆç­‰å¾… notEmpty æ¡ä»¶</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notEmpty <span class="token operator">=</span> takeLock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// put, offer ç­‰å†™æ“ä½œçš„æ–¹æ³•éœ€è¦è·å–åˆ°è¿™ä¸ªé”</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> putLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// å¦‚æœå†™æ“ä½œçš„æ—¶å€™é˜Ÿåˆ—æ˜¯æ»¡çš„ï¼Œé‚£ä¹ˆç­‰å¾… notFull æ¡ä»¶</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Condition</span> notFull <span class="token operator">=</span> putLock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="å‚è€ƒèµ„æ–™" tabindex="-1"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™" aria-hidden="true">#</a> å‚è€ƒèµ„æ–™</h2>`,93),b={href:"https://book.douban.com/subject/10484692/",target:"_blank",rel:"noopener noreferrer"},g={href:"https://book.douban.com/subject/26591326/",target:"_blank",rel:"noopener noreferrer"},y={href:"https://time.geekbang.org/column/intro/100023901",target:"_blank",rel:"noopener noreferrer"};function h(f,w){const a=o("ExternalLinkIcon");return c(),l("div",null,[u,n("blockquote",null,[n("p",null,[s("æƒ³è¯¦ç»†äº†è§£ "),k,s(" ç”¨æ³•å’ŒåŸç†å¯ä»¥å‚è€ƒï¼š"),n("a",r,[s("Java å¹¶å‘ä¹‹å†…å­˜æ¨¡å‹"),t(a)])])]),d,n("blockquote",null,[n("p",null,[s("ç¤ºä¾‹æ‘˜è‡ªï¼š"),n("a",v,[s("æå®¢æ—¶é—´æ•™ç¨‹ - Java ä¸šåŠ¡å¼€å‘å¸¸è§é”™è¯¯ 100 ä¾‹"),t(a)])])]),m,n("ul",null,[n("li",null,[n("a",b,[s("ã€ŠJava å¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹"),t(a)])]),n("li",null,[n("a",g,[s("ã€ŠJava å¹¶å‘ç¼–ç¨‹çš„è‰ºæœ¯ã€‹"),t(a)])]),n("li",null,[n("a",y,[s("æå®¢æ—¶é—´æ•™ç¨‹ - Java å¹¶å‘ç¼–ç¨‹å®æˆ˜"),t(a)])])])])}const L=e(i,[["render",h],["__file","index.html.vue"]]);export{L as default};
