import{_ as h}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as k,a as l,d,w as a,r as o,o as p,b as i,e as s}from"./app-Bn2Qe0IQ.js";const g={};function c(A,t){const r=o("CodeTabs");return p(),k("div",null,[t[8]||(t[8]=l(`<h1 id="java-å¹¶å‘é¢è¯•äºŒ" tabindex="-1"><a class="header-anchor" href="#java-å¹¶å‘é¢è¯•äºŒ"><span>Java å¹¶å‘é¢è¯•äºŒ</span></a></h1><h2 id="java-é”" tabindex="-1"><a class="header-anchor" href="#java-é”"><span>Java é”</span></a></h2><h3 id="ã€ä¸­ç­‰ã€‘java-ä¸­-æ ¹æ®ä¸åŒç»´åº¦åˆ’åˆ†-é”æœ‰å“ªäº›åˆ†ç±»" tabindex="-1"><a class="header-anchor" href="#ã€ä¸­ç­‰ã€‘java-ä¸­-æ ¹æ®ä¸åŒç»´åº¦åˆ’åˆ†-é”æœ‰å“ªäº›åˆ†ç±»"><span>ã€ä¸­ç­‰ã€‘Java ä¸­ï¼Œæ ¹æ®ä¸åŒç»´åº¦åˆ’åˆ†ï¼Œé”æœ‰å“ªäº›åˆ†ç±»ï¼Ÿ</span></a></h3><p>åœ¨ Java ä¸­ï¼Œé”å¯ä»¥æŒ‰ç…§ <strong>å¤šä¸ªç»´åº¦</strong> è¿›è¡Œåˆ†ç±»ï¼Œä¸åŒç»´åº¦çš„é”é€‚ç”¨äºä¸åŒçš„å¹¶å‘åœºæ™¯ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†çš„åˆ†ç±»ï¼š</p><p><strong>æŒ‰é”çš„å…¬å¹³æ€§åˆ’åˆ†</strong></p><table><thead><tr><th><strong>é”ç±»å‹</strong></th><th><strong>ç‰¹ç‚¹</strong></th><th><strong>å®ç°ç±»/å…³é”®å­—</strong></th></tr></thead><tbody><tr><td><strong>å…¬å¹³é”</strong></td><td>ä¸¥æ ¼æŒ‰ç…§çº¿ç¨‹è¯·æ±‚é¡ºåºï¼ˆFIFOï¼‰åˆ†é…é”ï¼Œé¿å…çº¿ç¨‹é¥¥é¥¿ï¼Œä½†æ€§èƒ½è¾ƒä½ã€‚</td><td><code>ReentrantLock(true)</code></td></tr><tr><td><strong>éå…¬å¹³é”</strong></td><td>å…è®¸æ’é˜Ÿï¼Œæ–°è¯·æ±‚çš„çº¿ç¨‹å¯èƒ½ç›´æ¥æŠ¢åˆ°é”ï¼Œååé‡é«˜ï¼Œä½†å¯èƒ½å¯¼è‡´çº¿ç¨‹é¥¥é¥¿ï¼ˆé»˜è®¤æ–¹å¼ï¼‰ã€‚</td><td><code>ReentrantLock(false)</code>ã€<code>synchronized</code></td></tr></tbody></table><p><strong>æŒ‰é”çš„è·å–æ–¹å¼åˆ’åˆ†</strong></p><table><thead><tr><th><strong>é”ç±»å‹</strong></th><th><strong>ç‰¹ç‚¹</strong></th><th><strong>å®ç°ç±»/å…³é”®å­—</strong></th></tr></thead><tbody><tr><td><strong>æ‚²è§‚é”</strong></td><td>è®¤ä¸ºå¹¶å‘å†²çªå¿…ç„¶å‘ç”Ÿï¼Œå…ˆåŠ é”å†æ“ä½œï¼ˆé˜»å¡å…¶ä»–çº¿ç¨‹ï¼‰ã€‚</td><td><code>synchronized</code>ã€<code>ReentrantLock</code></td></tr><tr><td><strong>ä¹è§‚é”</strong></td><td>è®¤ä¸ºå¹¶å‘å†²çªè¾ƒå°‘ï¼Œä¸åŠ é”ï¼Œæ›´æ–°æ—¶æ£€æŸ¥ï¼ˆCAS æˆ–ç‰ˆæœ¬å·æœºåˆ¶ï¼‰ã€‚</td><td><code>AtomicInteger</code>ã€<code>StampedLock</code></td></tr></tbody></table><p><strong>æŒ‰é”çš„å¯é‡å…¥æ€§åˆ’åˆ†</strong></p><table><thead><tr><th><strong>é”ç±»å‹</strong></th><th><strong>ç‰¹ç‚¹</strong></th><th><strong>å®ç°ç±»/å…³é”®å­—</strong></th></tr></thead><tbody><tr><td><strong>å¯é‡å…¥é”</strong></td><td>åŒä¸€çº¿ç¨‹å¯å¤šæ¬¡è·å–åŒä¸€æŠŠé”ï¼ˆé¿å…æ­»é”ï¼‰ã€‚</td><td><code>ReentrantLock</code>ã€<code>synchronized</code></td></tr><tr><td><strong>ä¸å¯é‡å…¥é”</strong></td><td>åŒä¸€çº¿ç¨‹é‡å¤è·å–åŒä¸€æŠŠé”ä¼šå¯¼è‡´æ­»é”ï¼ˆJava æ— åŸç”Ÿå®ç°ï¼Œéœ€è‡ªå®šä¹‰ï¼‰ã€‚</td><td>æ— ï¼ˆéœ€è‡ªè¡Œå®ç°ï¼‰</td></tr></tbody></table><p><strong>æŒ‰é”çš„å…±äº«æ€§åˆ’åˆ†</strong></p><table><thead><tr><th><strong>é”ç±»å‹</strong></th><th><strong>ç‰¹ç‚¹</strong></th><th><strong>å®ç°ç±»/å…³é”®å­—</strong></th></tr></thead><tbody><tr><td><strong>ç‹¬å é”ï¼ˆæ’ä»–é”ï¼‰</strong></td><td>åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰é”ï¼ˆå¦‚ <code>synchronized</code>ã€<code>ReentrantLock</code>ï¼‰ã€‚</td><td><code>synchronized</code>ã€<code>ReentrantLock</code></td></tr><tr><td><strong>å…±äº«é”</strong></td><td>å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–ï¼Œä½†å†™å…¥æ—¶ç‹¬å ï¼ˆå¦‚ <code>ReadWriteLock</code>ï¼‰ã€‚</td><td><code>ReentrantReadWriteLock</code></td></tr></tbody></table><p><strong>æŒ‰é”çš„é˜»å¡æ–¹å¼åˆ’åˆ†</strong></p><table><thead><tr><th><strong>é”ç±»å‹</strong></th><th><strong>ç‰¹ç‚¹</strong></th><th><strong>å®ç°ç±»/å…³é”®å­—</strong></th></tr></thead><tbody><tr><td><strong>é˜»å¡é”</strong></td><td>è·å–ä¸åˆ°é”æ—¶ï¼Œçº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼ˆå¦‚ <code>synchronized</code>ï¼‰ã€‚</td><td><code>synchronized</code>ã€<code>ReentrantLock</code></td></tr><tr><td><strong>è‡ªæ—‹é”</strong></td><td>è·å–ä¸åˆ°é”æ—¶ï¼Œçº¿ç¨‹å¾ªç¯å°è¯•ï¼ˆé¿å…çº¿ç¨‹åˆ‡æ¢ï¼Œä½†æ¶ˆè€— CPUï¼‰ã€‚</td><td><code>AtomicInteger</code>ï¼ˆCAS è‡ªæ—‹ï¼‰</td></tr><tr><td><strong>é€‚åº”æ€§è‡ªæ—‹é”</strong></td><td>JVM è‡ªåŠ¨ä¼˜åŒ–è‡ªæ—‹æ¬¡æ•°ï¼ˆå¦‚ <code>synchronized</code> åœ¨ JDK 6+ çš„ä¼˜åŒ–ï¼‰ã€‚</td><td>JVM å†…éƒ¨ä¼˜åŒ–</td></tr></tbody></table><p><strong>æŒ‰é”çš„ä¼˜åŒ–ç­–ç•¥åˆ’åˆ†</strong></p><table><thead><tr><th><strong>é”ç±»å‹</strong></th><th><strong>ç‰¹ç‚¹</strong></th><th><strong>å®ç°ç±»/å…³é”®å­—</strong></th></tr></thead><tbody><tr><td><strong>åå‘é”</strong></td><td>å•çº¿ç¨‹è®¿é—®æ—¶æ— åŒæ­¥å¼€é”€ï¼ˆJDK 6+ å¯¹ <code>synchronized</code> çš„ä¼˜åŒ–ï¼‰ã€‚</td><td>JVM è‡ªåŠ¨ä¼˜åŒ–ï¼ˆ<code>synchronized</code>ï¼‰</td></tr><tr><td><strong>è½»é‡çº§é”</strong></td><td>å¤šçº¿ç¨‹æ— ç«äº‰æ—¶ï¼Œä½¿ç”¨ CAS ä»£æ›¿é˜»å¡ï¼ˆJDK 6+ ä¼˜åŒ–ï¼‰ã€‚</td><td>JVM è‡ªåŠ¨ä¼˜åŒ–ï¼ˆ<code>synchronized</code>ï¼‰</td></tr><tr><td><strong>é‡é‡çº§é”</strong></td><td>çœŸæ­£çš„äº’æ–¥é”ï¼Œæ¶‰åŠ OS çº¿ç¨‹é˜»å¡ï¼ˆå¦‚ <code>synchronized</code> ç«äº‰æ¿€çƒˆæ—¶ï¼‰ã€‚</td><td>JVM è‡ªåŠ¨å‡çº§ï¼ˆ<code>synchronized</code>ï¼‰</td></tr></tbody></table><p><strong>æŒ‰é”çš„å®ç°æ–¹å¼åˆ’åˆ†</strong></p><table><thead><tr><th><strong>é”ç±»å‹</strong></th><th><strong>ç‰¹ç‚¹</strong></th><th><strong>å®ç°ç±»/å…³é”®å­—</strong></th></tr></thead><tbody><tr><td><strong>å†…ç½®é”ï¼ˆJVM é”ï¼‰</strong></td><td>ç”± JVM å®ç°ï¼ˆå¦‚ <code>synchronized</code>ï¼‰ã€‚</td><td><code>synchronized</code></td></tr><tr><td><strong>æ˜¾å¼é”</strong></td><td>ç”± Java API æä¾›ï¼ˆå¦‚ <code>ReentrantLock</code>ï¼‰ã€‚</td><td><code>ReentrantLock</code>ã€<code>ReadWriteLock</code></td></tr><tr><td><strong>åˆ†å¸ƒå¼é”</strong></td><td>è·¨ JVM çš„é”ï¼ˆå¦‚ Redisã€ZooKeeper å®ç°ï¼‰ã€‚</td><td><code>Redisson</code>ã€<code>Curator</code></td></tr></tbody></table><p><strong>æ€»ç»“</strong></p><table><thead><tr><th><strong>åˆ†ç±»ç»´åº¦</strong></th><th><strong>é”ç±»å‹</strong></th></tr></thead><tbody><tr><td><strong>å…¬å¹³æ€§</strong></td><td>å…¬å¹³é”ã€éå…¬å¹³é”</td></tr><tr><td><strong>è·å–æ–¹å¼</strong></td><td>æ‚²è§‚é”ã€ä¹è§‚é”</td></tr><tr><td><strong>å¯é‡å…¥æ€§</strong></td><td>å¯é‡å…¥é”ã€ä¸å¯é‡å…¥é”</td></tr><tr><td><strong>å…±äº«æ€§</strong></td><td>ç‹¬å é”ã€å…±äº«é”</td></tr><tr><td><strong>é˜»å¡æ–¹å¼</strong></td><td>é˜»å¡é”ã€è‡ªæ—‹é”ã€é€‚åº”æ€§è‡ªæ—‹é”</td></tr><tr><td><strong>ä¼˜åŒ–ç­–ç•¥</strong></td><td>åå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”</td></tr><tr><td><strong>å®ç°æ–¹å¼</strong></td><td>å†…ç½®é”ï¼ˆ<code>synchronized</code>ï¼‰ã€æ˜¾å¼é”ï¼ˆ<code>ReentrantLock</code>ï¼‰ã€åˆ†å¸ƒå¼é”ï¼ˆ<code>Redisson</code>ï¼‰</td></tr></tbody></table><p><strong>é€‰æ‹©åˆé€‚çš„é”å–å†³äºï¼š</strong></p><ul><li><strong>å¹¶å‘ç«äº‰ç¨‹åº¦</strong>ï¼ˆé«˜ç«äº‰â†’æ‚²è§‚é”ï¼Œä½ç«äº‰â†’ä¹è§‚é”ï¼‰</li><li><strong>ä»»åŠ¡æ‰§è¡Œæ—¶é—´</strong>ï¼ˆé•¿ä»»åŠ¡â†’å…¬å¹³é”ï¼ŒçŸ­ä»»åŠ¡â†’éå…¬å¹³é”ï¼‰</li><li><strong>è¯»å†™æ¯”ä¾‹</strong>ï¼ˆè¯»å¤šâ†’å…±äº«é”ï¼Œå†™å¤šâ†’ç‹¬å é”ï¼‰</li><li><strong>æ˜¯å¦éœ€è¦è·¨ JVM</strong>ï¼ˆæ˜¯â†’åˆ†å¸ƒå¼é”ï¼‰</li></ul><p>è¿™äº›åˆ†ç±»å¸®åŠ©å¼€å‘è€…æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©æœ€ä¼˜çš„é”ç­–ç•¥ï¼Œå¹³è¡¡ <strong>æ€§èƒ½ã€å…¬å¹³æ€§ã€ä¸€è‡´æ€§</strong>ã€‚</p><h3 id="ã€ä¸­ç­‰ã€‘æ‚²è§‚é”å’Œä¹è§‚é”æœ‰ä»€ä¹ˆåŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#ã€ä¸­ç­‰ã€‘æ‚²è§‚é”å’Œä¹è§‚é”æœ‰ä»€ä¹ˆåŒºåˆ«"><span>ã€ä¸­ç­‰ã€‘æ‚²è§‚é”å’Œä¹è§‚é”æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</span></a></h3><p><strong>æ‚²è§‚é”å‡å®šä¼šå†²çªï¼Œæå‰åŠ é”é˜»å¡ï¼›ä¹è§‚é”å‡å®šä¸å†²çªï¼Œæäº¤æ—¶æ£€æµ‹ç‰ˆæœ¬ï¼Œå†²çªåˆ™é‡è¯•ã€‚</strong></p><ul><li><strong>æ‚²è§‚é”</strong>ï¼šå…ˆåŠ é”å†æ“ä½œï¼Œé€‚åˆå†™å¤šè¯»å°‘çš„é«˜å¹¶å‘åœºæ™¯ï¼Œä¿è¯å®‰å…¨ä½†æ€§èƒ½è¾ƒä½ï¼Œå¦‚é‡‘èäº¤æ˜“ã€‚</li><li><strong>ä¹è§‚é”</strong>ï¼šé€šè¿‡ç‰ˆæœ¬å·æˆ– CAS æœºåˆ¶å®ç°ï¼Œæäº¤æ—¶æ£€æŸ¥æ•°æ®æ˜¯å¦è¢«ä¿®æ”¹ï¼Œé€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œå¦‚ç”µå•†åº“å­˜ã€‚</li></ul><p>ä»¥ä¸‹æ˜¯æ‚²è§‚é”ä¸ä¹è§‚é”çš„è¯¦ç»†å¯¹æ¯”ï¼š</p><table><thead><tr><th><strong>å¯¹æ¯”ç»´åº¦</strong></th><th><strong>æ‚²è§‚é”</strong></th><th><strong>ä¹è§‚é”</strong></th></tr></thead><tbody><tr><td><strong>æ ¸å¿ƒæ€æƒ³</strong></td><td>å‡å®šå¹¶å‘å†²çªå¿…ç„¶å‘ç”Ÿï¼Œå…ˆåŠ é”å†è®¿é—®æ•°æ®</td><td>å‡å®šå¹¶å‘å†²çªè¾ƒå°‘ï¼Œå…ˆæ“ä½œå†æ£€æµ‹å†²çª</td></tr><tr><td><strong>é”æœºåˆ¶</strong></td><td>æ˜¾å¼åŠ é”ï¼ˆé˜»å¡å…¶ä»–çº¿ç¨‹ï¼‰</td><td>æ— é”æœºåˆ¶ï¼ˆä¾èµ– CAS æˆ–ç‰ˆæœ¬å·æ§åˆ¶ï¼‰</td></tr><tr><td><strong>å®ç°æ–¹å¼</strong></td><td><code>synchronized</code>ã€<code>ReentrantLock</code>ã€æ•°æ®åº“<code>SELECT FOR UPDATE</code></td><td><code>Atomic</code>ç±»ï¼ˆCASï¼‰ã€ç‰ˆæœ¬å·æœºåˆ¶ã€æ•°æ®åº“ä¹è§‚é”ï¼ˆå¦‚ MVCCï¼‰</td></tr><tr><td><strong>çº¿ç¨‹é˜»å¡</strong></td><td>ä¼šé˜»å¡ç«äº‰çº¿ç¨‹ï¼ˆçº¿ç¨‹æŒ‚èµ·ï¼‰</td><td>ä¸é˜»å¡çº¿ç¨‹ï¼Œä½†å¯èƒ½è‡ªæ—‹é‡è¯•æˆ–å¤±è´¥</td></tr><tr><td><strong>æ•°æ®ä¸€è‡´æ€§</strong></td><td>å¼ºä¸€è‡´æ€§ï¼ˆç‹¬å è®¿é—®ï¼‰</td><td>æœ€ç»ˆä¸€è‡´æ€§ï¼ˆå¯èƒ½éœ€é‡è¯•ï¼‰</td></tr><tr><td><strong>é€‚ç”¨åœºæ™¯</strong></td><td>- å†™æ“ä½œé¢‘ç¹<br>- ä¸´ç•ŒåŒºä»£ç æ‰§è¡Œæ—¶é—´é•¿<br>- å¼ºä¸€è‡´æ€§è¦æ±‚é«˜</td><td>- è¯»å¤šå†™å°‘<br>- çŸ­å¹³å¿«æ“ä½œ<br>- é«˜ååé‡éœ€æ±‚</td></tr><tr><td><strong>æ€§èƒ½ç‰¹ç‚¹</strong></td><td>- é«˜ç«äº‰æ—¶æ€§èƒ½ä¸‹é™æ˜æ˜¾ï¼ˆçº¿ç¨‹åˆ‡æ¢å¼€é”€ï¼‰<br>- ä½ç«äº‰æ—¶ä»æœ‰å›ºå®šé”å¼€é”€</td><td>- ä½ç«äº‰æ—¶æ€§èƒ½æä½³ï¼ˆæ— é˜»å¡ï¼‰<br>- é«˜ç«äº‰æ—¶ CPU è‡ªæ—‹æµªè´¹</td></tr><tr><td><strong>å†²çªå¤„ç†</strong></td><td>é€šè¿‡é”æ’é˜Ÿé¿å…å†²çª</td><td>é€šè¿‡é‡è¯•æˆ–æ”¾å¼ƒå¤„ç†å†²çª</td></tr><tr><td><strong>å…¸å‹åº”ç”¨</strong></td><td>- é“¶è¡Œè½¬è´¦<br>- è®¢å•æ”¯ä»˜<br>- æ•°æ®åº“è¡Œçº§é”</td><td>- åº“å­˜æ‰£å‡<br>- è®¡æ•°å™¨<br>- ç‚¹èµç³»ç»Ÿ</td></tr><tr><td><strong>ä¼˜ç¼ºç‚¹</strong></td><td>âœ”ï¸ å¼ºä¸€è‡´æ€§<br>âŒ ååé‡ä½ã€æ­»é”é£é™©</td><td>âœ”ï¸ é«˜å¹¶å‘æ€§èƒ½å¥½<br>âŒ å®ç°å¤æ‚ã€å¯èƒ½ ABA é—®é¢˜</td></tr></tbody></table><h3 id="ã€ä¸­ç­‰ã€‘å…¬å¹³é”å’Œéå…¬å¹³é”æœ‰ä»€ä¹ˆåŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#ã€ä¸­ç­‰ã€‘å…¬å¹³é”å’Œéå…¬å¹³é”æœ‰ä»€ä¹ˆåŒºåˆ«"><span>ã€ä¸­ç­‰ã€‘å…¬å¹³é”å’Œéå…¬å¹³é”æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</span></a></h3><p><strong>å…¬å¹³é”æŒ‰è¯·æ±‚é¡ºåºåˆ†é…ï¼Œéå…¬å¹³é”å…è®¸æ’é˜Ÿï¼Œå¯èƒ½è®©å…ˆåˆ°çš„çº¿ç¨‹ç­‰å¾…ã€‚</strong></p><ul><li><strong>å…¬å¹³é”</strong>ï¼šçº¿ç¨‹è·å–é”çš„é¡ºåºä¸¥æ ¼éµå¾ªè¯·æ±‚çš„å…ˆåé¡ºåºï¼Œä¿è¯å…¬å¹³æ€§ä½†å¯èƒ½é™ä½ååé‡ã€‚</li><li><strong>éå…¬å¹³é”</strong>ï¼šå…è®¸åè¯·æ±‚çš„çº¿ç¨‹â€œæ’é˜Ÿâ€æŠ¢å…ˆè·å–é”ï¼Œè™½å¯èƒ½é€ æˆé¥¥é¥¿ä½†é€šå¸¸èƒ½æé«˜ç³»ç»Ÿæ•´ä½“æ€§èƒ½ã€‚</li></ul><p>å…¬å¹³é”å’Œéå…¬å¹³é”çš„è¯¦ç»†å¯¹æ¯”ï¼š</p><table><thead><tr><th><strong>å¯¹æ¯”ç»´åº¦</strong></th><th><strong>å…¬å¹³é” (Fair Lock)</strong></th><th><strong>éå…¬å¹³é” (Nonfair Lock)</strong></th></tr></thead><tbody><tr><td><strong>é”è·å–é¡ºåº</strong></td><td>ä¸¥æ ¼æŒ‰ç…§çº¿ç¨‹è¯·æ±‚é¡ºåºï¼ˆFIFOï¼‰åˆ†é…é”</td><td>å…è®¸æ’é˜Ÿï¼Œæ–°è¯·æ±‚çš„çº¿ç¨‹å¯èƒ½ç›´æ¥æŠ¢åˆ°é”</td></tr><tr><td><strong>æ€§èƒ½è¡¨ç°</strong></td><td>ååé‡è¾ƒä½ï¼ˆä¸Šä¸‹æ–‡åˆ‡æ¢é¢‘ç¹ï¼‰</td><td>ååé‡è¾ƒé«˜ï¼ˆå‡å°‘çº¿ç¨‹åˆ‡æ¢ï¼Œä½†å¯èƒ½çº¿ç¨‹é¥¥é¥¿ï¼‰</td></tr><tr><td><strong>å“åº”æ—¶é—´</strong></td><td>ç­‰å¾…æ—¶é—´ç¨³å®šï¼ˆé€‚åˆé•¿ä»»åŠ¡ï¼‰</td><td>çŸ­ä»»åŠ¡å¯èƒ½æ›´å¿«è·å–é”ï¼ˆé€‚åˆé«˜å¹¶å‘çŸ­ä»»åŠ¡ï¼‰</td></tr><tr><td><strong>é€‚ç”¨åœºæ™¯</strong></td><td>- éœ€è¦ä¸¥æ ¼å…¬å¹³æ€§<br>- çº¿ç¨‹æ‰§è¡Œæ—¶é—´å·®å¼‚å¤§ï¼ˆé¿å…é¥¥é¥¿ï¼‰</td><td>- é«˜å¹¶å‘çŸ­ä»»åŠ¡<br>- è¿½æ±‚ååé‡</td></tr><tr><td><strong>é”å®ç°ç±»</strong></td><td><code>ReentrantLock(true)</code></td><td><code>ReentrantLock(false)</code>ï¼ˆé»˜è®¤ï¼‰</td></tr><tr><td><strong>å®ç°</strong></td><td>ä¾èµ– AQS ç»´æŠ¤ç­‰å¾…çº¿ç¨‹ï¼Œå…ˆåˆ°å…ˆå¾—</td><td>å…ˆå°è¯• CAS æŠ¢é”ï¼Œå¤±è´¥åè¿›å…¥ AQS é˜Ÿåˆ—</td></tr><tr><td><strong>çº¿ç¨‹é¥¥é¥¿</strong></td><td>ä¸ä¼šå‘ç”Ÿ</td><td>å¯èƒ½å‘ç”Ÿï¼ˆé«˜å¹¶å‘æ—¶æŸäº›çº¿ç¨‹é•¿æœŸæ— æ³•è·å–é”ï¼‰</td></tr><tr><td><strong>æ“ä½œç³»ç»Ÿè°ƒåº¦å½±å“</strong></td><td>ä¾èµ–ç³»ç»Ÿçº¿ç¨‹è°ƒåº¦ï¼Œå¯èƒ½å› ä¼˜å…ˆçº§åè½¬å½±å“å…¬å¹³æ€§</td><td>æ›´ä¾èµ– JVM çš„é”ä¼˜åŒ–ç­–ç•¥</td></tr><tr><td><strong>é”é‡å…¥æ€§</strong></td><td>æ”¯æŒï¼ˆä¸å…¬å¹³æ€§æ— å…³ï¼‰</td><td>æ”¯æŒï¼ˆä¸å…¬å¹³æ€§æ— å…³ï¼‰</td></tr><tr><td><strong>é€‚ç”¨å¹¶å‘æ¨¡å‹</strong></td><td>é€‚åˆä»»åŠ¡æ‰§è¡Œæ—¶é—´ä¸å‡è¡¡çš„åœºæ™¯</td><td>é€‚åˆä»»åŠ¡æ‰§è¡Œæ—¶é—´çŸ­çš„åœºæ™¯</td></tr></tbody></table><p><strong>å¦‚ä½•é€‰æ‹©ï¼Ÿ</strong></p><ul><li><p><strong>é€‰å…¬å¹³é”</strong>ï¼š</p><ul><li>éœ€è¦ä¸¥æ ¼é¡ºåºæ‰§è¡Œï¼ˆå¦‚è®¢å•å¤„ç†ï¼‰</li><li>é¿å…ä½ä¼˜å…ˆçº§çº¿ç¨‹é¥¥é¥¿</li><li>çº¿ç¨‹ä»»åŠ¡æ‰§è¡Œæ—¶é—´å·®å¼‚å¤§</li></ul></li><li><p><strong>é€‰éå…¬å¹³é”</strong>ï¼š</p><ul><li>è¿½æ±‚é«˜ååé‡ï¼ˆå¦‚ç§’æ€ç³»ç»Ÿï¼‰</li><li>ä»»åŠ¡æ‰§è¡Œæ—¶é—´çŸ­ä¸”å‡åŒ€</li><li>èƒ½æ¥å—å¶å°”çš„çº¿ç¨‹é¥¥é¥¿</li></ul></li></ul><p><strong>æ³¨æ„äº‹é¡¹ï¼š</strong></p><ul><li><strong>é»˜è®¤è¡Œä¸º</strong>ï¼š<code>ReentrantLock</code> å’Œ <code>synchronized</code> é»˜è®¤éƒ½æ˜¯<strong>éå…¬å¹³é”</strong>ï¼ˆå› ä¸ºæ€§èƒ½æ›´å¥½ï¼‰ã€‚</li><li><strong>æ€§èƒ½å·®å¼‚</strong>ï¼šéå…¬å¹³é”åœ¨é«˜å¹¶å‘ä¸‹ååé‡å¯æå‡ <strong>10%~30%</strong>ï¼Œä½†å¯èƒ½å¢åŠ å»¶è¿Ÿæ–¹å·®ã€‚</li><li><strong>synchronized çš„å…¬å¹³æ€§</strong>ï¼šJava çš„ <code>synchronized</code> <strong>ä¸æ”¯æŒå…¬å¹³é”</strong>ï¼Œä»… <code>ReentrantLock</code> å¯é…ç½®ã€‚</li></ul><h3 id="ã€å›°éš¾ã€‘aqs-çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆ-â­â­â­" tabindex="-1"><a class="header-anchor" href="#ã€å›°éš¾ã€‘aqs-çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆ-â­â­â­"><span>ã€å›°éš¾ã€‘AQS çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿâ­â­â­</span></a></h3><p>AQSï¼ˆ<strong>AbstractQueuedSynchronizer</strong>ï¼‰æ˜¯ Java å¹¶å‘åŒ…ï¼ˆ<code>java.util.concurrent.locks</code>ï¼‰çš„æ ¸å¿ƒæ¡†æ¶ï¼Œç”¨äºæ„å»ºé”ï¼ˆå¦‚ <code>ReentrantLock</code>ï¼‰å’ŒåŒæ­¥å™¨ï¼ˆå¦‚ <code>CountDownLatch</code>ã€<code>Semaphore</code>ï¼‰ã€‚</p><p><strong>AQS ç”¨ä¸€ä¸ª volatile int çŠ¶æ€å€¼ + ä¸€ä¸ªåŒå‘é“¾è¡¨é˜Ÿåˆ—ï¼ˆCLHï¼‰ï¼Œé€šè¿‡ CAS è‡ªæ—‹å®ç°çº¿ç¨‹çš„æ’é˜Ÿä¸å”¤é†’ï¼Œæ˜¯ Java å¹¶å‘é”çš„â€œéª¨æ¶å¼•æ“â€ã€‚</strong></p><div class="hint-container info"><p class="hint-container-title">AQS è¦ç‚¹</p></div><p>AQS åŸç†å¯å½’çº³ä¸ºï¼š<strong>2 ç§æ¨¡å¼ï¼Œ3 å¤§æ ¸å¿ƒï¼Œ4 æ­¥æ“ä½œ</strong></p><p><strong>2 ç§æ¨¡å¼</strong></p><ul><li><strong>ç‹¬å æ¨¡å¼ï¼ˆExclusiveï¼‰</strong>ï¼šåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è·å–èµ„æºï¼ˆå¦‚ <code>ReentrantLock</code>ï¼‰ã€‚</li><li><strong>å…±äº«æ¨¡å¼ï¼ˆSharedï¼‰</strong>ï¼šå¤šä¸ªçº¿ç¨‹å¯åŒæ—¶è·å–èµ„æºï¼ˆå¦‚ <code>Semaphore</code>, <code>CountDownLatch</code>ï¼‰ã€‚</li></ul><p><strong>3 å¤§æ ¸å¿ƒ</strong></p><ol><li><strong>çŠ¶æ€ï¼ˆStateï¼‰</strong>ï¼šä¸€ä¸ª <code>volatile</code> æ•´å‹å˜é‡ï¼Œç”¨äºè¡¨ç¤ºåŒæ­¥çŠ¶æ€ã€‚<code>state</code> åœ¨ä¸åŒçš„åŒæ­¥ç»„ä»¶ä¸­æ„ä¹‰ä¸åŒã€‚ <ul><li><strong>é”çš„æ„ä¹‰</strong>ï¼š0 ä»£è¡¨æ— é”ï¼Œ&gt;0 ä»£è¡¨æœ‰é”ï¼ˆå¯é‡å…¥æ—¶ç´¯åŠ ï¼‰ã€‚ä¾‹å¦‚åœ¨ <code>ReentrantLock</code> é‡Œï¼Œ<code>state</code> ä¸º 0 è¡¨ç¤ºé”æœªè¢«æŒæœ‰ï¼Œå¤§äº 0 è¡¨ç¤ºé”å·²è¢«æŒæœ‰ï¼Œä¸”é‡å…¥æ¬¡æ•°å°±æ˜¯ <code>state</code> çš„å€¼ã€‚</li><li><strong>ä¿¡å·é‡/CountDownLatch ç­‰æ„ä¹‰</strong>ï¼šstate è¡¨ç¤ºå¯ç”¨èµ„æºæ•°æˆ–å€’æ•°è®¡æ•°ã€‚</li></ul></li><li><strong>åŒæ­¥é˜Ÿåˆ—ï¼ˆCLH å˜ä½“ï¼‰</strong>ï¼šä¸€ä¸ª<strong>åŒé“¾è¡¨</strong>ï¼Œå­˜æ”¾ç­‰å¾…è·å–èµ„æºçš„çº¿ç¨‹ã€‚<code>Node</code> åŒ…å«ä»¥ä¸‹é‡è¦å±æ€§ï¼š <ul><li><strong><code>thread</code></strong>ï¼šæŒ‡å‘ç­‰å¾…è·å–åŒæ­¥çŠ¶æ€çš„çº¿ç¨‹ã€‚</li><li><strong><code>prev</code> å’Œ <code>next</code></strong>ï¼šåˆ†åˆ«æŒ‡å‘å‰ä¸€ä¸ªèŠ‚ç‚¹å’Œåä¸€ä¸ªèŠ‚ç‚¹ï¼Œä»è€Œå½¢æˆåŒå‘é“¾è¡¨ã€‚</li><li><strong><code>waitStatus</code></strong>ï¼šè¡¨ç¤ºèŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€ï¼Œå¸¸è§çš„çŠ¶æ€æœ‰ï¼š <ul><li><code>CANCELLED</code>ï¼ˆ1ï¼‰ï¼šè¡¨ç¤ºè¯¥èŠ‚ç‚¹å¯¹åº”çš„çº¿ç¨‹å·²å–æ¶ˆç­‰å¾…ã€‚</li><li><code>SIGNAL</code>ï¼ˆ-1ï¼‰ï¼šè¡¨ç¤ºè¯¥èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹éœ€è¦è¢«å”¤é†’ã€‚</li><li><code>CONDITION</code>ï¼ˆ-2ï¼‰ï¼šè¡¨ç¤ºè¯¥èŠ‚ç‚¹å¤„äºæ¡ä»¶é˜Ÿåˆ—ä¸­ã€‚</li><li><code>PROPAGATE</code>ï¼ˆ-3ï¼‰ï¼šç”¨äºå…±äº«æ¨¡å¼ä¸‹ï¼Œè¡¨æ˜çŠ¶æ€éœ€è¦å‘åä¼ æ’­ã€‚</li></ul></li><li>æ¯ä¸ªçº¿ç¨‹è¢«å°è£…ä¸ºä¸€ä¸ª <strong>Node èŠ‚ç‚¹</strong>ã€‚</li><li>é˜Ÿåˆ—å¤´èŠ‚ç‚¹ï¼ˆheadï¼‰æ˜¯å½“å‰æŒæœ‰èµ„æºçš„çº¿ç¨‹ï¼ˆç‹¬å æ¨¡å¼ï¼‰æˆ–å·²å”¤é†’çš„èŠ‚ç‚¹ã€‚</li></ul></li><li><strong>CAS æ“ä½œ</strong>ï¼šæ‰€æœ‰å¯¹ <code>state</code> å’Œé˜Ÿåˆ—å¤´çš„ä¿®æ”¹ï¼Œéƒ½é€šè¿‡ <strong><code>Unsafe.compareAndSwap</code></strong> åŸå­å®Œæˆï¼Œä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</li></ol><p><strong>4 æ­¥å…³é”®æ“ä½œ</strong></p><p>å¯ä»¥æŠŠä¸€ä¸ªçº¿ç¨‹è·å–é”åˆ°é‡Šæ”¾é”çš„è¿‡ç¨‹ï¼Œæƒ³è±¡æˆ**â€œå°è¯•åŠ é” â†’ æ’é˜Ÿç­‰å€™ â†’ è¢«å”¤é†’ â†’ è§£é”â€**çš„æµç¨‹ã€‚</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>çº¿ç¨‹è¯·æ±‚èµ„æº</span></span>
<span class="line"><span>    â”‚</span></span>
<span class="line"><span>    â–¼</span></span>
<span class="line"><span>   state=0? â”€â”€Yâ”€â”€&gt; CAS è·å–èµ„æºï¼ˆæˆåŠŸï¼‰</span></span>
<span class="line"><span>    â”‚                     â”‚</span></span>
<span class="line"><span>    N                     â–¼</span></span>
<span class="line"><span>    â”‚                æ‰§è¡Œã€å æœ‰èµ„æº</span></span>
<span class="line"><span>    â–¼                     â”‚</span></span>
<span class="line"><span>åŠ å…¥ CLH é˜Ÿåˆ—å°¾éƒ¨ â—„â”€â”€â”€ å¤±è´¥     â”‚</span></span>
<span class="line"><span>    â”‚                     â–¼</span></span>
<span class="line"><span>è‡ªæ—‹/æ£€æŸ¥/æŒ‚èµ·       é‡Šæ”¾èµ„æº (state=0)</span></span>
<span class="line"><span>ï¼ˆç­‰å¾…è¢«å‰é©±å”¤é†’ï¼‰         â”‚</span></span>
<span class="line"><span>    â”‚                     â–¼</span></span>
<span class="line"><span>    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  å”¤é†’åç»§èŠ‚ç‚¹</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container info"><p class="hint-container-title">AQS ç‹¬å æ¨¡å¼å·¥ä½œæµç¨‹</p></div><p><strong>ç‹¬å æ¨¡å¼</strong>ï¼šåŒä¸€æ—¶åˆ»ä»…å…è®¸ä¸€ä¸ªçº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€ï¼Œä¾‹å¦‚ <code>ReentrantLock</code>ã€‚</p><ol><li><strong>tryAcquire</strong>ï¼šçº¿ç¨‹å°è¯•ç›´æ¥è·å–é”ï¼ˆCAS ä¿®æ”¹ stateï¼‰ã€‚ <ul><li><strong>æˆåŠŸ</strong>ï¼šæ‹¿åˆ°é”ï¼Œè®¾ç½®è‡ªå·±ä¸ºç‹¬å çº¿ç¨‹ã€‚</li><li><strong>å¤±è´¥</strong>ï¼šè¿›å…¥ç¬¬ 2 æ­¥ã€‚</li></ul></li><li><strong>addWaiter</strong>ï¼šå°†å½“å‰çº¿ç¨‹åŒ…è£…æˆ Node èŠ‚ç‚¹ï¼Œ<strong>ç”¨ CAS å¿«é€Ÿæ’å…¥</strong>åˆ°åŒæ­¥é˜Ÿåˆ—å°¾éƒ¨ã€‚</li><li><strong>acquireQueued</strong>ï¼šåœ¨é˜Ÿåˆ—ä¸­è¿›å…¥â€œ<strong>è‡ªæ—‹-æ£€æµ‹-æŒ‚èµ·</strong>â€å¾ªç¯ã€‚ <ul><li>æ£€æŸ¥è‡ªå·±æ˜¯ä¸æ˜¯ç¬¬äºŒä¸ªèŠ‚ç‚¹ï¼ˆå³ head çš„ä¸‹ä¸€ä¸ªï¼‰ï¼Œå¦‚æœæ˜¯åˆ™å†æ¬¡å°è¯•è·å–é”ï¼ˆtryAcquireï¼‰ã€‚</li><li>å¦‚æœè·å–å¤±è´¥ï¼Œåˆ™æ ¹æ®å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œå†³å®šæ˜¯å¦å°†è‡ªå·±æŒ‚èµ·ï¼ˆ<code>LockSupport.park</code>ï¼‰ã€‚</li></ul></li><li><strong>release &amp; unparkSuccessor</strong>ï¼šæŒæœ‰é”çš„çº¿ç¨‹é‡Šæ”¾é”æ—¶ã€‚ <ul><li><code>tryRelease</code>ï¼šä¿®æ”¹ stateã€‚</li><li>å”¤é†’ï¼ˆ<code>LockSupport.unpark</code>ï¼‰é˜Ÿåˆ—ä¸­ä¸‹ä¸€ä¸ªç­‰å¾…çš„èŠ‚ç‚¹ï¼ˆåç»§èŠ‚ç‚¹ï¼‰ï¼Œè®©å®ƒé‡æ–°å°è¯•è·å–é”ã€‚</li></ul></li></ol><div class="hint-container info"><p class="hint-container-title">AQS å…±äº«æ¨¡å¼å·¥ä½œæµç¨‹</p></div><p><strong>å…±äº«æ¨¡å¼</strong>ï¼šåŒä¸€æ—¶åˆ»å…è®¸å¤šä¸ªçº¿ç¨‹è·å–åŒæ­¥çŠ¶æ€ï¼Œä¾‹å¦‚ <code>CountDownLatch</code> å’Œ <code>Semaphore</code>ã€‚</p><ul><li><strong>è·å–é”</strong>ï¼š <ul><li>çº¿ç¨‹è°ƒç”¨ <code>acquireShared(int)</code> â†’ <code>tryAcquireShared(int)</code>ï¼ˆå­ç±»å®ç°ï¼‰ã€‚</li><li>å¦‚æœæˆåŠŸï¼ˆè¿”å› <code>â‰¥0</code>ï¼‰ï¼Œè·å–é”ï¼›å¦åˆ™è¿›å…¥é˜Ÿåˆ—ç­‰å¾…ã€‚</li></ul></li><li><strong>é‡Šæ”¾é”</strong>ï¼š <ul><li>çº¿ç¨‹è°ƒç”¨ <code>releaseShared(int)</code> â†’ <code>tryReleaseShared(int)</code>ï¼ˆå­ç±»å®ç°ï¼‰ã€‚</li><li>å¦‚æœæˆåŠŸï¼Œå”¤é†’åç»­ç­‰å¾…çš„çº¿ç¨‹ï¼ˆå¯èƒ½å¤šä¸ªï¼‰ã€‚</li></ul></li></ul><div class="hint-container info"><p class="hint-container-title">AQS å…³é”®æ–¹æ³•</p></div><p>AQS çš„å…³é”®æ–¹æ³•é‡‡ç”¨æ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼ä¸²è”èµ·æ¥ï¼š</p><ul><li><strong>ç‹¬å æ¨¡å¼</strong><ul><li><strong><code>tryAcquire(int arg)</code></strong>ï¼šå°è¯•ä»¥ç‹¬å æ¨¡å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œæ­¤æ–¹æ³•éœ€ç”±å­ç±»å®ç°ã€‚</li><li><strong><code>acquire(int arg)</code></strong>ï¼šä»¥ç‹¬å æ¨¡å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œè‹¥è·å–å¤±è´¥åˆ™å°†çº¿ç¨‹åŠ å…¥é˜Ÿåˆ—å¹¶é˜»å¡ã€‚</li><li><strong><code>tryRelease(int arg)</code></strong>ï¼šå°è¯•ä»¥ç‹¬å æ¨¡å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œéœ€å­ç±»å®ç°ã€‚</li><li><strong><code>release(int arg)</code></strong>ï¼šä»¥ç‹¬å æ¨¡å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œè‹¥é‡Šæ”¾æˆåŠŸåˆ™å”¤é†’é˜Ÿåˆ—ä¸­çš„åç»§èŠ‚ç‚¹ã€‚</li></ul></li><li><strong>å…±äº«æ¨¡å¼</strong><ul><li><strong><code>tryAcquireShared(int arg)</code></strong>ï¼šå°è¯•ä»¥å…±äº«æ¨¡å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œéœ€å­ç±»å®ç°ã€‚</li><li><strong><code>acquireShared(int arg)</code></strong>ï¼šä»¥å…±äº«æ¨¡å¼è·å–åŒæ­¥çŠ¶æ€ï¼Œè‹¥è·å–å¤±è´¥åˆ™å°†çº¿ç¨‹åŠ å…¥é˜Ÿåˆ—å¹¶é˜»å¡ã€‚</li><li><strong><code>tryReleaseShared(int arg)</code></strong>ï¼šå°è¯•ä»¥å…±äº«æ¨¡å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œéœ€å­ç±»å®ç°ã€‚</li><li><strong><code>releaseShared(int arg)</code></strong>ï¼šä»¥å…±äº«æ¨¡å¼é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œè‹¥é‡Šæ”¾æˆåŠŸåˆ™å”¤é†’é˜Ÿåˆ—ä¸­çš„åç»§èŠ‚ç‚¹ã€‚</li></ul></li></ul><div class="hint-container tip"><p class="hint-container-title">æ‰©å±•</p><p><a href="https://tech.meituan.com/2019/12/05/aqs-theory-and-apply.html" target="_blank" rel="noopener noreferrer">ä» ReentrantLock çš„å®ç°çœ‹ AQS çš„åŸç†åŠåº”ç”¨</a></p></div><h3 id="ã€ä¸­ç­‰ã€‘synchronized-å’Œ-reentrantlock-æœ‰ä»€ä¹ˆåŒºåˆ«-â­â­â­" tabindex="-1"><a class="header-anchor" href="#ã€ä¸­ç­‰ã€‘synchronized-å’Œ-reentrantlock-æœ‰ä»€ä¹ˆåŒºåˆ«-â­â­â­"><span>ã€ä¸­ç­‰ã€‘synchronized å’Œ ReentrantLock æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿâ­â­â­</span></a></h3><ul><li><code>ReentrantLock</code> <strong>æ›´å¼ºå¤§</strong>ï¼šæ”¯æŒå…¬å¹³é”ã€å¯ä¸­æ–­ã€è¶…æ—¶ã€å¤šæ¡ä»¶å˜é‡ã€‚<code>ReentrantLock</code> <strong>å¿…é¡»æ‰‹åŠ¨é‡Šæ”¾é”</strong>ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ­»é”ï¼</li><li><code>synchronized</code> <strong>æ›´ç®€å•</strong>ï¼šè‡ªåŠ¨ç®¡ç†é”ï¼Œé€‚åˆåŸºç¡€åŒæ­¥éœ€æ±‚ã€‚</li><li><strong>æ€§èƒ½å·®å¼‚</strong>ï¼šJDK 6 åï¼Œsynchronized ç»è¿‡ä¸€ç³»åˆ—ä¼˜åŒ–ï¼Œä¸¤è€…æ€§èƒ½æ¥è¿‘ï¼Œä½† <code>ReentrantLock</code> åœ¨é«˜ç«äº‰åœºæ™¯ä»ç•¥æœ‰ä¼˜åŠ¿ã€‚</li></ul><div class="hint-container info"><p class="hint-container-title">synchronized å’Œ ReentrantLock è¯¦ç»†å¯¹æ¯”</p></div><p>ä»¥ä¸‹æ˜¯ <strong><code>synchronized</code></strong> å’Œ <strong><code>ReentrantLock</code></strong> çš„è¯¦ç»†å¯¹æ¯”è¡¨æ ¼ï¼Œæ¶µç›– <strong>é”æœºåˆ¶ã€åŠŸèƒ½ã€æ€§èƒ½ã€ä½¿ç”¨åœºæ™¯</strong> ç­‰æ ¸å¿ƒç»´åº¦ï¼š</p><hr><table><thead><tr><th><strong>å¯¹æ¯”ç»´åº¦</strong></th><th><strong><code>synchronized</code></strong></th><th><strong><code>ReentrantLock</code></strong></th></tr></thead><tbody><tr><td><strong>é”ç±»å‹</strong></td><td>JVM å†…ç½®å…³é”®å­—ï¼ˆéšå¼é”ï¼‰</td><td>JDK æä¾›çš„ç±»ï¼ˆæ˜¾å¼é”ï¼‰</td></tr><tr><td><strong>åŠ é”è§£é”æ–¹å¼</strong></td><td>è‡ªåŠ¨åŠ é”/é‡Šæ”¾é”ï¼ˆè¿›å…¥åŒæ­¥ä»£ç å—åŠ é”ï¼Œé€€å‡ºæ—¶é‡Šæ”¾ï¼‰</td><td>éœ€æ‰‹åŠ¨è°ƒç”¨ <code>lock()</code> å’Œ <code>unlock()</code>ï¼ˆå¿…é¡»é…åˆ <code>try-finally</code> ä½¿ç”¨ï¼‰</td></tr><tr><td><strong>æ˜¯å¦å¯é‡å…¥</strong></td><td>æ”¯æŒï¼ˆåŒä¸€çº¿ç¨‹å¯é‡å¤è·å–ï¼‰</td><td>æ”¯æŒï¼ˆåŒä¸€çº¿ç¨‹å¯é‡å¤è·å–ï¼‰</td></tr><tr><td><strong>æ˜¯å¦æ”¯æŒå…¬å¹³</strong></td><td>ä»…æ”¯æŒéå…¬å¹³é”</td><td>å¯é…ç½®å…¬å¹³é”æˆ–éå…¬å¹³é”ï¼ˆæ„é€ å‡½æ•°ä¼ å‚ <code>true/false</code>ï¼‰</td></tr><tr><td><strong>æ˜¯å¦å¯ä¸­æ–­</strong></td><td>ä¸æ”¯æŒä¸­æ–­</td><td>æ”¯æŒ <code>lockInterruptibly()</code>ï¼Œå¯å“åº”ä¸­æ–­</td></tr><tr><td><strong>æ˜¯å¦æ”¯æŒè¶…æ—¶</strong></td><td>ä¸æ”¯æŒè¶…æ—¶</td><td>æ”¯æŒ <code>tryLock(timeout, unit)</code>ï¼Œå¯è®¾ç½®è¶…æ—¶æ—¶é—´</td></tr><tr><td><strong>æ˜¯å¦æ”¯æŒå¤šæ¡ä»¶</strong></td><td>é€šè¿‡ <code>wait()</code>/<code>notify()</code> å®ç°ï¼Œå•ä¸€ç­‰å¾…é˜Ÿåˆ—</td><td>æ”¯æŒå¤šä¸ª <code>Condition</code>ï¼Œå¯ç²¾ç¡®æ§åˆ¶çº¿ç¨‹å”¤é†’ï¼ˆå¦‚ <code>await()</code>/<code>signal()</code>ï¼‰</td></tr><tr><td><strong>æ€§èƒ½</strong></td><td>JDK 6+ ä¼˜åŒ–åï¼ˆåå‘é”â†’è½»é‡çº§é”â†’é‡é‡çº§é”ï¼‰æ€§èƒ½æ¥è¿‘ <code>ReentrantLock</code></td><td>åœ¨é«˜ç«äº‰åœºæ™¯ä¸‹æ€§èƒ½ç•¥ä¼˜ï¼ˆå‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼‰</td></tr><tr><td><strong>æ­»é”æ£€æµ‹</strong></td><td>æ— å†…ç½®æ­»é”æ£€æµ‹</td><td>å¯é€šè¿‡ <code>tryLock</code> é¿å…æ­»é”</td></tr><tr><td><strong>é€‚ç”¨åœºæ™¯</strong></td><td>ç®€å•åŒæ­¥åœºæ™¯ï¼ˆå¦‚å•æ–¹æ³•åŒæ­¥ï¼‰</td><td>å¤æ‚åŒæ­¥éœ€æ±‚ï¼ˆå¦‚å…¬å¹³é”ã€å¯ä¸­æ–­é”ã€è¶…æ—¶é”ï¼‰</td></tr><tr><td><strong>åº•å±‚å®ç°</strong></td><td>JVM é€šè¿‡ <code>monitorenter</code>/<code>monitorexit</code> å­—èŠ‚ç å®ç°</td><td>åŸºäº <code>AbstractQueuedSynchronizer (AQS)</code> å®ç°</td></tr></tbody></table><div class="hint-container info"><p class="hint-container-title">synchronized å’Œ ReentrantLock çš„ä½¿ç”¨å·®å¼‚</p></div>`,66)),d(r,{data:[{id:"synchronized ä½¿ç”¨"},{id:"ReentrantLock ä½¿ç”¨"}],"tab-id":"synchronized å’Œ ReentrantLock ä½¿ç”¨å·®å¼‚"},{title0:a(({value:n,isActive:e})=>[...t[0]||(t[0]=[s("synchronized ä½¿ç”¨",-1)])]),title1:a(({value:n,isActive:e})=>[...t[1]||(t[1]=[s("ReentrantLock ä½¿ç”¨",-1)])]),tab0:a(({value:n,isActive:e})=>[...t[2]||(t[2]=[i("div",{class:"language-java line-numbers-mode","data-highlighter":"shiki","data-ext":"java",style:{"--shiki-light":"#383A42","--shiki-dark":"#abb2bf","--shiki-light-bg":"#FAFAFA","--shiki-dark-bg":"#282c34"}},[i("pre",{class:"shiki shiki-themes one-light one-dark-pro vp-code"},[i("code",{class:"language-java"},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A0A1A7","--shiki-light-font-style":"italic","--shiki-dark":"#7F848E","--shiki-dark-font-style":"italic"}},"// 1. ç”¨äºä»£ç å—")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"synchronized"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}}," ("),i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E5C07B"}},"this"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}},") {}")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A0A1A7","--shiki-light-font-style":"italic","--shiki-dark":"#7F848E","--shiki-dark-font-style":"italic"}},"// 2. ç”¨äºå¯¹è±¡")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"synchronized"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}}," (object) {}")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A0A1A7","--shiki-light-font-style":"italic","--shiki-dark":"#7F848E","--shiki-dark-font-style":"italic"}},"// 3. ç”¨äºæ–¹æ³•")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"public"),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}}," synchronized"),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}}," void"),i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}}," test"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}}," () {}")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A0A1A7","--shiki-light-font-style":"italic","--shiki-dark":"#7F848E","--shiki-dark-font-style":"italic"}},"// 4. å¯é‡å…¥")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"for"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}}," ("),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"int"),i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E06C75"}}," i "),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#56B6C2"}},"="),i("span",{style:{"--shiki-light":"#986801","--shiki-dark":"#D19A66"}}," 0"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},";"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}}," i "),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#56B6C2"}},"<"),i("span",{style:{"--shiki-light":"#986801","--shiki-dark":"#D19A66"}}," 100"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},";"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}}," i"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"++"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}},") {")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"	synchronized"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}}," ("),i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E5C07B"}},"this"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}},") {}")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}},"}")])])]),i("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"})])],-1)])]),tab1:a(({value:n,isActive:e})=>[...t[3]||(t[3]=[i("div",{class:"language-java line-numbers-mode","data-highlighter":"shiki","data-ext":"java",style:{"--shiki-light":"#383A42","--shiki-dark":"#abb2bf","--shiki-light-bg":"#FAFAFA","--shiki-dark-bg":"#282c34"}},[i("pre",{class:"shiki shiki-themes one-light one-dark-pro vp-code"},[i("code",{class:"language-java"},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"public"),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}}," void"),i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}}," test"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}}," () "),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"throw"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}}," Exception {")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A0A1A7","--shiki-light-font-style":"italic","--shiki-dark":"#7F848E","--shiki-dark-font-style":"italic"}},"	// 1. åˆå§‹åŒ–é€‰æ‹©å…¬å¹³é”ã€éå…¬å¹³é”")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#C18401","--shiki-dark":"#E5C07B"}},"	ReentrantLock"),i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E06C75"}}," lock "),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#56B6C2"}},"="),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}}," new"),i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}}," ReentrantLock"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}},"("),i("span",{style:{"--shiki-light":"#986801","--shiki-dark":"#D19A66"}},"true"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}},")"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},";")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A0A1A7","--shiki-light-font-style":"italic","--shiki-dark":"#7F848E","--shiki-dark-font-style":"italic"}},"	// 2. å¯ç”¨äºä»£ç å—")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E5C07B"}},"	lock"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"."),i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}},"lock"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"();")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"	try"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}}," {")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"		try"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}}," {")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A0A1A7","--shiki-light-font-style":"italic","--shiki-dark":"#7F848E","--shiki-dark-font-style":"italic"}},"			// 3. æ”¯æŒå¤šç§åŠ é”æ–¹å¼ï¼Œæ¯”è¾ƒçµæ´»ï¼›å…·æœ‰å¯é‡å…¥ç‰¹æ€§")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"			if"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}},"("),i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E5C07B"}},"lock"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"."),i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}},"tryLock"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"("),i("span",{style:{"--shiki-light":"#986801","--shiki-dark":"#D19A66"}},"100"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},", "),i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E5C07B"}},"TimeUnit"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"."),i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E5C07B"}},"MILLISECONDS"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},")"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}},"){ }")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}},"		} "),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"finally"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}}," {")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A0A1A7","--shiki-light-font-style":"italic","--shiki-dark":"#7F848E","--shiki-dark-font-style":"italic"}},"			// 4. æ‰‹åŠ¨é‡Šæ”¾é”")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E5C07B"}},"			lock"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"."),i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}},"unlock"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"()")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}},"		}")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}},"	} "),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"finally"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}}," {")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E5C07B"}},"		lock"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"."),i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}},"unlock"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"();")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}},"	}")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}},"}")])])]),i("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"})])],-1)])]),_:1}),t[9]||(t[9]=l(`<div class="hint-container info"><p class="hint-container-title">synchronized å’Œ ReentrantLock çš„é€‚ç”¨åœºæ™¯</p></div><ul><li><strong><code>synchronized</code> é€‚ç”¨åœºæ™¯</strong>ï¼šå•ä¾‹æ¨¡å¼çš„åŒé‡æ£€æŸ¥é”ã€ç®€å•çš„çº¿ç¨‹å®‰å…¨è®¡æ•°å™¨ã€‚</li><li><strong><code>ReentrantLock</code> é€‚ç”¨åœºæ™¯</strong>ï¼š <ul><li>éœ€è¦å…¬å¹³æ€§çš„ä»»åŠ¡é˜Ÿåˆ—ï¼ˆå¦‚è®¢å•å¤„ç†ï¼‰ã€‚</li><li>éœ€è¦è¶…æ—¶æ§åˆ¶çš„èµ„æºäº‰ç”¨ï¼ˆå¦‚é¿å…æ­»é”ï¼‰ã€‚</li><li>å¤æ‚çš„å¤šæ¡ä»¶çº¿ç¨‹åè°ƒï¼ˆå¦‚ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ï¼‰ã€‚</li></ul></li></ul><p><strong>ä½¿ç”¨é€‰æ‹©å»ºè®®</strong></p><ul><li><strong>é€‰æ‹© <code>synchronized</code></strong>ï¼š <ul><li>éœ€è¦ç®€å•çš„ä»£ç å—åŒæ­¥ã€‚</li><li>ä¸éœ€è¦é«˜çº§åŠŸèƒ½ï¼ˆå¦‚è¶…æ—¶ã€å…¬å¹³é”ï¼‰ã€‚</li></ul></li><li><strong>é€‰æ‹© <code>ReentrantLock</code></strong>ï¼š <ul><li>éœ€è¦ç²¾ç»†æ§åˆ¶ï¼ˆå¦‚å…¬å¹³æ€§ã€å¯ä¸­æ–­ï¼‰ã€‚</li><li>éœ€è¦é¿å…æ­»é”ï¼ˆ<code>tryLock</code>ï¼‰ã€‚</li></ul></li></ul><h3 id="ã€å›°éš¾ã€‘reentrantlock-çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆ-â­â­â­" tabindex="-1"><a class="header-anchor" href="#ã€å›°éš¾ã€‘reentrantlock-çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆ-â­â­â­"><span>ã€å›°éš¾ã€‘ReentrantLock çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿâ­â­â­</span></a></h3><p>æœ¬è´¨ä¸Šï¼Œ<strong>ReentrantLock æ˜¯ AQS åœ¨ç‹¬å æ¨¡å¼ä¸‹çš„ä¸€ä¸ªç»å…¸å®ç°</strong>ã€‚</p><p><strong>ReentrantLock ä»¥ AQS çš„ state å’ŒåŒæ­¥é˜Ÿåˆ—ä¸ºåŸºç¡€ï¼Œé€šè¿‡ NonfairSync / FairSync å®ç°ï¼ˆéï¼‰å…¬å¹³ç­–ç•¥ï¼Œå¹¶å†…ç½®å¯é‡å…¥è®¡æ•°å’Œæ¡ä»¶é˜Ÿåˆ—æœºåˆ¶çš„äº’æ–¥é”å®ç°</strong>ã€‚</p><ul><li><strong>æ ¸å¿ƒä¾èµ–</strong>ï¼š<code>ReentrantLock</code> é€šè¿‡å†…éƒ¨ç±» <code>Sync</code>ï¼ˆç»§æ‰¿ <code>AQS</code>ï¼‰å®ç°é”æœºåˆ¶ã€‚</li><li><strong>AQS ä½œç”¨</strong>ï¼šæä¾›çº¿ç¨‹é˜»å¡/å”¤é†’çš„é˜Ÿåˆ—ç®¡ç†ï¼ˆCLH å˜ä½“ï¼‰å’ŒçŠ¶æ€ï¼ˆ<code>state</code>ï¼‰çš„åŸå­æ“ä½œã€‚</li></ul><div class="hint-container info"><p class="hint-container-title">ä¸¤ç§æ¨¡å¼</p></div><p>ReentrantLock å†…éƒ¨æœ‰ä¸¤ä¸ªä¸»è¦çš„é™æ€å†…éƒ¨ç±»ï¼Œå†³å®šäº†å…¶æŠ¢å è¡Œä¸ºï¼š</p><ol><li><strong><code>NonfairSync</code>ï¼ˆéå…¬å¹³é”ï¼Œé»˜è®¤ï¼‰</strong>ï¼š<strong>å…è®¸æ’é˜Ÿ</strong><ul><li>æ–°çº¿ç¨‹æ¥äº†ç›´æ¥å°è¯• CAS æŠ¢é”ï¼ˆæ’é˜Ÿï¼‰ï¼ŒæŠ¢ä¸åˆ°æ‰æ’é˜Ÿã€‚</li><li><strong>ä¼˜ç‚¹</strong>ï¼šååé‡é«˜ã€‚</li><li><strong>ç¼ºç‚¹</strong>ï¼šå¯èƒ½å¯¼è‡´é¥¥é¥¿é—®é¢˜ã€‚</li></ul></li><li><strong><code>FairSync</code>ï¼ˆå…¬å¹³é”ï¼‰</strong>ï¼š<strong>å…ˆåˆ°å…ˆå¾—</strong><ul><li>æ–°çº¿ç¨‹æ¥äº†å…ˆæ£€æŸ¥åŒæ­¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œæœ‰æ’é˜Ÿè€…åˆ™ç›´æ¥å»é˜Ÿå°¾æ’é˜Ÿã€‚</li><li><strong>ä¼˜ç‚¹</strong>ï¼šå…¬å¹³ï¼Œæ— é¥¥é¥¿é—®é¢˜ã€‚</li><li><strong>ç¼ºç‚¹</strong>ï¼šä¸Šä¸‹æ–‡åˆ‡æ¢å¤šï¼Œååé‡ç›¸å¯¹ä½ã€‚</li></ul></li></ol><p>äºŒè€…æ ¸å¿ƒåŒºåˆ«å°±åœ¨ <code>lock()</code> æ–¹æ³•ä¸­ï¼Œå°è¯•è·å–é”å‰<strong>æ˜¯å¦æ£€æŸ¥åŒæ­¥é˜Ÿåˆ—ä¸­æœ‰ç­‰å¾…è€…</strong>ï¼ˆ<code>hasQueuedPredecessors()</code>ï¼‰ã€‚</p><div class="hint-container info"><p class="hint-container-title">ä¸‰å¤§æ ¸å¿ƒ</p></div><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ReentrantLock</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    â”‚</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    â”œâ”€â”€ </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Sync</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (extends AQS)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    â”‚    â”œâ”€â”€ state ï¼ˆé”è®¡æ•°å™¨ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    â”‚    â”œâ”€â”€ exclusiveOwnerThread ï¼ˆå½“å‰æŒæœ‰çº¿ç¨‹ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    â”‚    â””â”€â”€ </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">CLH</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> Queue ï¼ˆç­‰å¾…é”çš„çº¿ç¨‹é˜Ÿåˆ—ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    â”‚</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    â”œâ”€â”€ NonfairSync ï¼ˆé»˜è®¤ï¼Œæ’é˜ŸæŠ¢é”ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    â”œâ”€â”€ FairSync ï¼ˆå…ˆæ¥ååˆ°ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    â”‚</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    â””â”€â”€ </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ConditionObject</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">         â””â”€â”€ </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Condition</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> Queue ï¼ˆç­‰å¾…ç‰¹å®šæ¡ä»¶çš„çº¿ç¨‹é˜Ÿåˆ—ï¼‰</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol><li><strong>AQS åŒæ­¥å™¨ï¼ˆSyncï¼‰</strong>ï¼šç»§æ‰¿è‡ª AQSã€‚ <ul><li><strong>çŠ¶æ€ (<code>state</code>)</strong>ï¼š<code>volatile int</code>ï¼Œè¡¨ç¤ºé”è¢«æŒæœ‰çš„æ¬¡æ•°ã€‚<code>0</code>=ç©ºé—²ï¼Œ<code>N</code>=è¢«åŒä¸€ä¸ªçº¿ç¨‹é‡å…¥äº† <code>N</code> æ¬¡ã€‚</li><li><strong>åŒæ­¥é˜Ÿåˆ—</strong>ï¼šå­˜å‚¨ç­‰å¾…çº¿ç¨‹çš„ CLH å˜ä½“é˜Ÿåˆ—ã€‚</li><li><strong>ç‹¬å çº¿ç¨‹</strong>ï¼šè®°å½•å½“å‰æŒæœ‰é”çš„çº¿ç¨‹ (<code>exclusiveOwnerThread</code>)ã€‚</li></ul></li><li><strong>å¯é‡å…¥æœºåˆ¶</strong>ï¼š <ul><li><strong>åŠ é”</strong>ï¼šè‹¥å½“å‰çº¿ç¨‹æ˜¯æŒæœ‰è€…ï¼Œåˆ™ <code>state</code> åŠ  1ï¼ˆæ— éœ€ CASï¼‰ã€‚</li><li><strong>è§£é”</strong>ï¼š<code>state</code> å‡ 1ï¼Œå‡åˆ° 0 æ—¶æ‰å®Œå…¨é‡Šæ”¾ï¼Œå”¤é†’åç»§èŠ‚ç‚¹ã€‚</li></ul></li><li><strong>æ¡ä»¶å˜é‡ (<code>ConditionObject</code>)</strong>ï¼š <ul><li>æ¯ä¸ª <code>Condition</code> å¯¹è±¡å†…éƒ¨ç»´æŠ¤ä¸€ä¸ª <strong>ç‹¬ç«‹çš„ç­‰å¾…é˜Ÿåˆ—</strong>ã€‚</li><li><code>await()</code> å°†å½“å‰çº¿ç¨‹ä»<strong>é”çš„åŒæ­¥é˜Ÿåˆ—</strong>ç§»åˆ°<strong>æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—</strong>ï¼Œå¹¶é‡Šæ”¾é”ã€‚</li><li><code>signal()</code> å°†æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹ç§»åˆ°<strong>é”çš„åŒæ­¥é˜Ÿåˆ—</strong>ä¸­ï¼Œé‡æ–°ç­‰å¾…è·å–é”ã€‚</li></ul></li></ol><div class="hint-container info"><p class="hint-container-title">å…³é”®æ­¥éª¤</p></div><p><strong>ğŸ”’ åŠ é”å››æ­¥æ›²</strong></p><ol><li><strong>å¿«é€ŸæŠ¢ç¥¨</strong>ï¼šæ–°çº¿ç¨‹ç›´æ¥ CAS å°è¯•å°† <code>state</code> ä» 0 æ”¹ä¸º 1ï¼ˆæ’é˜Ÿï¼‰ã€‚</li><li><strong>æŠ¢åˆ°åˆ™å</strong>ï¼šæˆåŠŸåˆ™è®¾ç½®è‡ªå·±ä¸ºç‹¬å çº¿ç¨‹ï¼Œè¿›å…¥ä¸´ç•ŒåŒºã€‚</li><li><strong>æ²¡æŠ¢åˆ™æ’</strong>ï¼šå¤±è´¥åˆ™è°ƒç”¨ AQS çš„ <code>acquire(1)</code>ï¼Œè¿›å…¥åŒæ­¥é˜Ÿåˆ—é˜Ÿå°¾ã€‚</li><li><strong>é˜Ÿåˆ—ä¸­ç­‰</strong>ï¼šåœ¨é˜Ÿåˆ—ä¸­è¿›å…¥â€œè‡ªæ—‹-æ£€æŸ¥-æŒ‚èµ·â€å¾ªç¯ï¼Œç­‰å¾…è¢«å‰é©±èŠ‚ç‚¹å”¤é†’ã€‚</li></ol><p><strong>ğŸ”“ è§£é”ä¸¤æ­¥æ›²</strong>ï¼ˆ<code>unlock()</code> æœ¬è´¨æ˜¯ä¸¤ä¸ªå…³é”®æ“ä½œï¼‰</p><ol><li><strong>å°è¯•é‡Šæ”¾</strong>ï¼šè°ƒç”¨ <code>tryRelease(1)</code>ï¼Œå°† <code>state</code> å‡ 1ã€‚å¦‚æœ <code>state</code> å‡åˆ° 0ï¼Œåˆ™æ¸…ç©ºç‹¬å çº¿ç¨‹æ ‡è®°ã€‚</li><li><strong>å”¤é†’åç»§</strong>ï¼šå¦‚æœé”å®Œå…¨é‡Šæ”¾ï¼ˆ<code>state == 0</code>ï¼‰ï¼Œåˆ™å”¤é†’åŒæ­¥é˜Ÿåˆ—ä¸­ä¸‹ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„ç­‰å¾…çº¿ç¨‹ã€‚</li></ol><h3 id="ã€å›°éš¾ã€‘reentrantreadwritelock-çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆ-â­â­" tabindex="-1"><a class="header-anchor" href="#ã€å›°éš¾ã€‘reentrantreadwritelock-çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆ-â­â­"><span>ã€å›°éš¾ã€‘ReentrantReadWriteLock çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿâ­â­</span></a></h3><div class="hint-container info"><p class="hint-container-title">ReentrantReadWriteLock çš„ç‰¹æ€§</p></div><p><strong>ReentrantReadWriteLock æ˜¯ä¸ºã€è¯»å¤šå†™å°‘ã€‘çš„å¹¶å‘åœºæ™¯è®¾è®¡çš„é”å®ç°</strong>ã€‚</p><p><strong>ReentrantReadWriteLock å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶æŒæœ‰è¯»é”ï¼Œä½†åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªçº¿ç¨‹æŒæœ‰å†™é”</strong>ã€‚æ­¤å¤–ï¼Œå­˜åœ¨è¯»é”æ—¶æ— æ³•è·å–å†™é”ï¼Œå­˜åœ¨å†™é”æ—¶æ— æ³•è·å–è¯»é”ã€‚</p><p>ReentrantReadWriteLock æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š</p><ul><li><strong>å¯é‡å…¥</strong>ï¼šè¯»å†™é”éƒ½æ”¯æŒå¯é‡å…¥ã€‚</li><li><strong>æ”¯æŒå…¬å¹³é”</strong>ï¼Œé»˜è®¤ä¸ºéå…¬å¹³é”ã€‚</li><li><strong>æ”¯æŒé”é™çº§</strong>ï¼š<strong>æŒæœ‰å†™é”å¯ä»¥è·å–è¯»é”ï¼›åä¹‹ä¸å…è®¸</strong>ã€‚</li></ul><div class="hint-container info"><p class="hint-container-title">ReentrantReadWriteLock çš„æ ¸å¿ƒè®¾è®¡</p></div><p><strong>ReentrantReadWriteLock åŸºäº AQS å®ç°çš„è¯»å†™é”</strong>ã€‚</p><p><code>ReentrantReadWriteLock</code> çš„<strong>æ ¸å¿ƒè®¾è®¡æ€æƒ³</strong>æ˜¯<strong>å°†ä¸€ä¸ª 32 ä½çš„ int çŠ¶æ€å˜é‡æ‹†åˆ†ä¸ºä¸¤éƒ¨åˆ†</strong>ï¼š<code>state = (readCount &lt;&lt; 16) | writeCount</code></p><p>è™½ç„¶æä¾›äº†ä¸¤ä¸ªé”å¯¹è±¡ï¼ˆ<code>readLock</code>, <code>writeLock</code>ï¼‰ï¼Œä½†åº•å±‚å…±äº«åŒä¸€ä¸ª AQS åŒæ­¥å™¨ã€‚</p><table><thead><tr><th style="text-align:left;">è§†è§’</th><th style="text-align:left;">è¯»é” (<code>ReadLock</code>)</th><th style="text-align:left;">å†™é” (<code>WriteLock</code>)</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>è¡Œä¸º</strong></td><td style="text-align:left;">å…±äº«é”</td><td style="text-align:left;">ç‹¬å é”</td></tr><tr><td style="text-align:left;"><strong>å ç”¨ state</strong></td><td style="text-align:left;">é«˜ 16 ä½</td><td style="text-align:left;">ä½ 16 ä½</td></tr><tr><td style="text-align:left;"><strong>äº’æ–¥è§„åˆ™</strong></td><td style="text-align:left;">ä¸<strong>å†™é”</strong>äº’æ–¥</td><td style="text-align:left;">ä¸<strong>æ‰€æœ‰é”</strong>ï¼ˆè¯»ã€å†™ï¼‰äº’æ–¥</td></tr><tr><td style="text-align:left;"><strong>é‡å…¥è®¡æ•°</strong></td><td style="text-align:left;">æ‰€æœ‰è¯»çº¿ç¨‹çš„æ€»é‡å…¥æ¬¡æ•°</td><td style="text-align:left;">å•ä¸ªå†™çº¿ç¨‹çš„é‡å…¥æ¬¡æ•°</td></tr><tr><td style="text-align:left;"><strong>æ¡ä»¶å˜é‡</strong></td><td style="text-align:left;"><strong>ä¸æ”¯æŒ</strong> <code>Condition</code></td><td style="text-align:left;"><strong>æ”¯æŒ</strong> <code>Condition</code></td></tr></tbody></table><div class="hint-container info"><p class="hint-container-title">ReentrantReadWriteLock å†™é”å®ç°ï¼ˆWriteLockï¼‰</p></div><p><strong>ReentrantReadWriteLock å†™é”åŸºäº AQS çš„ç‹¬å æ¨¡å¼å®ç°</strong>ã€‚</p><p>å†™é”è·å–æ­¥éª¤ï¼š</p><ol><li>çº¿ç¨‹ç”³è¯·å†™é”ï¼ˆ<code>writeLock.lock()</code>ï¼‰</li><li>æ£€æŸ¥æœ‰æ²¡æœ‰è¯»é”æˆ–å†™é”ï¼ˆ<code>state != 0</code>ï¼‰</li><li>æ²¡æœ‰ï¼Œ<strong>CAS è®¾ç½® state çš„ä½ 16 ä¸º 1</strong>ï¼ˆè·å¾—å†™é”ï¼‰</li><li>æœ‰ï¼Œå½“å‰çº¿ç¨‹æ˜¯å¦å·²æŒæœ‰å†™é”ï¼ˆå¯é‡å…¥ï¼‰ <ul><li>æ˜¯ï¼šCAS å°† state çš„ä½ 16 åŠ  1ï¼ˆè·å¾—å†™é”ï¼‰</li><li>å¦ï¼šæ’é˜Ÿç­‰å¾…ï¼ˆè¿›å…¥ AQS åŒæ­¥é˜Ÿåˆ—æŒ‚èµ·ï¼‰</li></ul></li></ol><p>å®ç°æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">protected</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> tryAcquire</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> acquires) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // æ£€æŸ¥æ˜¯å¦æœ‰è¯»é”æˆ–å…¶ä»–çº¿ç¨‹æŒæœ‰å†™é”</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (c </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> w </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // æ£€æŸ¥é‡å…¥æˆ– CAS è®¾ç½®çŠ¶æ€</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container info"><p class="hint-container-title">ReentrantReadWriteLock è¯»é”å®ç°ï¼ˆReadLockï¼‰</p></div><p><strong>ReentrantReadWriteLock è¯»é”åŸºäº AQS çš„å…±äº«æ¨¡å¼å®ç°</strong>ã€‚</p><ol><li>çº¿ç¨‹ç”³è¯·è¯»é”ï¼ˆ<code>readLock.lock()</code>ï¼‰</li><li>æ£€æŸ¥æœ‰æ²¡æœ‰å†™é”ï¼ˆ<code>(state &amp; 0xFFFF) != 0</code>ï¼‰</li><li>æ²¡æœ‰ï¼ŒCAS å°† state çš„é«˜ 16 åŠ  1ï¼ˆè·å¾—è¯»é”ï¼‰</li><li>æœ‰ï¼Œæ’é˜Ÿç­‰å¾…ï¼ˆè¿›å…¥ AQS åŒæ­¥é˜Ÿåˆ—æŒ‚èµ·ï¼‰</li></ol><div class="hint-container info"><p class="hint-container-title">ReentrantReadWriteLock é”é™çº§å®ç°</p></div><ol><li><strong>çº¿ç¨‹æŒæœ‰å†™é”</strong></li><li><strong>ç›´æ¥ç”³è¯·è¯»é”</strong>ï¼šå› ä¸ºçº¿ç¨‹æœ‰å†™é”ï¼Œå› æ­¤ä¸€å®šæˆåŠŸï¼ˆé«˜ 16 ä½åŠ  1ï¼‰</li><li><strong>é‡Šæ”¾å†™é”</strong></li><li>é”çŠ¶æ€ä» <strong>â€œç‹¬å å†™â€</strong> é™çº§ä¸º <strong>â€œå…±äº«è¯»â€</strong>ã€‚</li></ol><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// é”é™çº§ç¤ºä¾‹ä»£ç </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">writeLock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">         // è·å–å†™é”</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">try</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // ä¿®æ”¹æ•°æ®ã€‚..</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    readLock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      // åœ¨ä¿æŒå†™é”çš„æƒ…å†µä¸‹è·å–è¯»é”ï¼ˆé”é™çº§å…³é”®æ­¥éª¤ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">} </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    writeLock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // é‡Šæ”¾å†™é”ï¼Œé™çº§ä¸ºè¯»é”</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// æ­¤æ—¶ä»æŒæœ‰è¯»é”ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥è·å–è¯»é”ä½†ä¸èƒ½è·å–å†™é”</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æ€§èƒ½ä¼˜åŒ–æŠ€å·§</strong></p><ul><li><strong>firstReader ä¼˜åŒ–</strong>ï¼šè®°å½•ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹ï¼Œé¿å… ThreadLocal æŸ¥æ‰¾</li><li><strong>cachedHoldCounter</strong>ï¼šç¼“å­˜æœ€è¿‘ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹è®¡æ•°å™¨</li><li><strong>è¯»é”è®¡æ•°å­˜å‚¨</strong>ï¼šä½¿ç”¨ ThreadLocal ä¿å­˜æ¯ä¸ªçº¿ç¨‹çš„é‡å…¥æ¬¡æ•°ï¼Œé¿å…ç«äº‰</li></ul><h3 id="ã€å›°éš¾ã€‘stampedlock-çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆ-â­" tabindex="-1"><a class="header-anchor" href="#ã€å›°éš¾ã€‘stampedlock-çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆ-â­"><span>ã€å›°éš¾ã€‘StampedLock çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿâ­</span></a></h3><p><code>StampedLock</code>æ˜¯ JDK8 å¼•å…¥çš„é«˜æ€§èƒ½é”ï¼Œ<strong>é€‚åˆè¯»å¤šå†™å°‘ä¸”è¿½æ±‚æè‡´ååçš„åœºæ™¯</strong>ï¼Œä½†éœ€è°¨æ…å¤„ç†ä¹è§‚è¯»å¤±è´¥å’Œæ­»é”é£é™©ã€‚</p><p>StampedLock æ˜¯ <strong>é€šè¿‡ä¸€ä¸ª 64 ä½ long å€¼åŒæ—¶ç¼–ç ç‰ˆæœ¬å·ã€è¯»è®¡æ•°å’Œå†™æ ‡è®°ï¼Œå¹¶åˆ©ç”¨æˆ³è®°ï¼ˆStampï¼‰å®ç°ä¹è§‚è¯»ã€é”å‡çº§ç­‰é«˜çº§å¹¶å‘æ§åˆ¶ï¼Œåœ¨ç‰ºç‰²éƒ¨åˆ†æ˜“ç”¨æ€§å’Œé‡å…¥æ€§çš„å‰æä¸‹ï¼Œæä¾›æé«˜è¯»æ€§èƒ½çš„åŒæ­¥å™¨</strong>ã€‚</p><div class="hint-container info"><p class="hint-container-title">StampedLock ä¸‰ç§æ¨¡å¼</p></div><p>StampedLock çš„çŠ¶æ€å­˜å‚¨åœ¨ä¸€ä¸ª <code>long</code> å‹ï¼ˆ64 ä½ï¼‰å˜é‡ä¸­ï¼Œåˆ†ä¸ºä¸‰ä¸ªé€»è¾‘éƒ¨åˆ†ï¼š</p><table><thead><tr><th style="text-align:left;">æ¨¡å¼</th><th style="text-align:left;">å ç”¨ä½</th><th style="text-align:left;">ä½œç”¨</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>è¯»é”</strong></td><td style="text-align:left;">ä½ 7 ä½</td><td style="text-align:left;">è¯»çº¿ç¨‹è®¡æ•°ï¼ˆå®é™…æ˜¯<code>readerCount+1</code>ï¼‰</td></tr><tr><td style="text-align:left;"><strong>å†™é”</strong></td><td style="text-align:left;">ç¬¬ 8 ä½</td><td style="text-align:left;">ç‹¬å æ ‡è®°ï¼Œ0 æœªå ç”¨ï¼Œ1 å·²å ç”¨</td></tr><tr><td style="text-align:left;"><strong>ç‰ˆæœ¬å·</strong></td><td style="text-align:left;">æœªä½¿ç”¨çš„é«˜ä½</td><td style="text-align:left;">åŠ é”è¿”å›æœ‰æ•ˆæˆ³ï¼Œè§£é”éœ€éªŒè¯æˆ³ï¼›<br>æˆ³æ— æ•ˆ = çŠ¶æ€å˜æ›´ï¼ˆæœ‰å†™æ“ä½œï¼‰ï¼Œæˆ³æœ‰æ•ˆ = æ•°æ®ä¸€è‡´</td></tr></tbody></table><p>çŠ¶æ€æµè½¬ï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>åˆå§‹çŠ¶æ€ï¼šstate = (version: 0, readCount: 0, write: 0)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[æ“ä½œä¸çŠ¶æ€å˜åŒ–ç¤ºä¾‹]</span></span>
<span class="line"><span>1. å†™é”è·å– (\`writeLock()\`)</span></span>
<span class="line"><span>   -&gt; state ä½ 8 ä½ç½® 1ï¼ŒåŒæ—¶æ•´ä¸ª long å€¼æ”¹å˜ (version++)</span></span>
<span class="line"><span>   -&gt; è¿”å› stamp W1</span></span>
<span class="line"><span></span></span>
<span class="line"><span>2. ä¹è§‚è¯» (\`tryOptimisticRead()\`)</span></span>
<span class="line"><span>   -&gt; ä¸ä¿®æ”¹ stateï¼ä»…è®°å½•å½“å‰ state å€¼ä½œä¸º stamp O1</span></span>
<span class="line"><span>   -&gt; æ ¡éªŒæ—¶ï¼šæ¯”è¾ƒå½“å‰ state æ˜¯å¦ç­‰äº O1</span></span>
<span class="line"><span></span></span>
<span class="line"><span>3. è¯»é”è·å– (\`readLock()\`)</span></span>
<span class="line"><span>   -&gt; é«˜ 56 ä½è¯»è®¡æ•°+1 ï¼ˆå¦‚æœå†™é”æœªè¢«å ç”¨ï¼‰d</span></span>
<span class="line"><span>   -&gt; è¿”å› stamp R1</span></span>
<span class="line"><span></span></span>
<span class="line"><span>4. é”å‡çº§ (\`tryConvertToWriteLock(R1)\`)</span></span>
<span class="line"><span>   -&gt; åŸå­æ“ä½œï¼šè¯»è®¡æ•°-1ï¼ŒåŒæ—¶å†™æ ‡è®°ç½® 1</span></span>
<span class="line"><span>   -&gt; æˆåŠŸè¿”å›æ–° stamp W2ï¼Œå¤±è´¥è¿”å› 0</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container info"><p class="hint-container-title">StampedLock ä¹è§‚é”</p></div><p>StampedLock ä¹è§‚é”æ˜¯ä¸€ç§ <strong>â€œè¯»æ—¶å¤åˆ¶+ç‰ˆæœ¬æ ¡éªŒâ€</strong> çš„ä¹è§‚å¹¶å‘æ§åˆ¶ã€‚</p><p>ä¹è§‚é”åœ¨è¯»è¿œå¤šäºå†™ä¸”å†™æ“ä½œä¸é¢‘ç¹çš„åœºæ™¯ä¸‹ï¼Œæ€§èƒ½æé«˜ï¼ˆå®Œå…¨æ— é”ï¼‰ã€‚</p><p>StampedLock ä¹è§‚é”æµç¨‹</p><ol><li>è°ƒç”¨ <code>tryOptimisticRead()</code> è·å–ä¸€ä¸ª<strong>æˆ³è®°ï¼ˆStampï¼‰</strong>ï¼Œæ­¤æ—¶<strong>å®Œå…¨ä¸é˜»å¡</strong>ã€‚</li><li>è¯»å–å…±äº«æ•°æ®åˆ°å±€éƒ¨å˜é‡ã€‚</li><li>è°ƒç”¨ <code>validate(stamp)</code> æ ¡éªŒï¼š<strong>è‡ªè·å–æˆ³è®°ä»¥æ¥ï¼Œæ˜¯å¦æœ‰å†™é”è¢«è·å–è¿‡ï¼Ÿ</strong><ul><li><strong>æ— å˜åŒ–</strong>ï¼šæ•°æ®æœ‰æ•ˆï¼Œç›´æ¥ä½¿ç”¨ã€‚</li><li><strong>æœ‰å˜åŒ–</strong>ï¼šå‡çº§ä¸º<strong>æ‚²è§‚è¯»é”</strong>ï¼Œé‡æ–°è¯»å–æ•°æ®ã€‚</li></ul></li></ol><div class="hint-container info"><p class="hint-container-title">StampedLock é”å‡çº§</p></div><p><strong>è¯»é” â†’ å†™é”å‡çº§</strong>ï¼š<code>tryConvertToWriteLock(stamp)</code></p><ul><li><strong>å‰æ</strong>ï¼šå½“å‰çº¿ç¨‹å·²æŒæœ‰è¯»é”ï¼ˆ<code>stamp</code> æ˜¯æœ‰æ•ˆçš„è¯»é”æˆ³è®°ï¼‰ã€‚</li><li><strong>è¿‡ç¨‹</strong>ï¼šåŸå­åœ°å°è¯•é‡Šæ”¾è¯»è®¡æ•°ï¼Œè·å–å†™é”æ ‡è®°ã€‚</li><li><strong>ç»“æœ</strong>ï¼šæˆåŠŸè¿”å›æ–°å†™æˆ³è®°ï¼Œå¤±è´¥è¿”å› 0ã€‚</li><li><strong>æ³¨æ„</strong>ï¼š<strong>å¯èƒ½æ­»é”</strong>ï¼å¦‚æœå½“å‰è¿˜æœ‰å…¶ä»–è¯»é”æŒæœ‰è€…ï¼Œå‡çº§ä¼šå¤±è´¥ï¼ˆå› ä¸ºè¯»å†™äº’æ–¥ï¼‰ã€‚</li></ul><p><strong>ä¹è§‚è¯» â†’ å†™é”å‡çº§</strong>ï¼š</p><ul><li>ä¹è§‚è¯»æˆ³è®°æœ¬èº«ä¸ä»£è¡¨æŒæœ‰é”ï¼Œå‡çº§å¤±è´¥æ˜¯å¸¸æ€ã€‚</li><li>é€šå¸¸å…ˆè·å–æ‚²è§‚è¯»é”ï¼Œå†è¿›è¡Œå‡çº§å°è¯•ã€‚</li></ul><div class="hint-container info"><p class="hint-container-title">StampedLock vs. ReentrantReadWriteLock</p></div><table><thead><tr><th>ç‰¹æ€§</th><th><code>StampedLock</code></th><th><code>ReentrantReadWriteLock</code></th></tr></thead><tbody><tr><td><strong>è¯»å¹¶å‘åº¦</strong></td><td>æœ€é«˜ï¼ˆä¹è§‚è¯»æ— é˜»å¡ï¼‰</td><td>é«˜ï¼ˆæ‚²è§‚è¯»é˜»å¡å†™ï¼‰</td></tr><tr><td><strong>å†™é¥¥é¥¿</strong></td><td>å¯èƒ½å‘ç”Ÿ</td><td>éå…¬å¹³æ¨¡å¼ä¸‹å¯èƒ½å‘ç”Ÿ</td></tr><tr><td><strong>é”é‡å…¥</strong></td><td>ä¸æ”¯æŒ</td><td>æ”¯æŒ</td></tr><tr><td><strong>å…¬å¹³æ€§</strong></td><td>ä»…éå…¬å¹³</td><td>æ”¯æŒå…¬å¹³/éå…¬å¹³</td></tr><tr><td><strong>æ¡ä»¶å˜é‡</strong></td><td>ä¸æ”¯æŒ</td><td>æ”¯æŒ</td></tr></tbody></table><div class="hint-container info"><p class="hint-container-title">StampedLock ä½¿ç”¨ç¤ºä¾‹</p></div><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">StampedLock</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> lock </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> StampedLock</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// ä¹è§‚è¯»ç¤ºä¾‹</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> stamp </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">tryOptimisticRead</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// è¯»å–å…±äº«æ•°æ®ã€‚..</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">validate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(stamp)</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // ç‰ˆæœ¬å¤±æ•ˆï¼Œè½¬æ‚²è§‚è¯»</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    stamp </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">readLock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    try</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // é‡æ–°è¯»å–æ•°æ®ã€‚..</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unlockRead</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(stamp);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// å†™é”ç¤ºä¾‹</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">long</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> stamp </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">writeLock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">try</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // ä¿®æ”¹æ•°æ®ã€‚..</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">} </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unlockWrite</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(stamp);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="java-æ— é”" tabindex="-1"><a class="header-anchor" href="#java-æ— é”"><span>Java æ— é”</span></a></h2><h3 id="ã€ä¸­ç­‰ã€‘ä»€ä¹ˆæ˜¯-cas-cas-çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆ-â­â­â­" tabindex="-1"><a class="header-anchor" href="#ã€ä¸­ç­‰ã€‘ä»€ä¹ˆæ˜¯-cas-cas-çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆ-â­â­â­"><span>ã€ä¸­ç­‰ã€‘ä»€ä¹ˆæ˜¯ CASï¼ŸCAS çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿâ­â­â­</span></a></h3><div class="hint-container info"><p class="hint-container-title">ä»€ä¹ˆæ˜¯ CASï¼Ÿ</p></div><p>CAS æ˜¯ <strong>Compare-And-Swapï¼ˆæ¯”è¾ƒå¹¶äº¤æ¢ï¼‰</strong> çš„ç¼©å†™ï¼Œæ˜¯å®ç°å¹¶å‘ç¼–ç¨‹çš„<strong>æ— é”åŸå­æ“ä½œ</strong>æ ¸å¿ƒã€‚</p><p>CAS æ ¸å¿ƒè§„åˆ™æ˜¯ï¼šå…ˆæ¯”è¾ƒå†…å­˜ä¸­æŸä¸ªå€¼æ˜¯å¦ç­‰äºé¢„æœŸå€¼ï¼Œè‹¥ç›¸ç­‰åˆ™å°†å…¶æ›´æ–°ä¸ºæ–°å€¼ï¼›è‹¥ä¸ç­‰åˆ™ä¸æ“ä½œï¼Œæ•´ä¸ªè¿‡ç¨‹åŸå­æ€§å®Œæˆã€‚</p><p>CAS æ“ä½œä¼ªä»£ç </p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> CAS</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Variable</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> var</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> expected</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> newValue) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">var</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">value</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> expected) {  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// æ¯”è¾ƒå½“å‰å€¼æ˜¯å¦ç­‰äºé¢„æœŸå€¼</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        var</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">value</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> newValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">     // å¦‚æœç›¸ç­‰ï¼Œæ›´æ–°ä¸ºæ–°å€¼</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // å¦åˆ™å¤±è´¥</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¯´æ˜ï¼š</p><ol><li>è¯»å–å†…å­˜å€¼ <code>V</code>ã€‚</li><li>æ¯”è¾ƒ <code>V</code> å’Œé¢„æœŸå€¼ <code>A</code>ï¼š <ul><li>å¦‚æœ <code>V == A</code>ï¼Œè¯´æ˜æ²¡æœ‰å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡ï¼Œæ›´æ–°ä¸º <code>B</code>ã€‚</li><li>å¦‚æœ <code>V != A</code>ï¼Œè¯´æ˜å€¼å·²è¢«ä¿®æ”¹ï¼Œæ”¾å¼ƒæ›´æ–°ã€‚</li></ul></li><li>è¿”å›æ“ä½œæ˜¯å¦æˆåŠŸã€‚</li></ol><div class="hint-container info"><p class="hint-container-title">CAS ç‰¹æ€§</p></div><ul><li><strong>æ— é”</strong>ï¼šæ— éœ€åŠ  synchronized/Lockï¼Œå‡å°‘çº¿ç¨‹é˜»å¡ / å”¤é†’å¼€é”€ï¼Œæ€§èƒ½æ›´é«˜ï¼›</li><li><strong>åŸå­æ€§</strong>ï¼šCPU æŒ‡ä»¤çº§ä¿è¯ï¼Œæ¯”æ‰‹åŠ¨åŠ é”æ›´å¯é ï¼›</li><li><strong>ABA é—®é¢˜</strong>ï¼šV å…ˆä» A å˜ B å†å˜å› Aï¼ŒCAS ä¼šè¯¯åˆ¤ä¸ºæœªä¿®æ”¹ï¼ˆè§£å†³ï¼šåŠ ç‰ˆæœ¬å·ï¼Œå¦‚ <code>AtomicStampedReference</code>ï¼‰ã€‚</li></ul><div class="hint-container info"><p class="hint-container-title">CAS çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</p></div><p><strong>Java å±‚é¢ï¼Œé€šè¿‡ <code>Unsafe</code> ç±»è°ƒç”¨ native æ–¹æ³•ï¼ˆå¦‚ <code>compareAndSwapInt()</code>ï¼‰å®ç° CAS</strong>ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> native</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> boolean</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> compareAndSwapInt</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> o</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> long</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> expected</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> newValue)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>æ›´åº•å±‚ï¼ˆCPU å±‚é¢ï¼‰ï¼ŒCAS å®ç°ä¾èµ–äº CPU æä¾›çš„åŸå­æŒ‡ä»¤ï¼ˆå¦‚ x86 çš„ <code>cmpxchg</code> æŒ‡ä»¤ï¼‰ã€‚</p><div class="hint-container info"><p class="hint-container-title">CAS å…¸å‹åº”ç”¨</p></div><p><strong>ï¼ˆ1ï¼‰åŸå­ç±»</strong></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">AtomicInteger</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> atomicInt </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> AtomicInteger</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">atomicInt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">incrementAndGet</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // CAS å®ç°åŸå­è‡ªå¢</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>åº•å±‚å®ç°</strong>ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> incrementAndGet</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> unsafe</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getAndAddInt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, valueOffset, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> +</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ï¼ˆ2ï¼‰è‡ªæ—‹é”</strong></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">while</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">CAS</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">)) {  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// å°è¯•è·å–é”</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // è‡ªæ—‹ç­‰å¾…</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ï¼ˆ3ï¼‰æ— é”æ•°æ®ç»“æ„</strong></p><ul><li><code>ConcurrentHashMap</code>ï¼ˆJDK 8 ä½¿ç”¨ CAS + <code>synchronized</code> æ›¿ä»£åˆ†æ®µé”ï¼‰ã€‚</li><li><code>CopyOnWriteArrayList</code>ï¼ˆCAS ä¿è¯å†™å…¥åŸå­æ€§ï¼‰ã€‚</li></ul><h3 id="ã€ä¸­ç­‰ã€‘cas-ç®—æ³•å­˜åœ¨å“ªäº›é—®é¢˜-â­â­â­" tabindex="-1"><a class="header-anchor" href="#ã€ä¸­ç­‰ã€‘cas-ç®—æ³•å­˜åœ¨å“ªäº›é—®é¢˜-â­â­â­"><span>ã€ä¸­ç­‰ã€‘CAS ç®—æ³•å­˜åœ¨å“ªäº›é—®é¢˜ï¼Ÿâ­â­â­</span></a></h3><p>CASï¼ˆCompare-And-Swapï¼‰æ˜¯ä¸€ç§æ— é”å¹¶å‘ç¼–ç¨‹æŠ€æœ¯ï¼Œå¹¿æ³›ç”¨äº Java çš„ <code>Atomic</code> ç±»ã€AQSã€<code>ConcurrentHashMap</code> ç­‰å¹¶å‘å·¥å…·ä¸­ã€‚ä½†å®ƒä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜å’Œé™åˆ¶ï¼š</p><p><strong>ABA é—®é¢˜</strong></p><ul><li><strong>é—®é¢˜æè¿°</strong>ï¼šå˜é‡å€¼ä» <code>A</code> â†’ <code>B</code> â†’ <code>A</code>ï¼ŒCAS æ£€æŸ¥æ—¶è®¤ä¸ºæ²¡æœ‰å˜åŒ–ï¼Œä½†å®é™…ä¸Šå·²ç»è¢«ä¿®æ”¹è¿‡ã€‚</li><li><strong>å½±å“</strong>ï¼šå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼ˆå¦‚é“¾è¡¨æ“ä½œæ—¶èŠ‚ç‚¹è¢«æ›¿æ¢ä½†æŒ‡é’ˆä»æœ‰æ•ˆï¼‰ã€‚</li><li><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š <ul><li>ä½¿ç”¨ <strong>ç‰ˆæœ¬å·/æ—¶é—´æˆ³</strong>ï¼ˆå¦‚ <code>AtomicStampedReference</code>ï¼‰ã€‚</li><li>ä½¿ç”¨ <code>boolean</code> æ ‡è®°ï¼ˆå¦‚ <code>AtomicMarkableReference</code>ï¼‰ã€‚</li></ul></li></ul><p><strong>è‡ªæ—‹äº§ç”Ÿçš„ CPU ç©ºè½¬</strong></p><ul><li><strong>é—®é¢˜æè¿°</strong>ï¼šå¦‚æœ CAS é•¿æ—¶é—´å¤±è´¥ï¼Œçº¿ç¨‹ä¼šæŒç»­è‡ªæ—‹ï¼ˆ<code>while</code> å¾ªç¯ï¼‰ï¼Œå ç”¨ CPU èµ„æºã€‚</li><li><strong>å½±å“</strong>ï¼šé«˜å¹¶å‘ç«äº‰æ—¶ï¼Œå¯èƒ½å¯¼è‡´ CPU ä½¿ç”¨ç‡é£™å‡ã€‚</li><li><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š <ul><li>é™åˆ¶è‡ªæ—‹æ¬¡æ•°ï¼ˆå¦‚ <code>LongAdder</code> æ”¹ç”¨åˆ†æ®µ CASï¼‰ã€‚</li><li>ç»“åˆ <code>yield()</code> æˆ– <code>Thread.sleep()</code> å‡å°‘ç«äº‰ã€‚</li></ul></li></ul><p><strong>åªèƒ½ä¿è¯å•ä¸ªå˜é‡çš„åŸå­æ€§</strong></p><ul><li><strong>é—®é¢˜æè¿°</strong>ï¼šCAS åªèƒ½å¯¹ä¸€ä¸ªå˜é‡è¿›è¡ŒåŸå­æ“ä½œï¼Œæ— æ³•ä¿è¯å¤šä¸ªå˜é‡çš„å¤åˆæ“ä½œï¼ˆå¦‚ <code>i++</code> å’Œ <code>j--</code>ï¼‰ã€‚</li><li><strong>å½±å“</strong>ï¼šéœ€è¦é¢å¤–åŒæ­¥æœºåˆ¶ï¼ˆå¦‚é”ï¼‰æ¥ä¿è¯å¤šå˜é‡ä¸€è‡´æ€§ã€‚</li><li><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š <ul><li>ä½¿ç”¨ <code>synchronized</code> æˆ– <code>ReentrantLock</code>ã€‚</li><li>è®¾è®¡ä¸å¯å˜å¯¹è±¡ï¼ˆå¦‚ <code>String</code>ã€<code>BigInteger</code>ï¼‰ã€‚</li></ul></li></ul><p><strong>å…¬å¹³æ€§é—®é¢˜</strong></p><ul><li><strong>é—®é¢˜æè¿°</strong>ï¼šCAS æ˜¯éå…¬å¹³çš„ï¼Œæ–°çº¿ç¨‹å¯èƒ½æ¯”ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹æ›´å¿«è·å–é”ã€‚</li><li><strong>å½±å“</strong>ï¼šå¯èƒ½å¯¼è‡´çº¿ç¨‹é¥¥é¥¿ï¼ˆæŸäº›çº¿ç¨‹é•¿æœŸå¾—ä¸åˆ°æ‰§è¡Œï¼‰ã€‚</li><li><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š <ul><li>ä½¿ç”¨å…¬å¹³é”ï¼ˆå¦‚ <code>ReentrantLock(true)</code>ï¼‰ã€‚</li><li>ç»“åˆé˜Ÿåˆ—è°ƒåº¦ï¼ˆå¦‚ AQS çš„ CLH é˜Ÿåˆ—ï¼‰ã€‚</li></ul></li></ul><p><strong>ä¸é€‚ç”¨äºå¤æ‚æ“ä½œ</strong></p><ul><li><strong>é—®é¢˜æè¿°</strong>ï¼šCAS é€‚åˆç®€å•æ“ä½œï¼ˆå¦‚ <code>count++</code>ï¼‰ï¼Œä½†ä¸é€‚åˆå¤æ‚é€»è¾‘ï¼ˆå¦‚æ•°æ®åº“äº‹åŠ¡ï¼‰ã€‚</li><li><strong>å½±å“</strong>ï¼šéœ€è¦æ‹†åˆ†ä¸ºå¤šä¸ª CAS æ­¥éª¤ï¼Œå¯èƒ½å¼•å…¥ä¸­é—´çŠ¶æ€ä¸ä¸€è‡´ã€‚</li><li><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š <ul><li>ä½¿ç”¨é”ï¼ˆå¦‚ <code>synchronized</code>ï¼‰ã€‚</li><li>æ”¹ç”¨äº‹åŠ¡å†…å­˜ï¼ˆå¦‚ Clojure STMï¼‰ã€‚</li></ul></li></ul><p><strong>å¹³å°ä¾èµ–æ€§</strong></p><ul><li><strong>é—®é¢˜æè¿°</strong>ï¼šCAS ä¾èµ–åº•å±‚ CPU æŒ‡ä»¤ï¼ˆå¦‚ <code>CMPXCHG</code>ï¼‰ï¼Œä¸åŒæ¶æ„æ€§èƒ½å¯èƒ½å·®å¼‚è¾ƒå¤§ã€‚</li><li><strong>å½±å“</strong>ï¼šåœ¨ ARM ç­‰å¼±å†…å­˜æ¨¡å‹å¹³å°å¯èƒ½å‡ºç°æ„å¤–è¡Œä¸ºã€‚</li><li><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼šä½¿ç”¨ JVM å†…ç½®åŸå­ç±»ï¼ˆå¦‚ <code>AtomicInteger</code>ï¼‰ï¼Œè€Œéæ‰‹åŠ¨å®ç°ã€‚</li></ul><p><strong>æ€»ç»“</strong></p><table><thead><tr><th>é—®é¢˜</th><th>å½±å“</th><th>è§£å†³æ–¹æ¡ˆ</th></tr></thead><tbody><tr><td><strong>ABA é—®é¢˜</strong></td><td>æ•°æ®ä¸ä¸€è‡´</td><td><code>AtomicStampedReference</code></td></tr><tr><td><strong>è‡ªæ—‹å¼€é”€</strong></td><td>CPU å ç”¨é«˜</td><td>é™åˆ¶è‡ªæ—‹æ¬¡æ•° / é€€è®©ç­–ç•¥</td></tr><tr><td><strong>å•å˜é‡é™åˆ¶</strong></td><td>å¤åˆæ“ä½œä¸å®‰å…¨</td><td>é” / ä¸å¯å˜å¯¹è±¡</td></tr><tr><td><strong>å…¬å¹³æ€§</strong></td><td>çº¿ç¨‹é¥¥é¥¿</td><td>å…¬å¹³é” / é˜Ÿåˆ—è°ƒåº¦</td></tr><tr><td><strong>å¤æ‚æ“ä½œ</strong></td><td>éš¾ä»¥å®ç°</td><td>é” / äº‹åŠ¡å†…å­˜</td></tr><tr><td><strong>å¹³å°ä¾èµ–</strong></td><td>è·¨å¹³å°å…¼å®¹æ€§å·®</td><td>ä½¿ç”¨æ ‡å‡†åº“</td></tr></tbody></table><p>CAS åœ¨æ— é”ç¼–ç¨‹ä¸­éå¸¸é«˜æ•ˆï¼Œä½†éœ€ç»“åˆåœºæ™¯æƒè¡¡åˆ©å¼Šã€‚åœ¨é«˜ç«äº‰ç¯å¢ƒä¸‹ï¼Œå¯èƒ½éœ€è¦æ”¹ç”¨é”æˆ–å…¶ä»–å¹¶å‘ç­–ç•¥ã€‚</p><h3 id="ã€ä¸­ç­‰ã€‘java-ä¸­æ”¯æŒå“ªäº›åŸå­ç±»-â­" tabindex="-1"><a class="header-anchor" href="#ã€ä¸­ç­‰ã€‘java-ä¸­æ”¯æŒå“ªäº›åŸå­ç±»-â­"><span>ã€ä¸­ç­‰ã€‘Java ä¸­æ”¯æŒå“ªäº›åŸå­ç±»ï¼Ÿâ­</span></a></h3><p>Java åŸå­ç±»åº•å±‚åŸºäº <strong>CAS æŒ‡ä»¤ï¼ˆCPU çº§åŸå­æ“ä½œï¼‰+ è‡ªæ—‹é‡è¯•</strong> å®ç°æ— é”åŸå­æ“ä½œã€‚éƒ¨åˆ†é«˜æ€§èƒ½åŸå­ç±»ï¼ˆå¦‚ LongAdderï¼‰é‡‡ç”¨<strong>åˆ†æ®µç´¯åŠ </strong>ä¼˜åŒ–é«˜å¹¶å‘æ€§èƒ½ã€‚</p><p>åŸå­ç±»ç›¸å½“äºä¸€ç§æ³›åŒ–çš„ volatile å˜é‡ï¼Œèƒ½å¤Ÿæ”¯æŒåŸå­çš„ã€æœ‰æ¡ä»¶çš„è¯»/æ”¹/å†™æ“ä½œã€‚</p><div class="hint-container info"><p class="hint-container-title">åŸå­ç±»åˆ†ç±»</p></div><table><thead><tr><th style="text-align:left;">åˆ†ç±»</th><th style="text-align:left;">æ ¸å¿ƒç±»</th><th style="text-align:left;">ä½œç”¨</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>åŸºæœ¬ç±»å‹åŸå­ç±»</strong></td><td style="text-align:left;">AtomicIntegerã€AtomicLongã€AtomicBoolean</td><td style="text-align:left;">å¯¹ <code>int</code> / <code>long</code> / <code>boolean</code> åšåŸå­å¢åˆ æ”¹æŸ¥ï¼Œæ›¿ä»£åŠ é”</td></tr><tr><td style="text-align:left;"><strong>å¼•ç”¨ç±»å‹åŸå­ç±»</strong></td><td style="text-align:left;">AtomicReferenceã€AtomicStampedReferenceã€AtomicMarkableReference</td><td style="text-align:left;">å¯¹å¼•ç”¨ç±»å‹åšåŸå­æ“ä½œï¼Œè§£å†³ CAS çš„ ABA é—®é¢˜</td></tr><tr><td style="text-align:left;"><strong>æ•°ç»„ç±»å‹åŸå­ç±»</strong></td><td style="text-align:left;">AtomicIntegerArrayã€AtomicLongArrayã€AtomicReferenceArray</td><td style="text-align:left;">å¯¹æ•°ç»„å…ƒç´ åšåŸå­æ“ä½œï¼ˆæ•°ç»„æœ¬èº«ä¸åŸå­ï¼Œå…ƒç´ åŸå­ï¼‰</td></tr><tr><td style="text-align:left;"><strong>å­—æ®µæ›´æ–°å™¨</strong></td><td style="text-align:left;">AtomicIntegerFieldUpdaterã€AtomicLongFieldUpdaterã€AtomicReferenceFieldUpdater</td><td style="text-align:left;">å¯¹å­—æ®µåšåŸå­æ›´æ–°ï¼Œæ— éœ€æ”¹å­—æ®µç±»å‹</td></tr><tr><td style="text-align:left;"><strong>ç´¯åŠ å™¨</strong></td><td style="text-align:left;">LongAdderã€DoubleAdderã€LongAccumulatorã€DoubleAccumulator</td><td style="text-align:left;">é«˜å¹¶å‘ä¸‹æ›¿ä»£ AtomicLong/Doubleï¼Œåˆ†æ®µç´¯åŠ ææ€§èƒ½<br>é€‚åˆç»Ÿè®¡ï¼Œä½†ä¸ä¿è¯å®æ—¶ç²¾ç¡®å€¼</td></tr></tbody></table><div class="hint-container info"><p class="hint-container-title">æ ¸å¿ƒåŸå­ç±»</p></div><p><strong>ï¼ˆ1ï¼‰åŸºç¡€ç±»</strong></p><table><thead><tr><th style="text-align:center;">ç±»</th><th style="text-align:center;">æ ¸å¿ƒç‰¹æ€§</th><th style="text-align:center;">å…¸å‹åœºæ™¯</th></tr></thead><tbody><tr><td style="text-align:center;">AtomicInteger</td><td style="text-align:center;">æ”¯æŒ getAndIncrementï¼ˆi++ï¼‰ã€compareAndSet ç­‰</td><td style="text-align:center;">è®¡æ•°å™¨ã€åºåˆ—å·ç”Ÿæˆ</td></tr><tr><td style="text-align:center;">AtomicBoolean</td><td style="text-align:center;">åŸå­æ›´æ–°å¸ƒå°”å€¼ï¼Œåº•å±‚ç”¨ int å­˜å‚¨ï¼ˆ0/1ï¼‰</td><td style="text-align:center;">çŠ¶æ€æ ‡è®°ï¼ˆå¦‚å¼€å…³ï¼‰</td></tr><tr><td style="text-align:center;">AtomicReference</td><td style="text-align:center;">åŸå­æ›´æ–°å¯¹è±¡å¼•ç”¨</td><td style="text-align:center;">åŸå­æ›¿æ¢å¯¹è±¡å®ä¾‹</td></tr></tbody></table><p><strong>ï¼ˆ2ï¼‰è§£å†³ ABA é—®é¢˜</strong></p><table><thead><tr><th style="text-align:center;">ç±»</th><th style="text-align:center;">æ ¸å¿ƒç‰¹æ€§</th><th style="text-align:center;">è®°å¿†ç‚¹</th></tr></thead><tbody><tr><td style="text-align:center;">AtomicStampedReference</td><td style="text-align:center;">åŠ ç‰ˆæœ¬å·ï¼ˆæˆ³ï¼‰ï¼ŒCAS æ—¶æ ¡éªŒå€¼ + ç‰ˆæœ¬</td><td style="text-align:center;">å½»åº•è§£å†³ ABAï¼ˆç‰ˆæœ¬å”¯ä¸€ï¼‰</td></tr><tr><td style="text-align:center;">AtomicMarkableReference</td><td style="text-align:center;">åŠ æ ‡è®°ä½ï¼ˆbooleanï¼‰ï¼ŒCAS æ ¡éªŒå€¼ + æ ‡è®°</td><td style="text-align:center;">ç®€åŒ–ç‰ˆ ABA è§£å†³ï¼ˆä»…æ ‡è®°æ˜¯å¦ä¿®æ”¹ï¼‰</td></tr></tbody></table><p><strong>ï¼ˆ3ï¼‰é«˜æ€§èƒ½ç´¯åŠ å™¨</strong></p><table><thead><tr><th style="text-align:center;">ç±»</th><th style="text-align:center;">æ ¸å¿ƒç‰¹æ€§</th><th style="text-align:center;">è®°å¿†ç‚¹</th></tr></thead><tbody><tr><td style="text-align:center;">LongAdder</td><td style="text-align:center;">åˆ†æ®µç´¯åŠ ï¼ˆbase+cells æ•°ç»„ï¼‰ï¼Œä½ç«äº‰ç”¨ baseï¼Œé«˜ç«äº‰åˆ† cell</td><td style="text-align:center;">é«˜å¹¶å‘è®¡æ•°æ€§èƒ½â‰ˆ10 å€ AtomicLong</td></tr><tr><td style="text-align:center;">LongAccumulator</td><td style="text-align:center;">è‡ªå®šä¹‰ç´¯åŠ è§„åˆ™ï¼ˆå¦‚ä¹˜æ³•ã€æœ€å¤§å€¼ï¼‰ï¼Œæ¯” LongAdder æ›´çµæ´»</td><td style="text-align:center;">æ”¯æŒéåŠ å‡çš„åŸå­è®¡ç®—</td></tr></tbody></table><p><strong>ï¼ˆ4ï¼‰çµæ´»ç±»</strong></p><table><thead><tr><th style="text-align:center;">ç±»</th><th style="text-align:center;">æ ¸å¿ƒç‰¹æ€§</th><th style="text-align:center;">è®°å¿†ç‚¹</th></tr></thead><tbody><tr><td style="text-align:center;">AtomicIntegerFieldUpdater</td><td style="text-align:center;">éœ€é€šè¿‡é™æ€æ–¹æ³•åˆ›å»ºï¼Œå­—æ®µå¿…é¡» volatile</td><td style="text-align:center;">ä¸æ”¹åŸæœ‰ç±»ç»“æ„ï¼ŒåŸå­æ›´æ–°å­—æ®µ</td></tr><tr><td style="text-align:center;">AtomicReferenceArray</td><td style="text-align:center;">ç´¢å¼•æ“ä½œåŸå­ï¼Œæ•°ç»„é•¿åº¦ä¸å¯å˜</td><td style="text-align:center;">åŸå­æ›´æ–°æ•°ç»„å…ƒç´ </td></tr></tbody></table><div class="hint-container info"><p class="hint-container-title">åŸå­ç±»é€‰å‹</p></div><ul><li><strong>ä½å¹¶å‘è®¡æ•°ï¼ˆå¦‚æ™®é€šè®¡æ•°å™¨ï¼‰</strong>â†’ åŸºæœ¬ç±»å‹åŸå­ç±»ï¼ˆAtomicInteger ç­‰ï¼‰</li><li><strong>é«˜å¹¶å‘è®¡æ•°ï¼ˆå¦‚æ¥å£ QPS ç»Ÿè®¡ï¼‰</strong>â†’ ç´¯åŠ å™¨ï¼ˆLongAdder ç­‰ï¼‰</li><li><strong>æ“ä½œå¼•ç”¨å¯¹è±¡ + é˜² ABA</strong> â†’ å¼•ç”¨ç±»å‹åŸå­ç±»ï¼ˆAtomicStampedReference ç­‰ï¼‰</li><li><strong>æ“ä½œå¯¹è±¡çš„æ™®é€šå­—æ®µ</strong> â†’ å­—æ®µæ›´æ–°å™¨ï¼ˆAtomicIntegerFieldUpdater ç­‰ï¼‰</li><li><strong>æ“ä½œæ•°ç»„å…ƒç´ </strong> â†’ æ•°ç»„ç±»å‹åŸå­ç±»ï¼ˆAtomicIntegerArray ç­‰ï¼‰</li></ul><h3 id="ã€ä¸­ç­‰ã€‘ä»€ä¹ˆæ˜¯-threadlocal" tabindex="-1"><a class="header-anchor" href="#ã€ä¸­ç­‰ã€‘ä»€ä¹ˆæ˜¯-threadlocal"><span>ã€ä¸­ç­‰ã€‘ä»€ä¹ˆæ˜¯ ThreadLocalï¼Ÿ</span></a></h3><div class="hint-container info"><p class="hint-container-title">ä»€ä¹ˆæ˜¯ ThreadLocalï¼Ÿ</p></div><p>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œå…±äº«å˜é‡å­˜åœ¨å¹¶å‘å®‰å…¨é—®é¢˜ã€‚æ¢ä¸ªæ€è·¯ï¼Œå¦‚æœå˜é‡éå…±äº«ï¼Œè€Œæ˜¯å„ä¸ªçº¿ç¨‹ç‹¬äº«ï¼Œå°±ä¸ä¼šæœ‰å¹¶å‘å®‰å…¨é—®é¢˜ã€‚è¿™ç§æ€æƒ³æœ‰ä¸ªæœ¯è¯­å«<strong>çº¿ç¨‹å°é—­</strong>ï¼Œå…¶æœ¬è´¨ä¸Šå°±æ˜¯é¿å…å…±äº«ã€‚æ²¡æœ‰å…±äº«ï¼Œè‡ªç„¶ä¹Ÿå°±æ²¡æœ‰å¹¶å‘å®‰å…¨é—®é¢˜ã€‚åœ¨ Java ä¸­ï¼Œ<code>ThreadLocal</code> æ­£æ˜¯æ ¹æ®è¿™ä¸ªæ€è·¯è€Œè®¾è®¡çš„ã€‚</p><p><strong><code>ThreadLocal</code> ä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½åˆ›å»ºäº†ä¸€ä¸ªæœ¬åœ°å‰¯æœ¬</strong>ï¼Œè¿™ä¸ªå‰¯æœ¬åªèƒ½è¢«å½“å‰çº¿ç¨‹è®¿é—®ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è®¿é—®ï¼Œé‚£ä¹ˆè‡ªç„¶æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><div class="hint-container info"><p class="hint-container-title">ThreadLocal æœ‰å“ªäº›åº”ç”¨åœºæ™¯ï¼Ÿ</p></div><p><strong>ï¼ˆ1ï¼‰å­˜å‚¨çº¿ç¨‹ç§æœ‰æ•°æ®</strong></p><ul><li><p><strong>ç”¨æˆ·ä¼šè¯ï¼ˆSessionï¼‰ç®¡ç†</strong>ï¼šæ¯ä¸ªè¯·æ±‚çº¿ç¨‹å­˜å‚¨å½“å‰ç”¨æˆ·çš„ <code>Session</code>ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ThreadLocal</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">User</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> currentUser </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ThreadLocal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">withInitial</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(() </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// è®¾ç½®å½“å‰ç”¨æˆ·</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">currentUser</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(user);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// è·å–å½“å‰ç”¨æˆ·</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">User</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> user </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> currentUser</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>æ•°æ®åº“è¿æ¥ï¼ˆConnectionï¼‰ç®¡ç†</strong>ï¼šé¿å…ä¼ é€’ <code>Connection</code> å‚æ•°ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ThreadLocal</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Connection</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> connectionHolder </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    ThreadLocal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">withInitial</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(() </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> dataSource</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">getConnection</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><p><strong>ï¼ˆ2ï¼‰é¿å…å‚æ•°é€ä¼ </strong></p><p><strong>é—®é¢˜</strong>ï¼šå¤šå±‚æ–¹æ³•è°ƒç”¨éœ€è¦é€ä¼ æŸä¸ªä¸Šä¸‹æ–‡å‚æ•°ï¼ˆå¦‚ <code>traceId</code>ï¼‰ã€‚</p><p><strong>è§£å†³</strong>ï¼šä½¿ç”¨ <code>ThreadLocal</code> å­˜å‚¨ï¼Œé¿å…æ–¹æ³•å‚æ•°ä¼ é€’ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ThreadLocal</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> traceIdHolder </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ThreadLocal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// åœ¨å…¥å£å¤„è®¾ç½® traceId</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">traceIdHolder</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;req-123&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// åœ¨ä»»æ„æ·±å±‚æ–¹æ³•è·å–</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> traceId </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> traceIdHolder</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // æ— éœ€é€ä¼ å‚æ•°</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ï¼ˆ3ï¼‰çº¿ç¨‹å®‰å…¨çš„å·¥å…·ç±»</strong></p><p><strong>ä¾‹å¦‚</strong>ï¼š<code>SimpleDateFormat</code> æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œä½†å¯ä»¥ç”¨ <code>ThreadLocal</code> åŒ…è£…ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ThreadLocal</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">SimpleDateFormat</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> dateFormatHolder </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    ThreadLocal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">withInitial</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(() </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> SimpleDateFormat</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;yyyy-MM-dd&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// çº¿ç¨‹å®‰å…¨åœ°ä½¿ç”¨</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> formattedDate </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> dateFormatHolder</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">format</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Date</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æœ€ä½³å®è·µ</strong></p><p>ï¼ˆ1ï¼‰<strong>å°½é‡ç”¨ <code>static final</code></strong></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> final</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ThreadLocal</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">User</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> userHolder </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ThreadLocal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>é¿å…é‡å¤åˆ›å»º <code>ThreadLocal</code> å®ä¾‹ã€‚</p><p>ï¼ˆ2ï¼‰<strong>å¿…é¡»è°ƒç”¨ <code>remove()</code></strong></p><p>å°¤å…¶åœ¨çº¿ç¨‹æ± åœºæ™¯ï¼Œå¦åˆ™ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p><p>ï¼ˆ3ï¼‰<strong>æ¨èåˆå§‹åŒ–é»˜è®¤å€¼</strong></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ThreadLocal</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">User</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> userHolder </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ThreadLocal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">withInitial</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(() </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> User</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>ï¼ˆ4ï¼‰<strong>é¿å…åœ¨çˆ¶å­çº¿ç¨‹é—´ä¼ é€’</strong></p><p><code>ThreadLocal</code> ä¸èƒ½è‡ªåŠ¨ç»§æ‰¿ï¼Œéœ€æ‰‹åŠ¨å¤„ç†ï¼ˆå¯ç”¨ <code>InheritableThreadLocal</code>ï¼‰ã€‚</p><h3 id="ã€ä¸­ç­‰ã€‘threadlocal-çš„åŸç†æ˜¯ä»€ä¹ˆ-â­â­â­" tabindex="-1"><a class="header-anchor" href="#ã€ä¸­ç­‰ã€‘threadlocal-çš„åŸç†æ˜¯ä»€ä¹ˆ-â­â­â­"><span>ã€ä¸­ç­‰ã€‘<code>ThreadLocal</code> çš„åŸç†æ˜¯ä»€ä¹ˆï¼Ÿâ­â­â­</span></a></h3><p>ThreadLocal æ˜¯<strong>çº¿ç¨‹æœ¬åœ°å˜é‡</strong>ï¼Œæ ¸å¿ƒä½œç”¨æ˜¯ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ›å»ºç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ï¼Œå®ç°çº¿ç¨‹é—´æ•°æ®éš”ç¦»ã€‚</p><div class="hint-container info"><p class="hint-container-title">æ ¸å¿ƒç»“æ„</p></div><table><thead><tr><th style="text-align:center;">è§’è‰²</th><th style="text-align:center;">ä½œç”¨ï¼ˆè®°å¿†ç‚¹ï¼‰</th><th style="text-align:center;">æ ¸å¿ƒå…³ç³»</th></tr></thead><tbody><tr><td style="text-align:center;">ThreadLocal</td><td style="text-align:center;">å¯¹å¤–æš´éœ²çš„æ“ä½œå…¥å£ï¼ˆget/set/removeï¼‰</td><td style="text-align:center;">ä½œä¸º Keyï¼Œå…³è”çº¿ç¨‹çš„å˜é‡å‰¯æœ¬</td></tr><tr><td style="text-align:center;">Thread</td><td style="text-align:center;">çº¿ç¨‹å¯¹è±¡ï¼Œå†…ç½® <code>ThreadLocalMap</code> æˆå‘˜å˜é‡</td><td style="text-align:center;">æ¯ä¸ªçº¿ç¨‹æœ‰ä¸“å±çš„ ThreadLocalMap</td></tr><tr><td style="text-align:center;">ThreadLocalMap</td><td style="text-align:center;">çº¿ç¨‹å†…éƒ¨çš„å“ˆå¸Œè¡¨ï¼ˆç±»ä¼¼ HashMapï¼‰</td><td style="text-align:center;">Key=ThreadLocalï¼ˆå¼±å¼•ç”¨ï¼‰ï¼ŒValue = å˜é‡å‰¯æœ¬</td></tr></tbody></table><div class="hint-container info"><p class="hint-container-title">æ ¸å¿ƒæœºåˆ¶</p></div><ol><li>å¼±å¼•ç”¨è§£å†³å†…å­˜æ³„æ¼ï¼ˆå…³é”®ï¼‰ <ul><li>ThreadLocalMap çš„ Key æ˜¯ ThreadLocal çš„<strong>å¼±å¼•ç”¨</strong>ã€‚</li><li>å½“ ThreadLocal æ— å¼ºå¼•ç”¨æ—¶ï¼ŒGC ä¼šå›æ”¶ Keyã€‚</li><li>ä»…å›æ”¶ Key ä»ä¼šæ®‹ç•™ Valueï¼ˆå¼ºå¼•ç”¨ï¼‰ï¼Œéœ€æ‰‹åŠ¨è°ƒç”¨ <code>remove()</code> æ¸…ç©ºï¼Œé¿å…å†…å­˜æ³„æ¼ï¼›</li></ul></li><li>çº¿ç¨‹éš”ç¦»æœ¬è´¨ï¼šå˜é‡å‰¯æœ¬å­˜åœ¨ Thread è‡ªèº«çš„ Map ä¸­ï¼Œè€Œé ThreadLocal é‡Œï¼ŒThreadLocal ä»…ä½œä¸º â€œç´¢å¼•â€ï¼›</li><li>åˆå§‹åŒ–æœºåˆ¶ï¼šé‡å†™ <code>initialValue()</code> å¯æŒ‡å®šåˆå§‹å€¼ï¼Œä¹Ÿå¯é€šè¿‡ <code>setInitialValue()</code> æ‰‹åŠ¨åˆå§‹åŒ–ã€‚</li></ol><div class="hint-container info"><p class="hint-container-title">åº”ç”¨åœºæ™¯</p></div><table><thead><tr><th style="text-align:center;">åœºæ™¯</th><th style="text-align:left;">æ ¸å¿ƒç”¨æ³•</th></tr></thead><tbody><tr><td style="text-align:center;"><strong>èµ„æºéš”ç¦»</strong></td><td style="text-align:left;">æ•°æ®åº“è¿æ¥ã€Sessionã€ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆå¦‚ç™»å½•æ€ï¼‰ï¼Œé¿å…çº¿ç¨‹å…±äº«å†²çª</td></tr><tr><td style="text-align:center;"><strong>æ€§èƒ½ä¼˜åŒ–</strong></td><td style="text-align:left;">æ›¿ä»£æ–¹æ³•ä¼ å‚ï¼Œå‡å°‘å¤šçº¿ç¨‹ä¸‹é”çš„ä½¿ç”¨ï¼ˆå¦‚ SimpleDateFormat éš”ç¦»ï¼‰</td></tr><tr><td style="text-align:center;"><strong>é“¾è·¯è¿½è¸ª</strong></td><td style="text-align:left;">å­˜å‚¨çº¿ç¨‹ä¸“å±çš„è¿½è¸ª IDï¼ˆTraceIDï¼‰ï¼Œå…¨é“¾è·¯æ—¥å¿—å…³è”</td></tr></tbody></table><h3 id="ã€ä¸­ç­‰ã€‘å¦‚ä½•è§£å†³-threadlocal-å†…å­˜æ³„æ¼é—®é¢˜-â­â­" tabindex="-1"><a class="header-anchor" href="#ã€ä¸­ç­‰ã€‘å¦‚ä½•è§£å†³-threadlocal-å†…å­˜æ³„æ¼é—®é¢˜-â­â­"><span>ã€ä¸­ç­‰ã€‘å¦‚ä½•è§£å†³ <code>ThreadLocal</code> å†…å­˜æ³„æ¼é—®é¢˜ï¼Ÿâ­â­</span></a></h3><p><strong>ThreadLocal çš„å†…å­˜æ³„æ¼é—®é¢˜æºäºå…¶ç‰¹æ®Šçš„ &quot;å¼±å¼•ç”¨ Key + å¼ºå¼•ç”¨ Value&quot; å­˜å‚¨ç»“æ„</strong>ã€‚</p><table><thead><tr><th style="text-align:left;">æ³„æ¼åŸå› </th><th style="text-align:left;">æ ¸å¿ƒé€»è¾‘</th></tr></thead><tbody><tr><td style="text-align:left;">æ ¸å¿ƒçŸ›ç›¾</td><td style="text-align:left;">ThreadLocalMap çš„ Key æ˜¯å¼±å¼•ç”¨ï¼ˆGC å›æ”¶ï¼‰ï¼ŒValue æ˜¯å¼ºå¼•ç”¨ï¼ˆç»‘å®šçº¿ç¨‹ï¼‰ï¼Œå¯¼è‡´ Key å›æ”¶å Value æˆ â€œåƒµå°¸å€¼â€ï¼Œéšçº¿ç¨‹é•¿æœŸå­˜æ´»</td></tr><tr><td style="text-align:left;">é«˜å±åœºæ™¯</td><td style="text-align:left;">çº¿ç¨‹æ± ï¼ˆçº¿ç¨‹å¤ç”¨ï¼‰+ æœªæ‰‹åŠ¨æ¸…ç† â†’ åƒµå°¸å€¼ç´¯ç§¯ï¼Œå†…å­˜æŒç»­æ³„æ¼</td></tr></tbody></table><div class="hint-container info"><p class="hint-container-title">ThreadLocal å†…å­˜æ³„éœ²åœºæ™¯</p></div>`,160)),d(r,{data:[{id:"çº¿ç¨‹æ± ç¯å¢ƒæœªæ¸…ç†"},{id:"<code v-pre>remove()</code> æœªæ”¾ finally å—"}],"tab-id":"å†…å­˜æ³„æ¼çš„å…·ä½“åœºæ™¯"},{title0:a(({value:n,isActive:e})=>[...t[4]||(t[4]=[s("çº¿ç¨‹æ± ç¯å¢ƒæœªæ¸…ç†",-1)])]),title1:a(({value:n,isActive:e})=>[...t[5]||(t[5]=[i("code",null,"remove()",-1),s(" æœªæ”¾ finally å—",-1)])]),tab0:a(({value:n,isActive:e})=>[...t[6]||(t[6]=[i("div",{class:"language-java line-numbers-mode","data-highlighter":"shiki","data-ext":"java",style:{"--shiki-light":"#383A42","--shiki-dark":"#abb2bf","--shiki-light-bg":"#FAFAFA","--shiki-dark-bg":"#282c34"}},[i("pre",{class:"shiki shiki-themes one-light one-dark-pro vp-code"},[i("code",{class:"language-java"},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#C18401","--shiki-dark":"#E5C07B"}},"ExecutorService"),i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E06C75"}}," pool "),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#56B6C2"}},"="),i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E5C07B"}}," Executors"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"."),i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}},"newFixedThreadPool"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"("),i("span",{style:{"--shiki-light":"#986801","--shiki-dark":"#D19A66"}},"5"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},");")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#C18401","--shiki-dark":"#E5C07B"}},"ThreadLocal"),i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#ABB2BF"}},"<"),i("span",{style:{"--shiki-light":"#C18401","--shiki-dark":"#E5C07B"}},"BigObject"),i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#ABB2BF"}},">"),i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E06C75"}}," tl "),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#56B6C2"}},"="),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}}," new"),i("span",{style:{"--shiki-light":"#C18401","--shiki-dark":"#E5C07B"}}," ThreadLocal"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"<>"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}},"()"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},";")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E5C07B"}},"pool"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"."),i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}},"execute"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"(() "),i("span",{style:{"--shiki-light":"#C18401","--shiki-dark":"#C678DD"}},"->"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}}," {")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E5C07B"}},"    tl"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"."),i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}},"set"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"("),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"new"),i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}}," BigObject"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"());  "),i("span",{style:{"--shiki-light":"#A0A1A7","--shiki-light-font-style":"italic","--shiki-dark":"#7F848E","--shiki-dark-font-style":"italic"}},"// å­˜å‚¨å¤§å¯¹è±¡")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A0A1A7","--shiki-light-font-style":"italic","--shiki-dark":"#7F848E","--shiki-dark-font-style":"italic"}},"    // ä¸šåŠ¡é€»è¾‘ã€‚..")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A0A1A7","--shiki-light-font-style":"italic","--shiki-dark":"#7F848E","--shiki-dark-font-style":"italic"}},"    // ç¼ºå°‘ tl.remove()ï¼çº¿ç¨‹å¤ç”¨åæ—§ Value ä»ç„¶å­˜åœ¨")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"});")])])]),i("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"})])],-1)])]),tab1:a(({value:n,isActive:e})=>[...t[7]||(t[7]=[i("div",{class:"language-java line-numbers-mode","data-highlighter":"shiki","data-ext":"java",style:{"--shiki-light":"#383A42","--shiki-dark":"#abb2bf","--shiki-light-bg":"#FAFAFA","--shiki-dark-bg":"#282c34"}},[i("pre",{class:"shiki shiki-themes one-light one-dark-pro vp-code"},[i("code",{class:"language-java"},[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#C18401","--shiki-dark":"#E5C07B"}},"ThreadLocal"),i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#ABB2BF"}},"<"),i("span",{style:{"--shiki-light":"#C18401","--shiki-dark":"#E5C07B"}},"String"),i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#ABB2BF"}},">"),i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E06C75"}}," tl "),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#56B6C2"}},"="),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}}," new"),i("span",{style:{"--shiki-light":"#C18401","--shiki-dark":"#E5C07B"}}," ThreadLocal"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"<>"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}},"()"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},";")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E5C07B"}},"tl"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"."),i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}},"set"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"("),i("span",{style:{"--shiki-light":"#50A14F","--shiki-dark":"#98C379"}},'"æ•°æ®"'),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},");")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"if"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}}," ï¼ˆä¸šåŠ¡å¼‚å¸¸ï¼‰ {")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}},"    throw"),i("span",{style:{"--shiki-light":"#A626A4","--shiki-dark":"#C678DD"}}," new"),i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}}," Exception"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}},"()"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},";"),i("span",{style:{"--shiki-light":"#A0A1A7","--shiki-light-font-style":"italic","--shiki-dark":"#7F848E","--shiki-dark-font-style":"italic"}}," // è·³è¿‡ remove()")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#E06C75"}},"}")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#E45649","--shiki-dark":"#E5C07B"}},"tl"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"."),i("span",{style:{"--shiki-light":"#4078F2","--shiki-dark":"#61AFEF"}},"remove"),i("span",{style:{"--shiki-light":"#383A42","--shiki-dark":"#ABB2BF"}},"();")])])]),i("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"}),i("div",{class:"line-number"})])],-1)])]),_:1}),t[10]||(t[10]=l(`<div class="hint-container info"><p class="hint-container-title">ThreadLocal å†…å­˜æ³„éœ²è§£å†³æ–¹æ¡ˆ</p></div><p><strong>ï¼ˆ1ï¼‰æœ€æ ¸å¿ƒï¼šç”¨å®Œå¿…åœ¨ finally è°ƒç”¨ <code>remove()</code>ï¼ˆæ²»æ ‡æ²»æœ¬ï¼‰</strong></p><p>åœ¨ä¸šåŠ¡ä»£ç ç»“æŸå¤„ï¼ˆfinally å—ï¼‰è°ƒç”¨ <code>threadLocal.remove()</code>ï¼Œæ¸…ç©ºå½“å‰çº¿ç¨‹çš„ Valueï¼›</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ThreadLocal</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> tl </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ThreadLocal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">try</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    tl</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;ä¸šåŠ¡æ•°æ®&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // ä¸šåŠ¡é€»è¾‘æ‰§è¡Œ</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">} </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">finally</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    tl</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">remove</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // æ— è®ºæ˜¯å¦å¼‚å¸¸ï¼Œå¿…æ¸…ç†</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ï¼ˆ2ï¼‰å…œåº•ï¼šä¾èµ– Key çš„å¼±å¼•ç”¨ç‰¹æ€§ï¼ˆè¢«åŠ¨é˜²æŠ¤ï¼‰</strong></p><p><code>ThreadLocalMap</code> ä¼šåœ¨ <code>set()</code>/<code>get()</code>/<code>remove()</code> æ—¶ï¼Œè‡ªåŠ¨æ¸…ç† â€œKey ä¸º nullâ€ çš„ Entryï¼ˆåƒµå°¸å€¼ï¼‰ã€‚</p><p>å¼±å¼•ç”¨æ˜¯ JDK å±‚é¢çš„å…œåº•ï¼Œä½†è‹¥é•¿æœŸä¸æ“ä½œ <code>Map</code>ï¼ˆå¦‚çº¿ç¨‹æ± ç©ºé—²ï¼‰ï¼Œä»ä¼šæ³„æ¼ï¼Œéœ€é…åˆä¸»åŠ¨ <code>remove</code>ã€‚</p><p><strong>ï¼ˆ3ï¼‰é«˜å±åœºæ™¯ï¼šçº¿ç¨‹æ± ä½¿ç”¨å¿…è§„èŒƒï¼ˆé‡ç‚¹é¿å‘ï¼‰</strong></p><p>çº¿ç¨‹æ± çº¿ç¨‹å¤ç”¨ï¼Œè‹¥å‰ä¸€ä¸ªä»»åŠ¡æœªæ¸…ç† <code>ThreadLocal</code>ï¼Œåä¸€ä¸ªä»»åŠ¡ä¼šè¯»å–åˆ°è„æ•°æ® + å†…å­˜æ³„æ¼ï¼›</p><p>çº¿ç¨‹æ± ä»»åŠ¡ä¸­ï¼ŒThreadLocal å¿…é¡»åœ¨ finally ä¸­ removeï¼Œæˆ–ä½¿ç”¨çº¿ç¨‹æ± çš„ä»»åŠ¡åŒ…è£…å™¨ç»Ÿä¸€æ¸…ç†ã€‚</p><p><strong>ï¼ˆ4ï¼‰è¾…åŠ©ï¼šè§„èŒƒåˆå§‹åŒ–ï¼ˆå‡å°‘æ³„æ¼é£é™©ï¼‰</strong></p><p>è§„èŒƒåˆå§‹åŒ–å¯å‡å°‘æ— æ•ˆ set æ“ä½œï¼Œé™ä½åƒµå°¸å€¼äº§ç”Ÿæ¦‚ç‡ã€‚</p><ul><li><strong>æ–¹å¼ 1</strong>ï¼šé‡å†™ <code>initialValue()</code> åˆå§‹åŒ–ï¼Œé¿å…å¤šæ¬¡ set å¯¼è‡´æ—§å€¼æ®‹ç•™ï¼›</li><li><strong>æ–¹å¼ 2</strong>ï¼šä½¿ç”¨ <code>ThreadLocal.withInitial()</code>ï¼ˆJava 8+ï¼‰ï¼Œåˆå§‹åŒ–é€»è¾‘æ›´æ¸…æ™°ï¼Œå‡å°‘ç©ºå€¼æ“ä½œï¼›</li></ul><div class="hint-container info"><p class="hint-container-title">ThreadLocal ä½¿ç”¨é¿å‘</p></div><table><thead><tr><th style="text-align:center;">å¸¸è§è¯¯åŒº</th><th style="text-align:center;">æ­£ç¡®åšæ³•</th></tr></thead><tbody><tr><td style="text-align:center;">ä¾èµ– GC è‡ªåŠ¨å›æ”¶</td><td style="text-align:center;">GC ä»…å›æ”¶ Keyï¼Œæ— æ³•å›æ”¶ Valueï¼Œå¿…é¡»æ‰‹åŠ¨ remove</td></tr><tr><td style="text-align:center;">çº¿ç¨‹æ± åªåˆå§‹åŒ–ä¸€æ¬¡ ThreadLocal</td><td style="text-align:center;">æ¯æ¬¡ä»»åŠ¡æ‰§è¡Œå®Œéƒ½è¦ removeï¼Œè€Œéä»…åˆå§‹åŒ–</td></tr><tr><td style="text-align:center;">è®¤ä¸º ThreadLocal é™æ€åŒ–ä¼šæ³„æ¼</td><td style="text-align:center;">é™æ€åŒ–æœ¬èº«ä¸æ³„æ¼ï¼Œæ³„æ¼æ ¹æºæ˜¯æœª remove + çº¿ç¨‹å¤ç”¨</td></tr></tbody></table><h3 id="ã€ä¸­ç­‰ã€‘inheritablethreadlocal-çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#ã€ä¸­ç­‰ã€‘inheritablethreadlocal-çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆ"><span>ã€ä¸­ç­‰ã€‘InheritableThreadLocal çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</span></a></h3><p><strong>æ ¸å¿ƒè®¾è®¡ç›®æ ‡</strong></p><ul><li><strong>çº¿ç¨‹é—´å€¼ç»§æ‰¿</strong>ï¼šå­çº¿ç¨‹è‡ªåŠ¨ç»§æ‰¿çˆ¶çº¿ç¨‹çš„ ThreadLocal å€¼</li><li><strong>ä¸ ThreadLocal å…¼å®¹</strong>ï¼šç»§æ‰¿è‡ª<code>ThreadLocal</code>ï¼Œä¿æŒç›¸åŒ API</li></ul><p><strong>æ•°æ®å­˜å‚¨ä½ç½®</strong></p><p>ç»§æ‰¿è‡ª<code>ThreadLocal</code>ï¼Œä½†ä½¿ç”¨çº¿ç¨‹å¯¹è±¡çš„<strong>ç‹¬ç«‹å­—æ®µ</strong>ï¼›<code>Thread.inheritableThreadLocals</code>ï¼ˆä¸“é—¨å­˜å‚¨å¯ç»§æ‰¿çš„å˜é‡ï¼‰</p><p><strong>çº¿ç¨‹åˆ›å»ºæ—¶çš„å€¼æ‹·è´</strong></p><ul><li><p><strong>è§¦å‘æ—¶æœº</strong>ï¼šå½“çˆ¶çº¿ç¨‹åˆ›å»ºå­çº¿ç¨‹ï¼ˆ<code>Thread.init()</code>æ–¹æ³•ï¼‰</p></li><li><p><strong>æ‹·è´é€»è¾‘</strong>ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">parent</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">inheritableThreadLocals</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    this</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">inheritableThreadLocals</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        ThreadLocal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">createInheritedMap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">parent</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">inheritableThreadLocals</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>æ·±æ‹·è´ä¿è¯éš”ç¦»</strong>ï¼šå­çº¿ç¨‹è·å¾—çˆ¶çº¿ç¨‹å€¼çš„ç‹¬ç«‹å‰¯æœ¬ï¼ˆä¿®æ”¹äº’ä¸å½±å“ï¼‰</p></li></ul><p><strong>å€¼ä¼ é€’è§„åˆ™</strong></p><ul><li><strong>ä»…åˆå§‹åŒ–æ—¶æ‹·è´</strong>ï¼šå­çº¿ç¨‹åˆ›å»ºåçˆ¶çº¿ç¨‹å¯¹å€¼çš„ä¿®æ”¹ä¸å†å½±å“å­çº¿ç¨‹</li><li><strong>æµ…æ‹·è´é—®é¢˜</strong>ï¼šè‹¥å­˜å‚¨å¼•ç”¨å¯¹è±¡ï¼Œçˆ¶å­çº¿ç¨‹ä»å…±äº«åŒä¸€å¯¹è±¡ï¼ˆéœ€å¼€å‘è€…è‡ªè¡Œå¤„ç†çº¿ç¨‹å®‰å…¨ï¼‰</li></ul><p><strong>ä¸ ThreadLocal çš„å¯¹æ¯”</strong></p><table><thead><tr><th>ç‰¹æ€§</th><th><code>InheritableThreadLocal</code></th><th><code>ThreadLocal</code></th></tr></thead><tbody><tr><td><strong>ç»§æ‰¿æ€§</strong></td><td>å­çº¿ç¨‹è‡ªåŠ¨ç»§æ‰¿çˆ¶çº¿ç¨‹å€¼</td><td>å®Œå…¨éš”ç¦»</td></tr><tr><td><strong>å­˜å‚¨å­—æ®µ</strong></td><td><code>Thread.inheritableThreadLocals</code></td><td><code>Thread.threadLocals</code></td></tr><tr><td><strong>æ€§èƒ½å¼€é”€</strong></td><td>ç•¥é«˜ï¼ˆéœ€åˆå§‹åŒ–æ—¶æ‹·è´æ•°æ®ï¼‰</td><td>æ›´ä½</td></tr><tr><td><strong>ä½¿ç”¨åœºæ™¯</strong></td><td>éœ€è¦è·¨çº¿ç¨‹ä¼ é€’ä¸Šä¸‹æ–‡ï¼ˆå¦‚ TraceIDï¼‰</td><td>çº¿ç¨‹ç§æœ‰æ•°æ®</td></tr></tbody></table><p><strong>ä½¿ç”¨æ³¨æ„äº‹é¡¹</strong></p><ul><li><strong>å¯¹è±¡å…±äº«é£é™©</strong>ï¼šè‹¥å€¼æ˜¯å¯å˜çš„å¼•ç”¨å¯¹è±¡ï¼Œéœ€è‡ªè¡Œä¿è¯çº¿ç¨‹å®‰å…¨</li><li><strong>çº¿ç¨‹æ± é™·é˜±</strong>ï¼šçº¿ç¨‹æ± å¤ç”¨çº¿ç¨‹æ—¶ä¼šå¯¼è‡´æ—§å€¼æ®‹ç•™ï¼ˆéœ€æ‰‹åŠ¨æ¸…ç†ï¼‰</li><li><strong>æ€§èƒ½å½±å“</strong>ï¼šå¤§é‡çº¿ç¨‹åˆ›å»ºæ—¶ï¼Œå€¼æ‹·è´å¯èƒ½æˆä¸ºç“¶é¢ˆ</li></ul><p><strong>å…¸å‹åº”ç”¨åœºæ™¯</strong></p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-java"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// çˆ¶çº¿ç¨‹è®¾ç½®å€¼</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">InheritableThreadLocal</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#E45649;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> itl </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> InheritableThreadLocal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">itl</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;parent_value&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Thread</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">(() </span><span style="--shiki-light:#C18401;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // å­çº¿ç¨‹è‡ªåŠ¨è¯»å–åˆ°çˆ¶çº¿ç¨‹è®¾ç½®çš„å€¼</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    System</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">out</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">println</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">itl</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // è¾“å‡ºï¼šparent_value</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">})</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">start</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å®ç°å±€é™</strong></p><ul><li><strong>ä¸æ”¯æŒåŠ¨æ€æ›´æ–°</strong>ï¼šå­çº¿ç¨‹å¯åŠ¨åçˆ¶çº¿ç¨‹çš„ä¿®æ”¹ä¸å¯è§</li><li><strong>æ— å›è°ƒæœºåˆ¶</strong>ï¼šæ— æ³•åƒ<code>ThreadLocal</code>çš„<code>initialValue()</code>é‚£æ ·è‡ªå®šä¹‰å­çº¿ç¨‹åˆå§‹å€¼</li></ul>`,32))])}const u=h(g,[["render",c]]),B=JSON.parse('{"path":"/pages/96684ccf/","title":"Java å¹¶å‘é¢è¯•äºŒ","lang":"zh-CN","frontmatter":{"title":"Java å¹¶å‘é¢è¯•äºŒ","date":"2024-07-23T07:21:03.000Z","order":8,"categories":["Java","JavaCore","é¢è¯•"],"tags":["Java","JavaCore","é¢è¯•","å¹¶å‘"],"permalink":"/pages/96684ccf/","description":"Java å¹¶å‘é¢è¯•äºŒ Java é” ã€ä¸­ç­‰ã€‘Java ä¸­ï¼Œæ ¹æ®ä¸åŒç»´åº¦åˆ’åˆ†ï¼Œé”æœ‰å“ªäº›åˆ†ç±»ï¼Ÿ åœ¨ Java ä¸­ï¼Œé”å¯ä»¥æŒ‰ç…§ å¤šä¸ªç»´åº¦ è¿›è¡Œåˆ†ç±»ï¼Œä¸åŒç»´åº¦çš„é”é€‚ç”¨äºä¸åŒçš„å¹¶å‘åœºæ™¯ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†çš„åˆ†ç±»ï¼š æŒ‰é”çš„å…¬å¹³æ€§åˆ’åˆ† æŒ‰é”çš„è·å–æ–¹å¼åˆ’åˆ† æŒ‰é”çš„å¯é‡å…¥æ€§åˆ’åˆ† æŒ‰é”çš„å…±äº«æ€§åˆ’åˆ† æŒ‰é”çš„é˜»å¡æ–¹å¼åˆ’åˆ† æŒ‰é”çš„ä¼˜åŒ–ç­–ç•¥åˆ’åˆ† æŒ‰é”çš„å®ç°æ–¹å¼åˆ’åˆ† æ€»ç»“ é€‰æ‹©åˆé€‚çš„é”å–å†³...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Java å¹¶å‘é¢è¯•äºŒ\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2024-07-23T07:21:03.000Z\\",\\"dateModified\\":\\"2026-01-21T23:57:06.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"é’æ‚Ÿ\\",\\"url\\":\\"https://dunwu.github.io/waterdrop\\"}]}"],["meta",{"property":"og:url","content":"https://dunwu.github.io/waterdrop/waterdrop/pages/96684ccf/"}],["meta",{"property":"og:site_name","content":"é’æ‚Ÿ"}],["meta",{"property":"og:title","content":"Java å¹¶å‘é¢è¯•äºŒ"}],["meta",{"property":"og:description","content":"Java å¹¶å‘é¢è¯•äºŒ Java é” ã€ä¸­ç­‰ã€‘Java ä¸­ï¼Œæ ¹æ®ä¸åŒç»´åº¦åˆ’åˆ†ï¼Œé”æœ‰å“ªäº›åˆ†ç±»ï¼Ÿ åœ¨ Java ä¸­ï¼Œé”å¯ä»¥æŒ‰ç…§ å¤šä¸ªç»´åº¦ è¿›è¡Œåˆ†ç±»ï¼Œä¸åŒç»´åº¦çš„é”é€‚ç”¨äºä¸åŒçš„å¹¶å‘åœºæ™¯ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†çš„åˆ†ç±»ï¼š æŒ‰é”çš„å…¬å¹³æ€§åˆ’åˆ† æŒ‰é”çš„è·å–æ–¹å¼åˆ’åˆ† æŒ‰é”çš„å¯é‡å…¥æ€§åˆ’åˆ† æŒ‰é”çš„å…±äº«æ€§åˆ’åˆ† æŒ‰é”çš„é˜»å¡æ–¹å¼åˆ’åˆ† æŒ‰é”çš„ä¼˜åŒ–ç­–ç•¥åˆ’åˆ† æŒ‰é”çš„å®ç°æ–¹å¼åˆ’åˆ† æ€»ç»“ é€‰æ‹©åˆé€‚çš„é”å–å†³..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2026-01-21T23:57:06.000Z"}],["meta",{"property":"article:tag","content":"å¹¶å‘"}],["meta",{"property":"article:tag","content":"é¢è¯•"}],["meta",{"property":"article:tag","content":"JavaCore"}],["meta",{"property":"article:tag","content":"Java"}],["meta",{"property":"article:published_time","content":"2024-07-23T07:21:03.000Z"}],["meta",{"property":"article:modified_time","content":"2026-01-21T23:57:06.000Z"}]]},"git":{"createdTime":1720743538000,"updatedTime":1769039826000,"contributors":[{"name":"dunwu","username":"dunwu","email":"forbreak@163.com","commits":13,"url":"https://github.com/dunwu"}]},"readingTime":{"minutes":32.4,"words":9720},"filePathRelative":"01.Java/JavaCore/é¢è¯•/Java_é¢è¯•_å¹¶å‘ï¼ˆäºŒï¼‰.md","excerpt":"\\n<h2>Java é”</h2>\\n<h3>ã€ä¸­ç­‰ã€‘Java ä¸­ï¼Œæ ¹æ®ä¸åŒç»´åº¦åˆ’åˆ†ï¼Œé”æœ‰å“ªäº›åˆ†ç±»ï¼Ÿ</h3>\\n<p>åœ¨ Java ä¸­ï¼Œé”å¯ä»¥æŒ‰ç…§ <strong>å¤šä¸ªç»´åº¦</strong> è¿›è¡Œåˆ†ç±»ï¼Œä¸åŒç»´åº¦çš„é”é€‚ç”¨äºä¸åŒçš„å¹¶å‘åœºæ™¯ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†çš„åˆ†ç±»ï¼š</p>\\n<p><strong>æŒ‰é”çš„å…¬å¹³æ€§åˆ’åˆ†</strong></p>\\n<table>\\n<thead>\\n<tr>\\n<th><strong>é”ç±»å‹</strong></th>\\n<th><strong>ç‰¹ç‚¹</strong></th>\\n<th><strong>å®ç°ç±»/å…³é”®å­—</strong></th>\\n</tr>\\n</thead>\\n<tbody>\\n<tr>\\n<td><strong>å…¬å¹³é”</strong></td>\\n<td>ä¸¥æ ¼æŒ‰ç…§çº¿ç¨‹è¯·æ±‚é¡ºåºï¼ˆFIFOï¼‰åˆ†é…é”ï¼Œé¿å…çº¿ç¨‹é¥¥é¥¿ï¼Œä½†æ€§èƒ½è¾ƒä½ã€‚</td>\\n<td><code>ReentrantLock(true)</code></td>\\n</tr>\\n<tr>\\n<td><strong>éå…¬å¹³é”</strong></td>\\n<td>å…è®¸æ’é˜Ÿï¼Œæ–°è¯·æ±‚çš„çº¿ç¨‹å¯èƒ½ç›´æ¥æŠ¢åˆ°é”ï¼Œååé‡é«˜ï¼Œä½†å¯èƒ½å¯¼è‡´çº¿ç¨‹é¥¥é¥¿ï¼ˆé»˜è®¤æ–¹å¼ï¼‰ã€‚</td>\\n<td><code>ReentrantLock(false)</code>ã€<code>synchronized</code></td>\\n</tr>\\n</tbody>\\n</table>","autoDesc":true}');export{u as comp,B as data};
